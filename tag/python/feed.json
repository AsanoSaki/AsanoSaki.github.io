{
    "version": "https://jsonfeed.org/version/1",
    "title": "AsanoSaki • All posts by \"python\" tag",
    "description": "",
    "home_page_url": "https://asanosaki.github.io",
    "items": [
        {
            "id": "https://asanosaki.github.io/posts/45720.html",
            "url": "https://asanosaki.github.io/posts/45720.html",
            "title": "Django Channels、WS协议及同步与异步详解",
            "date_published": "2023-10-11T08:28:00.000Z",
            "content_html": "<blockquote>\n<p>介绍同步与异步、WebSocket 协议以及 Django Channels 三者的概念及其联系，并结合代码示例进行讲解。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 同步与异步</h1>\n<p>在 Django 中，同步和异步主要涉及到请求处理的方式。这两种方式的主要区别在于它们如何处理多个并发请求：</p>\n<ul>\n<li>同步（Synchronous）：在同步模式下，Django 会为<strong>每个请求</strong>创建一个<strong>单独</strong>的线程或进程。这意味着，如果一个请求正在等待响应（例如，等待数据库查询返回结果），那么整个线程或进程将被<strong>阻塞</strong>，直到响应返回。这可能会导致资源的浪费，因为在等待期间，线程或进程不能做其他任何事情。</li>\n<li>异步（Asynchronous）：与同步模式不同，异步模式允许单个线程或进程<strong>同时处理多个请求</strong>。当一个请求需要等待响应时（例如，等待数据库查询返回结果），线程或进程可以切换到另一个请求，继续执行其他任务，而不是被阻塞。这样可以更有效地利用系统资源，提高并发处理能力。</li>\n</ul>\n<p>Django 3.1 版本开始引入了对异步视图和中间件的支持，这意味着你可以编写异步的视图函数，这些函数可以使用 Python 的 <code>async</code> 和 <code>await</code> 关键字进行定义。这使得 Django 可以更好地处理 I/O 密集型任务，如 HTTP 请求、数据库操作和文件读写等。</p>\n<p>然而需要注意的是，并非所有的 Django 组件都支持异步操作。例如，Django 的 ORM（对象关系映射）目前仍然是同步的，这意味着你不能在异步视图或中间件中直接使用它。如果你需要在异步代码中执行数据库操作，你需要使用 Django 提供的 <code>sync_to_async</code> 或 <code>async_to_sync</code> 函数来确保数据库操作在同步环境中执行。</p>\n<p>总的来说，同步和异步各有优势和适用场景。对于 CPU 密集型任务，同步模式可能更合适；而对于 I/O 密集型任务，异步模式可能会带来更好的性能。在实际开发中，你可能需要根据应用的具体需求和性能要求来选择使用同步还是异步。</p>\n<p>（1）同步代码样例</p>\n<p>现在我们来看一些同步与异步的样例，首先是同步视图，在下面这个例子中，当请求到达 <code>sync_view</code> 时，Django 将等待视图函数完成后才会处理下一个请求：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> HttpResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> render</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">sync_view</span>(<span class=\"params\">request</span>):  <span class=\"comment\"># 这是一个同步视图</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(<span class=\"string\">&#x27;Hello, this is a synchronous view!&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p>下面这个例子在视图中同步地从数据库获取所有的博客对象，然后将它们传递给模板：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> render</span><br><span class=\"line\"><span class=\"keyword\">from</span> .models <span class=\"keyword\">import</span> Blog</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">sync_view</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    blogs = Blog.objects.<span class=\"built_in\">all</span>()  <span class=\"comment\"># 获取所有的博客对象</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> render(request, <span class=\"string\">&#x27;blog/index.html&#x27;</span>, &#123;<span class=\"string\">&#x27;blogs&#x27;</span>: blogs&#125;)</span><br></pre></td></tr></table></figure>\n<p>（2）异步代码样例</p>\n<p>在下面这个例子中，<code>async_view</code> 是一个异步视图。当请求到达这个视图时，Django 可以在等待 <code>asyncio.sleep(1)</code> 完成时处理其他请求：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> asyncio</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> HttpResponse</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">async_view</span>(<span class=\"params\">request</span>):  <span class=\"comment\"># 这是一个异步视图</span></span><br><span class=\"line\">    <span class=\"keyword\">await</span> asyncio.sleep(<span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(<span class=\"string\">&#x27;Hello, this is an asynchronous view!&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p>请注意，要使用异步视图，你需要确保你的 Django 项目正在运行在支持异步的 ASGI 服务器上，而不是传统的 WSGI 服务器。此外，你的中间件和任何你在视图中调用的代码也必须支持异步。否则，你可能会遇到问题。如果你的代码库主要是同步的，那么最好坚持使用同步视图。如果你正在编写新的、主要使用 Python 的异步库的代码，那么异步视图可能会很有用。请记住，混合使用同步和异步代码可以很复杂，需要谨慎对待。</p>\n<p>再来看下面的例子，我们创建了一个新的 <code>get_blogs</code> 异步函数，它使用 <code>run_in_executor</code> 方法在一个单独的线程中运行数据库查询。这允许 Django 在等待数据库查询完成时处理其他请求：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> asyncio</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> .models <span class=\"keyword\">import</span> Blog</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">async_view</span>(<span class=\"params\">request</span>):  <span class=\"comment\"># 异步获取所有的博客对象</span></span><br><span class=\"line\">    blogs = <span class=\"keyword\">await</span> get_blogs()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;<span class=\"string\">&#x27;blogs&#x27;</span>: <span class=\"built_in\">list</span>(blogs.values())&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">get_blogs</span>():</span><br><span class=\"line\">    loop = asyncio.get_event_loop()</span><br><span class=\"line\">    blogs = <span class=\"keyword\">await</span> loop.run_in_executor(<span class=\"literal\">None</span>, Blog.objects.<span class=\"built_in\">all</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> blogs</span><br></pre></td></tr></table></figure>\n<p>请注意，虽然这个示例展示了如何在 Django 视图中使用异步代码操作数据库，但是 Django 的数据库层目前还不支持原生的异步操作。因此，在实践中，你可能需要使用像 <code>asgiref.sync_to_async</code> 这样的工具来安全地在异步视图中执行同步数据库操作。同时，你也需要确保你的数据库驱动程序和数据库服务器能够处理并发连接。否则，你可能会遇到性能问题或错误。如果你不确定如何正确地使用异步代码，那么最好使用同步视图和同步数据库操作。</p>\n<h1>2. WebSocket</h1>\n<p>WebSocket 是一种用于在 Web 和移动应用程序之间进行实时通信的新标准。WebSocket 设计为在 Web 浏览器和 Web 服务器之间实现，但也可以由客户端或服务器应用程序使用。WebSocket 是一种提供单个 TCP 连接上的<strong>全双工</strong>通信通道的协议，可以实现服务器和客户端之间的实时交互。</p>\n<p>WebSocket 与 HTTP 不同，其主要区别如下：</p>\n<ul>\n<li>通信方式：HTTP 是<strong>单向</strong>的，客户端发送请求，服务器发送响应。而 WebSocket 是<strong>双向</strong>的，在客户端-服务器通信的场景中使用的全双工协议，即客户端和服务器可以同时发送和接收数据。</li>\n<li>连接：HTTP 每次请求都需要重新建立连接，而 WebSocket 使用<strong>长连接</strong>实现数据<strong>实时</strong>推送。一旦通信链接建立和连接打开后，消息交换将以双向模式进行，客户端-服务器之间的连接会持久存在。</li>\n<li>数据传输：HTTP 协议中的数据传输是文本格式的，而 WebSocket 可以传输文本和二进制数据。</li>\n<li>性能：由于 HTTP 的每次请求都需要建立连接和断开连接，而 WebSocket 可以在一次连接上进行多次通信，因此 WebSocket 在性能上比 HTTP 有优势。</li>\n<li>应用场景：HTTP 主要用于客户端和服务器之间的请求和响应，如浏览器请求网页和服务器返回网页的 HTML 文件。WebSocket 可以实现双向通信，常常用于实时通信场景。</li>\n<li>协议头：HTTP 协议头的大小从200字节到2KB不等，常见大小是700-800字节。而 WebSocket 协议头相对较小，这使得其在高频率、小数据量的通信场景下更有优势。</li>\n<li>状态：HTTP 是无状态协议，而 WebSocket 是有状态协议。这意味着客户端和服务器之间的连接将保持活动状态，直到被任何一方（客户端或服务器）终止。</li>\n</ul>\n<p>两种协议都位于 OSI 模型的第七层，并依赖于第四层的 TCP。尽管它们是不同的，但 RFC 6455 指出，WebSocket 旨在通过 HTTP 端口443和80工作，并支持 HTTP 代理和中介，从而使其与 HTTP 兼容。为了实现兼容性，WebSocket 握手使用 HTTP Upgrade 头从 HTTP 协议切换到 WebSocket 协议。</p>\n<p>WebSocket 协议使得 Web 浏览器（或其他客户端应用程序）和 Web 服务器之间可以在不需要客户端请求的情况下发送内容，以及在保持连接打开的同时传递消息。这样，客户端和服务器之间可以进行<strong>双向持续的对话</strong>。通信通常是通过 TCP 端口号443（或80，如果是非安全连接）进行的，这对于使用防火墙阻止非 Web Internet 连接的环境是有利的。</p>\n<p>在 Django 中实现 WebSocket，你可以选择使用 <code>channels</code> 或者 <code>dwebsocket</code>。但是，<code>channels</code> 被更广泛地使用，因为它可以完美地集成到 Django 的生态系统中。</p>\n<h1>3. 在JavaScript中使用WebSocket</h1>\n<p>（1）创建 <code>WebSocket</code> 对象</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> ws = <span class=\"keyword\">new</span> <span class=\"title class_\">WebSocket</span>(<span class=\"string\">&#x27;ws://localhost:8888&#x27;</span>);  <span class=\"comment\">// 如果是安全连接则地址为wss://...</span></span><br></pre></td></tr></table></figure>\n<p>（2）连接成功时的回调函数</p>\n<p>当 WebSocket 连接成功时，<code>onopen</code> 事件会被触发。你可以在这个函数中发送消息到服务器：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ws.<span class=\"property\">onopen</span> = <span class=\"keyword\">function</span>(<span class=\"params\">params</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;客户端连接成功&#x27;</span>);</span><br><span class=\"line\">    ws.<span class=\"title function_\">send</span>(<span class=\"string\">&#x27;hello&#x27;</span>);  <span class=\"comment\">// 向服务器发送消息</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>（3）从服务器接收信息时的回调函数</p>\n<p>当从服务器接收到信息时，<code>onmessage</code> 事件会被触发。你可以在这个函数中处理接收到的数据：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ws.<span class=\"property\">onmessage</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;收到服务器响应&#x27;</span>, e.<span class=\"property\">data</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>（4）连接关闭时的回调函数</p>\n<p>当连接关闭后，<code>onclose</code> 事件会被触发。你可以在这个函数中处理连接关闭后的逻辑：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ws.<span class=\"property\">onclose</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;关闭客户端连接&quot;</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>（5）连接失败时的回调函数</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ws.<span class=\"property\">onerror</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;连接失败&quot;</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>（6）监听窗口关闭事件</p>\n<p>当窗口关闭时，主动去关闭 WebSocket 连接，防止连接还没断开就关闭窗口，这样服务端会抛异常：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">onbeforeunload</span> = <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    ws.<span class=\"title function_\">close</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>4. Django Channels</h1>\n<p>Django Channels 是一个开源框架，它扩展了 Django 的功能，使得 Django 不仅可以处理 HTTP，还可以处理需要长时间连接的协议，如 WebSocket、MQTT（消息队列遥测传输）、聊天协议、广播等实时应用。</p>\n<p>Channels 允许 Django 项目支持“长连接”，它用 ASGI 替换了 Django 的默认 WSGI。ASGI（Asynchronous Server Gateway Interface）为异步 Python Web 服务器和应用程序提供了一个接口，同时支持 WSGI 提供的所有功能。</p>\n<p>Channels 保留了 Django 的同步行为，并添加了一层异步协议，允许用户编写完全同步、异步或两者混合的视图（Views）。Django Channels 提供了一种通信系统，叫做 Channel Layer，它可以让多个 <code>Consumer</code> 实例之间互相通信，以及与外部 Django 程序实现互通。</p>\n<ul>\n<li>Channel Layer 主要包括两种抽象概念：Channel 和 Group。Channel 是一个发送消息的通道，每个 Channel 都有一个名称，拥有这个名称的人都可以往 Channel 里面发送消息。Group 是多个 Channel 的集合，每个 Group 都有一个名称，拥有这个名称的人都可以往这个 Group 里添加/删除 Channel，也可以往 Group 里发送消息。Group 内的所有 Channel 都可以收到，但是不能给 Group 内的具体某个 Channel 发送消息。使用 Django Channels 可以实现一些实时通讯的功能，如在线聊天室、游戏、通知等。</li>\n<li><code>Consumer</code> 是 Channels 的基本单位，相当于 Django 的视图，它是一个事件驱动的类，可以处理不同类型的事件，如连接、断开、接收消息等，支持同步和异步应用程序。</li>\n</ul>\n<p>现在我们来看一下 Django Channels 的样例，首先需要安装 Channels 和 Channels Redis：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install channels channels_redis</span><br></pre></td></tr></table></figure>\n<p>然后需要在你的项目设置中（<code>settings.py</code> 文件）配置 <code>CHANNEL_LAYERS</code> 需要添加 <code>channels</code> 到你的 <code>INSTALLED_APPS</code> 列表，并设置 <code>ASGI_APPLICATION</code> 和 <code>CHANNEL_LAYERS</code>。例如：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INSTALLED_APPS = [ </span><br><span class=\"line\">    <span class=\"string\">&#x27;channels&#x27;</span>,  <span class=\"comment\"># 添加此行</span></span><br><span class=\"line\">    <span class=\"string\">&#x27;game.apps.GameConfig&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\">ASGI_APPLICATION = <span class=\"string\">&#x27;djangoapp.asgi.application&#x27;</span>  <span class=\"comment\"># &#x27;djangoapp&#x27;为你的项目名</span></span><br><span class=\"line\"></span><br><span class=\"line\">CHANNEL_LAYERS = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;default&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;BACKEND&quot;</span>: <span class=\"string\">&quot;channels_redis.core.RedisChannelLayer&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CONFIG&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;hosts&quot;</span>: [(<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"number\">6379</span>)],</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在这个例子中，我们假设你正在本地运行一个 Redis 服务器，它监听在6379端口。如果你的 Redis 服务器在其他地方或者使用了不同的端口，你需要更新 <code>hosts</code> 设置。</p>\n<p>接下来你需要在 Django App 的目录下创建一个路由文件 <code>routing.py</code>，作用相当于 HTTP 的 <code>urls</code>，并在其中定义你的 WebSocket 路由。我们先创建出来：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"></span><br><span class=\"line\">websocket_urlpatterns = [</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>此外，你还需要运行一个兼容的 ASGI 服务器，如 Daphne 或 Uvicorn。我们安装 Daphne：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install daphne</span><br></pre></td></tr></table></figure>\n<p>输入 <code>daphne</code> 命令查看是否可用，如果不可用说明应该是没有配置环境变量，按如下方式修改环境变量（需要重启系统）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim /etc/environment</span><br><span class=\"line\">在 PATH=&#x27;xxx&#x27; 后面添加 &#x27;:/home/&lt;用户名&gt;/.local/bin&#x27;</span><br><span class=\"line\">即: &#x27;xxx:/home/&lt;用户名&gt;/.local/bin&#x27;</span><br></pre></td></tr></table></figure>\n<p>为了在 Django 项目中使用 Daphne，你需要确保你的项目已经配置为使用 ASGI 而不是 WSGI。这通常意味着你需要在你的项目中创建一个 <code>asgi.py</code> 文件，并在你的设置文件中设置 <code>ASGI_APPLICATION</code> 变量（之前已经设置好了）。</p>\n<p>现在我们配置 <code>djangoapp/djangoapp/asgi.py</code> 文件：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> channels.auth <span class=\"keyword\">import</span> AuthMiddlewareStack</span><br><span class=\"line\"><span class=\"keyword\">from</span> channels.routing <span class=\"keyword\">import</span> ProtocolTypeRouter, URLRouter</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.asgi <span class=\"keyword\">import</span> get_asgi_application</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.routing <span class=\"keyword\">import</span> websocket_urlpatterns</span><br><span class=\"line\"></span><br><span class=\"line\">os.environ.setdefault(<span class=\"string\">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class=\"string\">&#x27;djangoapp.settings&#x27;</span>)  <span class=\"comment\"># &#x27;djangoapp&#x27;为你的项目名</span></span><br><span class=\"line\"></span><br><span class=\"line\">application = ProtocolTypeRouter(&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;http&quot;</span>: get_asgi_application(),</span><br><span class=\"line\">    <span class=\"string\">&quot;websocket&quot;</span>: AuthMiddlewareStack(URLRouter(websocket_urlpatterns))</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>现在我们在 Django App 目录下创建 <code>consumers.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ChatConsumer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">connect</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        self.room_name = self.scope[<span class=\"string\">&#x27;url_route&#x27;</span>][<span class=\"string\">&#x27;kwargs&#x27;</span>][<span class=\"string\">&#x27;room_name&#x27;</span>]</span><br><span class=\"line\">        self.room_group_name = <span class=\"string\">&#x27;chat_%s&#x27;</span> % self.room_name</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 加入房间</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_add(</span><br><span class=\"line\">            self.room_group_name,</span><br><span class=\"line\">            self.channel_name</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.accept()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">disconnect</span>(<span class=\"params\">self, close_code</span>):</span><br><span class=\"line\">        <span class=\"comment\"># 离开房间</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_discard(</span><br><span class=\"line\">            self.room_group_name,</span><br><span class=\"line\">            self.channel_name</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 接收来自WebSocket的消息</span></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        text_data_json = json.loads(text_data)</span><br><span class=\"line\">        message = text_data_json[<span class=\"string\">&#x27;message&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 发送消息到房间组</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_send(</span><br><span class=\"line\">            self.room_group_name,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&#x27;type&#x27;</span>: <span class=\"string\">&#x27;chat_message&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;message&#x27;</span>: message</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 接收来自房间组的消息</span></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">chat_message</span>(<span class=\"params\">self, event</span>):</span><br><span class=\"line\">        message = event[<span class=\"string\">&#x27;message&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 发送消息到WebSocket</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.send(text_data=json.dumps(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;message&#x27;</span>: message</span><br><span class=\"line\">        &#125;))</span><br></pre></td></tr></table></figure>\n<p>在这个例子中，我们创建了一个 <code>ChatConsumer</code> 类，它是一个异步的 WebSocket Consumer，这个类继承自 <code>AsyncWebsocketConsumer</code>，这是 Django Channels 提供的一个基础类。</p>\n<p>其中的主要函数说明如下：</p>\n<ul>\n<li><code>async def connect(self)</code>：当一个 WebSocket 连接打开时，这个方法会被调用。在这个方法中，我们从 URL 路由中获取房间名，并将其保存在 <code>self.room_name</code> 中。然后，我们创建一个房间组名，并将其保存在 <code>self.room_group_name</code> 中。然后，我们将当前的 Channel 添加到房间组中。最后，我们接受 WebSocket 连接。</li>\n<li><code>async def disconnect(self, close_code)</code>：当一个 WebSocket 连接关闭时，这个方法会被调用。在这个方法中，我们将当前的 Channel 从房间组中移除。</li>\n<li><code>async def receive(self, text_data)</code>：当从 WebSocket 接收到消息时，这个方法会被调用。在这个方法中，我们首先将接收到的文本数据解析为 JSON，然后我们从 JSON 数据中获取消息，并将其发送到房间组中。</li>\n<li><code>async def chat_message(self, event)</code>：这是一个自定义的事件处理器方法，当从房间组接收到类型为 <code>chat_message</code> 的事件时，这个方法会被调用。在这个方法中，我们首先从事件中获取消息，然后我们将消息发送回 WebSocket。</li>\n</ul>\n<p>总的来说，这段代码的功能为：当用户连接到 WebSocket 时，他们会被添加到一个名为 <code>chat_&#123;room_name&#125;</code> 的组中。当他们发送消息时，这个消息会被广播到他们所在的组中的所有其他用户。当他们接收到组中的消息时，这个消息会被发送回他们的 WebSocket，即实现了一个简单的聊天室功能。</p>\n<p>最后我们定义一下 Consumer 的路由，以下代码将 URL 路径 <code>ws/chat/&#123;room_name&#125;/</code> 映射到我们的 <code>ChatConsumer</code>。这意味着当用户连接到这个路径的 WebSocket 时，他们会被连接到聊天室：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> re_path</span><br><span class=\"line\"><span class=\"keyword\">from</span> .consumers <span class=\"keyword\">import</span> ChatConsumer</span><br><span class=\"line\"></span><br><span class=\"line\">websocket_urlpatterns = [</span><br><span class=\"line\">    re_path(<span class=\"string\">r&#x27;ws/chat/(?P&lt;room_name&gt;\\w+)/$&#x27;</span>, ChatConsumer.as_asgi()),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/60606.html",
            "url": "https://asanosaki.github.io/posts/60606.html",
            "title": "Django使用SMTP发送邮件教程",
            "date_published": "2023-10-08T07:37:00.000Z",
            "content_html": "<blockquote>\n<p>介绍 Django 中如何使用 SMTP 协议发送邮件。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. SMTP介绍</h1>\n<p>SMTP（Simple Mail Transfer Protocol）即简单邮件传输协议，它是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式。SMTP 协议属于 TCP/IP 协议簇，它帮助每台计算机在发送或中转信件时找到下一个目的地。通过 SMTP 协议所指定的服务器，就可以把 E-mail 寄到收信人的服务器上了，整个过程只要几分钟。SMTP 服务器则是遵循 SMTP 协议的发送邮件服务器，用来发送或中转发出的电子邮件。</p>\n<p>一个 SMTP 服务器总是有一个独特的地址，和一个用于发送邮件的特定端口，在大多数情况下是587。本文以使用 QQ 邮箱为例，因此我们将使用的地址是 <code>smtp.qq.com</code>，端口号是587。</p>\n<h1>2. 申请邮箱授权码</h1>\n<p>首先我们需要启用 QQ 邮箱的 SMTP 服务，并申请一个授权码，打开邮箱网页，然后在“设置-账号”选项卡中找到 SMTP 服务部分，点击开启服务，然后完成相关的身份验证后会收到一串授权码。</p>\n<h1>3. Django发送邮件</h1>\n<p>首先在项目的 <code>settings.py</code> 文件中添加配置信息：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">EMAIL_BACKEND = <span class=\"string\">&#x27;django.core.mail.backends.smtp.EmailBackend&#x27;</span></span><br><span class=\"line\">EMAIL_HOST = <span class=\"string\">&#x27;smtp.qq.com&#x27;</span></span><br><span class=\"line\">EMAIL_PORT = <span class=\"number\">587</span></span><br><span class=\"line\">EMAIL_USE_TLS = <span class=\"literal\">True</span></span><br><span class=\"line\">EMAIL_HOST_USER = <span class=\"string\">&#x27;******@qq.com&#x27;</span></span><br><span class=\"line\">EMAIL_HOST_PASSWORD = <span class=\"string\">&#x27;******&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">RECIPIENT_ADDRESS = [<span class=\"string\">&#x27;******@qq.com&#x27;</span>]</span><br></pre></td></tr></table></figure>\n<p>配置参数说明如下：</p>\n<ul>\n<li><code>EMAIL_BACKEND</code>：声明了我们的 Django 项目将用于连接 SMTP 服务器的后端。这个变量指向 <code>smtp.EmailBackend</code> 类，该类接收发送邮件所需的所有参数。虽然这个类是默认的 <code>EMAIL_BACKEND</code>，但在 Django 的设置中明确定义被认为是一个好的做法。</li>\n<li><code>EMAIL_HOST</code>：将要使用的 SMTP 服务器域，取决于你的电子邮件提供商。常用的有：<code>smtp.qq.com</code>、<code>smtp.163.com</code>、<code>smtp.gmail.com</code> 等。</li>\n<li><code>EMAIL_PORT</code>：SMTP 服务器端口号，587是大多数 SMTP 服务器的默认端口，对于个人电子邮件提供商来说，这一点仍然适用。</li>\n<li><code>EMAIL_USE_TLS</code>：TLS（Transport Layer Security，传输层安全协议），用于在两个应用程序之间提供保密性和数据完整性。在此处用于加密网络应用程序（Django）和服务器（SMTP 服务器）之间的通信。</li>\n<li><code>EMAIL_HOST_USER</code>：主机用户（发件人邮箱），设置是你的个人电子邮件地址。</li>\n<li><code>EMAIL_HOST_PASSWORD</code>：发件人的授权码，即从你的电子邮件帐户获得的应用程序密码。</li>\n<li><code>RECIPIENT_ADDRESS</code>：收件人邮箱列表。</li>\n</ul>\n<p>现在假设我们的前端发来如下请求：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">    <span class=\"attr\">url</span>: <span class=\"string\">&#x27;http://localhost:8000/sendemail/&#x27;</span>,</span><br><span class=\"line\">    <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">    <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">message</span>: message,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">dataType</span>: <span class=\"string\">&#x27;json&#x27;</span>,</span><br><span class=\"line\">    <span class=\"attr\">success</span>: <span class=\"function\">(<span class=\"params\">resp</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>然后我们需要在后端接收 <code>message</code>，并将其通过邮件（<code>django.core.mail.send_mail</code> 函数）发送给自己（即 <code>settings</code> 中的 <code>EMAIL_HOST_USER</code> 为自己的邮箱，<code>RECIPIENT_ADDRESS</code> 列表中也仅有一个自己的邮箱）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core <span class=\"keyword\">import</span> mail</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.conf <span class=\"keyword\">import</span> settings</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">sendEmail</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    data = request.GET</span><br><span class=\"line\">    message = data.get(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>).strip()  <span class=\"comment\"># 如果没有的话返回空，且过滤掉空格</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> message:</span><br><span class=\"line\">        mail.send_mail(</span><br><span class=\"line\">            subject=<span class=\"string\">&#x27;在线计算器与编译器项目用户反馈&#x27;</span>,  <span class=\"comment\"># 题目</span></span><br><span class=\"line\">            message=message,  <span class=\"comment\"># 消息内容</span></span><br><span class=\"line\">            from_email=settings.EMAIL_HOST_USER,  <span class=\"comment\"># 发送者</span></span><br><span class=\"line\">            recipient_list=settings.RECIPIENT_ADDRESS,  <span class=\"comment\"># 接收者邮件列表</span></span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/54938.html",
            "url": "https://asanosaki.github.io/posts/54938.html",
            "title": "Django学习笔记-实现聊天系统",
            "date_published": "2023-10-04T07:08:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是通过 WebSocket 实现多人模式中的在线聊天系统。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 实现聊天系统前端界面</h1>\n<p>聊天系统整体可以分为两部分：输入框与历史记录。</p>\n<p>我们需要先修改一下之前代码中的一个小 BUG，当在一个窗口中按 Q 时，另一个窗口中点击鼠标左键也能攻击，因为按下按键的事件被所有窗口都捕捉到了，这是不合理的。</p>\n<p>我们之前监听的对象是 <code>window</code>，每个地图是一个 <code>canvas</code> 元素，因此我们可以绑定到 <code>canvas</code> 对象上。由于不是所有对象都能添加绑定事件的，因此我们还需要对 <code>canvas</code> 做一个修改，需要添加 <code>tabindex</code> 参数并将其聚焦后才能监听事件，首先在 <code>GameMap</code> 类中修改一下 <code>canvas</code> 对象：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">GameMap</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;  <span class=\"comment\">// 需要将AcGamePlayground传进来</span></span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();  <span class=\"comment\">// 调用基类构造函数，相当于将自己添加到了AC_GAME_OBJECTS中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$canvas</span> = $(<span class=\"string\">`&lt;canvas tabindex=0&gt;&lt;/canvas&gt;`</span>);  <span class=\"comment\">// 画布，用来渲染画面，tabindex=0表示能够监听事件</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">focus</span>();  <span class=\"comment\">// 聚焦后才能监听事件</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在 <code>Player</code> 类中修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span> &amp;&amp; outer.<span class=\"property\">fireball_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">70</span> &amp;&amp; outer.<span class=\"property\">blink_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// F键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;blink&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>聊天的前端界面需要创建一个新的文件，我们在 <code>~/djangoapp/game/static/js/src/playground</code> 目录下创建一个 <code>chat_field</code> 目录，并进入该目录创建 <code>zbase.js</code> 文件：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ChatField</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">func_id</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 在每次打开输入框时需要将之前历史记录框的计时函数删掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$history</span> = $(<span class=\"string\">`&lt;div class=&#x27;ac_game_chat_field_history&#x27;&gt;&lt;/div&gt;`</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$input</span> = $(<span class=\"string\">`&lt;input type=&#x27;text&#x27; class=&#x27;ac_game_chat_field_input&#x27;&gt;`</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$history</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$input</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$history</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$input</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$input</span>.<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;  <span class=\"comment\">// 输入框也需要监听ESC事件</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">27</span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"title function_\">hide_input</span>();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show_history</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$history</span>.<span class=\"title function_\">fadeIn</span>();  <span class=\"comment\">// 慢慢显示出来</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">func_id</span>) <span class=\"built_in\">clearTimeout</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">func_id</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">func_id</span> = <span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"property\">$history</span>.<span class=\"title function_\">fadeOut</span>();</span><br><span class=\"line\">            outer.<span class=\"property\">func_id</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;, <span class=\"number\">3000</span>);  <span class=\"comment\">// 显示3秒后消失</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show_input</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$input</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">show_history</span>();  <span class=\"comment\">// 打开输入框顺带打开历史记录</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$input</span>.<span class=\"title function_\">focus</span>();  <span class=\"comment\">// 聚焦一下才能输入</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide_input</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$input</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">focus</span>();  <span class=\"comment\">// 关闭输入框后要重新聚焦回Canvas上</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>AcGamePlayground</code> 类中创建出来：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\">mode</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 单人模式下创建AI敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;single mode&#x27;</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.07</span>, <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_random_color</span>(), <span class=\"number\">0.15</span>, <span class=\"string\">&#x27;robot&#x27;</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">MultiPlayerSocket</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span>.<span class=\"property\">uuid</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>[<span class=\"number\">0</span>].<span class=\"property\">uuid</span>;  <span class=\"comment\">// 用每名玩家的唯一编号区分不同的窗口</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">chat_field</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">ChatField</span>(<span class=\"variable language_\">this</span>);  <span class=\"comment\">// 聊天区</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span>.<span class=\"property\">ws</span>.<span class=\"property\">onopen</span> = <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"property\">mps</span>.<span class=\"title function_\">send_create_player</span>(outer.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">username</span>, outer.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">avatar</span>);</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在在 <code>Player</code> 类中即可监听事件：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">13</span> &amp;&amp; outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;  <span class=\"comment\">// 还没满人允许使用聊天功能</span></span><br><span class=\"line\">                outer.<span class=\"property\">playground</span>.<span class=\"property\">chat_field</span>.<span class=\"title function_\">show_input</span>();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">27</span> &amp;&amp; outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"property\">playground</span>.<span class=\"property\">chat_field</span>.<span class=\"title function_\">hide_input</span>();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span> &amp;&amp; outer.<span class=\"property\">fireball_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">70</span> &amp;&amp; outer.<span class=\"property\">blink_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// F键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;blink&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们还需要实现一下聊天区的 CSS 样式（在 <code>~/djangoapp/game/static/css</code> 目录的 <code>game.css</code> 文件中）：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_chat_field_history</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: absolute;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">40%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">15%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, <span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>:<span class=\"number\">30%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">77</span>, <span class=\"number\">77</span>, <span class=\"number\">77</span>, <span class=\"number\">0.2</span>);</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">1.5vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">padding</span>: <span class=\"number\">5px</span>;</span><br><span class=\"line\">    <span class=\"attribute\">overflow</span>: auto;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_chat_field_history</span>::-webkit-scrollbar &#123;  <span class=\"comment\">/* 滚动条 */</span></span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_chat_field_input</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: absolute;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">86%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">15%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, <span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">2vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">222</span>, <span class=\"number\">225</span>, <span class=\"number\">230</span>, <span class=\"number\">0.2</span>);</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">1.5vh</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在我们实现在历史记录区域里添加新消息的功能：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ChatField</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$input</span>.<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;  <span class=\"comment\">// 输入框也需要监听ESC事件</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">27</span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"title function_\">hide_input</span>();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">13</span>) &#123;  <span class=\"comment\">// 按Enter键时发送消息</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> username = outer.<span class=\"property\">playground</span>.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">username</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> text = outer.<span class=\"property\">$input</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">                outer.<span class=\"title function_\">hide_input</span>();  <span class=\"comment\">// 发送完消息后关闭输入框</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (text) &#123;  <span class=\"comment\">// 信息不为空才渲染出来</span></span><br><span class=\"line\">                    outer.<span class=\"property\">$input</span>.<span class=\"title function_\">val</span>(<span class=\"string\">&#x27;&#x27;</span>);  <span class=\"comment\">// 将输入框清空</span></span><br><span class=\"line\">                    outer.<span class=\"title function_\">add_message</span>(username, text);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render_message</span>(<span class=\"params\">message</span>) &#123;  <span class=\"comment\">// 渲染消息</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> $(<span class=\"string\">`&lt;div&gt;<span class=\"subst\">$&#123;message&#125;</span>&lt;/div&gt;`</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_message</span>(<span class=\"params\">username, text</span>) &#123;  <span class=\"comment\">// 向历史记录区里添加消息</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> message = <span class=\"string\">`[<span class=\"subst\">$&#123;username&#125;</span>] <span class=\"subst\">$&#123;text&#125;</span>`</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$history</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"title function_\">render_message</span>(message));</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">show_history</span>();  <span class=\"comment\">// 每次发新消息时都显示一下历史记录</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$history</span>.<span class=\"title function_\">scrollTop</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$history</span>[<span class=\"number\">0</span>].<span class=\"property\">scrollHeight</span>);  <span class=\"comment\">// 将滚动条移动到最底部</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>2. 实现后端同步函数</h1>\n<p>我们先在 WebSocket 前端实现发送和接收消息的函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"property\">onmessage</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> data = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(e.<span class=\"property\">data</span>);  <span class=\"comment\">// 将字符串变回JSON</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> uuid = data.<span class=\"property\">uuid</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (uuid === outer.<span class=\"property\">uuid</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 如果是给自己发送消息就直接过滤掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">let</span> event = data.<span class=\"property\">event</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;create_player&#x27;</span>) &#123;  <span class=\"comment\">// create_player路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_create_player</span>(uuid, data.<span class=\"property\">username</span>, data.<span class=\"property\">avatar</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;move_to&#x27;</span>) &#123;  <span class=\"comment\">// move_to路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_move_to</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;shoot_fireball&#x27;</span>) &#123;  <span class=\"comment\">// shoot_fireball路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_shoot_fireball</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>, data.<span class=\"property\">fireball_uuid</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;attack&#x27;</span>) &#123;  <span class=\"comment\">// attack路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_attack</span>(uuid, data.<span class=\"property\">attackee_uuid</span>, data.<span class=\"property\">x</span>, data.<span class=\"property\">y</span>, data.<span class=\"property\">theta</span>, data.<span class=\"property\">damage</span>, data.<span class=\"property\">fireball_uuid</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;blink&#x27;</span>) &#123;  <span class=\"comment\">// blink路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_blink</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;message&#x27;</span>) &#123;  <span class=\"comment\">// message路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_message</span>(data.<span class=\"property\">username</span>, data.<span class=\"property\">text</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_message</span>(<span class=\"params\">username, text</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;message&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: outer.<span class=\"property\">uuid</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;username&#x27;</span>: username,</span><br><span class=\"line\">            <span class=\"string\">&#x27;text&#x27;</span>: text,</span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_message</span>(<span class=\"params\">username, text</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">chat_field</span>.<span class=\"title function_\">add_message</span>(username, text);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后实现后端代码：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.conf <span class=\"keyword\">import</span> settings</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">message</span>(<span class=\"params\">self, data</span>):</span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_send(</span><br><span class=\"line\">            self.room_name,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&#x27;type&#x27;</span>: <span class=\"string\">&#x27;group_send_event&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;message&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;uuid&#x27;</span>: data[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;username&#x27;</span>: data[<span class=\"string\">&#x27;username&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;text&#x27;</span>: data[<span class=\"string\">&#x27;text&#x27;</span>],</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        data = json.loads(text_data)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br><span class=\"line\"></span><br><span class=\"line\">        event = data[<span class=\"string\">&#x27;event&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> event == <span class=\"string\">&#x27;create_player&#x27;</span>:  <span class=\"comment\"># 做一个路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.create_player(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;move_to&#x27;</span>:  <span class=\"comment\"># move_to的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.move_to(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;shoot_fireball&#x27;</span>:  <span class=\"comment\"># shoot_fireball的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.shoot_fireball(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;attack&#x27;</span>:  <span class=\"comment\"># attack的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.attack(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;blink&#x27;</span>:  <span class=\"comment\"># blink的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.blink(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;message&#x27;</span>:  <span class=\"comment\"># message的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.message(data)</span><br></pre></td></tr></table></figure>\n<p>最后在前端的 <code>ChatField</code> 类中调用一下发送消息的函数即可：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ChatField</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$input</span>.<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;  <span class=\"comment\">// 输入框也需要监听ESC事件</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">27</span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"title function_\">hide_input</span>();</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">13</span>) &#123;  <span class=\"comment\">// 按Enter键时发送消息</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> username = outer.<span class=\"property\">playground</span>.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">username</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> text = outer.<span class=\"property\">$input</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">                outer.<span class=\"title function_\">hide_input</span>();  <span class=\"comment\">// 发送完消息后关闭输入框</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (text) &#123;  <span class=\"comment\">// 信息不为空才渲染出来</span></span><br><span class=\"line\">                    outer.<span class=\"property\">$input</span>.<span class=\"title function_\">val</span>(<span class=\"string\">&#x27;&#x27;</span>);  <span class=\"comment\">// 将输入框清空</span></span><br><span class=\"line\">                    outer.<span class=\"title function_\">add_message</span>(username, text);</span><br><span class=\"line\"></span><br><span class=\"line\">                    outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_message</span>(username, text);  <span class=\"comment\">// 给其他玩家的窗口发送消息</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上一章：<a href=\"/posts/60167.html\">Django学习笔记-实现联机对战（下）</a>。</p>\n<p>下一章：无。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/65222.html",
            "url": "https://asanosaki.github.io/posts/65222.html",
            "title": "Django、Nginx、uWSGI详解及配置示例",
            "date_published": "2023-10-03T02:25:00.000Z",
            "content_html": "<blockquote>\n<p>介绍 Django、Nginx 以及 uWSGI 三者的概念及其联系与区别，并讲解如何配置。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>一、Django、Nginx、uWSGI的概念、联系与区别</h1>\n<p>Django、Nginx 和 uWSGI 都是用于构建和运行 Web 应用程序的软件，这三个软件的概念如下：</p>\n<ul>\n<li>Django：Django 是一个基于 Python 的开源 Web 框架，它提供了一套完整的工具和组件，可以帮助开发人员快速构建 Web 应用程序。Django 遵循了 MVC（模型-视图-控制器）的设计模式，将业务逻辑、数据模型和用户界面分离，提高了代码的可读性和可维护性。Django 还支持多种数据库、缓存、模板引擎、表单验证、国际化、安全性等特性，使得开发者可以专注于业务需求，而不用担心底层的细节。Django 框架主要负责处理业务逻辑和生成结果给 Web 服务器，再由 Web 服务器返回给浏览器。而 Web 框架和 Web 服务器之间的通信需要遵循一套<strong>规范</strong>，这个规范就是 WSGI。</li>\n<li>Nginx：Nginx 是一个高性能的 HTTP 和<strong>反向代理</strong> Web 服务器，它可以处理来自客户端（例如浏览器）的 HTTP 请求，并将其转发给后端的 Web 应用程序或其他服务器。Nginx 具有高并发、低内存占用、负载均衡、静态文件缓存等优点，可以提高 Web 应用程序的响应速度和可靠性。如果你有多个 Web 服务器，你可以使用 Nginx 来做<strong>负载均衡</strong>，根据某些规则将不同的请求分发到不同的 Web 服务器上去。</li>\n<li>uWSGI：uWSGI 是一个实现了 WSGI 协议、uwsgi 协议和 HTTP 协议的 Web 服务器接口，它可以在 Web 服务器和 Web 应用程序之间提供接口，使得它们可以相互通信。WSGI（Web Server Gateway Interface）是一种 Python 用于 Web 开发的标准接口，它定义了 Web 服务器如何调用 Web 应用程序，并将结果返回给客户端，在生产环境中使用 WSGI 作为 Python Web 的服务器。uwsgi 是 uWSGI 程序实现的一个私有协议，它采用二进制格式传输数据，比 HTTP 协议更高效。uWSGI 是一个<strong>应用</strong>服务器，它可以将客户端请求转发给 Django 等 Web 应用程序进行处理。</li>\n</ul>\n<p>Django、Nginx、uWSGI 之间的联系和区别主要体现在以下几个方面：</p>\n<ul>\n<li>角色：Django 是一个 Web 框架，负责处理业务逻辑和生成响应内容；Nginx 是一个 Web 服务器，负责接收和转发 HTTP 请求；uWSGI 是一个 Web 服务器接口，负责将 HTTP 请求转换为 WSGI 请求，并调用 Django 处理。</li>\n<li>协议：Django 遵循 WSGI 协议，与 uWSGI 进行通信；Nginx 遵循 HTTP 协议，与客户端和 uWSGI 进行通信；uWSGI 支持多种协议，包括 HTTP、uwsgi 和 WSGI。</li>\n<li>性能：Django 本身不是一个高性能的 Web 框架，它需要借助其他软件来提高效率；Nginx 是一个高性能的 Web 服务器，它可以处理大量的并发请求，并缓存静态文件；uWSGI 是一个高效的 Web 服务器接口，它可以利用 uwsgi 协议减少数据传输的开销。</li>\n<li>配置：Django 需要在 <code>settings.py</code> 文件中配置数据库、中间件、应用等信息；Nginx 需要在 <code>nginx.conf</code> 文件中配置监听端口、反向代理规则、静态文件路径等信息；uWSGI 需要在 <code>uwsgi.ini</code> 文件中配置项目路径、端口号、进程数等信息。</li>\n</ul>\n<p>总结一下：</p>\n<ul>\n<li>Nginx：HTTP 服务器，反向代理服务器。</li>\n<li>uWSGI：应用服务器，或者更精确地说是 WSGI 应用容器。</li>\n<li>Django：WSGI 应用程序（框架）。</li>\n</ul>\n<h1>二、Nginx正向代理和反向代理的区别</h1>\n<p>正向代理和反向代理是两种不同的代理模式，它们的区别主要在于代理的对象和目的不同：</p>\n<ul>\n<li>正向代理：指客户端（如浏览器）<strong>通过</strong>代理服务器来访问目标服务器，目的是为了隐藏客户端的真实身份或者突破访问限制。正向代理的特点是客户端知道目标服务器的地址，而目标服务器不知道客户端的地址。例如，如果你想访问某个国外的网站，但是由于网络封锁或者速度慢，你可以通过一个正向代理服务器来转发你的请求，这样就可以提高访问效率或者绕过限制。</li>\n<li>反向代理：指客户端（如浏览器）<strong>直接</strong>访问代理服务器，然后代理服务器再转发请求给目标服务器，目的是为了提高目标服务器的性能或者安全性。反向代理的特点是客户端不知道目标服务器的地址，而目标服务器知道代理服务器的地址。例如，如果你想访问某个网站，但是这个网站有多台后端服务器提供服务，你可以通过一个反向代理服务器来分发你的请求，这样就可以实现负载均衡或者缓存等功能。</li>\n</ul>\n<p>总之，正向代理和反向代理的区别就是看你是站在客户端的角度还是目标服务器的角度。正向代理是为了满足客户端的需求，而反向代理是为了满足目标服务器的需求。</p>\n<h1>三、Nginx与uWSGI的配置文件示例</h1>\n<p>要在 Django 应用程序中使用 Nginx 和 uWSGI，你需要做以下几个步骤：</p>\n<ul>\n<li>安装 Nginx 和 uWSGI，你可以使用 <code>apt</code> 或 <code>pip</code> 命令来安装它们：</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install curl gnupg2 ca-certificates lsb-release ubuntu-keyring  # 安装Nginx依赖包</span><br><span class=\"line\">apt-get update</span><br><span class=\"line\">apt-get install nginx  # 安装Nginx</span><br><span class=\"line\">nginx -v  # 查看版本号</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl start nginx  # 启动Nginx</span><br><span class=\"line\">systemctl status nginx  # 查看运行状态</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">如果systemctl指令报错可以使用service指令启动</span></span><br><span class=\"line\">service nginx start</span><br><span class=\"line\">service nginx status</span><br><span class=\"line\"></span><br><span class=\"line\">pip install uwsgi  # 安装uWSGI</span><br><span class=\"line\"></span><br><span class=\"line\">sudo /etc/init.d/nginx start  # 启动Nginx服务</span><br><span class=\"line\">uwsgi --ini scripts/uwsgi.ini  # 启动uWSGI服务（假设配置文件在scripts目录下）</span><br></pre></td></tr></table></figure>\n<ul>\n<li>配置 uWSGI，你需要创建一个 <code>ini</code> 文件，指定你的项目目录、模块、端口、进程、日志等信息。</li>\n<li>配置 Nginx，你需要创建一个 <code>conf</code> 文件，指定你的监听端口、服务器名、静态文件路径、反向代理规则等信息。</li>\n<li>启动 uWSGI 和 Nginx，你可以使用 <code>systemctl/service</code> 或 <code>uwsgi</code> 命令来启动它们。</li>\n</ul>\n<p>Nginx 配置文件的位置一般是在 <code>/etc/nginx/nginx.conf</code>，它用来定义 Nginx 服务器的基本参数。Nginx 配置文件的语法格式是由多个块组成，每个块用花括号 <code>&#123;&#125;</code> 包围，每个指令用分号 <code>;</code> 结束。例如，一个简单的 Nginx 配置文件可以写成这样：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user www-data;</span><br><span class=\"line\">worker_processes auto;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\">include /etc/nginx/modules-enabled/*.conf;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections 768;</span><br><span class=\"line\">    # multi_accept on;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    sendfile on;</span><br><span class=\"line\">    tcp_nopush on;</span><br><span class=\"line\">    tcp_nodelay on;</span><br><span class=\"line\">    keepalive_timeout 65;</span><br><span class=\"line\">    types_hash_max_size 2048;</span><br><span class=\"line\"></span><br><span class=\"line\">    include /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE</span><br><span class=\"line\">    ssl_prefer_server_ciphers on;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log /var/log/nginx/access.log;</span><br><span class=\"line\">    error_log /var/log/nginx/error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">    gzip on;</span><br><span class=\"line\"></span><br><span class=\"line\">    include /etc/nginx/conf.d/*.conf;</span><br><span class=\"line\">    include /etc/nginx/sites-enabled/*;</span><br><span class=\"line\"></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">         listen 80;  # 监听80端口，作为默认服务器</span><br><span class=\"line\">         server_name app4007.acapp.acwing.com.cn;  # 服务器名，可以是域名或IP地址</span><br><span class=\"line\">         rewrite ^(.*)$ https://$&#123;server_name&#125;$1 permanent;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 443 ssl;  # 将80端口的HTTP请求重定向到443端口的HTTPS请求，提高安全性，使用SSL证书和协议来保证HTTPS请求的加密和验证</span><br><span class=\"line\">        server_name app4007.acapp.acwing.com.cn;</span><br><span class=\"line\">        ssl_certificate   cert/acapp.pem;</span><br><span class=\"line\">        ssl_certificate_key  cert/acapp.key;</span><br><span class=\"line\">        ssl_session_timeout 5m;</span><br><span class=\"line\">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\">        charset utf-8;</span><br><span class=\"line\">        access_log /var/log/nginx/access.log;</span><br><span class=\"line\">        error_log /var/log/nginx/error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">        client_max_body_size 10M;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;  # 匹配所有请求路径</span><br><span class=\"line\">            include /etc/nginx/uwsgi_params;  # 包含uWSGI的请求参数</span><br><span class=\"line\">            uwsgi_pass 127.0.0.1:8000;  # 转发请求给uWSGI服务器，由Django应用程序处理</span><br><span class=\"line\">            uwsgi_read_timeout 60;  # 设置uWSGI的读取超时时间</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        location /static &#123;  # 匹配以&#x27;/static&#x27;开头的请求路径，将以&#x27;/static&#x27;开头的请求直接返回静态文件内容，提高效率</span><br><span class=\"line\">            alias /home/asanosaki/djangoapp/static/;  # 指定静态文件存放的目录</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        location /wss &#123;  # 匹配以&#x27;/wss&#x27;开头的请求路径，将以&#x27;/wss&#x27;开头的请求转发给WebSocket服务器，实现双向通信</span><br><span class=\"line\">            proxy_pass http://127.0.0.1:5015;</span><br><span class=\"line\">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">            proxy_set_header Host $http_host;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\"></span><br><span class=\"line\">            proxy_http_version 1.1;</span><br><span class=\"line\">            proxy_set_header Upgrade $http_upgrade;</span><br><span class=\"line\">            proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>uWSGI 配置文件的位置可以自己指定，一般放在项目目录下，假设我们在项目根目录下的 <code>scripts/uwsgi.ini</code> 文件中。uWSGI 配置文件的语法格式是由多个节组成，每个节用方括号 <code>[]</code> 包围，每个指令用等号 <code>=</code> 赋值。例如，一个简单的 uWSGI 配置文件可以写成这样：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[uwsgi]</span><br><span class=\"line\">socket = 127.0.0.1:8000  # 用于和Nginx进行数据交互的端口</span><br><span class=\"line\">chdir = /home/asanosaki/djangoapp  # Django项目的根目录，使用绝对路径</span><br><span class=\"line\">wsgi-file = djangoapp/wsgi.py  # wsgi.py在Django项目中的位置</span><br><span class=\"line\">master = true  # 启动主进程，来管理其他进程</span><br><span class=\"line\">processes = 2  # 最大开启的进程数</span><br><span class=\"line\">threads = 5  # 每个进程的线程数</span><br><span class=\"line\">vacuum = true  # 当服务器退出的时候自动删除unix socket文件和pid文件，避免在下次启动服务器时出现文件冲突或占用的问题</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/60167.html",
            "url": "https://asanosaki.github.io/posts/60167.html",
            "title": "Django学习笔记-实现联机对战（下）",
            "date_published": "2023-09-25T12:19:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是通过 Django Channels 框架使用 WebSocket 协议实现多人模式中的同步移动，攻击以及被击中判定函数。<br>\n此外实现房间内玩家数提示板、技能冷却时间以及闪现技能。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 编写移动同步函数move_to</h1>\n<p>与上一章中的 <code>create_player</code> 同步函数相似，移动函数的同步也需要在前端实现 <code>send_move_to</code> 和 <code>receive_move_to</code> 函数。我们修改 <code>MultiPlayerSocket</code> 类（在目录 <code>~/djangoapp/game/static/js/src/playground/socket/multiplayer</code> 中）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">WebSocket</span>(<span class=\"string\">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">receive</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"property\">onmessage</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> data = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(e.<span class=\"property\">data</span>);  <span class=\"comment\">// 将字符串变回JSON</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> uuid = data.<span class=\"property\">uuid</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (uuid === outer.<span class=\"property\">uuid</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 如果是给自己发送消息就直接过滤掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">let</span> event = data.<span class=\"property\">event</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;create_player&#x27;</span>) &#123;  <span class=\"comment\">// create_player路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_create_player</span>(uuid, data.<span class=\"property\">username</span>, data.<span class=\"property\">avatar</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;move_to&#x27;</span>) &#123;  <span class=\"comment\">// move_to路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_move_to</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_create_player</span>(<span class=\"params\">username, avatar</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_create_player</span>(<span class=\"params\">uuid, username, avatar</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 根据uuid找到对应的Player</span></span><br><span class=\"line\">    <span class=\"title function_\">get_player</span>(<span class=\"params\">uuid</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> players = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; players.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> player = players[i];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (player.<span class=\"property\">uuid</span> === uuid)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> player;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;move_to&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: outer.<span class=\"property\">uuid</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;tx&#x27;</span>: tx,</span><br><span class=\"line\">            <span class=\"string\">&#x27;ty&#x27;</span>: ty,</span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_move_to</span>(<span class=\"params\">uuid, tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> player = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_player</span>(uuid);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (player) &#123;  <span class=\"comment\">// 确保玩家存在再调用move_to函数</span></span><br><span class=\"line\">            player.<span class=\"title function_\">move_to</span>(tx, ty);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后修改一下后端通信代码（<code>~/djangoapp/game/consumers/multiplayer</code> 目录中的 <code>index.py</code> 文件）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.conf <span class=\"keyword\">import</span> settings</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">connect</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">disconnect</span>(<span class=\"params\">self, close_code</span>):</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">create_player</span>(<span class=\"params\">self, data</span>):  <span class=\"comment\"># async表示异步函数</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">group_send_event</span>(<span class=\"params\">self, data</span>):  <span class=\"comment\"># 组内的每个连接接收到消息后直接发给前端即可</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.send(text_data=json.dumps(data))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">move_to</span>(<span class=\"params\">self, data</span>):  <span class=\"comment\"># 与create_player函数相似</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_send(</span><br><span class=\"line\">            self.room_name,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&#x27;type&#x27;</span>: <span class=\"string\">&#x27;group_send_event&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;move_to&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;uuid&#x27;</span>: data[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;tx&#x27;</span>: data[<span class=\"string\">&#x27;tx&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;ty&#x27;</span>: data[<span class=\"string\">&#x27;ty&#x27;</span>],</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        data = json.loads(text_data)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br><span class=\"line\"></span><br><span class=\"line\">        event = data[<span class=\"string\">&#x27;event&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> event == <span class=\"string\">&#x27;create_player&#x27;</span>:  <span class=\"comment\"># 做一个路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.create_player(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;move_to&#x27;</span>:  <span class=\"comment\"># move_to的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.move_to(data)</span><br></pre></td></tr></table></figure>\n<p>最后我们还需要调用函数，首先我们需要在 <code>AcGamePlayground</code> 类中记录下游戏模式 <code>mode</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\">mode</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">mode</span> = mode;  <span class=\"comment\">// 需要将模式记录下来，之后玩家在不同的模式中需要调用不同的函数</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">resize</span>();  <span class=\"comment\">// 界面打开后需要resize一次，需要将game_map也resize</span></span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>Player</code> 类中进行修改，当为多人模式时，需要广播发送 <code>move_to</code> 信号：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> rect = outer.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"title function_\">getBoundingClientRect</span>();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = (e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                outer.<span class=\"title function_\">move_to</span>(tx, ty);  <span class=\"comment\">// e.clientX/Y为鼠标点击坐标</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_move_to</span>(tx, ty);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                ...</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在即可实现多名玩家的同步移动。当 A 窗口中的玩家移动时，首先该窗口（<code>Player</code> 类）的监听函数会控制该玩家自身进行移动，接着判定为多人模式，因此再调用 <code>MultiPlayerSocket</code> 类中的 <code>send_move_to</code> 函数向服务器发送信息（通过 <code>WebSocket</code> 向服务器发送一个事件），接着服务器端（<code>~/djangoapp/game/consumers/multiplayer/index.py</code> 文件中）的 <code>receive</code> 函数会接收到信息，发现事件 <code>event</code> 为 <code>move_to</code>，就会调用 <code>move_to</code> 函数，该函数会向这个房间中的其他所有玩家群发消息，每个窗口都会在前端（<code>MultiPlayerSocket</code> 类中）的 <code>receive</code> 函数接收到信息，通过事件路由到 <code>receive_move_to</code> 函数，该函数就会通过 <code>uuid</code> 调用每名玩家的 <code>move_to</code> 函数。</p>\n<h1>2. 编写攻击同步函数shoot_fireball</h1>\n<p>由于发射的火球是会消失的，因此需要先将每名玩家发射的火球存下来，此外我们实现一个根据火球的 <code>uuid</code> 删除火球的函数，在 <code>Player</code> 类中进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, character, username, avatar</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">fire_balls</span> = [];  <span class=\"comment\">// 存下玩家发射的火球</span></span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 向(tx, ty)位置发射火球</span></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, y = <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> radius = <span class=\"number\">0.01</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"title function_\">atan2</span>(ty - <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, tx - <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> vx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta), vy = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> color = <span class=\"string\">&#x27;orange&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> speed = <span class=\"number\">0.5</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> move_length = <span class=\"number\">0.8</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> fire_ball = <span class=\"keyword\">new</span> <span class=\"title class_\">FireBall</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>, <span class=\"variable language_\">this</span>, x, y, radius, vx, vy, color, speed, move_length, <span class=\"number\">0.01</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">fire_balls</span>.<span class=\"title function_\">push</span>(fire_ball);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> fire_ball;  <span class=\"comment\">// 返回fire_ball是为了获取自己创建这个火球的uuid</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">destroy_fireball</span>(<span class=\"params\">uuid</span>) &#123;  <span class=\"comment\">// 删除火球</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">fire_balls</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> fire_ball = <span class=\"variable language_\">this</span>.<span class=\"property\">fire_balls</span>[i];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (fire_ball.<span class=\"property\">uuid</span> === uuid) &#123;</span><br><span class=\"line\">                fire_ball.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>由于火球在 <code>Player</code> 中存了一份，因此我们在删除火球前需要将它从 <code>Player</code> 的 <code>fire_balls</code> 中删掉。且由于 <code>FireBall</code> 类中的 <code>update</code> 函数过于臃肿，可以先将其分成 <code>update_move</code> 以及 <code>update_attack</code>，我们修改 <code>FireBall</code> 类：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FireBall</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 火球需要标记是哪个玩家发射的，且射出后的速度方向与大小是固定的，射程为move_length</span></span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, player, x, y, radius, vx, vy, color, speed, move_length, damage</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update_move</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> true_move = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> * true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> * true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> -= true_move;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update_attack</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 攻击碰撞检测</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> player = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>[i];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (player !== <span class=\"variable language_\">this</span>.<span class=\"property\">player</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"title function_\">is_collision</span>(player)) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"title function_\">attack</span>(player);  <span class=\"comment\">// this攻击player</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_move</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_attack</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_collision</span>(<span class=\"params\">player</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">attack</span>(<span class=\"params\">player</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">on_destroy</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> fire_balls = <span class=\"variable language_\">this</span>.<span class=\"property\">player</span>.<span class=\"property\">fire_balls</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; fire_balls.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (fire_balls[i] === <span class=\"variable language_\">this</span>) &#123;</span><br><span class=\"line\">                fire_balls.<span class=\"title function_\">splice</span>(i, <span class=\"number\">1</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们在 <code>MultiPlayerSocket</code> 类中实现 <code>send_shoot_fireball</code> 和 <code>receive_shoot_fireball</code> 函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"property\">onmessage</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> data = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(e.<span class=\"property\">data</span>);  <span class=\"comment\">// 将字符串变回JSON</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> uuid = data.<span class=\"property\">uuid</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (uuid === outer.<span class=\"property\">uuid</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 如果是给自己发送消息就直接过滤掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">let</span> event = data.<span class=\"property\">event</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;create_player&#x27;</span>) &#123;  <span class=\"comment\">// create_player路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_create_player</span>(uuid, data.<span class=\"property\">username</span>, data.<span class=\"property\">avatar</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;move_to&#x27;</span>) &#123;  <span class=\"comment\">// move_to路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_move_to</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;shoot_fireball&#x27;</span>) &#123;  <span class=\"comment\">// shoot_fireball路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_shoot_fireball</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>, data.<span class=\"property\">fireball_uuid</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_shoot_fireball</span>(<span class=\"params\">tx, ty, fireball_uuid</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;shoot_fireball&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: outer.<span class=\"property\">uuid</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;tx&#x27;</span>: tx,</span><br><span class=\"line\">            <span class=\"string\">&#x27;ty&#x27;</span>: ty,</span><br><span class=\"line\">            <span class=\"string\">&#x27;fireball_uuid&#x27;</span>: fireball_uuid,</span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_shoot_fireball</span>(<span class=\"params\">uuid, tx, ty, fireball_uuid</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> player = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_player</span>(uuid);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (player) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> fire_ball = player.<span class=\"title function_\">shoot_fireball</span>(tx, ty);</span><br><span class=\"line\">            fire_ball.<span class=\"property\">uuid</span> = fireball_uuid;  <span class=\"comment\">// 所有窗口同一个火球的uuid需要统一</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在我们需要实现后端函数：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.conf <span class=\"keyword\">import</span> settings</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">self, data</span>):</span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_send(</span><br><span class=\"line\">            self.room_name,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&#x27;type&#x27;</span>: <span class=\"string\">&#x27;group_send_event&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;shoot_fireball&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;uuid&#x27;</span>: data[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;tx&#x27;</span>: data[<span class=\"string\">&#x27;tx&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;ty&#x27;</span>: data[<span class=\"string\">&#x27;ty&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;fireball_uuid&#x27;</span>: data[<span class=\"string\">&#x27;fireball_uuid&#x27;</span>],</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        data = json.loads(text_data)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br><span class=\"line\"></span><br><span class=\"line\">        event = data[<span class=\"string\">&#x27;event&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> event == <span class=\"string\">&#x27;create_player&#x27;</span>:  <span class=\"comment\"># 做一个路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.create_player(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;move_to&#x27;</span>:  <span class=\"comment\"># move_to的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.move_to(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;shoot_fireball&#x27;</span>:  <span class=\"comment\"># shoot_fireball的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.shoot_fireball(data)</span><br></pre></td></tr></table></figure>\n<p>最后是在 <code>Player</code> 类中调用函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, character, username, avatar</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> rect = outer.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"title function_\">getBoundingClientRect</span>();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                ...</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = (e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;fireball&#x27;</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">let</span> fire_ball = outer.<span class=\"title function_\">shoot_fireball</span>(tx, ty);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                        outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_shoot_fireball</span>(tx, ty, fire_ball.<span class=\"property\">uuid</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 释放完一次技能后还原</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 向(tx, ty)位置发射火球</span></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">destroy_fireball</span>(<span class=\"params\">uuid</span>) &#123;  <span class=\"comment\">// 删除火球</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_attacked</span>(<span class=\"params\">theta, damage</span>) &#123;  <span class=\"comment\">// 被攻击到</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 更新移动</span></span><br><span class=\"line\">    <span class=\"title function_\">update_move</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">on_destroy</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>[i] === <span class=\"variable language_\">this</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"title function_\">splice</span>(i, <span class=\"number\">1</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>3. 编写击中判定同步函数attack</h1>\n<p>我们需要统一攻击这个动作，由一个窗口来唯一判断是否击中，若击中则广播给其他窗口，因此窗口中看到其他玩家发射的火球仅为动画，不应该有击中判定。我们先在 <code>FireBall</code> 类中进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FireBall</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_move</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">player</span>.<span class=\"property\">character</span> !== <span class=\"string\">&#x27;enemy&#x27;</span>) &#123;  <span class=\"comment\">// 在敌人的窗口中不进行攻击检测</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_attack</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>每名玩家还需要有一个函数 <code>receive_attack</code> 表示接收到被攻击的信息：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">destroy_fireball</span>(<span class=\"params\">uuid</span>) &#123;  <span class=\"comment\">// 删除火球</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">fire_balls</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> fire_ball = <span class=\"variable language_\">this</span>.<span class=\"property\">fire_balls</span>[i];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (fire_ball.<span class=\"property\">uuid</span> === uuid) &#123;</span><br><span class=\"line\">                fire_ball.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_attacked</span>(<span class=\"params\">theta, damage</span>) &#123;  <span class=\"comment\">// 被攻击到</span></span><br><span class=\"line\">        <span class=\"comment\">// 创建粒子效果</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span> + <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">5</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> x = <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, y = <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> radius = <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">0.2</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>();</span><br><span class=\"line\">            <span class=\"keyword\">let</span> vx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta), vy = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">            <span class=\"keyword\">let</span> color = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> speed = <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"number\">10</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> move_length = <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">10</span>;</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">Particle</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>, x, y, radius, vx, vy, color, speed, move_length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> -= damage;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> *= <span class=\"number\">1.08</span>;  <span class=\"comment\">// 血量越少移动越快</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// 半径小于eps认为已死</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vx</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vy</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> = damage * <span class=\"number\">90</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_attack</span>(<span class=\"params\">x, y, theta, damage, fireball_uuid, attacker</span>) &#123;  <span class=\"comment\">// 接收被攻击到的消息</span></span><br><span class=\"line\">        attacker.<span class=\"title function_\">destroy_fireball</span>(fireball_uuid);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> = x;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> = y;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">is_attacked</span>(theta, damage);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们假设发射火球的玩家为 <code>attacker</code>，被击中的玩家为 <code>attackee</code>，被击中者的位置也是由攻击者的窗口决定的，且火球在击中其他玩家后在其他玩家的窗口也应该消失，因此还需要传火球的 <code>uuid</code>。我们在 <code>MultiPlayerSocket</code> 类中实现 <code>send_attack</code> 与 <code>receive_attack</code> 函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"property\">onmessage</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> data = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(e.<span class=\"property\">data</span>);  <span class=\"comment\">// 将字符串变回JSON</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> uuid = data.<span class=\"property\">uuid</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (uuid === outer.<span class=\"property\">uuid</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 如果是给自己发送消息就直接过滤掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">let</span> event = data.<span class=\"property\">event</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;create_player&#x27;</span>) &#123;  <span class=\"comment\">// create_player路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_create_player</span>(uuid, data.<span class=\"property\">username</span>, data.<span class=\"property\">avatar</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;move_to&#x27;</span>) &#123;  <span class=\"comment\">// move_to路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_move_to</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;shoot_fireball&#x27;</span>) &#123;  <span class=\"comment\">// shoot_fireball路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_shoot_fireball</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>, data.<span class=\"property\">fireball_uuid</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;attack&#x27;</span>) &#123;  <span class=\"comment\">// attack路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_attack</span>(uuid, data.<span class=\"property\">attackee_uuid</span>, data.<span class=\"property\">x</span>, data.<span class=\"property\">y</span>, data.<span class=\"property\">theta</span>, data.<span class=\"property\">damage</span>, data.<span class=\"property\">fireball_uuid</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_attack</span>(<span class=\"params\">attackee_uuid, x, y, theta, damage, fireball_uuid</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;attack&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: outer.<span class=\"property\">uuid</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;attackee_uuid&#x27;</span>: attackee_uuid,</span><br><span class=\"line\">            <span class=\"string\">&#x27;x&#x27;</span>: x,</span><br><span class=\"line\">            <span class=\"string\">&#x27;y&#x27;</span>: y,</span><br><span class=\"line\">            <span class=\"string\">&#x27;theta&#x27;</span>: theta,</span><br><span class=\"line\">            <span class=\"string\">&#x27;damage&#x27;</span>: damage,</span><br><span class=\"line\">            <span class=\"string\">&#x27;fireball_uuid&#x27;</span>: fireball_uuid,</span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_attack</span>(<span class=\"params\">uuid, attackee_uuid, x, y, theta, damage, fireball_uuid</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> attacker = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_player</span>(uuid);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> attackee = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_player</span>(attackee_uuid);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (attacker &amp;&amp; attackee) &#123;  <span class=\"comment\">// 如果攻击者和被攻击者都还存在就判定攻击</span></span><br><span class=\"line\">            attackee.<span class=\"title function_\">receive_attack</span>(x, y, theta, damage, fireball_uuid, attacker);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后实现后端函数如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.conf <span class=\"keyword\">import</span> settings</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">attack</span>(<span class=\"params\">self, data</span>):</span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_send(</span><br><span class=\"line\">            self.room_name,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&#x27;type&#x27;</span>: <span class=\"string\">&#x27;group_send_event&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;attack&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;uuid&#x27;</span>: data[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;attackee_uuid&#x27;</span>: data[<span class=\"string\">&#x27;attackee_uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;x&#x27;</span>: data[<span class=\"string\">&#x27;x&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;y&#x27;</span>: data[<span class=\"string\">&#x27;y&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;theta&#x27;</span>: data[<span class=\"string\">&#x27;theta&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;damage&#x27;</span>: data[<span class=\"string\">&#x27;damage&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;fireball_uuid&#x27;</span>: data[<span class=\"string\">&#x27;fireball_uuid&#x27;</span>],</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        data = json.loads(text_data)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br><span class=\"line\"></span><br><span class=\"line\">        event = data[<span class=\"string\">&#x27;event&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> event == <span class=\"string\">&#x27;create_player&#x27;</span>:  <span class=\"comment\"># 做一个路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.create_player(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;move_to&#x27;</span>:  <span class=\"comment\"># move_to的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.move_to(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;shoot_fireball&#x27;</span>:  <span class=\"comment\"># shoot_fireball的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.shoot_fireball(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;attack&#x27;</span>:  <span class=\"comment\"># attack的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.attack(data)</span><br></pre></td></tr></table></figure>\n<p>最后需要在火球 <code>FireBall</code> 类中调用攻击判定的同步函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FireBall</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 火球需要标记是哪个玩家发射的，且射出后的速度方向与大小是固定的，射程为move_length</span></span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, player, x, y, radius, vx, vy, color, speed, move_length, damage</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update_move</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update_attack</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 攻击碰撞检测</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> player = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>[i];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (player !== <span class=\"variable language_\">this</span>.<span class=\"property\">player</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"title function_\">is_collision</span>(player)) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"title function_\">attack</span>(player);  <span class=\"comment\">// this攻击player</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_move</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">player</span>.<span class=\"property\">character</span> !== <span class=\"string\">&#x27;enemy&#x27;</span>) &#123;  <span class=\"comment\">// 在敌人的窗口中不进行攻击检测</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_attack</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_collision</span>(<span class=\"params\">player</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> distance = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_dist</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, player.<span class=\"property\">x</span>, player.<span class=\"property\">y</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (distance &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> + player.<span class=\"property\">radius</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">attack</span>(<span class=\"params\">player</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"title function_\">atan2</span>(player.<span class=\"property\">y</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, player.<span class=\"property\">x</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        player.<span class=\"title function_\">is_attacked</span>(theta, <span class=\"variable language_\">this</span>.<span class=\"property\">damage</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_attack</span>(player.<span class=\"property\">uuid</span>, player.<span class=\"property\">x</span>, player.<span class=\"property\">y</span>, theta, <span class=\"variable language_\">this</span>.<span class=\"property\">damage</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">uuid</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">on_destroy</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>4. 优化改进（玩家提示板、技能CD）</h1>\n<p>我们限制在房间人数还没到3个时玩家不能移动，需要在 <code>AcGamePlayground</code> 类中添加一个状态机 <code>state</code>，一共有三种状态：<code>waiting</code>、<code>fighting</code>、<code>over</code>，且每个窗口的状态是独立的，提示板会在之后进行实现：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\">mode</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">mode</span> = mode;  <span class=\"comment\">// 需要将模式记录下来，之后玩家在不同的模式中需要调用不同的函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">state</span> = <span class=\"string\">&#x27;waiting&#x27;</span>;  <span class=\"comment\">// waiting -&gt; fighting -&gt; over</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">notice_board</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">NoticeBoard</span>(<span class=\"variable language_\">this</span>);  <span class=\"comment\">// 提示板</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">player_count</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 玩家人数</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">resize</span>();  <span class=\"comment\">// 界面打开后需要resize一次，需要将game_map也resize</span></span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接下来我们实现一个提示板，显示当前房间有多少名玩家在等待，在 <code>~/djangoapp/game/static/js/src/playground</code> 目录下新建 <code>notice_board</code> 目录，然后进入该目录创建 <code>zbase.js</code> 文件如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">NoticeBoard</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">ctx</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">text</span> = <span class=\"string\">&#x27;已就绪: 0人&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">write</span>(<span class=\"params\">text</span>) &#123;  <span class=\"comment\">// 更新this.text的信息</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">text</span> = text;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// Canvas渲染文本</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">font</span> = <span class=\"string\">&#x27;20px serif&#x27;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"string\">&#x27;white&#x27;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">textAlign</span> = <span class=\"string\">&#x27;center&#x27;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fillText</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">text</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span>, <span class=\"number\">20</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>每次有玩家创建时就将 <code>player_count</code> 的数量加一，当玩家数量大于等于3时将游戏状态转换成 <code>Fighting</code>，且设置除了在 <code>Fighting</code> 状态下点击鼠标或按下按键才有效果，否则无效。在 <code>Player</code> 类中进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">player_count</span>++;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">notice_board</span>.<span class=\"title function_\">write</span>(<span class=\"string\">&#x27;已就绪: &#x27;</span> + <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">player_count</span> + <span class=\"string\">&#x27;人&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">player_count</span> &gt;= <span class=\"number\">3</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">state</span> = <span class=\"string\">&#x27;fighting&#x27;</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">notice_board</span>.<span class=\"title function_\">write</span>(<span class=\"string\">&#x27;Fighting&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 点击事件不往后传</span></span><br><span class=\"line\"></span><br><span class=\"line\">            ...</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            ...</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在对局一开始就能攻击，显然不太合适，因此还需要设定在游戏刚开始的前若干秒无法攻击，即技能冷却。每个窗口只有自己才有技能冷却，也就是只能看到自己的冷却时间。现在我们给火球技能设置一秒的冷却时间，在 <code>Player</code> 类中进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, character, username, avatar</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span>) &#123;  <span class=\"comment\">// 如果是自己的话则加上技能CD</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> = <span class=\"number\">1</span>;  <span class=\"comment\">// 单位: s</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 点击事件不往后传</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">const</span> rect = outer.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"title function_\">getBoundingClientRect</span>();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = (e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                outer.<span class=\"title function_\">move_to</span>(tx, ty);  <span class=\"comment\">// e.clientX/Y为鼠标点击坐标</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_move_to</span>(tx, ty);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = (e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;fireball&#x27;</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">let</span> fire_ball = outer.<span class=\"title function_\">shoot_fireball</span>(tx, ty);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                        outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_shoot_fireball</span>(tx, ty, fire_ball.<span class=\"property\">uuid</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    outer.<span class=\"property\">fireball_coldtime</span> = <span class=\"number\">1</span>;  <span class=\"comment\">// 用完技能后重置冷却时间</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 释放完一次技能后还原</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span> &amp;&amp; outer.<span class=\"property\">fireball_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update_coldtime</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 更新技能冷却时间</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> -= <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">max</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span>, <span class=\"number\">0</span>);  <span class=\"comment\">// 防止变为负数</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;  <span class=\"comment\">// 将这行代码从update_move函数移动到update函数中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_move</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">state</span> === <span class=\"string\">&#x27;fighting&#x27;</span>) &#123;  <span class=\"comment\">// 只有自己且开始战斗后才更新冷却时间</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_coldtime</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们还不知道技能什么时候冷却好，因此还需要加上一个技能图标与 CD 提示，可以模仿其他 MOBA 类游戏，在技能图标上添加一层 CD 涂层即可。假设我们的技能图标资源存放在 <code>~/djangoapp/game/static/image/playground</code> 目录下，那么我们在 <code>Player</code> 类中渲染技能图标：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, character, username, avatar</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span>) &#123;  <span class=\"comment\">// 如果是自己的话则加上技能CD</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> = <span class=\"number\">1</span>;  <span class=\"comment\">// 单位: s</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_img</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_img</span>.<span class=\"property\">src</span> = <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/static/image/playground/fireball.png&#x27;</span>;  <span class=\"comment\">// 技能图标资源链接</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;  <span class=\"comment\">// 要将相对值恢复成绝对值</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> !== <span class=\"string\">&#x27;robot&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">save</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">stroke</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">clip</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">drawImage</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">img</span>, (<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>) * scale, (<span class=\"variable language_\">this</span>.<span class=\"property\">y</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>) * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"number\">2</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"number\">2</span> * scale);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">restore</span>();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// AI</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"comment\">// 角度从0画到2PI，是否逆时针为false</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">state</span> === <span class=\"string\">&#x27;fighting&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">render_skill_coldtime</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render_skill_coldtime</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 渲染技能图标与冷却时间</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"number\">1.5</span>, y = <span class=\"number\">0.95</span>, r = <span class=\"number\">0.03</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">save</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(x * scale, y * scale, r * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">stroke</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">clip</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">drawImage</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">fireball_img</span>, (x - r) * scale, (y - r) * scale, r * <span class=\"number\">2</span> * scale, r * <span class=\"number\">2</span> * scale);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">restore</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> &gt; <span class=\"number\">0</span>) &#123;  <span class=\"comment\">// 技能还在冷却中则绘制冷却蒙版</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"comment\">// 角度由冷却时间决定</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> fireball_coldtime_ratio = <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> / <span class=\"number\">1</span>;  <span class=\"comment\">// 剩余冷却时间占总冷却时间的比例</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">moveTo</span>(x * scale, y * scale);  <span class=\"comment\">// 设置圆心从(x, y)开始画</span></span><br><span class=\"line\">            <span class=\"comment\">// 减去PI/2的目的是为了从PI/2处开始转圈，而不是从0度开始</span></span><br><span class=\"line\">            <span class=\"comment\">// 最后的参数为false为取逆时针方向，反之为顺时针，但为true后相当于绘制的是冷却时间对立的另一段，因此需要调换一下冷却时间</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(x * scale, y * scale, r * scale, <span class=\"number\">0</span> - <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> / <span class=\"number\">2</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span> * (<span class=\"number\">1</span> - fireball_coldtime_ratio) - <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> / <span class=\"number\">2</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">lineTo</span>(x * scale, y * scale);  <span class=\"comment\">// 画完之后向圆心画一条线</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"string\">&#x27;rgba(0, 0, 255, 0.6)&#x27;</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">on_destroy</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span>)</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">state</span> = <span class=\"string\">&#x27;over&#x27;</span>;  <span class=\"comment\">// 玩家寄了之后更新状态为over</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>[i] === <span class=\"variable language_\">this</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"title function_\">splice</span>(i, <span class=\"number\">1</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>5. 闪现技能</h1>\n<p>闪现技能的实现很简单，整体参考之前的火球技能即可，我们先实现单机模式下的闪现技能，在 <code>Player</code> 类中实现：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, character, username, avatar</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span>) &#123;  <span class=\"comment\">// 如果是自己的话则加上技能CD</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> = <span class=\"number\">1</span>;  <span class=\"comment\">// 单位: s</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_img</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_img</span>.<span class=\"property\">src</span> = <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/static/image/playground/fireball.png&#x27;</span>;  <span class=\"comment\">// 技能图标资源链接</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">blink_coldtime</span> = <span class=\"number\">10</span>;  <span class=\"comment\">// 闪现技能冷却时间</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">blink_img</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">blink_img</span>.<span class=\"property\">src</span> = <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/static/image/playground/blink.png&#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 点击事件不往后传</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">const</span> rect = outer.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"title function_\">getBoundingClientRect</span>();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = (e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                outer.<span class=\"title function_\">move_to</span>(tx, ty);  <span class=\"comment\">// e.clientX/Y为鼠标点击坐标</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_move_to</span>(tx, ty);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = (e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;fireball&#x27;</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">let</span> fire_ball = outer.<span class=\"title function_\">shoot_fireball</span>(tx, ty);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                        outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_shoot_fireball</span>(tx, ty, fire_ball.<span class=\"property\">uuid</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    outer.<span class=\"property\">fireball_coldtime</span> = <span class=\"number\">1</span>;  <span class=\"comment\">// 用完技能后重置冷却时间</span></span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;blink&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">blink</span>(tx, ty);</span><br><span class=\"line\">                    outer.<span class=\"property\">blink_coldtime</span> = <span class=\"number\">10</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 释放完一次技能后还原</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span> &amp;&amp; outer.<span class=\"property\">fireball_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">70</span> &amp;&amp; outer.<span class=\"property\">blink_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// F键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;blink&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">sqrt</span>((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">blink</span>(<span class=\"params\">tx, ty</span>) &#123;  <span class=\"comment\">// 闪现到(tx, ty)</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, y = <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> dist = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_dist</span>(x, y, tx, ty);</span><br><span class=\"line\">        dist = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(dist, <span class=\"number\">0.3</span>);  <span class=\"comment\">// 最大闪现距离为0.3</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"title function_\">atan2</span>(ty - y, tx - x);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += dist * <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += dist * <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 闪现完之后应该停下来而不是继续移动</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update_coldtime</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 更新技能冷却时间</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> -= <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">max</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span>, <span class=\"number\">0</span>);  <span class=\"comment\">// 防止变为负数</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">blink_coldtime</span> -= <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">blink_coldtime</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">max</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">blink_coldtime</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;  <span class=\"comment\">// 将这行代码从update_move函数移动到update函数中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_move</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">state</span> === <span class=\"string\">&#x27;fighting&#x27;</span>) &#123;  <span class=\"comment\">// 只有自己且开始战斗后才更新冷却时间</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_coldtime</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;  <span class=\"comment\">// 要将相对值恢复成绝对值</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> !== <span class=\"string\">&#x27;robot&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">save</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">stroke</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">clip</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">drawImage</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">img</span>, (<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>) * scale, (<span class=\"variable language_\">this</span>.<span class=\"property\">y</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>) * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"number\">2</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"number\">2</span> * scale);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">restore</span>();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// AI</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"comment\">// 角度从0画到2PI，是否逆时针为false</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">state</span> === <span class=\"string\">&#x27;fighting&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">render_fireball_coldtime</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">render_blink_coldtime</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render_fireball_coldtime</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 渲染火球技能图标与冷却时间</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"number\">1.5</span>, y = <span class=\"number\">0.95</span>, r = <span class=\"number\">0.03</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">save</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(x * scale, y * scale, r * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">stroke</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">clip</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">drawImage</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">fireball_img</span>, (x - r) * scale, (y - r) * scale, r * <span class=\"number\">2</span> * scale, r * <span class=\"number\">2</span> * scale);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">restore</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> &gt; <span class=\"number\">0</span>) &#123;  <span class=\"comment\">// 技能还在冷却中则绘制冷却蒙版</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"comment\">// 角度由冷却时间决定</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> coldtime_ratio = <span class=\"variable language_\">this</span>.<span class=\"property\">fireball_coldtime</span> / <span class=\"number\">1</span>;  <span class=\"comment\">// 剩余冷却时间占总冷却时间的比例</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">moveTo</span>(x * scale, y * scale);  <span class=\"comment\">// 设置圆心从(x, y)开始画</span></span><br><span class=\"line\">            <span class=\"comment\">// 减去PI/2的目的是为了从PI/2处开始转圈，而不是从0度开始</span></span><br><span class=\"line\">            <span class=\"comment\">// 最后的参数为false为取逆时针方向，反之为顺时针，但为true后相当于绘制的是冷却时间对立的另一段，因此需要调换一下冷却时间</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(x * scale, y * scale, r * scale, <span class=\"number\">0</span> - <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> / <span class=\"number\">2</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span> * (<span class=\"number\">1</span> - coldtime_ratio) - <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> / <span class=\"number\">2</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">lineTo</span>(x * scale, y * scale);  <span class=\"comment\">// 画完之后向圆心画一条线</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"string\">&#x27;rgba(0, 0, 255, 0.6)&#x27;</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render_blink_coldtime</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 渲染闪现技能图标与冷却时间</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"number\">1.6</span>, y = <span class=\"number\">0.95</span>, r = <span class=\"number\">0.03</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">save</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(x * scale, y * scale, r * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">stroke</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">clip</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">drawImage</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">blink_img</span>, (x - r) * scale, (y - r) * scale, r * <span class=\"number\">2</span> * scale, r * <span class=\"number\">2</span> * scale);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">restore</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">blink_coldtime</span> &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"keyword\">let</span> coldtime_ratio = <span class=\"variable language_\">this</span>.<span class=\"property\">blink_coldtime</span> / <span class=\"number\">10</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">moveTo</span>(x * scale, y * scale);  <span class=\"comment\">// 设置圆心从(x, y)开始画</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(x * scale, y * scale, r * scale, <span class=\"number\">0</span> - <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> / <span class=\"number\">2</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span> * (<span class=\"number\">1</span> - coldtime_ratio) - <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> / <span class=\"number\">2</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">lineTo</span>(x * scale, y * scale);  <span class=\"comment\">// 画完之后向圆心画一条线</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"string\">&#x27;rgba(0, 0, 255, 0.6)&#x27;</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">on_destroy</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span>)</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">state</span> = <span class=\"string\">&#x27;over&#x27;</span>;  <span class=\"comment\">// 玩家寄了之后更新状态为over</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>[i] === <span class=\"variable language_\">this</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"title function_\">splice</span>(i, <span class=\"number\">1</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们还需要将闪现技能在多人模式中进行同步，原理和移动的同步是一样的，先在 <code>MultiPlayerSocket</code> 类中实现前端函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"property\">onmessage</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> data = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(e.<span class=\"property\">data</span>);  <span class=\"comment\">// 将字符串变回JSON</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> uuid = data.<span class=\"property\">uuid</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (uuid === outer.<span class=\"property\">uuid</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 如果是给自己发送消息就直接过滤掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">let</span> event = data.<span class=\"property\">event</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;create_player&#x27;</span>) &#123;  <span class=\"comment\">// create_player路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_create_player</span>(uuid, data.<span class=\"property\">username</span>, data.<span class=\"property\">avatar</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;move_to&#x27;</span>) &#123;  <span class=\"comment\">// move_to路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_move_to</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;shoot_fireball&#x27;</span>) &#123;  <span class=\"comment\">// shoot_fireball路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_shoot_fireball</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>, data.<span class=\"property\">fireball_uuid</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;attack&#x27;</span>) &#123;  <span class=\"comment\">// attack路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_attack</span>(uuid, data.<span class=\"property\">attackee_uuid</span>, data.<span class=\"property\">x</span>, data.<span class=\"property\">y</span>, data.<span class=\"property\">theta</span>, data.<span class=\"property\">damage</span>, data.<span class=\"property\">fireball_uuid</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;blink&#x27;</span>) &#123;  <span class=\"comment\">// blink路由</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_blink</span>(uuid, data.<span class=\"property\">tx</span>, data.<span class=\"property\">ty</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_blink</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;blink&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: outer.<span class=\"property\">uuid</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;tx&#x27;</span>: tx,</span><br><span class=\"line\">            <span class=\"string\">&#x27;ty&#x27;</span>: ty,</span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_blink</span>(<span class=\"params\">uuid, tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> player = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_player</span>(uuid);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (player) &#123;</span><br><span class=\"line\">            player.<span class=\"title function_\">blink</span>(tx, ty);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后实现一下后端，在 <code>~/djangoapp/game/consumers/multiplayer/index.py</code> 文件中实现：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.conf <span class=\"keyword\">import</span> settings</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">blink</span>(<span class=\"params\">self, data</span>):</span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_send(</span><br><span class=\"line\">            self.room_name,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&#x27;type&#x27;</span>: <span class=\"string\">&#x27;group_send_event&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;blink&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;uuid&#x27;</span>: data[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;tx&#x27;</span>: data[<span class=\"string\">&#x27;tx&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;ty&#x27;</span>: data[<span class=\"string\">&#x27;ty&#x27;</span>],</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        data = json.loads(text_data)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br><span class=\"line\"></span><br><span class=\"line\">        event = data[<span class=\"string\">&#x27;event&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> event == <span class=\"string\">&#x27;create_player&#x27;</span>:  <span class=\"comment\"># 做一个路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.create_player(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;move_to&#x27;</span>:  <span class=\"comment\"># move_to的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.move_to(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;shoot_fireball&#x27;</span>:  <span class=\"comment\"># shoot_fireball的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.shoot_fireball(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;attack&#x27;</span>:  <span class=\"comment\"># attack的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.attack(data)</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> event == <span class=\"string\">&#x27;blink&#x27;</span>:  <span class=\"comment\"># blink的路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.blink(data)</span><br></pre></td></tr></table></figure>\n<p>最后在 <code>Player</code> 类中调用一下广播闪现技能的函数即可：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 点击事件不往后传</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">const</span> rect = outer.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"title function_\">getBoundingClientRect</span>();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = (e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                outer.<span class=\"title function_\">move_to</span>(tx, ty);  <span class=\"comment\">// e.clientX/Y为鼠标点击坐标</span></span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_move_to</span>(tx, ty);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = (e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;fireball&#x27;</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">let</span> fire_ball = outer.<span class=\"title function_\">shoot_fireball</span>(tx, ty);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                        outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_shoot_fireball</span>(tx, ty, fire_ball.<span class=\"property\">uuid</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    outer.<span class=\"property\">fireball_coldtime</span> = <span class=\"number\">1</span>;  <span class=\"comment\">// 用完技能后重置冷却时间</span></span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;blink&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">blink</span>(tx, ty);</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">mode</span> === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">                        outer.<span class=\"property\">playground</span>.<span class=\"property\">mps</span>.<span class=\"title function_\">send_blink</span>(tx, ty);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    outer.<span class=\"property\">blink_coldtime</span> = <span class=\"number\">10</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 释放完一次技能后还原</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (outer.<span class=\"property\">playground</span>.<span class=\"property\">state</span> !== <span class=\"string\">&#x27;fighting&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span> &amp;&amp; outer.<span class=\"property\">fireball_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">70</span> &amp;&amp; outer.<span class=\"property\">blink_coldtime</span> &lt; outer.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// F键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;blink&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上一章：<a href=\"/posts/31494.html\">Django学习笔记-实现联机对战（上）</a>。</p>\n<p>下一章：<a href=\"/posts/54938.html\">Django学习笔记-实现聊天系统</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/31812.html",
            "url": "https://asanosaki.github.io/posts/31812.html",
            "title": "Python子进程管理与进程信息获取",
            "date_published": "2023-09-18T02:54:00.000Z",
            "content_html": "<blockquote>\n<p>介绍 Python 中的子进程模块 <code>subprocess</code>、线程池模块 <code>ThreadPoolExecutor</code> 以及系统信息获取模块 <code>Psutil</code> 的用法。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. Python子进程模块subprocess</h1>\n<p><code>subprocess</code> 模块允许我们启动一个新进程，并连接到它们的输入/输出/错误管道，从而获取返回值。</p>\n<p>（1）<code>run</code> 方法</p>\n<p>首先我们来看看 <code>run</code> 方法的使用，该方法的参数如下：</p>\n<ul>\n<li><code>args</code>：表示要执行的命令。必须是一个字符串或字符串参数列表。</li>\n<li><code>stdin</code>、<code>stdout</code> 和 <code>stderr</code>：子进程的标准输入、输出和错误。其值可以是 <code>subprocess.PIPE</code>、<code>subprocess.DEVNULL</code>、一个已经存在的文件描述符、已经打开的文件对象或者 <code>None</code>。<code>subprocess.PIPE</code> 表示为子进程创建新的管道。<code>subprocess.DEVNULL</code> 表示使用 <code>os.devnull</code>。默认使用的是 <code>None</code>，表示什么都不做。另外，<code>stderr</code> 可以合并到 <code>stdout</code> 里一起输出。</li>\n<li><code>timeout</code>：设置命令超时时间。如果命令执行时间超时，子进程将被杀死，并抛出 <code>TimeoutExpired</code> 异常。</li>\n<li><code>check</code>：如果该参数设置为 <code>True</code>，并且进程退出状态码不是 0，则抛出 <code>CalledProcessError</code> 异常。</li>\n<li><code>encoding</code>：如果指定了该参数，则 <code>stdin</code>、<code>stdout</code> 和 <code>stderr</code> 可以接收字符串数据，并以该编码方式编码。否则只接收 <code>bytes</code> 类型的数据。</li>\n<li><code>shell</code>：如果该参数为 <code>True</code>，将通过操作系统的 Shell 执行指定的命令。</li>\n<li><code>capture_output</code>：如果 <code>capture_output = True</code>，则将捕获 <code>stdout</code> 和 <code>stderr</code>，调用时内部的 <code>Popen</code> 对象将自动使用 <code>stdout = PIPE</code> 和 <code>stderr = PIPE</code> 创建标准输出和标准错误对象；传递 <code>stdout</code> 和 <code>stderr</code> 参数时不能同时传递 <code>capture_output</code> 参数。如果希望捕获并将两个 <code>stream</code> 合并为一个，使用 <code>stdout = PIPE</code> 和 <code>stderr = STDOUT</code>。</li>\n</ul>\n<p>下面我们来看一个例子，<code>run</code> 方法调用方式返回 <code>CompletedProcess</code> 实例：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> subprocess</span><br><span class=\"line\"></span><br><span class=\"line\">args1 = [<span class=\"string\">&#x27;python&#x27;</span>, <span class=\"string\">&#x27;src/Python子进程测试程序1.py&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">ret = subprocess.run(args=args1, capture_output=<span class=\"literal\">True</span>, encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)  <span class=\"comment\"># 相当于在命令行执行：python src/Python子进程测试程序1.py</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(ret)  <span class=\"comment\"># CompletedProcess(args=[&#x27;python&#x27;, &#x27;src/Python子进程测试程序1.py&#x27;], returncode=0, stdout=&#x27;子进程输出: Hello World!\\n&#x27;, stderr=&#x27;&#x27;)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> ret.returncode == <span class=\"number\">0</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Success, stdout:&#x27;</span>, ret.stdout)  <span class=\"comment\"># Success, stdout: 子进程输出: Hello World!</span></span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Error, stderr:&#x27;</span>, ret.stderr)  <span class=\"comment\"># Error, stderr: python: can&#x27;t open file &#x27;D:\\xxx\\src\\Python子进程测试程序1_Wrong.py&#x27;: [Errno 2] No such file or directory</span></span><br></pre></td></tr></table></figure>\n<p>其中，<code>Python子进程测试程序1.py</code> 内容如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;子进程输出: Hello World!&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p>（2）<code>Popen</code> 方法</p>\n<p><code>Popen</code> 是 <code>subprocess</code> 的核心，子进程的创建和管理都靠它处理。</p>\n<p><code>Popen</code> 方法的参数如下：</p>\n<ul>\n<li><code>args</code>：Shell 命令，可以是字符串或者序列类型（如：列表、元组）。</li>\n<li><code>bufsize</code>：缓冲区大小。当创建标准流的管道对象时使用，默认为 <code>-1</code>。<code>0</code> 表示不使用缓冲区，<code>1</code> 表示行缓冲，仅当 <code>universal_newlines = True</code> 时可用，也就是文本模式。正数表示缓冲区大小，负数表示使用系统默认的缓冲区大小。</li>\n<li><code>stdin</code>、<code>stdout</code>、<code>stderr</code>：分别表示程序的标准输入、输出、错误句柄。</li>\n<li><code>preexec_fn</code>：只在 Unix 平台下有效，用于指定一个可执行对象（callable object），它将在子进程运行之前被调用。</li>\n<li><code>shell</code>：如果该参数为 <code>True</code>，将通过操作系统的 Shell 执行指定的命令。</li>\n<li><code>cwd</code>：用于设置子进程的当前目录。</li>\n<li><code>env</code>：用于指定子进程的环境变量。如果 <code>env = None</code>，子进程的环境变量将从父进程中继承。</li>\n</ul>\n<p>该方法会创建一个 <code>Popen</code> 对象， <code>Popen</code> 对象有以下几种方法：</p>\n<ul>\n<li><code>poll()</code>：检查进程是否终止，如果终止返回 <code>returncode</code>，否则返回 <code>None</code>。</li>\n<li><code>wait(timeout)</code>：等待子进程终止。</li>\n<li><code>communicate(input=None, timeout=None)</code>：和子进程交互，向子进程发送和读取数据。将 <code>input</code> 指定数据发送到 <code>stdin</code>；从 <code>stdout</code> 和 <code>stderr</code> 读取数据，直到到达文件末尾，等待进程终止。所以，返回值是一个元组：<code>(stdout_data, stderr_data)</code>。如果 <code>timeout</code> 时间内子进程不结束，则会抛出 <code>TimeoutExpired</code> 异常。其中需要注意的是，捕获异常之后，可以再次调用该函数，因为子进程并没有被 KILL。因此，如果超时结束程序的话，需要现正确 KILL 子进程。</li>\n<li><code>send_signal(singnal)</code>：发送信号到子进程。</li>\n<li><code>terminate()</code>：停止子进程，也就是发送 <code>SIGTERM</code> 信号到子进程。</li>\n<li><code>kill()</code>：杀死子进程，发送 <code>SIGKILL</code> 信号到子进程。</li>\n</ul>\n<p><code>Popen</code> 方法的样例如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">args2 = [<span class=\"string\">&#x27;python&#x27;</span>, <span class=\"string\">&#x27;src/Python子进程测试程序2.py&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">proc = subprocess.Popen(args=args2,</span><br><span class=\"line\">                        stdin=subprocess.PIPE,</span><br><span class=\"line\">                        stdout=subprocess.PIPE,</span><br><span class=\"line\">                        stderr=subprocess.PIPE,</span><br><span class=\"line\">                        encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(proc)  <span class=\"comment\"># &lt;Popen: returncode: None args: [&#x27;python&#x27;, &#x27;src/Python子进程测试程序2.py&#x27;]&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">stdout, stderr = proc.communicate(<span class=\"built_in\">input</span>=<span class=\"string\">&#x27;AsanoSaki&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;stdout:&#x27;</span>, stdout)  <span class=\"comment\"># stdout: 子进程输出:  AsanoSaki</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;stderr:&#x27;</span>, stderr)  <span class=\"comment\"># stderr: 空</span></span><br></pre></td></tr></table></figure>\n<p>其中，<code>Python子进程测试程序2.py</code> 内容如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s = <span class=\"built_in\">input</span>()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;子进程输出: &#x27;</span>, s)</span><br></pre></td></tr></table></figure>\n<p>现在我们来看一下 <code>communicate</code> 的用法，我们将测试程序修改为运行时间超过一秒：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">args2 = [<span class=\"string\">&#x27;python&#x27;</span>, <span class=\"string\">&#x27;src/Python子进程测试程序2.py&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">proc = subprocess.Popen(args=args2,</span><br><span class=\"line\">                        stdin=subprocess.PIPE,</span><br><span class=\"line\">                        stdout=subprocess.PIPE,</span><br><span class=\"line\">                        stderr=subprocess.PIPE,</span><br><span class=\"line\">                        encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    stdout, stderr = proc.communicate(<span class=\"built_in\">input</span>=<span class=\"string\">&#x27;AsanoSaki&#x27;</span>, timeout=<span class=\"number\">1</span>)  <span class=\"comment\"># 设置1s超时时间</span></span><br><span class=\"line\"><span class=\"keyword\">except</span> subprocess.TimeoutExpired:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;子进程运行超时&#x27;</span>)</span><br><span class=\"line\">    proc.kill()  <span class=\"comment\"># 需要KILL子进程</span></span><br><span class=\"line\">    stdout, stderr = proc.communicate()  <span class=\"comment\"># 捕获异常之后，可以再次调用该函数</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;stdout:&#x27;</span>, stdout)  <span class=\"comment\"># stdout: 子进程输出:  AsanoSaki</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;stderr:&#x27;</span>, stderr)  <span class=\"comment\"># stderr: 空</span></span><br></pre></td></tr></table></figure>\n<p>现在的 <code>Python子进程测试程序2.py</code> 内容如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s = <span class=\"built_in\">input</span>()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;子进程输出: &#x27;</span>, s)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">10</span>**<span class=\"number\">9</span>):</span><br><span class=\"line\">    <span class=\"keyword\">pass</span></span><br></pre></td></tr></table></figure>\n<h1>2. ThreadPoolExecutor线程池</h1>\n<p><code>concurrent.futures</code> 模块是 Python3.2 中引入的新模块，用于支持<strong>异步执行</strong>，以及在多核 CPU 和网络 I/O 中进行高效的并发编程。线程池的基类是 <code>concurrent.futures</code> 模块中的 <code>Executor</code>，<code>Executor</code> 提供了两个子类，即 <code>ThreadPoolExecutor</code> 和 <code>ProcessPoolExecutor</code> ，简化了跨平台异步编程的实现。其中 <code>ThreadPoolExecutor</code> 用于创建线程池，而 <code>ProcessPoolExecutor</code> 用于创建进程池。如果使用线程池/进程池来管理并发编程，那么只要将相应的 Task 函数提交给线程池/进程池，剩下的事情就由线程池/进程池来搞定。</p>\n<p>首先，让我们先来理解多进程和多线程两种并发编程的方式：</p>\n<ul>\n<li>多进程：当通过多进程来实现并发编程时，程序会将任务分配给多个进程，这些进程可以在<strong>不同</strong>的 CPU 上同时运行。进程之间是<strong>独立</strong>的，各自有自己的内存空间等，可以实现<strong>真正的并行</strong>执行。不过，进程之间的通信比较耗时，需要使用 IPC（进程间通信）机制，而且进程之间的切换比线程之间的切换耗时，所以创建进程的代价较高。</li>\n<li>多线程：当通过多线程来实现并发编程时，程序会将任务分配给多个线程，这些线程可以在<strong>同一个进程中的不同</strong> CPU 核上同时运行。线程之间<strong>共享</strong>进程的内存空间，因此开销比较小。但是需要注意，在 Python 解释器中，线程是无法实现真正的并行执行，因为 Python 有 GIL（全局解释器锁），它确保同时只有一个线程运行 Python 代码。因此，一个 Python 进程中的多个线程并不能并行执行，在使用多线程编程时不能完全利用多核 CPU。</li>\n</ul>\n<p><code>ThreadPoolExecutor</code> 创建一个线程池，任务可以提交到这个线程池中执行。<code>ThreadPoolExecutor</code> 比 <code>ProcessPoolExecutor</code> 更容易使用，且没有像进程那样的开销。它可以让我们在一个 Python 解释器中进行跨线程异步编程，因为它规避了 GIL。</p>\n<p><code>Exectuor</code> 提供了如下常用方法：</p>\n<ul>\n<li><code>submit(fn, *args, **kwargs)</code>：将 <code>fn</code> 函数提交给线程池。<code>*args</code> 代表传给 <code>fn</code> 函数的参数，<code>**kwargs</code> 代表以关键字参数的形式为 <code>fn</code> 函数传入参数。</li>\n<li><code>map(func, *iterables, timeout=None, chunksize=1)</code>：该函数类似于全局函数 <code>map(func, *iterables)</code>，只是该函数将会启动多个线程，以<strong>异步</strong>方式立即对 <code>iterables</code> 执行 <code>map</code> 处理。</li>\n<li><code>shutdown(wait=True)</code>：关闭线程池。</li>\n</ul>\n<p>程序将 <code>fn</code> 函数 <code>submit</code> 给线程池后，<code>submit</code> 方法会返回一个 <code>Future</code> 对象，<code>Future</code> 类主要用于获取线程任务函数的返回值。由于线程任务会在新线程中以异步方式执行，因此，线程执行的函数相当于一个“将来完成”的任务，所以 <code>Python</code> 使用 <code>Future</code> 来代表。</p>\n<p><code>Future</code> 对象提供了如下方法：</p>\n<ul>\n<li><code>cancel()</code>：取消该 <code>Future</code> 代表的线程任务。如果该任务正在执行，不可取消，则该方法返回 <code>False</code>；否则，程序会取消该任务，并返回 <code>True</code>。</li>\n<li><code>cancelled()</code>：返回 <code>Future</code> 代表的线程任务是否被成功取消。</li>\n<li><code>running()</code>：如果该 <code>Future</code> 代表的线程任务正在执行、不可被取消，该方法返回 <code>True</code>。</li>\n<li><code>done()</code>：如果该 <code>Funture</code> 代表的线程任务被成功取消或执行完成，则该方法返回 <code>True</code>。</li>\n<li><code>result(timeout=None)</code>：获取该 <code>Future</code> 代表的线程任务最后返回的结果。如果 <code>Future</code> 代表的线程任务还未完成，该方法将会阻塞当前线程，其中 <code>timeout</code> 参数指定最多阻塞多少秒。</li>\n<li><code>exception(timeout=None)</code>：获取该 <code>Future</code> 代表的线程任务所引发的异常。如果该任务成功完成，没有异常，则该方法返回 <code>None</code>。</li>\n<li><code>add_done_callback(fn)</code>：为该 <code>Future</code> 代表的线程任务注册一个“回调函数”，当该任务成功完成时，程序会自动触发该 <code>fn</code> 函数。</li>\n</ul>\n<p>在用完一个线程池后，应该调用该线程池的 <code>shutdown()</code> 方法，该方法将启动线程池的关闭序列。调用 <code>shutdown()</code> 方法后的线程池不再接收新任务，但会将以前所有的已提交任务执行完成。当线程池中的所有任务都执行完成后，该线程池中的所有线程都会死亡。</p>\n<p>使用线程池来执行线程任务的步骤如下：</p>\n<ol>\n<li>调用 <code>ThreadPoolExecutor</code> 类的构造器创建一个线程池。</li>\n<li>定义一个普通函数作为线程任务。</li>\n<li>调用 <code>ThreadPoolExecutor</code> 对象的 <code>submit()</code> 方法来提交线程任务。</li>\n<li>当不想提交任何任务时，调用 <code>ThreadPoolExecutor</code> 对象的 <code>shutdown()</code> 方法来关闭线程池。</li>\n</ol>\n<p>下面我们来看一个例子：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> concurrent.futures <span class=\"keyword\">import</span> ThreadPoolExecutor</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">thread</span>(<span class=\"params\">num</span>):</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Threads:&#x27;</span>, num)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getResult</span>():  <span class=\"comment\"># 有返回结果的函数</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&#x27;Get Result&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 新建ThreadPoolExecutor对象并指定最大的线程数量</span></span><br><span class=\"line\"><span class=\"keyword\">with</span> ThreadPoolExecutor(max_workers=<span class=\"number\">3</span>) <span class=\"keyword\">as</span> executor:</span><br><span class=\"line\">    <span class=\"comment\"># 提交多个任务到线程池中</span></span><br><span class=\"line\">    executor.submit(thread, <span class=\"number\">1</span>)  <span class=\"comment\"># Threads: 1</span></span><br><span class=\"line\">    executor.submit(thread, <span class=\"number\">2</span>)  <span class=\"comment\"># Threads: 2</span></span><br><span class=\"line\">    t = executor.submit(getResult)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(t.result())  <span class=\"comment\"># Get Result</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 或者按如下方式实现</span></span><br><span class=\"line\">threadPool = ThreadPoolExecutor(max_workers=<span class=\"number\">3</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">3</span>):</span><br><span class=\"line\">    threadPool.submit(thread, i)</span><br><span class=\"line\">threadPool.shutdown(wait=<span class=\"literal\">True</span>)</span><br><span class=\"line\"><span class=\"comment\"># Threads: 0</span></span><br><span class=\"line\"><span class=\"comment\"># Threads: 1</span></span><br><span class=\"line\"><span class=\"comment\"># Threads: 2</span></span><br></pre></td></tr></table></figure>\n<h1>3. 系统信息获取模块Psutil</h1>\n<p>现在可能会有人在想那我们如何获取子进程/线程在运行时的时间开销或者内存占用等信息呢？Python 有一个第三方模块 <code>psutil</code>，专门用来获取操作系统以及硬件相关的信息，比如：CPU、磁盘、网络、内存等等。</p>\n<p>首先我们需要安装 <code>psutil</code>，直接通过 <code>pip</code> 命令安装即可：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install psutil</span><br></pre></td></tr></table></figure>\n<p>（1）查看 CPU 相关信息：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> psutil</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.cpu_count())  <span class=\"comment\"># CPU的逻辑数量：12</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.cpu_count(logical=<span class=\"literal\">False</span>))  <span class=\"comment\"># CPU的物理核心数量：6</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.cpu_times())  <span class=\"comment\"># CPU的用户/系统/空闲时间</span></span><br><span class=\"line\"><span class=\"comment\"># scputimes(user=26860.4375, system=10963.515624999884, idle=676060.796875, interrupt=740.875, dpc=477.75)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> _ <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">3</span>):</span><br><span class=\"line\">    <span class=\"comment\"># interval表示每隔0.5s刷新一次，percpu表示查看所有的CPU使用率</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(psutil.cpu_percent(interval=<span class=\"number\">0.5</span>, percpu=<span class=\"literal\">True</span>))</span><br><span class=\"line\"><span class=\"comment\"># [21.2, 0.0, 32.4, 0.0, 16.1, 0.0, 0.0, 0.0, 3.2, 0.0, 0.0, 0.0]</span></span><br><span class=\"line\"><span class=\"comment\"># [25.8, 0.0, 3.1, 0.0, 0.0, 0.0, 3.1, 3.1, 0.0, 0.0, 0.0, 18.8]</span></span><br><span class=\"line\"><span class=\"comment\"># [32.4, 0.0, 21.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 6.2, 0.0]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.cpu_stats())  <span class=\"comment\"># CPU的统计信息，包括上下文切换、中断、软中断以及系统调用次数等</span></span><br><span class=\"line\"><span class=\"comment\"># scpustats(ctx_switches=3399680458, interrupts=1365489476, soft_interrupts=0, syscalls=2283205750)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.cpu_freq())  <span class=\"comment\"># CPU的频率</span></span><br><span class=\"line\"><span class=\"comment\"># scpufreq(current=2592.0, min=0.0, max=2592.0)</span></span><br></pre></td></tr></table></figure>\n<p>（2）查看内存及磁盘相关信息：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(psutil.virtual_memory())  <span class=\"comment\"># 内存使用情况，分别为总内存、可用内存、内存占用率、已使用的内存大小、剩余的内存大小</span></span><br><span class=\"line\"><span class=\"comment\"># svmem(total=17022177280, available=7125008384, percent=58.1, used=9897168896, free=7125008384)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.swap_memory())  <span class=\"comment\"># 交换内存信息（专门用来临时存储数据）</span></span><br><span class=\"line\"><span class=\"comment\"># sswap(total=6030352384, used=5409898496, free=620453888, percent=89.7, sin=0, sout=0)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.disk_partitions())  <span class=\"comment\"># 磁盘分区、磁盘使用率和磁盘IO信息</span></span><br><span class=\"line\"><span class=\"comment\"># [sdiskpart(device=&#x27;C:\\\\&#x27;, mountpoint=&#x27;C:\\\\&#x27;, fstype=&#x27;NTFS&#x27;, opts=&#x27;rw,fixed&#x27;, maxfile=255, maxpath=260),</span></span><br><span class=\"line\"><span class=\"comment\">#  sdiskpart(device=&#x27;D:\\\\&#x27;, mountpoint=&#x27;D:\\\\&#x27;, fstype=&#x27;NTFS&#x27;, opts=&#x27;rw,fixed&#x27;, maxfile=255, maxpath=260),</span></span><br><span class=\"line\"><span class=\"comment\">#  sdiskpart(device=&#x27;E:\\\\&#x27;, mountpoint=&#x27;E:\\\\&#x27;, fstype=&#x27;NTFS&#x27;, opts=&#x27;rw,fixed&#x27;, maxfile=255, maxpath=260)]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.disk_usage(<span class=\"string\">&quot;C:\\\\&quot;</span>))  <span class=\"comment\"># 某个磁盘使用情况</span></span><br><span class=\"line\"><span class=\"comment\"># sdiskusage(total=160253673472, used=101791543296, free=58462130176, percent=63.5)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.disk_io_counters())  <span class=\"comment\"># 磁盘IO统计信息，分别为读次数、写次数、读的字节数、写的字节数、读时间、写时间</span></span><br><span class=\"line\"><span class=\"comment\"># sdiskio(read_count=1833834, write_count=1831471, read_bytes=69098376704, write_bytes=59881958400, read_time=17952, write_time=2323)</span></span><br></pre></td></tr></table></figure>\n<p>（3）查看网络相关信息：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(psutil.net_io_counters())  <span class=\"comment\"># 网卡的网络IO统计信息</span></span><br><span class=\"line\"><span class=\"comment\"># snetio(bytes_sent=629698806, bytes_recv=1756588411, packets_sent=1280472, packets_recv=2023810, errin=0, errout=0, dropin=0, dropout=0)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.net_io_counters(pernic=<span class=\"literal\">True</span>))  <span class=\"comment\"># 列出所有网卡的信息</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;&#x27;Ethernet&#x27;: snetio(bytes_sent=0, bytes_recv=0, packets_sent=0, packets_recv=0, errin=0, errout=0, dropin=0, dropout=0),</span></span><br><span class=\"line\"><span class=\"comment\">#  &#x27;Local Area Connection* 3&#x27;: snetio(bytes_sent=0, bytes_recv=0, packets_sent=0, packets_recv=0, errin=0, errout=0, dropin=0, dropout=0),</span></span><br><span class=\"line\"><span class=\"comment\">#  &#x27;Local Area Connection* 4&#x27;: snetio(bytes_sent=0, bytes_recv=0, packets_sent=0, packets_recv=0, errin=0, errout=0, dropin=0, dropout=0),</span></span><br><span class=\"line\"><span class=\"comment\">#  ......]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.net_if_addrs())  <span class=\"comment\"># 网络接口信息</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;&#x27;Ethernet&#x27;: [snicaddr(family=&lt;AddressFamily.AF_LINK: -1&gt;, address=&#x27;04-D4-C4-74-A4-F0&#x27;, netmask=None, broadcast=None, ptp=None), snicaddr(family=&lt;AddressFamily.AF_INET: 2&gt;, address=&#x27;169.254.216.112&#x27;, netmask=&#x27;255.255.0.0&#x27;, broadcast=None, ptp=None)],</span></span><br><span class=\"line\"><span class=\"comment\">#  &#x27;Local Area Connection* 3&#x27;: [snicaddr(family=&lt;AddressFamily.AF_LINK: -1&gt;, address=&#x27;38-00-25-26-9C-70&#x27;, netmask=None, broadcast=None, ptp=None), snicaddr(family=&lt;AddressFamily.AF_INET: 2&gt;, address=&#x27;169.254.169.242&#x27;, netmask=&#x27;255.255.0.0&#x27;, broadcast=None, ptp=None), snicaddr(family=&lt;AddressFamily.AF_INET6: 23&gt;, address=&#x27;fe80::5e4e:63b6:7416:787b&#x27;, netmask=None, broadcast=None, ptp=None)],</span></span><br><span class=\"line\"><span class=\"comment\">#  ......]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.net_if_stats())  <span class=\"comment\"># 网卡的详细信息，包括是否启动、通信类型、传输速度、mtu</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;&#x27;Ethernet&#x27;: snicstats(isup=False, duplex=&lt;NicDuplex.NIC_DUPLEX_FULL: 2&gt;, speed=0, mtu=1500),</span></span><br><span class=\"line\"><span class=\"comment\">#  &#x27;vEthernet (Default Switch)&#x27;: snicstats(isup=True, duplex=&lt;NicDuplex.NIC_DUPLEX_FULL: 2&gt;, speed=4294, mtu=1500),</span></span><br><span class=\"line\"><span class=\"comment\">#  &#x27;Loopback Pseudo-Interface 1&#x27;: snicstats(isup=True, duplex=&lt;NicDuplex.NIC_DUPLEX_FULL: 2&gt;, speed=1073, mtu=1500),</span></span><br><span class=\"line\"><span class=\"comment\">#  ......]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.net_connections())  <span class=\"comment\"># 当前机器的网络连接，里面接受一个参数，默认是&quot;inet&quot;，当然我们也可以指定为其它，比如&quot;tcp&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># [sconn(fd=-1, family=&lt;AddressFamily.AF_INET: 2&gt;, type=&lt;SocketKind.SOCK_DGRAM: 2&gt;, laddr=addr(ip=&#x27;127.0.0.1&#x27;, port=1309), raddr=(), status=&#x27;NONE&#x27;, pid=7516),</span></span><br><span class=\"line\"><span class=\"comment\">#  sconn(fd=-1, family=&lt;AddressFamily.AF_INET: 2&gt;, type=&lt;SocketKind.SOCK_STREAM: 1&gt;, laddr=addr(ip=&#x27;127.0.0.1&#x27;, port=9100), raddr=(), status=&#x27;LISTEN&#x27;, pid=6004),</span></span><br><span class=\"line\"><span class=\"comment\">#  sconn(fd=-1, family=&lt;AddressFamily.AF_INET6: 23&gt;, type=&lt;SocketKind.SOCK_STREAM: 1&gt;, laddr=addr(ip=&#x27;::&#x27;, port=49667), raddr=(), status=&#x27;LISTEN&#x27;, pid=3768),</span></span><br><span class=\"line\"><span class=\"comment\">#  ......]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.users())  <span class=\"comment\"># 当前登录的用户信息</span></span><br><span class=\"line\"><span class=\"comment\"># [suser(name=&#x27;AsanoSaki&#x27;, terminal=None, host=None, started=1694966965.3425539, pid=None)]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> datetime</span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.boot_time())  <span class=\"comment\"># 系统的启动时间：1694912508.6818905</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(datetime.datetime.fromtimestamp(psutil.boot_time()))  <span class=\"comment\"># 2023-09-17 09:01:48.681890</span></span><br></pre></td></tr></table></figure>\n<p>（4）查看进程相关信息：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(psutil.pids())  <span class=\"comment\"># 当前存在的所有进程的PID</span></span><br><span class=\"line\"><span class=\"comment\"># [0, 4, 8, 140, 212, 584, 756, 1052, 1160, 1188, 1292, 1364, 1384, ...]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.pid_exists(<span class=\"number\">0</span>))  <span class=\"comment\"># 某个进程是否存在</span></span><br><span class=\"line\"><span class=\"comment\"># True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.process_iter())  <span class=\"comment\"># 所有进程对象（Process）组成的迭代器</span></span><br><span class=\"line\"><span class=\"comment\"># &lt;generator object process_iter at 0x00000263C4D2AF20&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(psutil.Process(pid=<span class=\"number\">10712</span>))  <span class=\"comment\"># 根据PID获取一个进程对应的Process对象</span></span><br><span class=\"line\"><span class=\"comment\"># psutil.Process(pid=10712, name=&#x27;pycharm64.exe&#x27;, status=&#x27;running&#x27;, started=&#x27;08:56:02&#x27;)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p = psutil.Process(pid=<span class=\"number\">10712</span>)  <span class=\"comment\"># 获取该Process对象</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.name())  <span class=\"comment\"># 进程名称，pycharm64.exe</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.exe())  <span class=\"comment\"># 进程的exe路径：E:\\PyCharm 2020.3.3\\bin\\pycharm64.exe</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.cwd())  <span class=\"comment\"># 进程的工作目录：E:\\PyCharm 2020.3.3\\jbr\\bin</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.cmdline())  <span class=\"comment\"># 进程启动的命令行：[&#x27;E:\\\\PyCharm 2020.3.3\\\\bin\\\\pycharm64.exe&#x27;]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.status())  <span class=\"comment\"># 进程状态：running</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.username())  <span class=\"comment\"># 进程用户名：LAPTOP-23NEHV3U\\AsanoSaki</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.create_time())  <span class=\"comment\"># 进程创建时间，返回时间戳：1694998562.3625667</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.cpu_times())  <span class=\"comment\"># 进程使用的CPU时间</span></span><br><span class=\"line\"><span class=\"comment\"># pcputimes(user=277.09375, system=34.265625, children_user=0.0, children_system=0.0)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.memory_info())  <span class=\"comment\"># 进程所使用的内存</span></span><br><span class=\"line\"><span class=\"comment\"># pmem(rss=1507303424, vms=1790066688, num_page_faults=1466884, peak_wset=1536196608,</span></span><br><span class=\"line\"><span class=\"comment\">#      wset=1507303424, peak_paged_pool=881616, paged_pool=876144, peak_nonpaged_pool=268096,</span></span><br><span class=\"line\"><span class=\"comment\">#      nonpaged_pool=154024, pagefile=1790066688, peak_pagefile=1798070272, private=1790066688)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(p.num_threads())  <span class=\"comment\"># 进程内的线程数量，即这个进程开启了多少个线程：68</span></span><br></pre></td></tr></table></figure>\n<p>现在我们使用 <code>psutil</code> 模块实现获取 <code>ThreadPoolExecutor</code> 线程任务运行的时间与内存占用信息：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">args2 = [<span class=\"string\">&#x27;python&#x27;</span>, <span class=\"string\">&#x27;src/Python子进程测试程序2.py&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">proc = subprocess.Popen(args=args2,</span><br><span class=\"line\">                        stdin=subprocess.PIPE,</span><br><span class=\"line\">                        stdout=subprocess.PIPE,</span><br><span class=\"line\">                        stderr=subprocess.PIPE,</span><br><span class=\"line\">                        encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getProcessInfo</span>(<span class=\"params\">pid</span>):</span><br><span class=\"line\">    p = psutil.Process(pid)  <span class=\"comment\"># 获取pid所代表的子进程</span></span><br><span class=\"line\">    start_time = time.time()</span><br><span class=\"line\">    memory = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"literal\">True</span>):</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            memory = <span class=\"built_in\">max</span>(memory, p.memory_info().rss)</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    runtime = (time.time() - start_time) * <span class=\"number\">1000</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> runtime, memory</span><br><span class=\"line\"></span><br><span class=\"line\">threadPool = ThreadPoolExecutor()</span><br><span class=\"line\">task = threadPool.submit(getProcessInfo, proc.pid)</span><br><span class=\"line\">stdout, stderr = proc.communicate(<span class=\"built_in\">input</span>=<span class=\"string\">&#x27;AsanoSaki&#x27;</span>)</span><br><span class=\"line\">runtime, memory = task.result()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(runtime)  <span class=\"comment\"># 510.7400417327881</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(memory)  <span class=\"comment\"># 40865792</span></span><br><span class=\"line\"></span><br><span class=\"line\">threadPool.shutdown(wait=<span class=\"literal\">True</span>)</span><br><span class=\"line\">proc.kill()</span><br></pre></td></tr></table></figure>\n<p>其中，<code>Python子进程测试程序2.py</code> 内容如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s = <span class=\"built_in\">input</span>()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;子进程输出: &#x27;</span>, s)</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/31494.html",
            "url": "https://asanosaki.github.io/posts/31494.html",
            "title": "Django学习笔记-实现联机对战（上）",
            "date_published": "2023-08-27T09:42:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是通过 Django Channels 框架使用 WebSocket 协议实现多人模式中的同步创建玩家函数。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 统一长度单位</h1>\n<p>多人模式中每个玩家所看到的地图相对来说应该是一样的，因此需要固定地图的长宽比，一般固定为16:9。我们需要在游戏窗口的长宽中取最小值，然后将地图渲染为16:9的大小。</p>\n<p>我们在 <code>AcGamePlayground</code> 类中实现一个 <code>resize</code> 函数用于将长宽比调整为16:9并且达到最大：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_playground&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 初始化时需要先关闭playground界面</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">resize</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">resize</span>();</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 用户改变窗口大小时改函数会触发</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将长宽比调整为16:9</span></span><br><span class=\"line\">    <span class=\"title function_\">resize</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">width</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">height</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> unit = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">16</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> / <span class=\"number\">9</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> = unit * <span class=\"number\">16</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> = unit * <span class=\"number\">9</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">height</span>;  <span class=\"comment\">// 当窗口大小改变时所有目标的相对大小和位置也要改变</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">game_map</span>) <span class=\"variable language_\">this</span>.<span class=\"property\">game_map</span>.<span class=\"title function_\">resize</span>();  <span class=\"comment\">// 如果地图存在需要调用地图的resize函数</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 将界面的宽高先存下来</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">width</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">height</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">game_map</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">GameMap</span>(<span class=\"variable language_\">this</span>);  <span class=\"comment\">// 创建游戏画面</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">resize</span>();  <span class=\"comment\">// 界面打开后需要resize一次，需要将game_map也resize</span></span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在需要将窗口大小的修改效果作用到黑色背景上，因此我们在 <code>GameMap</code> 类中也实现一个 <code>resize</code> 函数用于修改背景大小：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">GameMap</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;  <span class=\"comment\">// 需要将AcGamePlayground传进来</span></span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();  <span class=\"comment\">// 调用基类构造函数，相当于将自己添加到了AC_GAME_OBJECTS中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$canvas</span> = $(<span class=\"string\">`&lt;canvas&gt;&lt;/canvas&gt;`</span>);  <span class=\"comment\">// 画布，用来渲染画面</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$canvas</span>[<span class=\"number\">0</span>].<span class=\"title function_\">getContext</span>(<span class=\"string\">&#x27;2d&#x27;</span>);  <span class=\"comment\">// 二维画布</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span>;  <span class=\"comment\">// 设置画布宽度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span>;  <span class=\"comment\">// 设置画布高度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$canvas</span>);  <span class=\"comment\">// 将画布添加到HTML中</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">resize</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"string\">&#x27;rgba(0, 0, 0, 1)&#x27;</span>;  <span class=\"comment\">// 每次调整大小后直接涂一层不透明的背景</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fillRect</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">width</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">height</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();  <span class=\"comment\">// 每一帧都要画一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"string\">&#x27;rgba(0, 0, 0, 0.2)&#x27;</span>;  <span class=\"comment\">// 黑色背景</span></span><br><span class=\"line\">        <span class=\"comment\">// 左上角坐标(0, 0)，右下角坐标(w, h)</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fillRect</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">width</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">height</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们修改一下 <code>game.css</code> 文件，添加以下内容，实现将地图居中：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.ac_game_playground</span> &gt; <span class=\"selector-tag\">canvas</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在我们还需要修改地图里面的目标，一共有三种分别是玩家、火球、被击中的粒子效果。</p>\n<p>首先修改一下 <code>AcGamePlayground</code> 类中的玩家初始化代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将长宽比调整为16:9</span></span><br><span class=\"line\">    <span class=\"title function_\">resize</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 将界面的宽高先存下来</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">width</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">height</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">game_map</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">GameMap</span>(<span class=\"variable language_\">this</span>);  <span class=\"comment\">// 创建游戏画面</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">resize</span>();  <span class=\"comment\">// 界面打开后需要resize一次，需要将game_map也resize</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">players</span> = [];  <span class=\"comment\">// 所有玩家</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.05</span>, <span class=\"string\">&#x27;white&#x27;</span>, <span class=\"number\">0.15</span>, <span class=\"literal\">true</span>));  <span class=\"comment\">// 创建自己</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 创建敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.05</span>, <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_random_color</span>(), <span class=\"number\">0.15</span>, <span class=\"literal\">false</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们修改 <code>Player</code> 类，将所有绝对变量替换为相对变量：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">0.01</span>;  <span class=\"comment\">// 误差小于0.01认为是0</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Math.random()返回一个0~1之间的数，随机初始化AI的位置</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> tx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> ty = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">move_to</span>(tx, ty);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> rect = outer.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"title function_\">getBoundingClientRect</span>();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">move_to</span>((e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>, (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>);  <span class=\"comment\">// e.clientX/Y为鼠标点击坐标</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;fireball&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">shoot_fireball</span>((e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>, (e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>) / outer.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 释放完一次技能后还原</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 向(tx, ty)位置发射火球</span></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, y = <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> radius = <span class=\"number\">0.01</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"title function_\">atan2</span>(ty - <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, tx - <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> vx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta), vy = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> color = <span class=\"string\">&#x27;orange&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> speed = <span class=\"number\">0.5</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> move_length = <span class=\"number\">0.8</span>;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">FireBall</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>, <span class=\"variable language_\">this</span>, x, y, radius, vx, vy, color, speed, move_length, <span class=\"number\">0.01</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_attacked</span>(<span class=\"params\">theta, damage</span>) &#123;  <span class=\"comment\">// 被攻击到</span></span><br><span class=\"line\">        <span class=\"comment\">// 创建粒子效果</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span> + <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">5</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> x = <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, y = <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> radius = <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">0.2</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>();</span><br><span class=\"line\">            <span class=\"keyword\">let</span> vx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta), vy = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">            <span class=\"keyword\">let</span> color = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> speed = <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"number\">10</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> move_length = <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">10</span>;</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">Particle</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>, x, y, radius, vx, vy, color, speed, move_length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> -= damage;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> *= <span class=\"number\">1.08</span>;  <span class=\"comment\">// 血量越少移动越快</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// 半径小于eps认为已死</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vx</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vy</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> = damage * <span class=\"number\">90</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 更新移动</span></span><br><span class=\"line\">    <span class=\"title function_\">update_move</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">        <span class=\"comment\">// AI敌人随机向玩家射击，游戏刚开始前三秒AI不能射击</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> &gt; <span class=\"number\">3</span> &amp;&amp; !<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span> &amp;&amp; <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() &lt; <span class=\"number\">1</span> / <span class=\"number\">360.0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> player = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">shoot_fireball</span>(player.<span class=\"property\">x</span>, player.<span class=\"property\">y</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> &gt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// 有击退效果时玩家无法移动</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vx</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vy</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> *= <span class=\"variable language_\">this</span>.<span class=\"property\">friction</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;  <span class=\"comment\">// AI敌人不能停下来</span></span><br><span class=\"line\">                    <span class=\"keyword\">let</span> tx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">let</span> ty = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">                    <span class=\"variable language_\">this</span>.<span class=\"title function_\">move_to</span>(tx, ty);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 计算真实移动距离，与一帧的移动距离取min防止移出界</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> true_move = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>);</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> * true_move;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> * true_move;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> -= true_move;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_move</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;  <span class=\"comment\">// 要将相对值恢复成绝对值</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">save</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">stroke</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">clip</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">drawImage</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">img</span>, (<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>) * scale, (<span class=\"variable language_\">this</span>.<span class=\"property\">y</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>) * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"number\">2</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"number\">2</span> * scale);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">restore</span>();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// AI</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"comment\">// 角度从0画到2PI，是否逆时针为false</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后修改 <code>FireBall</code> 类，只需要修改 <code>eps</code> 以及 <code>render</code> 函数即可：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FireBall</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 火球需要标记是哪个玩家发射的，且射出后的速度方向与大小是固定的，射程为move_length</span></span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, player, x, y, radius, vx, vy, color, speed, move_length, damage</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">0.01</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_collision</span>(<span class=\"params\">player</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">attack</span>(<span class=\"params\">player</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最后修改 <code>Particle</code> 类，同样也是只需要修改 <code>eps</code> 以及 <code>render</code> 函数即可：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Particle</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, vx, vy, color, speed, move_length</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">0.01</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">friction</span> = <span class=\"number\">0.9</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> * scale, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * scale, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>2. 增加联机对战模式</h1>\n<p>我们先修改 <code>AcGameMenu</code> 类，实现多人模式按钮的逻辑：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGameMenu</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;  <span class=\"comment\">// root用来传AcGame对象</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 给按钮绑定监听函数</span></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 注意在function中调用this指的是function本身，因此需要先将外面的this存起来</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$single</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 关闭menu界面</span></span><br><span class=\"line\">            outer.<span class=\"property\">root</span>.<span class=\"property\">playground</span>.<span class=\"title function_\">show</span>(<span class=\"string\">&#x27;single mode&#x27;</span>);  <span class=\"comment\">// 显示playground界面，加入参数用于区分</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$multi</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">            outer.<span class=\"property\">root</span>.<span class=\"property\">playground</span>.<span class=\"title function_\">show</span>(<span class=\"string\">&#x27;multi mode&#x27;</span>);  <span class=\"comment\">// 多人模式</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"title function_\">logout_on_remote</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示menu界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭menu界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后修改 <code>AcGamePlayground</code> 类，区分两种模式，且需要进一步区分玩家类别，之前使用 True/False 表示是否是玩家本人，现在可以用字符串区分玩家本人（<code>me</code>）、其他玩家（<code>enemy</code>）以及人机（<code>robot</code>）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将长宽比调整为16:9</span></span><br><span class=\"line\">    <span class=\"title function_\">resize</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\">mode</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 将界面的宽高先存下来</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">width</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">height</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">game_map</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">GameMap</span>(<span class=\"variable language_\">this</span>);  <span class=\"comment\">// 创建游戏画面</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">resize</span>();  <span class=\"comment\">// 界面打开后需要resize一次，需要将game_map也resize</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">players</span> = [];  <span class=\"comment\">// 所有玩家</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.05</span>, <span class=\"string\">&#x27;white&#x27;</span>, <span class=\"number\">0.15</span>, <span class=\"string\">&#x27;me&#x27;</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">username</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">avatar</span>));  <span class=\"comment\">// 创建自己，自己的用户名和头像从settings中获得</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 单人模式下创建AI敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;single mode&#x27;</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.05</span>, <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_random_color</span>(), <span class=\"number\">0.15</span>, <span class=\"string\">&#x27;robot&#x27;</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后还需要修改一下 <code>Player</code> 类，将原本的 <code>this.is_me</code> 判断进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, character, username, avatar</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">character</span> = character;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">username</span> = username;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">avatar</span> = avatar;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> !== <span class=\"string\">&#x27;robot&#x27;</span>) &#123;  <span class=\"comment\">// 只有AI不用渲染图片</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">img</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">img</span>.<span class=\"property\">src</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">avatar</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;me&#x27;</span>) &#123;  <span class=\"comment\">// 只给自己添加监听函数</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;robot&#x27;</span>) &#123;  <span class=\"comment\">// 机器人才会随机动</span></span><br><span class=\"line\">            ...</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 向(tx, ty)位置发射火球</span></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_attacked</span>(<span class=\"params\">theta, damage</span>) &#123;  <span class=\"comment\">// 被攻击到</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 更新移动</span></span><br><span class=\"line\">    <span class=\"title function_\">update_move</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">        <span class=\"comment\">// AI敌人随机向玩家射击，游戏刚开始前三秒AI不能射击</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;robot&#x27;</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> &gt; <span class=\"number\">3</span> &amp;&amp; <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() &lt; <span class=\"number\">1</span> / <span class=\"number\">360.0</span>) &#123;</span><br><span class=\"line\">            ...</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> &gt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// 有击退效果时玩家无法移动</span></span><br><span class=\"line\">            ...</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">                ...</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> === <span class=\"string\">&#x27;robot&#x27;</span>) &#123;  <span class=\"comment\">// AI敌人不能停下来</span></span><br><span class=\"line\">                    ...</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 计算真实移动距离，与一帧的移动距离取min防止移出界</span></span><br><span class=\"line\">                ...</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">update_move</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> scale = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>;  <span class=\"comment\">// 要将相对值恢复成绝对值</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">character</span> !== <span class=\"string\">&#x27;robot&#x27;</span>) &#123;</span><br><span class=\"line\">            ...</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// AI</span></span><br><span class=\"line\">            ...</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>3. 配置Django Channels</h1>\n<p>假设有三名玩家编号为1、2、3进行多人游戏，那么每个玩家都有自己的一个窗口，且窗口中都能看到三名玩家。如果当前玩家1、2在进行游戏，3加入了游戏，那么需要告诉1、2两名玩家3来了，且还要告诉3当前已经有玩家1、2了。</p>\n<p>要实现这一点，可以通过一个<strong>中心服务器 Server</strong>（可以就是自己租的云服务器），即3向服务器发送他来了，服务器给1、2发送消息，且服务器给3发送消息说之前已经有1、2两名玩家了。因此服务器中需要存储每个地图中的玩家信息，用于完成第一个同步事件：生成玩家事件。</p>\n<p>我们之后一共需要实现四个同步函数：<code>create_player</code>、<code>move_to</code>、<code>shoot_fireball</code>、<code>attack</code>。前三个函数顾名思义，最后的 <code>attack</code> 函数是因为服务器存在延迟，比如3发射一个火球在本地看打中了1，但是由于延迟在1那边可能是没被打中的。</p>\n<p>攻击判断是一个权衡问题，一般的游戏都是选择在本地进行攻击判断，而不是云服务器，即以发起攻击的玩家窗口进行判断，如果击中了则通过 <code>attack</code> 函数在服务器上广播信息。</p>\n<p>在此之前我们使用的是 HTTP 协议，该协议为单向的，即客户端需要先向服务器请求信息后服务器才会返回信息，而服务器是不会主动向客户端发送信息的。</p>\n<p>因此此处我们需要使用 WebSocket 协议（WS），同理该协议也有对应的加密协议 WSS，Django Channels 即为 Django 支持 WSS 协议的一种实现方式。</p>\n<p>（1）安装 <code>channels_redis</code>：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install channels_redis</span><br></pre></td></tr></table></figure>\n<p>（2）配置 <code>djangoapp/djangoapp/asgi.py</code> 文件：</p>\n<p>文件内容如下（注意 <code>djangoapp</code> 需要改成自己项目的名称）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> channels.auth <span class=\"keyword\">import</span> AuthMiddlewareStack</span><br><span class=\"line\"><span class=\"keyword\">from</span> channels.routing <span class=\"keyword\">import</span> ProtocolTypeRouter, URLRouter</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.asgi <span class=\"keyword\">import</span> get_asgi_application</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.routing <span class=\"keyword\">import</span> websocket_urlpatterns</span><br><span class=\"line\"></span><br><span class=\"line\">os.environ.setdefault(<span class=\"string\">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class=\"string\">&#x27;djangoapp.settings&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">application = ProtocolTypeRouter(&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;http&quot;</span>: get_asgi_application(),</span><br><span class=\"line\">    <span class=\"string\">&quot;websocket&quot;</span>: AuthMiddlewareStack(URLRouter(websocket_urlpatterns))</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>（3）配置 <code>djangoapp/djangoapp/settings.py</code> 文件：</p>\n<p>在 <code>INSTALLED_APPS</code> 中添加 <code>channels</code>，添加后如下所示（注意 <code>djangoapp</code> 需要改成自己项目的名称）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INSTALLED_APPS = [ </span><br><span class=\"line\">    <span class=\"string\">&#x27;channels&#x27;</span>,  <span class=\"comment\"># 添加此行</span></span><br><span class=\"line\">    <span class=\"string\">&#x27;game.apps.GameConfig&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>然后在文件末尾添加：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ASGI_APPLICATION = <span class=\"string\">&#x27;djangoapp.asgi.application&#x27;</span></span><br><span class=\"line\">CHANNEL_LAYERS = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;default&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;BACKEND&quot;</span>: <span class=\"string\">&quot;channels_redis.core.RedisChannelLayer&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;CONFIG&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;hosts&quot;</span>: [(<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"number\">6379</span>)],</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>（4）配置 <code>game/routing.py</code> 文件：</p>\n<p>这一部分的作用相当于 HTTP 的 <code>urls</code>，文件内容如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"></span><br><span class=\"line\">websocket_urlpatterns = [</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>（5）编写 <code>game/consumers</code>，这一部分的作用相当于 HTTP 的 <code>views</code>。</p>\n<p>在 <code>game</code> 目录下创建 <code>consumers</code> 目录，然后进入该目录，先创建好 <code>__init__.py</code> 文件。由于我们未来会使用 WSS 协议支持联机对战和聊天室，因此我们需要再创建两个目录，先创建 <code>multiplayer</code> 目录，进入该目录创建 <code>__init__.py</code> 文件，然后编写 <code>index.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">connect</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.accept()</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;accept&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        self.room_name = <span class=\"string\">&quot;room&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_add(self.room_name, self.channel_name)  <span class=\"comment\"># 将当前连接加到组里</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">disconnect</span>(<span class=\"params\">self, close_code</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;disconnect&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        data = json.loads(text_data)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br></pre></td></tr></table></figure>\n<p>（6）启动 <code>django_channels</code>：</p>\n<p>首先安装 <code>daphne</code>：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install daphne</span><br></pre></td></tr></table></figure>\n<p>输入 <code>daphne</code> 查看是否可用，如果不可用说明应该是没有配置环境变量，按如下方式修改环境变量（需要重启系统）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim /etc/environment</span><br><span class=\"line\">在 PATH=&#x27;xxx&#x27; 后面添加 &#x27;:/home/&lt;用户名&gt;/.local/bin&#x27;</span><br><span class=\"line\">即: &#x27;xxx:/home/&lt;用户名&gt;/.local/bin&#x27;</span><br></pre></td></tr></table></figure>\n<p>HTTP 有 <code>uwsgi</code> 启动服务，WS 同样也需要启动，使用的是 <code>asgi</code>，在 <code>~/djangoapp</code> 目录下执行（注意 <code>djangoapp</code> 需要改成自己项目的名称）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">daphne -b 0.0.0.0 -p 5015 djangoapp.asgi:application</span><br></pre></td></tr></table></figure>\n<p>项目进行到这里已经需要启动多个服务了，顺序是：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NginX: sudo /etc/init.d/nginx start</span><br><span class=\"line\">Redis-server: sudo redis-server /etc/redis/redis.conf</span><br><span class=\"line\">uWSGI: uwsgi --ini scripts/uwsgi.ini</span><br><span class=\"line\">Django_channels: daphne -b 0.0.0.0 -p 5015 djangoapp.asgi:application</span><br></pre></td></tr></table></figure>\n<h1>4. 前端创建连接</h1>\n<p>前端（Playground）需要跟后端（WS）连接，我们需要在每个客户端中建立一个和服务器的连接，一般是使用 <strong>Web Socket</strong> 连接。</p>\n<p>首先配置一下 <code>/djangoapp/game</code> 目录下的路由 <code>routing.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.consumers.multiplayer.index <span class=\"keyword\">import</span> MultiPlayer</span><br><span class=\"line\"></span><br><span class=\"line\">websocket_urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;wss/multiplayer/&#x27;</span>, MultiPlayer.as_asgi(), name=<span class=\"string\">&#x27;wss_multiplayer&#x27;</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>我们在 <code>/djangoapp/game/static/js/src/playground</code> 目录下创建 <code>socket</code> 目录，Socket 也分为两个模块，分别为联机模式和聊天室，还是先实现联机模式，在 <code>socket</code> 目录中创建 <code>multiplayer</code> 目录，进入该目录后创建 <code>zbase.js</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">WebSocket</span>(<span class=\"string\">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当前端创建连接，即执行 <code>new WebSocket</code> 时，会调用 <code>consumers</code> 的 <code>MultiPlayer</code> 类（之后直接称为 <code>MultiPlayer</code>）中的 <code>connect</code> 函数；当前端断开连接（刷新或者关闭页面）时，会调用 <code>disconnect</code> 函数；<code>receive</code> 函数用于接收前端向后端发送的请求。</p>\n<p>由于服务器需要向多个客户端群发消息，Django Channels 中有一个概念叫做组（group），可以将多个不同的连接放到同一个组里，可以使用相关函数统一操作组里的连接，例如 <code>group_send</code> 群发消息。</p>\n<p>现在在 <code>AcGamePlayground</code> 类中添加我们刚实现的 <code>MultiPlayerSocket</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将长宽比调整为16:9</span></span><br><span class=\"line\">    <span class=\"title function_\">resize</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\">mode</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 单人模式下创建AI敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;single mode&#x27;</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.05</span>, <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_random_color</span>(), <span class=\"number\">0.15</span>, <span class=\"string\">&#x27;robot&#x27;</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">MultiPlayerSocket</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们打包静态文件并同步到发行版本，复习一下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd ~/djangoapp</span><br><span class=\"line\">./scripts/compress_game_js.sh</span><br><span class=\"line\">python3 manage.py collectstatic</span><br></pre></td></tr></table></figure>\n<p>重启一下服务，现在我们每次都需要重启两个服务，即 HTTPS 和 WSS：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uwsgi --ini scripts/uwsgi.ini</span><br><span class=\"line\">daphne -b 0.0.0.0 -p 5015 djangoapp.asgi:application</span><br></pre></td></tr></table></figure>\n<p>打开游戏进入多人模式，即可在后端的 WSS 服务看到输出信息。</p>\n<h1>5. 前端发送请求</h1>\n<p>有玩家进来时，需要两个函数，一个是实现客户端向服务器发送 <code>create_player</code> 请求，另一个是实现服务器从客户端接收请求的功能。</p>\n<p>先实现发送请求功能，在 <code>MultiPlayerSocket</code> 类中编写 <code>send_create_player</code> 函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">WebSocket</span>(<span class=\"string\">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_create_player</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// stringify可以将JSON变为字符串</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;message&#x27;</span>: <span class=\"string\">&#x27;hello world!&#x27;</span></span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_create_player</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>AcGamePlayground</code> 类中调用：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将长宽比调整为16:9</span></span><br><span class=\"line\">    <span class=\"title function_\">resize</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\">mode</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 单人模式下创建AI敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;single mode&#x27;</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.05</span>, <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_random_color</span>(), <span class=\"number\">0.15</span>, <span class=\"string\">&#x27;robot&#x27;</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">MultiPlayerSocket</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span>.<span class=\"property\">ws</span>.<span class=\"property\">onopen</span> = <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"property\">mps</span>.<span class=\"title function_\">send_create_player</span>();</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>没有修改过后端代码，因此不需要重启服务，直接重新打包一下静态文件即可，然后进入多人模式即可看到后端的输出信息，说明现在连接就已经创建成功了。</p>\n<h1>6. 编写同步函数create_player</h1>\n<p>我们每一个地图的所有信息都会有一个备份，比如1号玩家在2、3号窗口都会有一个备份，在不同的地图里我们需要能够判断出来谁是谁，比如在1号窗口中玩家1击中了玩家2，那么把信息发送到第二个窗口后，需要知道谁是2。</p>\n<p>因此我们需要给所有信息一个唯一的编号（可以使用一个随机的八位数，如果怕重复可以使用更多位数），使得我们未来知道需要同步哪些东西。在 <code>AcGameObject</code> 类中进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable constant_\">AC_GAME_OBJECTS</span> = [];  <span class=\"comment\">// 将所有对象加到一个全局数组里，之后可以遍历每个对象刷新一次</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable constant_\">AC_GAME_OBJECTS</span>.<span class=\"title function_\">push</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">has_called_start</span> = <span class=\"literal\">false</span>;  <span class=\"comment\">// 是否执行过start函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 当前帧距离上一帧的时间间隔，因为如果用帧来衡量的话不同浏览器可能帧数不一样会导致不同的效果</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">uuid</span> = <span class=\"variable language_\">this</span>.<span class=\"title function_\">create_uuid</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">create_uuid</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 创建唯一编号</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> res = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> x = <span class=\"built_in\">parseInt</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">floor</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">10</span>));  <span class=\"comment\">// Math.random()返回[0, 1)之间的数</span></span><br><span class=\"line\">            res += x;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> res;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 只会在第一帧执行一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 每一帧都会执行一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">on_destroy</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在被删除前执行一次</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">destroy</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 删掉该对象</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> last_timestamp;  <span class=\"comment\">// 上一帧的时间戳</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable constant_\">AC_GAME_ANIMATION</span> = <span class=\"keyword\">function</span>(<span class=\"params\">timestamp</span>) &#123;  <span class=\"comment\">// timestamp表示在哪个时刻调用的这个函数</span></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">requestAnimationFrame</span>(<span class=\"variable constant_\">AC_GAME_ANIMATION</span>);</span><br></pre></td></tr></table></figure>\n<p>现在又有一个问题，每次有一名新玩家进入时都会创建若干个编号，但是和之前其它窗口中的编号不一致，我们需要用通信的方式将他们保持一致，原则为<strong>谁创建的对象就用谁那边产生的编号</strong>，比如1号窗口创建了1号玩家，那么其它玩家窗口中的1号玩家的编号就由1号窗口发送过来。</p>\n<p>由于某个客户端（假设是1号窗口）向服务器发送消息后服务器会转播给<strong>所有</strong>客户端，也就是会发给自己（1号窗口），这种情况1号窗口应该要 Pass 掉这条信息，因此我们需要<strong>判断信息是哪个客户端发的</strong>。这边我们就可以用<strong>每个玩家的唯一编号</strong>，这样就可以保证每个窗口不一样，我们在 <code>AcGamePlayground</code> 中修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将长宽比调整为16:9</span></span><br><span class=\"line\">    <span class=\"title function_\">resize</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\">mode</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 单人模式下创建AI敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;single mode&#x27;</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.05</span>, <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_random_color</span>(), <span class=\"number\">0.15</span>, <span class=\"string\">&#x27;robot&#x27;</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">MultiPlayerSocket</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span>.<span class=\"property\">uuid</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>[<span class=\"number\">0</span>].<span class=\"property\">uuid</span>;  <span class=\"comment\">// 用每名玩家的唯一编号区分不同的窗口</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span>.<span class=\"property\">ws</span>.<span class=\"property\">onopen</span> = <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"property\">mps</span>.<span class=\"title function_\">send_create_player</span>();</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在客户端向服务器端发送消息的时候就要带上自己的 <code>uuid</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">WebSocket</span>(<span class=\"string\">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_create_player</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"comment\">// stringify可以将JSON变为字符串</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;create_player&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: outer.<span class=\"property\">uuid</span>,</span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_create_player</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在再测试一下即可在后端看到服务器接收到的客户端信息。</p>\n<p>接下来我们需要同步 <code>create_player</code> 这个事件，即当有新玩家来的时候，在所有窗口里创建这个玩家，同时将已有的玩家渲染到当前窗口里。</p>\n<p>首先我们需要在服务器端存下每一个游戏房间的信息，可以存在 Redis 里，我们可以用房间（room）的概念。每个房间有人数上限，这是一个通用配置，可以写在 <code>settings.py</code> 里，我们往该文件里添加一行：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ROOM_CAPACITY = <span class=\"number\">3</span></span><br></pre></td></tr></table></figure>\n<p>然后修改后端文件（<code>/djangoapp/game/consumers/multiplayer</code> 目录中的 <code>index.py</code>）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.conf <span class=\"keyword\">import</span> settings</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">connect</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        self.room_name = <span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1000</span>):  <span class=\"comment\"># 假设暂定最多1000个房间</span></span><br><span class=\"line\">            name = <span class=\"string\">&#x27;room-%d&#x27;</span> % (i)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> cache.has_key(name) <span class=\"keyword\">or</span> <span class=\"built_in\">len</span>(cache.get(name)) &lt; settings.ROOM_CAPACITY:  <span class=\"comment\"># 判断当前房间是否可用</span></span><br><span class=\"line\">                self.room_name = name</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> self.room_name:  <span class=\"comment\"># 房间不足</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.accept()</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;accept&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> cache.has_key(self.room_name):  <span class=\"comment\"># 如果没有该房间需要创建房间</span></span><br><span class=\"line\">            cache.<span class=\"built_in\">set</span>(self.room_name, [], <span class=\"number\">3600</span>)  <span class=\"comment\"># 每局时长设置为1小时</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> player <span class=\"keyword\">in</span> cache.get(self.room_name):  <span class=\"comment\"># 发送房间所有玩家的信息到当前的本地客户端</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.send(text_data=json.dumps(&#123;  <span class=\"comment\"># dumps将字典变为字符串</span></span><br><span class=\"line\">                <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;create_player&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;uuid&#x27;</span>: player[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;username&#x27;</span>: player[<span class=\"string\">&#x27;username&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;avatar&#x27;</span>: player[<span class=\"string\">&#x27;avatar&#x27;</span>],</span><br><span class=\"line\">            &#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_add(self.room_name, self.channel_name)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">disconnect</span>(<span class=\"params\">self, close_code</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;disconnect&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        data = json.loads(text_data)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br></pre></td></tr></table></figure>\n<p>现在我们需要在 <code>AcGamePlayground</code> 中传送用户名和头像参数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将长宽比调整为16:9</span></span><br><span class=\"line\">    <span class=\"title function_\">resize</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\">mode</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 单人模式下创建AI敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;single mode&#x27;</span>)&#123;</span><br><span class=\"line\">            ...</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (mode === <span class=\"string\">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">MultiPlayerSocket</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span>.<span class=\"property\">uuid</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>[<span class=\"number\">0</span>].<span class=\"property\">uuid</span>;  <span class=\"comment\">// 用每名玩家的唯一编号区分不同的窗口</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">mps</span>.<span class=\"property\">ws</span>.<span class=\"property\">onopen</span> = <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"property\">mps</span>.<span class=\"title function_\">send_create_player</span>(outer.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">username</span>, outer.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">avatar</span>);</span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>MultiPlayerSocket</code> 中接收信息并向服务器后端发送请求：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">WebSocket</span>(<span class=\"string\">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_create_player</span>(<span class=\"params\">username, avatar</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"comment\">// stringify可以将JSON变为字符串</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;  <span class=\"comment\">// 向后台发送请求</span></span><br><span class=\"line\">            <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;create_player&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: outer.<span class=\"property\">uuid</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;username&#x27;</span>: username,</span><br><span class=\"line\">            <span class=\"string\">&#x27;avatar&#x27;</span>: avatar,</span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_create_player</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在编写后端接收到信息后的处理逻辑，接收到创建玩家的信息后需要将该玩家添加到房间中，并给房间中其他连接群发消息，组内各个连接接收到消息后再发送给前端即可：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> channels.generic.websocket <span class=\"keyword\">import</span> AsyncWebsocketConsumer</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.conf <span class=\"keyword\">import</span> settings</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayer</span>(<span class=\"title class_ inherited__\">AsyncWebsocketConsumer</span>):</span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">connect</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        self.room_name = <span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1000</span>):  <span class=\"comment\"># 假设暂定最多1000个房间</span></span><br><span class=\"line\">            name = <span class=\"string\">&#x27;room-%d&#x27;</span> % (i)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> cache.has_key(name) <span class=\"keyword\">or</span> <span class=\"built_in\">len</span>(cache.get(name)) &lt; settings.ROOM_CAPACITY:  <span class=\"comment\"># 判断当前房间是否可用</span></span><br><span class=\"line\">                self.room_name = name</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> self.room_name:  <span class=\"comment\"># 房间不足</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.accept()</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;accept&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> cache.has_key(self.room_name):  <span class=\"comment\"># 如果没有该房间需要创建房间</span></span><br><span class=\"line\">            cache.<span class=\"built_in\">set</span>(self.room_name, [], <span class=\"number\">3600</span>)  <span class=\"comment\"># 每局时长设置为1小时</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> player <span class=\"keyword\">in</span> cache.get(self.room_name):  <span class=\"comment\"># 发送房间所有玩家的信息到当前的本地客户端</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.send(text_data=json.dumps(&#123;  <span class=\"comment\"># dumps将字典变为字符串</span></span><br><span class=\"line\">                <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;create_player&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;uuid&#x27;</span>: player[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;username&#x27;</span>: player[<span class=\"string\">&#x27;username&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;avatar&#x27;</span>: player[<span class=\"string\">&#x27;avatar&#x27;</span>],</span><br><span class=\"line\">            &#125;))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_add(self.room_name, self.channel_name)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">disconnect</span>(<span class=\"params\">self, close_code</span>):</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;disconnect&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">create_player</span>(<span class=\"params\">self, data</span>):  <span class=\"comment\"># async表示异步函数</span></span><br><span class=\"line\">        players = cache.get(self.room_name)  <span class=\"comment\"># 获得房间信息</span></span><br><span class=\"line\">        players.append(&#123;  <span class=\"comment\"># 将当前玩家添加到房间里</span></span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: data[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">            <span class=\"string\">&#x27;username&#x27;</span>: data[<span class=\"string\">&#x27;username&#x27;</span>],</span><br><span class=\"line\">            <span class=\"string\">&#x27;avatar&#x27;</span>: data[<span class=\"string\">&#x27;avatar&#x27;</span>],</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        cache.<span class=\"built_in\">set</span>(self.room_name, players, <span class=\"number\">3600</span>)  <span class=\"comment\"># 存入Redis</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.channel_layer.group_send(  <span class=\"comment\"># 群发消息，有两个参数，一个是room_name，一个是需要发送的信息</span></span><br><span class=\"line\">            self.room_name,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"string\">&#x27;type&#x27;</span>: <span class=\"string\">&#x27;group_send_event&#x27;</span>,  <span class=\"comment\"># 很重要，表示将消息发送给组内的所有人，接收消息的函数就是type</span></span><br><span class=\"line\">                <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;create_player&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;uuid&#x27;</span>: data[<span class=\"string\">&#x27;uuid&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;username&#x27;</span>: data[<span class=\"string\">&#x27;username&#x27;</span>],</span><br><span class=\"line\">                <span class=\"string\">&#x27;avatar&#x27;</span>: data[<span class=\"string\">&#x27;avatar&#x27;</span>],</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">group_send_event</span>(<span class=\"params\">self, data</span>):  <span class=\"comment\"># 组内的每个连接接收到消息后直接发给前端即可</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> self.send(text_data=json.dumps(data))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">async</span> <span class=\"keyword\">def</span> <span class=\"title function_\">receive</span>(<span class=\"params\">self, text_data</span>):</span><br><span class=\"line\">        data = json.loads(text_data)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(data)</span><br><span class=\"line\"></span><br><span class=\"line\">        event = data[<span class=\"string\">&#x27;event&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> event == <span class=\"string\">&#x27;create_player&#x27;</span>:  <span class=\"comment\"># 做一个路由</span></span><br><span class=\"line\">            <span class=\"keyword\">await</span> self.create_player(data)</span><br></pre></td></tr></table></figure>\n<p>现在我们需要在前端处理接收 WSS 协议的信息，修改一下 <code>MultiPlayerSocket</code> 类：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MultiPlayerSocket</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">WebSocket</span>(<span class=\"string\">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">receive</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"property\">onmessage</span> = <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> data = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(e.<span class=\"property\">data</span>);  <span class=\"comment\">// 将字符串变回JSON</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> uuid = data.<span class=\"property\">uuid</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (uuid === outer.<span class=\"property\">uuid</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// 如果是给自己发送消息就直接过滤掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">let</span> event = data.<span class=\"property\">event</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (event === <span class=\"string\">&#x27;create_player&#x27;</span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"title function_\">receive_create_player</span>(uuid, data.<span class=\"property\">username</span>, data.<span class=\"property\">avatar</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">send_create_player</span>(<span class=\"params\">username, avatar</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"comment\">// stringify可以将JSON变为字符串</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ws</span>.<span class=\"title function_\">send</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123;  <span class=\"comment\">// 向后台发送请求</span></span><br><span class=\"line\">            <span class=\"string\">&#x27;event&#x27;</span>: <span class=\"string\">&#x27;create_player&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;uuid&#x27;</span>: outer.<span class=\"property\">uuid</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;username&#x27;</span>: username,</span><br><span class=\"line\">            <span class=\"string\">&#x27;avatar&#x27;</span>: avatar,</span><br><span class=\"line\">        &#125;));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">receive_create_player</span>(<span class=\"params\">uuid, username, avatar</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> player = <span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span> / <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">scale</span>, <span class=\"number\">0.5</span>, <span class=\"number\">0.05</span>, <span class=\"string\">&#x27;white&#x27;</span>, <span class=\"number\">0.15</span>, <span class=\"string\">&#x27;enemy&#x27;</span>, username, avatar);</span><br><span class=\"line\">        player.<span class=\"property\">uuid</span> = uuid;  <span class=\"comment\">// 每个Player的uuid为创建他的窗口的uuid</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(player);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在我们多开窗口即可看到多名玩家同步到一个地图上了。</p>\n<p>上一章：<a href=\"/posts/57210.html\">Django学习笔记-AcApp端授权AcWing一键登录</a>。</p>\n<p>下一章：<a href=\"/posts/60167.html\">Django学习笔记-实现联机对战（下）</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/57210.html",
            "url": "https://asanosaki.github.io/posts/57210.html",
            "title": "Django学习笔记-AcApp端授权AcWing一键登录",
            "date_published": "2023-08-26T11:59:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是通过 OAuth2 实现 AcApp 端的 AcWing 一键登录功能。<br>\nAcApp 端使用 AcWing 一键授权登录的流程与之前网页端的流程一样，只有申请授权码这一步有一点细微的差别。</p>\n</blockquote>\n<span id=\"more\"></span>\n<p>我们在打开 AcApp 应用之后会自动向 AcWing 请求账号登录，客户端会向后端服务器请求一些参数，然后后端服务器向 AcWing 请求授权码，然后 AcWing 在接到请求之后会询问用户是否要授权登录，如果用户同意了那么 AcWing 会给客户端发送一个授权码，客户端可以通过授权码加上自己的身份信息向 AcWing 服务器请求自己的授权令牌 <code>access_token</code> 和用户的 <code>openid</code>，最后客户端在拿到令牌和 ID 后即可向 AcWing 服务器请求用户的用户名和头像等信息。</p>\n<p>在网页端授权登录时我们使用的方法是通过 URL 的方式重定向到某一个链接里申请授权码，而这次的 AcApp 不是通过链接，而是通过 AcWing 的一个 API 申请，请求授权码的 API：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">AcWingOS</span>.<span class=\"property\">api</span>.<span class=\"property\">oauth2</span>.<span class=\"title function_\">authorize</span>(appid, redirect_uri, scope, state, callback);</span><br></pre></td></tr></table></figure>\n<p>参数说明：</p>\n<ul>\n<li><code>appid</code>：应用的唯一 ID，可以在 AcWing 编辑 AcApp 的界面里看到；</li>\n<li><code>redirect_uri</code>：接收授权码的地址，表示 AcWing 端要将授权码返回到哪个链接，需要对链接进行编码：Python3 中使用 <code>urllib.parse.quote</code>；Java 中使用 <code>URLEncoder.encode</code>；</li>\n<li><code>scope</code>：申请授权的范围，目前只需填 <code>userinfo</code>；</li>\n<li><code>state</code>：用于判断请求和回调的一致性，授权成功后原样返回该参数值，即接收授权码的地址需要判断是否是 AcWing 发来的请求（判断收到的 <code>state</code> 与发送出去的 <code>state</code> 是否相同），如果不是直接 Pass。该参数可用于防止 CSRF 攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数（如果是将第三方授权登录绑定到现有账号上，那么推荐用 <code>随机数 + user_id</code> 作为 <code>state</code> 的值，可以有效防止CSRF攻击）。此处 <code>state</code> 可以存到 Redis 中，设置两小时有效期；</li>\n<li><code>callback</code>：<code>redirect_uri</code> 返回后的回调函数，即接受 <code>receive_code</code> 函数向前端返回的信息。</li>\n</ul>\n<p>用户同意授权后，会将 <code>code</code> 和 <code>state</code> 传递给 <code>redirect_uri</code>。</p>\n<p>如果用户拒绝授权，则将会收到如下错误码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">errcode</span>: <span class=\"string\">&quot;40010&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">errmsg</span>: <span class=\"string\">&quot;user reject&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们在 <code>game/views/settings/acwing/acapp</code> 目录中将之前网页端的 <code>apply_code.py</code> 与 <code>receive_code.py</code> 复制过来，然后对 <code>apply_code.py</code> 进行一点小修改，这次不是返回一个链接，而是返回四个参数：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"><span class=\"keyword\">from</span> urllib.parse <span class=\"keyword\">import</span> quote</span><br><span class=\"line\"><span class=\"keyword\">from</span> random <span class=\"keyword\">import</span> randint</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get_state</span>():  <span class=\"comment\"># 获得8位长度的随机数</span></span><br><span class=\"line\">    res = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">8</span>):</span><br><span class=\"line\">        res += <span class=\"built_in\">str</span>(randint(<span class=\"number\">0</span>, <span class=\"number\">9</span>))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">apply_code</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    appid = <span class=\"string\">&#x27;4007&#x27;</span></span><br><span class=\"line\">    redirect_uri = quote(<span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/acwing/acapp/receive_code/&#x27;</span>)</span><br><span class=\"line\">    scope = <span class=\"string\">&#x27;userinfo&#x27;</span></span><br><span class=\"line\">    state = get_state()</span><br><span class=\"line\">    cache.<span class=\"built_in\">set</span>(state, <span class=\"literal\">True</span>, <span class=\"number\">7200</span>)  <span class=\"comment\"># 有效期2小时</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 需要返回四个参数</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;appid&#x27;</span>: appid,</span><br><span class=\"line\">        <span class=\"string\">&#x27;redirect_uri&#x27;</span>: redirect_uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;scope&#x27;</span>: scope,</span><br><span class=\"line\">        <span class=\"string\">&#x27;state&#x27;</span>: state,</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p>进入 <code>game/urls/settings/acwing</code> 修改一下路由：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.acwing.web.apply_code <span class=\"keyword\">import</span> apply_code <span class=\"keyword\">as</span> web_apply_code</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.acwing.web.receive_code <span class=\"keyword\">import</span> receive_code <span class=\"keyword\">as</span> web_receive_code</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.acwing.acapp.apply_code <span class=\"keyword\">import</span> apply_code <span class=\"keyword\">as</span> acapp_apply_code</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.acwing.acapp.receive_code <span class=\"keyword\">import</span> receive_code <span class=\"keyword\">as</span> acapp_receive_code</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;web/apply_code/&#x27;</span>, web_apply_code, name=<span class=\"string\">&#x27;settings_acwing_web_apply_code&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;web/receive_code/&#x27;</span>, web_receive_code, name=<span class=\"string\">&#x27;settings_acwing_web_receive_code&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;acapp/apply_code/&#x27;</span>, acapp_apply_code, name=<span class=\"string\">&#x27;settings_acwing_acapp_apply_code&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;acapp/receive_code/&#x27;</span>, acapp_receive_code, name=<span class=\"string\">&#x27;settings_acwing_acapp_receive_code&#x27;</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>现在访问 <code>https://app4007.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/</code> 即可看到返回内容。</p>\n<p>然后我们修改一下 <code>receive_code.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth.models <span class=\"keyword\">import</span> User</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.models.player.player <span class=\"keyword\">import</span> Player</span><br><span class=\"line\"><span class=\"keyword\">from</span> random <span class=\"keyword\">import</span> randint</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">receive_code</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    data = request.GET</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"string\">&#x27;errcode&#x27;</span> <span class=\"keyword\">in</span> data:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;apply failed&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;errcode&#x27;</span>: data[<span class=\"string\">&#x27;errcode&#x27;</span>],</span><br><span class=\"line\">            <span class=\"string\">&#x27;errmsg&#x27;</span>: data[<span class=\"string\">&#x27;errmsg&#x27;</span>],</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    code = data.get(<span class=\"string\">&#x27;code&#x27;</span>)</span><br><span class=\"line\">    state = data.get(<span class=\"string\">&#x27;state&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> cache.has_key(state):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;state not exist&#x27;</span>,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    cache.delete(state)</span><br><span class=\"line\"></span><br><span class=\"line\">    apply_access_token_url = <span class=\"string\">&#x27;https://www.acwing.com/third_party/api/oauth2/access_token/&#x27;</span></span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;appid&#x27;</span>: <span class=\"string\">&#x27;4007&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;secret&#x27;</span>: <span class=\"string\">&#x27;0edf233ee876407ea3542220e2a8d83e&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;code&#x27;</span>: code</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_token_res = requests.get(apply_access_token_url, params=params).json()  <span class=\"comment\"># 申请授权令牌</span></span><br><span class=\"line\">    access_token = access_token_res[<span class=\"string\">&#x27;access_token&#x27;</span>]</span><br><span class=\"line\">    openid = access_token_res[<span class=\"string\">&#x27;openid&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    players = Player.objects.<span class=\"built_in\">filter</span>(openid=openid)  <span class=\"comment\"># filter不管存不存在都会返回一个列表，get如果不存在会报异常</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> players.exists():  <span class=\"comment\"># 用户如果已存在就直接返回用户</span></span><br><span class=\"line\">        player = players[<span class=\"number\">0</span>]</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;username&#x27;</span>: player.user.username,</span><br><span class=\"line\">            <span class=\"string\">&#x27;avatar&#x27;</span>: player.avatar,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    get_userinfo_url = <span class=\"string\">&#x27;https://www.acwing.com/third_party/api/meta/identity/getinfo/&#x27;</span></span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;access_token&#x27;</span>: access_token,</span><br><span class=\"line\">        <span class=\"string\">&#x27;openid&#x27;</span>: openid</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    get_userinfo_res = requests.get(get_userinfo_url, params=params).json()  <span class=\"comment\"># 申请获取用户信息</span></span><br><span class=\"line\">    username = get_userinfo_res[<span class=\"string\">&#x27;username&#x27;</span>]</span><br><span class=\"line\">    avatar = get_userinfo_res[<span class=\"string\">&#x27;photo&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> User.objects.<span class=\"built_in\">filter</span>(username=username).exists():  <span class=\"comment\"># 如果当前用户的用户名已经存在则在其后面添加若干位随机数</span></span><br><span class=\"line\">        username += <span class=\"built_in\">str</span>(randint(<span class=\"number\">0</span>, <span class=\"number\">9</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    user = User.objects.create(username=username)  <span class=\"comment\"># 创建该用户，没有密码</span></span><br><span class=\"line\">    player = Player.objects.create(user=user, avatar=avatar, openid=openid)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;username&#x27;</span>: player.user.username,</span><br><span class=\"line\">        <span class=\"string\">&#x27;avatar&#x27;</span>: player.avatar,</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p>接着我们修改前端文件，也就是 <code>game/static/js/src/settings</code> 目录中的 <code>Settings</code> 类：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Settings</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> = <span class=\"string\">&#x27;WEB&#x27;</span>;  <span class=\"comment\">// 默认为Web前端</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">acwingos</span>) <span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> = <span class=\"string\">&#x27;ACAPP&#x27;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">username</span> = <span class=\"string\">&#x27;&#x27;</span>;  <span class=\"comment\">// 初始用户信息为空</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">avatar</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            ...</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在初始化时需要从服务器端获取用户信息</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> === <span class=\"string\">&#x27;WEB&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">getinfo_web</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">getinfo_acapp</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 绑定监听函数</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_login</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_register</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登录</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上注册</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">acwing_login</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开注册界面</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开登录界面</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo_web</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 此处将之前的getinfo函数名进行了修改用来区分</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/getinfo/&#x27;</span>,  <span class=\"comment\">// 用AcWing部署</span></span><br><span class=\"line\">            <span class=\"comment\">// url: &#x27;http://8.130.54.44:8000/settings/getinfo/&#x27;,  // 用云服务器部署</span></span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">platform</span>: outer.<span class=\"property\">platform</span>,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;  <span class=\"comment\">// 调用成功的回调函数，返回的Json字典会传给resp</span></span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);  <span class=\"comment\">// 控制台输出查看结果</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">username</span> = resp.<span class=\"property\">username</span>;</span><br><span class=\"line\">                    outer.<span class=\"property\">avatar</span> = resp.<span class=\"property\">avatar</span>;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">                    outer.<span class=\"property\">root</span>.<span class=\"property\">menu</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// 如果未登录则需要弹出登录界面</span></span><br><span class=\"line\">                    outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">acapp_login</span>(<span class=\"params\">appid, redirect_uri, scope, state</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"comment\">// resp是redirect_uri的返回值，此处为用户名和头像</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">acwingos</span>.<span class=\"property\">api</span>.<span class=\"property\">oauth2</span>.<span class=\"title function_\">authorize</span>(appid, redirect_uri, scope, state, <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                outer.<span class=\"property\">username</span> = resp.<span class=\"property\">username</span>;</span><br><span class=\"line\">                outer.<span class=\"property\">avatar</span> = resp.<span class=\"property\">avatar</span>;</span><br><span class=\"line\">                outer.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">                outer.<span class=\"property\">root</span>.<span class=\"property\">menu</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo_acapp</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">acapp_login</span>(resp.<span class=\"property\">appid</span>, resp.<span class=\"property\">redirect_uri</span>, resp.<span class=\"property\">scope</span>, resp.<span class=\"property\">state</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注意，如果遇到跨域问题：<code>Access to XMLHttpRequest at 'XXX'</code>，大概率是某个文件的内容写错了，可以检查 uWSGI 启动后的报错内容修改代码。</p>\n<p>上一章：<a href=\"/posts/56617.html\">Django学习笔记-VS Code本地运行项目</a>。</p>\n<p>下一章：<a href=\"/posts/31494.html\">Django学习笔记-实现联机对战（上）</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/56617.html",
            "url": "https://asanosaki.github.io/posts/56617.html",
            "title": "Django学习笔记-VS Code本地运行项目",
            "date_published": "2023-07-06T05:19:00.000Z",
            "content_html": "<blockquote>\n<p>截止到上一章节，我们的项目一直是部署在云服务器上，包括编写代码以及调试运行也是在云服务器上，现在我们尝试将其放回 Windows 本地环境运行。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 将项目传到本地</h1>\n<p>这一步可以使用 Git 也可以使用 SCP，由于之前项目上传在 AcGit 上，只能在 AC Terminal 中拉取，因此使用 SCP 远程传输：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">scp -r -P 20000 asanosaki@&lt;公网IP&gt;:djangoapp .  # 在要存放项目的目录执行该指令</span><br></pre></td></tr></table></figure>\n<h1>2. 虚拟环境配置</h1>\n<p>我们需要先配置一个和云服务上相同的虚拟环境，首先在 VS Code 中打开该项目并且打开终端，在项目根目录下创建虚拟环境：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -m venv venv</span><br></pre></td></tr></table></figure>\n<p>虚拟环境创建成功之后，一般不会自动启用，所以需要启用它，进入 <code>venv/Scripts</code> 目录运行脚本 <code>Activate.ps1</code>：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd .\\venv\\Scripts\\</span><br><span class=\"line\">.\\Activate.ps1</span><br></pre></td></tr></table></figure>\n<p>此时在 VS Code 中可以看到命令行首部多了 <code>(venv)</code>，说明已进入虚拟环境，然后在右下角选择虚拟环境中的解释器即可。</p>\n<p>现在我们在虚拟环境中安装所需的环境：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install django</span><br></pre></td></tr></table></figure>\n<h1>3. 修改项目相关文件</h1>\n<p>首先修改一下我们的打包脚本 <code>compress_game_js.sh</code>：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">! /bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">JS_PATH=../game/static/js/</span><br><span class=\"line\">JS_PATH_DIST=$&#123;JS_PATH&#125;dist/</span><br><span class=\"line\">JS_PATH_SRC=$&#123;JS_PATH&#125;src/</span><br><span class=\"line\"></span><br><span class=\"line\">find $&#123;JS_PATH_SRC&#125; -type f -name &#x27;*.js&#x27; | sort | xargs cat &gt; $&#123;JS_PATH_DIST&#125;game.js</span><br></pre></td></tr></table></figure>\n<p>然后打开 Git Bash，进入 <code>scripts</code> 文件夹即可运行脚本：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sh compress_game_js.sh</span><br></pre></td></tr></table></figure>\n<p>然后将 <code>djangoapp/settings.py</code> 中的 Redis 配置删除，即删除以下这段话：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CACHES = &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;default&#x27;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;BACKEND&#x27;</span>: <span class=\"string\">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;LOCATION&#x27;</span>: <span class=\"string\">&#x27;redis://127.0.0.1:6379/1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;CLIENT_CLASS&quot;</span>: <span class=\"string\">&quot;django_redis.client.DefaultClient&quot;</span>,</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">USER_AGENTS_CACHE = <span class=\"string\">&#x27;default&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>同样在该文件中需要将 <code>localhost</code> 添加到 <code>ALLOWED_HOSTS</code> 中：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ALLOWED_HOSTS = [<span class=\"string\">&quot;8.130.54.44&quot;</span>, <span class=\"string\">&quot;app4007.acapp.acwing.com.cn&quot;</span>, <span class=\"string\">&quot;localhost&quot;</span>]</span><br></pre></td></tr></table></figure>\n<p>然后将 AcWing 一键授权登录的相关文件夹删除：<code>game/views/settings/acwing</code>、<code>game/urls/settings/acwing</code>，然后修改 <code>urls/settings/index.py</code> 中的路由：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.getinfo <span class=\"keyword\">import</span> getinfo</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.login <span class=\"keyword\">import</span> mylogin</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.logout <span class=\"keyword\">import</span> mylogout</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.register <span class=\"keyword\">import</span> register</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;getinfo/&#x27;</span>, getinfo, name=<span class=\"string\">&#x27;settings_getinfo&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;login/&#x27;</span>, mylogin, name=<span class=\"string\">&#x27;settings_login&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;logout/&#x27;</span>, mylogout, name=<span class=\"string\">&#x27;settings_logout&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;register/&#x27;</span>, register, name=<span class=\"string\">&#x27;settings_register&#x27;</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>修改 <code>AcGame</code> 类，去掉 AcWingOS API，且改为非模块化引入 JS 方式，即去掉 <code>export</code> 关键字：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGame</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">id</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">id</span> = id;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$ac_game</span> = $(<span class=\"string\">&#x27;#&#x27;</span> + id);  <span class=\"comment\">// jQuery通过id找对象的方式</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">settings</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Settings</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">menu</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGameMenu</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGamePlayground</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>同时前端的 <code>web.html</code> 文件也需要修改：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% load static %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&#123;% static &#x27;css/jquery-ui.min.css&#x27; %&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;&#123;% static &#x27;js/jquery-3.6.1.min.js&#x27; %&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&#123;% static &#x27;css/game.css&#x27; %&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;&#123;% static &#x27;js/dist/game.js&#x27; %&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;margin: 0&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;ac_game_1&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        $(<span class=\"variable language_\">document</span>).<span class=\"title function_\">ready</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"keyword\">let</span> ac_game = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGame</span>(<span class=\"string\">&quot;ac_game_1&quot;</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>最后修改 <code>Settings</code> 类，去掉 AcWing 一键登录功能，且修改 <code>ajax</code> 请求的地址：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Settings</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> = <span class=\"string\">&#x27;WEB&#x27;</span>;  <span class=\"comment\">// 默认为Web前端</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">username</span> = <span class=\"string\">&#x27;&#x27;</span>;  <span class=\"comment\">// 初始用户信息为空</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">avatar</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_settings&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=&#x27;ac_game_settings_login&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_title&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        Login</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_username&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;text&#x27; placeholder=&#x27;Username&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_password&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;password&#x27; placeholder=&#x27;Password&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_submit&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;button&gt;Login&lt;/button&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_errormessage&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_option&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        Register</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=&#x27;ac_game_settings_register&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_title&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        Register</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_username&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;text&#x27; placeholder=&#x27;Username&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_password ac_game_settings_password_first&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;password&#x27; placeholder=&#x27;Password&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_password ac_game_settings_password_second&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;password&#x27; placeholder=&#x27;Confirm Password&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_submit&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;button&gt;Register&lt;/button&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_errormessage&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_option&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        Login</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_login&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_username</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_username input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_password</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_password input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_submit</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_submit button&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_errormessage</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_errormessage&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_register</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_option&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_register&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_username</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_username input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_password</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_password_first input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_confirm_password</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_password_second input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_submit</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_submit button&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_errormessage</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_errormessage&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_login</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_option&#x27;</span>)</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在初始化时需要从服务器端获取用户信息</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">getinfo</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 绑定监听函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events_login</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events_register</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_login</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_register</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">register</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_submit</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">login_on_remote</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_register</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_login</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_submit</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">register_on_remote</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登录</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> username = <span class=\"variable language_\">this</span>.<span class=\"property\">$login_username</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> password = <span class=\"variable language_\">this</span>.<span class=\"property\">$login_password</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_errormessage</span>.<span class=\"title function_\">empty</span>();  <span class=\"comment\">// 先清空报错信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;http://localhost:8000/settings/login/&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">username</span>: username,</span><br><span class=\"line\">                <span class=\"attr\">password</span>: password,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;  <span class=\"comment\">// 登录成功</span></span><br><span class=\"line\">                    location.<span class=\"title function_\">reload</span>();  <span class=\"comment\">// 刷新页面</span></span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// 登录失败</span></span><br><span class=\"line\">                    outer.<span class=\"property\">$login_errormessage</span>.<span class=\"title function_\">html</span>(resp.<span class=\"property\">result</span>);  <span class=\"comment\">// 显示报错信息</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上注册</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> username = <span class=\"variable language_\">this</span>.<span class=\"property\">$register_username</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> password = <span class=\"variable language_\">this</span>.<span class=\"property\">$register_password</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> confirm_password = <span class=\"variable language_\">this</span>.<span class=\"property\">$register_confirm_password</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_errormessage</span>.<span class=\"title function_\">empty</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;http://localhost:8000/settings/register/&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">username</span>: username,</span><br><span class=\"line\">                <span class=\"attr\">password</span>: password,</span><br><span class=\"line\">                <span class=\"attr\">confirm_password</span>: confirm_password,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    location.<span class=\"title function_\">reload</span>();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">$register_errormessage</span>.<span class=\"title function_\">html</span>(resp.<span class=\"property\">result</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">logout_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登出</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> === <span class=\"string\">&#x27;ACAPP&#x27;</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;  <span class=\"comment\">// AcApp应该是直接关闭窗口退出</span></span><br><span class=\"line\"></span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;http://localhost:8000/settings/logout/&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    location.<span class=\"title function_\">reload</span>();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开注册界面</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开登录界面</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;http://localhost:8000/settings/getinfo/&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">platform</span>: outer.<span class=\"property\">platform</span>,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;  <span class=\"comment\">// 调用成功的回调函数，返回的Json字典会传给resp</span></span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);  <span class=\"comment\">// 控制台输出查看结果</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">username</span> = resp.<span class=\"property\">username</span>;</span><br><span class=\"line\">                    outer.<span class=\"property\">avatar</span> = resp.<span class=\"property\">avatar</span>;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">                    outer.<span class=\"property\">root</span>.<span class=\"property\">menu</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// 如果未登录则需要弹出登录界面</span></span><br><span class=\"line\">                    outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>顺带还需要修改一下 <code>game.css</code>：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.ac_game_menu</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">background-image</span>: <span class=\"built_in\">url</span>(<span class=\"string\">&#x27;/static/image/menu/background2.jpeg&#x27;</span>);  <span class=\"comment\">/* 注意不用带公网IP */</span></span><br><span class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">100%</span> <span class=\"number\">100%</span>;</span><br><span class=\"line\">    user-select: none;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">30%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">20%</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup_bt</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">15vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">3vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">font-style</span>: italic;</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">    <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">39</span>, <span class=\"number\">21</span>, <span class=\"number\">28</span>, <span class=\"number\">0.6</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">10px</span>;</span><br><span class=\"line\">    <span class=\"attribute\">letter-spacing</span>: <span class=\"number\">0.5vw</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup_bt</span><span class=\"selector-pseudo\">:hover</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">scale</span>(<span class=\"number\">1.2</span>);</span><br><span class=\"line\">    <span class=\"attribute\">transition</span>: <span class=\"number\">100ms</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_playground</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    user-select: none;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">background-image</span>: <span class=\"built_in\">url</span>(<span class=\"string\">&#x27;/static/image/menu/background2.jpeg&#x27;</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">100%</span> <span class=\"number\">100%</span>;</span><br><span class=\"line\">    user-select: none;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_login</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">32vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0.7</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">5px</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_register</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">39vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0.7</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">5px</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_title</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">3.5vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_username</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_password</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_submit</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_errormessage</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: red;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">1.5vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: inline;</span><br><span class=\"line\">    <span class=\"attribute\">float</span>: left;</span><br><span class=\"line\">    <span class=\"attribute\">padding-left</span>: <span class=\"number\">1vw</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_option</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">1.5vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: inline;</span><br><span class=\"line\">    <span class=\"attribute\">float</span>: right;</span><br><span class=\"line\">    <span class=\"attribute\">padding-right</span>: <span class=\"number\">1vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_item</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_item</span> &gt; <span class=\"selector-tag\">input</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">90%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">3vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_item</span> &gt; <span class=\"selector-tag\">button</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: black;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">30%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">3vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">2vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgb</span>(<span class=\"number\">199</span>, <span class=\"number\">237</span>, <span class=\"number\">204</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">7px</span>;</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>到此已经可以在本地运行该项目了，我们也可以根据<a href=\"https://blog.csdn.net/m0_51755720/article/details/132521497\"> Django 学习笔记-实现联机对战（上）</a>和<a href=\"https://blog.csdn.net/m0_51755720/article/details/133273444\"> Django 学习笔记-实现联机对战（下）</a>统一长度单位以及添加闪现技能与技能冷却，因为这些部分与云端内容无关。</p>\n<p>最后我们将 <code>.git</code> 文件夹删除，重新上传至 Github（先创建一个仓库 <code>Small_Ball_Fight</code>）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git init</span><br><span class=\"line\">git remote add origin git@github.com:AsanoSaki/Small_Ball_Fight.git</span><br><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m &quot;create small ball fight&quot;</span><br><span class=\"line\">git push --set-upstream origin master</span><br></pre></td></tr></table></figure>\n<p>上一章：<a href=\"/posts/54821.html\">Django学习笔记-Web端授权AcWing一键登录</a>。</p>\n<p>下一章：<a href=\"/posts/57210.html\">Django学习笔记-AcApp端授权AcWing一键登录</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/54821.html",
            "url": "https://asanosaki.github.io/posts/54821.html",
            "title": "Django学习笔记-Web端授权AcWing一键登录",
            "date_published": "2023-06-27T15:19:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是通过 OAuth2 实现网页端的 AcWing 一键登录功能。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 在Django中集成Redis</h1>\n<p>Redis 为内存数据库，目前我们使用的是 Django 自带的数据库 SQLite，且能够很容易地迁移到 MySQL，这些数据库的效率不如 Redis，其特点为：</p>\n<ul>\n<li>Redis 存的内容为 <code>key, value</code> 对，而其它数据库存的是若干张表，每张表为若干条目；</li>\n<li>Redis 为单线程的，不会出现读写冲突。</li>\n</ul>\n<p>首先我们需要先安装 Redis：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install redis-server</span><br><span class=\"line\">sudo service redis-server status  # 查看redis-server状态</span><br><span class=\"line\">pip install django_redis</span><br></pre></td></tr></table></figure>\n<p>接着配置一下 Django 的缓存机制，将下面这段代码复制到 <code>settings.py</code> 中：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CACHES = &#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;default&#x27;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;BACKEND&#x27;</span>: <span class=\"string\">&#x27;django_redis.cache.RedisCache&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;LOCATION&#x27;</span>: <span class=\"string\">&#x27;redis://127.0.0.1:6379/1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;CLIENT_CLASS&quot;</span>: <span class=\"string\">&quot;django_redis.client.DefaultClient&quot;</span>,</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">USER_AGENTS_CACHE = <span class=\"string\">&#x27;default&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>然后启动 <code>redis-server</code>，启动后可以使用 <code>top</code> 命令查看 <code>redis-server</code> 是否运行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>\n<p>此时在项目根目录执行 <code>python3 manage.py shell</code> 进入 IPython 交互界面，输入以下代码测试一下 Redis：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">In [<span class=\"number\">1</span>]: <span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">2</span>]: cache.keys(<span class=\"string\">&#x27;*&#x27;</span>)  <span class=\"comment\"># 查找当前数据库的所有关键字，支持正则匹配</span></span><br><span class=\"line\">Out[<span class=\"number\">2</span>]: []</span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">3</span>]: cache.<span class=\"built_in\">set</span>(<span class=\"string\">&#x27;yyj&#x27;</span>, <span class=\"number\">1</span>, <span class=\"number\">5</span>)  <span class=\"comment\"># 设置关键字，第三个参数表示多长时间过期，单位是秒，None表示不会过期</span></span><br><span class=\"line\">Out[<span class=\"number\">3</span>]: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">4</span>]: cache.<span class=\"built_in\">set</span>(<span class=\"string\">&#x27;abc&#x27;</span>, <span class=\"number\">2</span>, <span class=\"literal\">None</span>)</span><br><span class=\"line\">Out[<span class=\"number\">4</span>]: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">5</span>]: cache.has_key(<span class=\"string\">&#x27;abc&#x27;</span>)  <span class=\"comment\"># 查询某个键是否存在</span></span><br><span class=\"line\">Out[<span class=\"number\">5</span>]: <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">6</span>]: cache.has_key(<span class=\"string\">&#x27;yyj&#x27;</span>)</span><br><span class=\"line\">Out[<span class=\"number\">6</span>]: <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">7</span>]: cache.get(<span class=\"string\">&#x27;abc&#x27;</span>)  <span class=\"comment\"># 查询某个键的值</span></span><br><span class=\"line\">Out[<span class=\"number\">7</span>]: <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">8</span>]: cache.delete(<span class=\"string\">&#x27;abc&#x27;</span>)  <span class=\"comment\"># 删除某个关键字</span></span><br><span class=\"line\">Out[<span class=\"number\">8</span>]: <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\n<p>注意如果出现报错：<code>ConnectionError: Error 111 connecting to 127.0.0.1:6379. Connection refused.</code> 说明 <code>redis-server</code> 没有启动。</p>\n<h1>2. 申请授权码</h1>\n<p>一键授权登录的流程是用户点击一键登录后弹出确认授权的页面，用户确认后就自动创建一个新的账号，且登录到网站里。</p>\n<p>具体交互流程为：用户点击按钮后向网站服务器端（Web）发起申请，请求用 AcWing 账号登录，然后 Web 将自己的 <code>AppID</code> 报给 AcWing，AcWing 给用户返回一个页面询问用户是否要授权给刚刚的网站，如果用户同意，那么 AcWing 会将一个授权码 <code>code</code>（两小时有效期）发给 Web，Web 接到授权码后再加上自己的身份信息 <code>AppSecret</code> 以及 <code>AppID</code> 向 AcWing 申请一个授权令牌 <code>access-token</code>（两小时有效期）和用户的 <code>openid</code>（唯一辨别用户），Web 拿到令牌和用户 ID 后即可向 AcWing 申请用户的用户名和头像。</p>\n<p>由于我们需要记录每个用户的 <code>openid</code>，因此我们需要在数据库（<code>game/models/player/</code>）的 <code>Player</code> 类中添加一个信息：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.db <span class=\"keyword\">import</span> models</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth.models <span class=\"keyword\">import</span> User</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Player有两个关键字，user表示是和哪个User对应的，avatar表示头像</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span>(models.Model):</span><br><span class=\"line\">    user = models.OneToOneField(User, on_delete=models.CASCADE)  <span class=\"comment\"># 当删除User时也将其关联的Player一块删掉</span></span><br><span class=\"line\">    avatar = models.URLField(max_length=<span class=\"number\">256</span>, blank=<span class=\"literal\">True</span>)  <span class=\"comment\"># 头像用链接存</span></span><br><span class=\"line\">    openid = models.CharField(default=<span class=\"string\">&#x27;&#x27;</span>, max_length=<span class=\"number\">50</span>, blank=<span class=\"literal\">True</span>, null=<span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__str__</span>(<span class=\"params\">self</span>):  <span class=\"comment\"># 显示每个Player的数据</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">str</span>(self.user)</span><br></pre></td></tr></table></figure>\n<p>在根目录下更新一下数据库：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 manage.py makemigrations</span><br><span class=\"line\">python3 manage.py migrate</span><br></pre></td></tr></table></figure>\n<p>申请授权码的请求地址：<code>https://www.acwing.com/third_party/api/oauth2/web/authorize/</code>。</p>\n<p>请求方法为 <code>GET</code>，参考示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.acwing.com/third_party/api/oauth2/web/authorize/?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;scope=SCOPE&amp;state=STATE</span><br></pre></td></tr></table></figure>\n<p>参数说明：</p>\n<ul>\n<li><code>appid</code>：应用的唯一 ID，可以在 AcWing 编辑 AcApp 的界面里看到；</li>\n<li><code>redirect_uri</code>：接收授权码的地址，表示 AcWing 端要将授权码返回到哪个链接，需要对链接进行编码：Python3 中使用 <code>urllib.parse.quote</code>；Java 中使用 <code>URLEncoder.encode</code>；</li>\n<li><code>scope</code>：申请授权的范围，目前只需填 <code>userinfo</code>；</li>\n<li><code>state</code>：用于判断请求和回调的一致性，授权成功后原样返回该参数值，即接收授权码的地址需要判断是否是 AcWing 发来的请求（判断收到的 <code>state</code> 与发送出去的 <code>state</code> 是否相同），如果不是直接 Pass。该参数可用于防止 CSRF 攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数（如果是将第三方授权登录绑定到现有账号上，那么推荐用 <code>随机数 + user_id</code> 作为 <code>state</code> 的值，可以有效防止 CSRF 攻击）。此处 <code>state</code> 可以存到 Redis 中，设置两小时有效期。</li>\n</ul>\n<p>用户同意授权后会重定向到 <code>redirect_uri</code>，返回参数为 <code>code</code> 和 <code>state</code>。链接格式如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redirect_uri?code=CODE&amp;state=STATE</span><br></pre></td></tr></table></figure>\n<p>如果用户拒绝授权，则不会发生重定向。</p>\n<p>我们在 <code>game/views/settings</code> 目录中创建一个 <code>acwing</code> 目录表示 AcWing 授权登录，然后在该目录中先创建一个 <code>__init__.py</code>，再创建两个子目录 <code>web</code> 和 <code>acapp</code> 分别表示 Web 端的 AcWing 一键登录以及 AcApp 端的 AcWing 一键登录，最后同样在这两个子目录中创建 <code>__init__.py</code> 文件。</p>\n<p>在 <code>web</code> 目录下创建申请授权码的 API <code>apply_code.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">apply_code</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    appid = <span class=\"string\">&#x27;4007&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p>接着创建接收授权码的 API <code>receive_code.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> redirect</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">receive_code</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    <span class=\"keyword\">return</span> redirect(<span class=\"string\">&#x27;index&#x27;</span>)  <span class=\"comment\"># 重定向回index</span></span><br></pre></td></tr></table></figure>\n<p>然后在 <code>game/urls/settings</code> 目录中也创建一个 <code>acwing</code> 目录，在该目录中创建 <code>__init__.py</code> 和 <code>index.py</code>，<code>index.py</code> 内容如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.acwing.web.apply_code <span class=\"keyword\">import</span> apply_code</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.acwing.web.receive_code <span class=\"keyword\">import</span> receive_code</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;web/apply_code/&#x27;</span>, apply_code, name=<span class=\"string\">&#x27;settings_acwing_web_apply_code&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;web/receive_code/&#x27;</span>, receive_code, name=<span class=\"string\">&#x27;settings_acwing_web_receive_code&#x27;</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>然后需要将该目录 <code>include</code> 进 <code>settings</code> 目录的 <code>index.py</code> 中：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path, include</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.getinfo <span class=\"keyword\">import</span> getinfo</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.login <span class=\"keyword\">import</span> mylogin</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.logout <span class=\"keyword\">import</span> mylogout</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.register <span class=\"keyword\">import</span> register</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;getinfo/&#x27;</span>, getinfo, name=<span class=\"string\">&#x27;settings_getinfo&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;login/&#x27;</span>, mylogin, name=<span class=\"string\">&#x27;settings_login&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;logout/&#x27;</span>, mylogout, name=<span class=\"string\">&#x27;settings_logout&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;register/&#x27;</span>, register, name=<span class=\"string\">&#x27;settings_register&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;acwing/&#x27;</span>, include(<span class=\"string\">&#x27;game.urls.settings.acwing.index&#x27;</span>)),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>重启项目后即可访问 <code>https://&lt;公网IP&gt;/settings/acwing/web/apply_code/</code> 以及 <code>https://&lt;公网IP&gt;/settings/acwing/web/receive_code/</code> 测试效果。</p>\n<p>现在来看看 <code>urllib.parse.quote</code> 的作用，它能够将链接重新编码，替换掉原本的部分特殊字符防止出现 BUG：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">In [<span class=\"number\">1</span>]: <span class=\"keyword\">from</span> urllib.parse <span class=\"keyword\">import</span> quote</span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">2</span>]: url = <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/acwing/web/receive_code/?args=yyj&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">In [<span class=\"number\">3</span>]: quote(url)</span><br><span class=\"line\">Out[<span class=\"number\">3</span>]: <span class=\"string\">&#x27;https%3A//app4007.acapp.acwing.com.cn/settings/acwing/web/receive_code/%3Fargs%3Dyyj&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>现在我们完善一下 <code>apply_code.py</code> 的内容：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"><span class=\"keyword\">from</span> urllib.parse <span class=\"keyword\">import</span> quote</span><br><span class=\"line\"><span class=\"keyword\">from</span> random <span class=\"keyword\">import</span> randint</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">get_state</span>():  <span class=\"comment\"># 获得8位长度的随机数</span></span><br><span class=\"line\">    res = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">8</span>):</span><br><span class=\"line\">        res += <span class=\"built_in\">str</span>(randint(<span class=\"number\">0</span>, <span class=\"number\">9</span>))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> res</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">apply_code</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    appid = <span class=\"string\">&#x27;4007&#x27;</span></span><br><span class=\"line\">    redirect_uri = quote(<span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/acwing/web/receive_code/&#x27;</span>)</span><br><span class=\"line\">    scope = <span class=\"string\">&#x27;userinfo&#x27;</span></span><br><span class=\"line\">    state = get_state()</span><br><span class=\"line\">    cache.<span class=\"built_in\">set</span>(state, <span class=\"literal\">True</span>, <span class=\"number\">7200</span>)  <span class=\"comment\"># 有效期2小时</span></span><br><span class=\"line\">    apply_code_url = <span class=\"string\">&#x27;https://www.acwing.com/third_party/api/oauth2/web/authorize/&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;apply_code_url&#x27;</span>: apply_code_url + <span class=\"string\">&#x27;?appid=%s&amp;redirect_uri=%s&amp;scope=%s&amp;state=%s&#x27;</span> % (appid, redirect_uri, scope, state)</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p>然后修改一下前端代码（<code>Settings</code> 类）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Settings</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$acwingoption</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_acwingoption img&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在初始化时需要从服务器端获取用户信息</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 绑定监听函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events_login</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events_register</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_login</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_register</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">register</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_submit</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">login_on_remote</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$acwingoption</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">acwing_login</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_register</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登录</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上注册</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">logout_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登出</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">acwing_login</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/acwing/web/apply_code/&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    <span class=\"variable language_\">window</span>.<span class=\"property\">location</span>.<span class=\"title function_\">replace</span>(resp.<span class=\"property\">apply_code_url</span>);  <span class=\"comment\">// 将当前页面重定向</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开注册界面</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开登录界面</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>3. 申请授权令牌和用户ID</h1>\n<p>请求地址：<code>https://www.acwing.com/third_party/api/oauth2/access_token/</code>。</p>\n<p>请求方法为 <code>GET</code>，参考示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.acwing.com/third_party/api/oauth2/access_token/?appid=APPID&amp;secret=APPSECRET&amp;code=CODE</span><br></pre></td></tr></table></figure>\n<p>参数说明：</p>\n<ul>\n<li><code>appid</code>：应用的唯一 ID，可以在 AcWing 编辑 AcApp 的界面里看到；</li>\n<li><code>secret</code>：应用的秘钥，可以在 AcWing 编辑 AcApp 的界面里看到；</li>\n<li><code>code</code>：上一步中获取的授权码。</li>\n</ul>\n<p>申请成功的返回内容示例：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123; </span><br><span class=\"line\">    <span class=\"string\">&quot;access_token&quot;</span>: <span class=\"string\">&quot;ACCESS_TOKEN&quot;</span>, </span><br><span class=\"line\">    <span class=\"string\">&quot;expires_in&quot;</span>: <span class=\"number\">7200</span>, </span><br><span class=\"line\">    <span class=\"string\">&quot;refresh_token&quot;</span>: <span class=\"string\">&quot;REFRESH_TOKEN&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;openid&quot;</span>: <span class=\"string\">&quot;OPENID&quot;</span>, </span><br><span class=\"line\">    <span class=\"string\">&quot;scope&quot;</span>: <span class=\"string\">&quot;SCOPE&quot;</span>,</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>申请失败的返回内容示例：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;errcode&quot;</span>: <span class=\"number\">40001</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;errmsg&quot;</span>: <span class=\"string\">&quot;code expired&quot;</span>,  <span class=\"comment\"># 授权码过期</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>返回参数说明：</p>\n<ul>\n<li><code>access_token</code>：授权令牌，有效期2小时；</li>\n<li><code>expires_in</code>：授权令牌还有多久过期，单位（秒）；</li>\n<li><code>refresh_token</code>：用于刷新 <code>access_token</code> 的令牌，有效期30天；</li>\n<li><code>openid</code>：用户的 ID。每个 AcWing 用户在每个 AcApp 中授权的 <code>openid</code> 是唯一的，可用于识别用户；</li>\n<li><code>scope</code>：用户授权的范围。目前范围为 <code>userinfo</code>，包括用户名、头像。</li>\n</ul>\n<p>现在我们点击 AcWing 一键登录按钮即可跳出请求授权的页面，AcWing 会向 <code>receive_code</code> 函数发送 <code>code</code> 以及 <code>state</code>，现在我们完善 <code>receive_code.py</code> 接到授权后的操作：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> redirect</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">receive_code</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    data = request.GET</span><br><span class=\"line\">    code = data.get(<span class=\"string\">&#x27;code&#x27;</span>)</span><br><span class=\"line\">    state = data.get(<span class=\"string\">&#x27;state&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> cache.has_key(state):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">    cache.delete(state)</span><br><span class=\"line\"></span><br><span class=\"line\">    apply_access_token_url = <span class=\"string\">&#x27;https://www.acwing.com/third_party/api/oauth2/access_token/&#x27;</span></span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;appid&#x27;</span>: <span class=\"string\">&#x27;4007&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;secret&#x27;</span>: <span class=\"string\">&#x27;0edf233ee876407ea3542220e2a8d83e&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;code&#x27;</span>: code</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_token_res = requests.get(apply_access_token_url, params=params).json()  <span class=\"comment\"># 申请授权令牌</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(access_token_res)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> redirect(<span class=\"string\">&#x27;index&#x27;</span>)  <span class=\"comment\"># 重定向回index</span></span><br></pre></td></tr></table></figure>\n<p>现在我们点击一键登录按钮即可在后台看到接收到的授权令牌内容。</p>\n<h1>4. 申请用户信息</h1>\n<p>请求地址：<code>https://www.acwing.com/third_party/api/meta/identity/getinfo/</code>。</p>\n<p>请求方法为 <code>GET</code>，参考示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.acwing.com/third_party/api/meta/identity/getinfo/?access_token=ACCESS_TOKEN&amp;openid=OPENID</span><br></pre></td></tr></table></figure>\n<p>参数说明：</p>\n<ul>\n<li><code>access_token</code>：上一步中获取的授权令牌；</li>\n<li><code>openid</code>：上一步中获取的用户 <code>openid</code>。</li>\n</ul>\n<p>申请成功的返回内容示例：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;username&#x27;</span>: <span class=\"string\">&quot;USERNAME&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;photo&#x27;</span>: <span class=\"string\">&quot;https:cdn.acwing.com/xxxxx&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>申请失败的返回内容示例：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;errcode&#x27;</span>: <span class=\"string\">&quot;40004&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;errmsg&#x27;</span>: <span class=\"string\">&quot;access_token expired&quot;</span>  <span class=\"comment\"># 授权令牌过期</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在我们用授权令牌向 AcWing 申请用户的用户名和头像，进一步完善 <code>receive_code.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> redirect</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.core.cache <span class=\"keyword\">import</span> cache</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth.models <span class=\"keyword\">import</span> User</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth <span class=\"keyword\">import</span> login</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.models.player.player <span class=\"keyword\">import</span> Player</span><br><span class=\"line\"><span class=\"keyword\">from</span> random <span class=\"keyword\">import</span> randint</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">receive_code</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    data = request.GET</span><br><span class=\"line\">    code = data.get(<span class=\"string\">&#x27;code&#x27;</span>)</span><br><span class=\"line\">    state = data.get(<span class=\"string\">&#x27;state&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> cache.has_key(state):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">    cache.delete(state)</span><br><span class=\"line\"></span><br><span class=\"line\">    apply_access_token_url = <span class=\"string\">&#x27;https://www.acwing.com/third_party/api/oauth2/access_token/&#x27;</span></span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;appid&#x27;</span>: <span class=\"string\">&#x27;4007&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;secret&#x27;</span>: <span class=\"string\">&#x27;0edf233ee876407ea3542220e2a8d83e&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;code&#x27;</span>: code</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_token_res = requests.get(apply_access_token_url, params=params).json()  <span class=\"comment\"># 申请授权令牌</span></span><br><span class=\"line\">    access_token = access_token_res[<span class=\"string\">&#x27;access_token&#x27;</span>]</span><br><span class=\"line\">    openid = access_token_res[<span class=\"string\">&#x27;openid&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    player = Player.objects.<span class=\"built_in\">filter</span>(openid=openid)  <span class=\"comment\"># 查看当前用户的openid是否已经存在</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> player.exists():</span><br><span class=\"line\">        login(request, player[<span class=\"number\">0</span>].user)  <span class=\"comment\"># 如果用户的账号已经存在直接登录即可</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> redirect(<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    get_userinfo_url = <span class=\"string\">&#x27;https://www.acwing.com/third_party/api/meta/identity/getinfo/&#x27;</span></span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;access_token&#x27;</span>: access_token,</span><br><span class=\"line\">        <span class=\"string\">&#x27;openid&#x27;</span>: openid</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    get_userinfo_res = requests.get(get_userinfo_url, params=params).json()  <span class=\"comment\"># 申请获取用户信息</span></span><br><span class=\"line\">    username = get_userinfo_res[<span class=\"string\">&#x27;username&#x27;</span>]</span><br><span class=\"line\">    avatar = get_userinfo_res[<span class=\"string\">&#x27;photo&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> User.objects.<span class=\"built_in\">filter</span>(username=username).exists():  <span class=\"comment\"># 如果当前用户的用户名已经存在则在其后面添加若干位随机数</span></span><br><span class=\"line\">        username += <span class=\"built_in\">str</span>(randint(<span class=\"number\">0</span>, <span class=\"number\">9</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">    user = User.objects.create(username=username)  <span class=\"comment\"># 创建该用户，没有密码</span></span><br><span class=\"line\">    player = Player.objects.create(user=user, avatar=avatar, openid=openid)</span><br><span class=\"line\">    login(request, user)  <span class=\"comment\"># 创建好后直接登录</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> redirect(<span class=\"string\">&#x27;index&#x27;</span>)  <span class=\"comment\"># 重定向回index</span></span><br></pre></td></tr></table></figure>\n<p>至此 Web 端的 AcWing 一键登录已经实现。</p>\n<p>上一章：<a href=\"/posts/6653.html\">Django学习笔记-用户名密码登录</a>。</p>\n<p>下一章：<a href=\"/posts/56617.html\">Django学习笔记-VS Code本地运行项目</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/6653.html",
            "url": "https://asanosaki.github.io/posts/6653.html",
            "title": "Django学习笔记-用户名密码登录",
            "date_published": "2023-06-27T07:48:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是使用 Django 实现用户的注册与登录等后端功能。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 扩充Django数据库</h1>\n<p>首先我们先在 <code>settings.py</code> 中修改：<code>DEBUG = True</code>，否则如果服务器端的代码报错时前端不会显示报错详细信息。</p>\n<p>Django 自带一个账号系统，在网址后面添加后缀 <code>/admin</code> 即可访问管理员界面，登录之前的超级管理员账号，进入管理员界面后其中的 <code>Users</code> 界面就是自带的账号系统。</p>\n<p>其中可以填写每个用户的姓名和邮箱，<code>Active</code> 表示用户是否被封，不勾选即无法登录；<code>Staff status</code> 表示用户是否能进入到后台管理页面；<code>Superuser status</code> 表示用户是否具有超级管理员的权限。</p>\n<p>这个自带的账号系统不能满足我们的需求，例如需要存储用户的头像，该数据库就需要进行扩充。</p>\n<p>我们要在 <code>djangoapp/game/models</code> 目录下创建我们所需的表，即创建类似之前提到的 <code>Users</code>，我们在该目录中新建一个 <code>player</code> 目录，然后进入该目录，记得需要先创建一个 <code>__init__.py</code> 文件。</p>\n<p>接着我们创建 <code>player.py</code> 用来存储 <code>player</code> 这个数据表的信息，创建类时需要继承基类 <code>django.db.models.Model</code>（开发时有个小 Tips，如果忘记一些关键字怎么写可以在项目根目录执行 <code>python3 manage.py shell</code>，进入 IPython 交互功能，然后输入代码即具有补全功能）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.db <span class=\"keyword\">import</span> models</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth.models <span class=\"keyword\">import</span> User</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Player有两个关键字，user表示是和哪个User对应的，avatar表示头像</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span>(models.Model):</span><br><span class=\"line\">    user = models.OneToOneField(User, on_delete=models.CASCADE)  <span class=\"comment\"># 当删除User时也将其关联的Player一块删掉</span></span><br><span class=\"line\">    avatar = models.URLField(max_length=<span class=\"number\">256</span>, blank=<span class=\"literal\">True</span>)  <span class=\"comment\"># 头像用链接存</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__str__</span>(<span class=\"params\">self</span>):  <span class=\"comment\"># 显示每个Player的数据</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">str</span>(self.user)</span><br></pre></td></tr></table></figure>\n<p>创建好数据表后如果希望让我们的数据表出现在管理员界面，需要将它注册到管理员页面，在 <code>game</code> 目录下可以看到一个 <code>admin.py</code> 文件，对其进行修改：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.contrib <span class=\"keyword\">import</span> admin</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.models.player.player <span class=\"keyword\">import</span> Player  <span class=\"comment\"># 将表导进来</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Register your models here.</span></span><br><span class=\"line\">admin.site.register(Player)</span><br></pre></td></tr></table></figure>\n<p>每次对数据表的定义更新后都需要执行以下两句指令（在项目根目录）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 manage.py makemigrations</span><br><span class=\"line\">python3 manage.py migrate</span><br></pre></td></tr></table></figure>\n<p>然后我们重启一下项目：<code>uwsgi --ini scripts/uwsgi.ini</code>，即可看到新创建的 Player 表，在右上角的 <code>ADD PLAYER</code> 选项中即可添加 Player。</p>\n<p>从这个例子即可看出数据库中的 Table 对应 Django 中的 Class，Table 中的每一条数据就对应 Class 中的每一个对象。</p>\n<h1>2. 实现获取用户信息</h1>\n<p>假设我们将网页刷新后，Clinet 先向后台服务器（Server）发送一个请求获得当前玩家的信息 <code>getinfo</code>，后台一种是返回用户名和头像，还有一种是返回未登录，现在我们先默认每次都返回玩家的用户名和头像，每次写一个函数时需要写三个部分：<code>views</code> 表示调用数据库的逻辑、<code>urls</code> 表示路由、<code>js</code> 实现调用。</p>\n<p>由于有多个前端，因此后端在接收请求的时候需要知道是哪个前端，需要对 <code>AcGame</code> 类进行修改，让其多传入一个参数 <code>acwingos</code>，如果在 AcWing 打开该项目则会传入该参数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AcGame</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">id, acwingos</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">id</span> = id;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$ac_game</span> = $(<span class=\"string\">&#x27;#&#x27;</span> + id);  <span class=\"comment\">// jQuery通过id找对象的方式</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">acwingos</span> = acwingos;  <span class=\"comment\">// 通过AcWing打开时会传入此参数</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">menu</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGameMenu</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGamePlayground</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>进入 <code>views</code> 目录，我们将所有用户的信息全部放到 <code>settings</code> 目录中，在 <code>settings</code> 目录创建一个 <code>getinfo.py</code> 文件，内容如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.models.player.player <span class=\"keyword\">import</span> Player</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo_acapp</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    player = Player.objects.<span class=\"built_in\">all</span>()[<span class=\"number\">0</span>]  <span class=\"comment\"># 先默认返回第一个玩家的信息</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,  <span class=\"comment\"># 查询结果</span></span><br><span class=\"line\">        <span class=\"string\">&#x27;username&#x27;</span>: player.user.username,</span><br><span class=\"line\">        <span class=\"string\">&#x27;avatar&#x27;</span>: player.avatar,</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo_web</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    player = Player.objects.<span class=\"built_in\">all</span>()[<span class=\"number\">0</span>]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;username&#x27;</span>: player.user.username,</span><br><span class=\"line\">        <span class=\"string\">&#x27;avatar&#x27;</span>: player.avatar,</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    platform = request.GET.get(<span class=\"string\">&#x27;platform&#x27;</span>)  <span class=\"comment\"># 是哪个平台发起的请求</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> platform == <span class=\"string\">&#x27;ACAPP&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getinfo_acapp(request)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getinfo_web(request)</span><br></pre></td></tr></table></figure>\n<p>然后进入 <code>urls/settings</code> 目录，修改 <code>index.py</code> 文件：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.getinfo <span class=\"keyword\">import</span> getinfo</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;getinfo/&#x27;</span>, getinfo, name=<span class=\"string\">&#x27;settings_getinfo&#x27;</span>)</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>现在我们即可访问 <code>https://&lt;项目IP地址&gt;/settings/getinfo/</code> 查看效果。</p>\n<p>最后我们需要在游戏的菜单界面之前添加一个界面判断用户是否登录，先将 <code>AcGameMenu</code> 类在初始化操作中 <code>hide</code>，然后进入 <code>/djangoapp/game/static/js/src/settings</code> 目录中创建 <code>zbase.js</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Settings</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> = <span class=\"string\">&#x27;WEB&#x27;</span>;  <span class=\"comment\">// 默认为Web前端</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">acwingos</span>) <span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> = <span class=\"string\">&#x27;ACAPP&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在初始化时需要从服务器端获取用户信息</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">getinfo</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开注册界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开登录界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/getinfo/&#x27;</span>,  <span class=\"comment\">// 用AcWing部署</span></span><br><span class=\"line\">            <span class=\"comment\">// url: &#x27;http://8.130.54.44:8000/settings/getinfo/&#x27;,  // 用云服务器部署</span></span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">platform</span>: outer.<span class=\"property\">platform</span>,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;  <span class=\"comment\">// 调用成功的回调函数，返回的Json字典会传给resp</span></span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);  <span class=\"comment\">// 控制台输出查看结果</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">                    outer.<span class=\"property\">root</span>.<span class=\"property\">menu</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// 如果未登录则需要弹出登录界面</span></span><br><span class=\"line\">                    outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>AcGame</code> 类中创建 <code>Settings</code> 对象：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AcGame</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">id, acwingos</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">id</span> = id;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$ac_game</span> = $(<span class=\"string\">&#x27;#&#x27;</span> + id);  <span class=\"comment\">// jQuery通过id找对象的方式</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">settings</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Settings</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">menu</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGameMenu</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGamePlayground</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">acwingos</span> = acwingos;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时访问网站即可看到控制台的输出信息。</p>\n<p>此时项目的执行顺序为：创建 <code>Settings</code> 类的对象时先执行构造函数，接着会执行 <code>start</code> 中的 <code>getinfo</code> 函数，会向后端（<code>https://app4007.acapp.acwing.com.cn/settings/getinfo/</code>）发一个请求，然后路由会找到 <code>views.settings.getinfo</code> 文件中的 <code>getinfo</code> 函数，然后判断 <code>platform</code> 为 <code>WEB</code>，最后通过 <code>getinfo_web</code> 返回用户名和用户头像到 <code>resp</code> 中。</p>\n<p>现在我们来判断用户是否登录，修改 <code>views/settings</code> 目录中的 <code>getinfo.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.models.player.player <span class=\"keyword\">import</span> Player</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo_acapp</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo_web</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    user = request.user</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> user.is_authenticated:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;not login&#x27;</span>,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        player = Player.objects.<span class=\"built_in\">all</span>()[<span class=\"number\">0</span>]</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;username&#x27;</span>: player.user.username,</span><br><span class=\"line\">            <span class=\"string\">&#x27;avatar&#x27;</span>: player.avatar,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    ...</span><br></pre></td></tr></table></figure>\n<p>然后我们需要将用户的信息存下来，将头像渲染到小球里，首先在 <code>js/src/settings</code> 目录中修改 <code>zbase.js</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Settings</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">username</span> = <span class=\"string\">&#x27;&#x27;</span>;  <span class=\"comment\">// 初始用户信息为空</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">avatar</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在初始化时需要从服务器端获取用户信息</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">getinfo</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开注册界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开登录界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/getinfo/&#x27;</span>,  <span class=\"comment\">// 用AcWing部署</span></span><br><span class=\"line\">            <span class=\"comment\">// url: &#x27;http://8.130.54.44:8000/settings/getinfo/&#x27;,  // 用云服务器部署</span></span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">platform</span>: outer.<span class=\"property\">platform</span>,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;  <span class=\"comment\">// 调用成功的回调函数，返回的Json字典会传给resp</span></span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);  <span class=\"comment\">// 控制台输出查看结果</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">username</span> = resp.<span class=\"property\">username</span>;</span><br><span class=\"line\">                    outer.<span class=\"property\">avatar</span> = resp.<span class=\"property\">avatar</span>;</span><br><span class=\"line\">                    ...</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// 如果未登录则需要弹出登录界面</span></span><br><span class=\"line\">                    outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>Player</code> 类中渲染用户的头像：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;  <span class=\"comment\">// 用户自己的头像从服务器端获取</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">img</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Image</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">img</span>.<span class=\"property\">src</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"property\">avatar</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 向(tx, ty)位置发射火球</span></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_attacked</span>(<span class=\"params\">theta, damage</span>) &#123;  <span class=\"comment\">// 被攻击到</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">save</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">stroke</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">clip</span>();</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">drawImage</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">img</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"number\">2</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">restore</span>();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">            <span class=\"comment\">// 角度从0画到2PI，是否逆时针为false</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>3. 渲染登录与注册界面</h1>\n<p>首先我们下载 AcWing 一键登录所需要的图标资源，进入 <code>static/image/settings</code> 目录执行以下指令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://cdn.acwing.com/media/article/image/2021/11/18/1_ea3d5e7448-logo64x64_2.png</span><br><span class=\"line\">mv 1_ea3d5e7448-logo64x64_2.png acwing_logo.png</span><br></pre></td></tr></table></figure>\n<p>然后完善 <code>Settings</code> 类渲染登录与注册界面并且实现两个界面的跳转功能：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Settings</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> = <span class=\"string\">&#x27;WEB&#x27;</span>;  <span class=\"comment\">// 默认为Web前端</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">acwingos</span>) <span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> = <span class=\"string\">&#x27;ACAPP&#x27;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">username</span> = <span class=\"string\">&#x27;&#x27;</span>;  <span class=\"comment\">// 初始用户信息为空</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">avatar</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_settings&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=&#x27;ac_game_settings_login&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_title&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        Login</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_username&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;text&#x27; placeholder=&#x27;Username&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_password&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;password&#x27; placeholder=&#x27;Password&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_submit&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;button&gt;Login&lt;/button&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_errormessage&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_option&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        Register</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;br&gt;  &lt;!-- inline格式可能有bug，需要加一行回车 --&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_acwingoption&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;img width=&#x27;30&#x27; src=&#x27;https://app4007.acapp.acwing.com.cn/static/image/settings/acwing_logo.png&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div&gt;AcWing Login&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=&#x27;ac_game_settings_register&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_title&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        Register</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_username&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;text&#x27; placeholder=&#x27;Username&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_password ac_game_settings_password_first&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;password&#x27; placeholder=&#x27;Password&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_password ac_game_settings_password_second&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;input type=&#x27;password&#x27; placeholder=&#x27;Confirm Password&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_submit&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=&#x27;ac_game_settings_item&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                            &lt;button&gt;Register&lt;/button&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_errormessage&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_settings_option&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        Login</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_login&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_username</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_username input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_password</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_password input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_submit</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_submit button&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_errormessage</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_errormessage&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_register</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_option&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_register&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_username</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_username input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_password</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_password_first input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_confirm_password</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_password_second input&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_submit</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_submit button&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_errormessage</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_errormessage&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_login</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_settings_option&#x27;</span>)</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在初始化时需要从服务器端获取用户信息</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">getinfo</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 绑定监听函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events_login</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events_register</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_login</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_register</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">register</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_register</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_login</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开注册界面</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开登录界面</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/getinfo/&#x27;</span>,  <span class=\"comment\">// 用AcWing部署</span></span><br><span class=\"line\">            <span class=\"comment\">// url: &#x27;http://8.130.54.44:8000/settings/getinfo/&#x27;,  // 用云服务器部署</span></span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">platform</span>: outer.<span class=\"property\">platform</span>,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;  <span class=\"comment\">// 调用成功的回调函数，返回的Json字典会传给resp</span></span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);  <span class=\"comment\">// 控制台输出查看结果</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">username</span> = resp.<span class=\"property\">username</span>;</span><br><span class=\"line\">                    outer.<span class=\"property\">avatar</span> = resp.<span class=\"property\">avatar</span>;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">                    outer.<span class=\"property\">root</span>.<span class=\"property\">menu</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// 如果未登录则需要弹出登录界面</span></span><br><span class=\"line\">                    outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>game.css</code> 内容如下：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.ac_game_menu</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">background-image</span>: <span class=\"built_in\">url</span>(<span class=\"string\">&#x27;/static/image/menu/background.png&#x27;</span>);  <span class=\"comment\">/* 注意不用带公网IP */</span></span><br><span class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">100%</span> <span class=\"number\">100%</span>;</span><br><span class=\"line\">    user-select: none;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">30%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">20%</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup_bt</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">15vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">3vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">font-style</span>: italic;</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">    <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">39</span>, <span class=\"number\">21</span>, <span class=\"number\">28</span>, <span class=\"number\">0.6</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">10px</span>;</span><br><span class=\"line\">    <span class=\"attribute\">letter-spacing</span>: <span class=\"number\">0.5vw</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup_bt</span><span class=\"selector-pseudo\">:hover</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">scale</span>(<span class=\"number\">1.2</span>);</span><br><span class=\"line\">    <span class=\"attribute\">transition</span>: <span class=\"number\">100ms</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_playground</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    user-select: none;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">background-image</span>: <span class=\"built_in\">url</span>(<span class=\"string\">&#x27;/static/image/menu/background.png&#x27;</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">100%</span> <span class=\"number\">100%</span>;</span><br><span class=\"line\">    user-select: none;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_login</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">41vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0.7</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">5px</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_register</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">39vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0.7</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">5px</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_title</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">3.5vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_username</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_password</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_submit</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_errormessage</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: red;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">1.5vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: inline;</span><br><span class=\"line\">    <span class=\"attribute\">float</span>: left;</span><br><span class=\"line\">    <span class=\"attribute\">padding-left</span>: <span class=\"number\">1vw</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_option</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">1.5vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: inline;</span><br><span class=\"line\">    <span class=\"attribute\">float</span>: right;</span><br><span class=\"line\">    <span class=\"attribute\">padding-right</span>: <span class=\"number\">1vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_acwingoption</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">8vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_acwingoption</span> &gt; <span class=\"selector-tag\">img</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_acwingoption</span> &gt; <span class=\"selector-tag\">div</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">1.2vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">    <span class=\"attribute\">padding-top</span>: <span class=\"number\">1vh</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_item</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_item</span> &gt; <span class=\"selector-tag\">input</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">90%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">3vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_settings_item</span> &gt; <span class=\"selector-tag\">button</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: black;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">30%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">3vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">2vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">50%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">translate</span>(-<span class=\"number\">50%</span>, -<span class=\"number\">50%</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgb</span>(<span class=\"number\">199</span>, <span class=\"number\">237</span>, <span class=\"number\">204</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">7px</span>;</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>4. 实现登录与登出功能</h1>\n<p>实现登录与登出功能我们同样要编写 <code>views</code>、<code>urls</code> 以及 <code>js</code> 文件，首先在 <code>game/views/settings</code> 目录下创建 <code>login.py</code> 文件：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth <span class=\"keyword\">import</span> authenticate, login</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mylogin</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    data = request.GET</span><br><span class=\"line\">    username = data.get(<span class=\"string\">&#x27;username&#x27;</span>)</span><br><span class=\"line\">    password = data.get(<span class=\"string\">&#x27;password&#x27;</span>)</span><br><span class=\"line\">    user = authenticate(username=username, password=password)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> user:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;用户名或密码不正确&#x27;</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    login(request, user)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p>然后进入 <code>game/urls/settings</code> 目录修改 <code>index.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.getinfo <span class=\"keyword\">import</span> getinfo</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.login <span class=\"keyword\">import</span> mylogin</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;getinfo/&#x27;</span>, getinfo, name=<span class=\"string\">&#x27;settings_getinfo&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;login/&#x27;</span>, mylogin, name=<span class=\"string\">&#x27;settings_login&#x27;</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>此时重启一下项目后访问 <code>https://&lt;公网IP&gt;/settings/login/</code> 即可看到返回结果。</p>\n<p>现在我们实现一下登出函数，在 <code>game/views/settings</code> 目录下创建 <code>logout.py</code> 文件：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth <span class=\"keyword\">import</span> logout</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">mylogout</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    user = request.user</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> user.is_authenticated:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    logout(request)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p>然后进入 <code>game/urls/settings</code> 目录修改 <code>index.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.getinfo <span class=\"keyword\">import</span> getinfo</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.login <span class=\"keyword\">import</span> mylogin</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.logout <span class=\"keyword\">import</span> mylogout</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;getinfo/&#x27;</span>, getinfo, name=<span class=\"string\">&#x27;settings_getinfo&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;login/&#x27;</span>, mylogin, name=<span class=\"string\">&#x27;settings_login&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;logout/&#x27;</span>, mylogout, name=<span class=\"string\">&#x27;settings_logout&#x27;</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>此时重启一下项目后在登录状态下访问 <code>https://&lt;公网IP&gt;/settings/logout/</code> 即可登出。</p>\n<p>然后我们在 <code>Settings</code> 类中实现登录登出：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Settings</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在初始化时需要从服务器端获取用户信息</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 绑定监听函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events_login</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events_register</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_login</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_register</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">register</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_submit</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">login_on_remote</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_register</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_login</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登录</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> username = <span class=\"variable language_\">this</span>.<span class=\"property\">$login_username</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> password = <span class=\"variable language_\">this</span>.<span class=\"property\">$login_password</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$login_errormessage</span>.<span class=\"title function_\">empty</span>();  <span class=\"comment\">// 先清空报错信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/login/&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">username</span>: username,</span><br><span class=\"line\">                <span class=\"attr\">password</span>: password,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;  <span class=\"comment\">// 登录成功</span></span><br><span class=\"line\">                    location.<span class=\"title function_\">reload</span>();  <span class=\"comment\">// 刷新页面</span></span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;  <span class=\"comment\">// 登录失败</span></span><br><span class=\"line\">                    outer.<span class=\"property\">$login_errormessage</span>.<span class=\"title function_\">html</span>(resp.<span class=\"property\">result</span>);  <span class=\"comment\">// 显示报错信息</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上注册</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">logout_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登出</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">platform</span> === <span class=\"string\">&#x27;ACAPP&#x27;</span>) &#123;  <span class=\"comment\">// AcApp应该是直接关闭窗口退出</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">acwingos</span>.<span class=\"property\">api</span>.<span class=\"property\">window</span>.<span class=\"title function_\">close</span>();  <span class=\"comment\">// 调用AcWing接口关闭窗口</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">                <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/logout/&#x27;</span>,</span><br><span class=\"line\">                <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">                <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">                    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                        location.<span class=\"title function_\">reload</span>();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开注册界面</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开登录界面</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中登出函数 <code>logout_on_remote</code> 需要在 <code>AcGameMenu</code> 类中调用：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGameMenu</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;  <span class=\"comment\">// root用来传AcGame对象</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_menu&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=&#x27;ac_game_menu_btgroup&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    ...</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_menu_btgroup_bt ac_game_menu_btgroup_bt_settings&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        登出</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_menu_btgroup_bt_settings&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 给按钮绑定监听函数</span></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"property\">root</span>.<span class=\"property\">settings</span>.<span class=\"title function_\">logout_on_remote</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示menu界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭menu界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>5. 实现注册功能</h1>\n<p>首先在 <code>game/views/settings</code> 目录下创建 <code>register.py</code> 文件：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth <span class=\"keyword\">import</span> login</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.contrib.auth.models <span class=\"keyword\">import</span> User</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.models.player.player <span class=\"keyword\">import</span> Player</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">register</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    data = request.GET</span><br><span class=\"line\">    username = data.get(<span class=\"string\">&#x27;username&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>).strip()  <span class=\"comment\"># 如果没有的话返回空，且过滤掉空格</span></span><br><span class=\"line\">    password = data.get(<span class=\"string\">&#x27;password&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>).strip()</span><br><span class=\"line\">    confirm_password = data.get(<span class=\"string\">&#x27;confirm_password&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>).strip()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> username <span class=\"keyword\">or</span> <span class=\"keyword\">not</span> password:  <span class=\"comment\"># 用户名或密码为空</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;Username or password can\\&#x27;t be empty!&#x27;</span>,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> password != confirm_password:  <span class=\"comment\"># 两次密码不一致</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;Password inconsistency!&#x27;</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">elif</span> User.objects.<span class=\"built_in\">filter</span>(username=username).exists():  <span class=\"comment\"># 用户名已存在</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;Username has existed!&#x27;</span></span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    user = User(username=username)</span><br><span class=\"line\">    user.set_password(password)</span><br><span class=\"line\">    user.save()</span><br><span class=\"line\">    Player.objects.create(user=user, avatar=<span class=\"string\">&#x27;https://cdn.acwing.com/media/article/image/2021/11/18/1_ea3d5e7448-logo64x64_2.png&#x27;</span>)</span><br><span class=\"line\">    login(request, user)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p>然后进入 <code>game/urls/settings</code> 目录修改 <code>index.py</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.getinfo <span class=\"keyword\">import</span> getinfo</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.login <span class=\"keyword\">import</span> mylogin</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.logout <span class=\"keyword\">import</span> mylogout</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.settings.register <span class=\"keyword\">import</span> register</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;getinfo/&#x27;</span>, getinfo, name=<span class=\"string\">&#x27;settings_getinfo&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;login/&#x27;</span>, mylogin, name=<span class=\"string\">&#x27;settings_login&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;logout/&#x27;</span>, mylogout, name=<span class=\"string\">&#x27;settings_logout&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;register/&#x27;</span>, register, name=<span class=\"string\">&#x27;settings_register&#x27;</span>),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>此时重启一下项目后访问 <code>https://&lt;公网IP&gt;/settings/register/</code> 即可看到返回结果。</p>\n<p>最后修改前端  <code>Settings</code> 类：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Settings</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在初始化时需要从服务器端获取用户信息</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 绑定监听函数</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_login</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events_register</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_login</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">login</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_submit</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">register_on_remote</span>();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登录</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上注册</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> username = <span class=\"variable language_\">this</span>.<span class=\"property\">$register_username</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> password = <span class=\"variable language_\">this</span>.<span class=\"property\">$register_password</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"keyword\">let</span> confirm_password = <span class=\"variable language_\">this</span>.<span class=\"property\">$register_confirm_password</span>.<span class=\"title function_\">val</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$register_errormessage</span>.<span class=\"title function_\">empty</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        $.<span class=\"title function_\">ajax</span>(&#123;</span><br><span class=\"line\">            <span class=\"attr\">url</span>: <span class=\"string\">&#x27;https://app4007.acapp.acwing.com.cn/settings/register/&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">&#x27;GET&#x27;</span>,</span><br><span class=\"line\">            <span class=\"attr\">data</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">username</span>: username,</span><br><span class=\"line\">                <span class=\"attr\">password</span>: password,</span><br><span class=\"line\">                <span class=\"attr\">confirm_password</span>: confirm_password,</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"attr\">success</span>: <span class=\"keyword\">function</span>(<span class=\"params\">resp</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(resp);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (resp.<span class=\"property\">result</span> === <span class=\"string\">&#x27;success&#x27;</span>) &#123;</span><br><span class=\"line\">                    location.<span class=\"title function_\">reload</span>();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    outer.<span class=\"property\">$register_errormessage</span>.<span class=\"title function_\">html</span>(resp.<span class=\"property\">result</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">logout_on_remote</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在远程服务器上登出</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">register</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开注册界面</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">login</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 打开登录界面</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">getinfo</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>6. 修改获取用户信息</h1>\n<p>之前我们是默认返回第一个用户的信息，我们对 <code>game/views/settings</code> 目录下的 <code>getinfo.py</code> 文件进行修改：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> JsonResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.models.player.player <span class=\"keyword\">import</span> Player</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo_acapp</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo_web</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    user = request.user</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> user.is_authenticated:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;not login&#x27;</span>,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        player = Player.objects.get(user=user)  <span class=\"comment\"># 获取user的player信息</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> JsonResponse(&#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;result&#x27;</span>: <span class=\"string\">&#x27;success&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;username&#x27;</span>: player.user.username,</span><br><span class=\"line\">            <span class=\"string\">&#x27;avatar&#x27;</span>: player.avatar,</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getinfo</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    platform = request.GET.get(<span class=\"string\">&#x27;platform&#x27;</span>)  <span class=\"comment\"># 是哪个平台发起的请求</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> platform == <span class=\"string\">&#x27;ACAPP&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getinfo_acapp(request)</span><br><span class=\"line\">    <span class=\"comment\"># elif platform == &#x27;WEB&#x27;:</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> getinfo_web(request)</span><br></pre></td></tr></table></figure>\n<p>上一章：<a href=\"/posts/13510.html\">Django学习笔记-部署Nginx与对接AcApp</a>。</p>\n<p>下一章：<a href=\"/posts/54821.html\">Django学习笔记-Web端授权AcWing一键登录</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/13510.html",
            "url": "https://asanosaki.github.io/posts/13510.html",
            "title": "Django学习笔记-部署Nginx与对接AcApp",
            "date_published": "2023-06-25T15:10:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是通过 Nginx 与 uWSGI 将项目部署至 AcWing 平台上，同时修复在 AcApp 小窗口上存在的部分 BUG。</p>\n</blockquote>\n<span id=\"more\"></span>\n<p>现在我们需要将之前在网页上运行的项目部署至 AcWing 上，让其前后端分离，一个后端可以对应多个前端。</p>\n<p>如果要将网站修改为 HTTPS 协议，需要先购买一个域名，然后申请证书，还需要进行备案，非常麻烦。在 AcWing 上线 App 已具备域名和证书。</p>\n<h1>1. 增加容器的映射端口80与443</h1>\n<p>由于创建后的容器不方便增加新的端口映射，因此我们先将原容器保存成镜像后再生成一个新的容器。</p>\n<p>首先需要将容器中正在运行的任务全部关闭，然后登录运行容器的<strong>服务器</strong>，执行以下命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker commit ubuntu_django ubuntu_django:1.0  # 将容器ubuntu_django打包成镜像ubuntu_django，版本号为1.0</span><br><span class=\"line\">docker images  # 查看现有镜像</span><br><span class=\"line\">docker stop ubuntu_django  # 停止容器</span><br><span class=\"line\">docker rm ubuntu_django  # 删除容器</span><br><span class=\"line\">docker run -p 20000:22 -p 8000:8000 -p 80:80 -p 443:443 --name ubuntu_django -itd ubuntu_django:1.0  # 使用保存的镜像重新创建容器</span><br></pre></td></tr></table></figure>\n<p>此时如果无法远程连接容器可以按照 <a href=\"https://blog.csdn.net/m0_51755720/article/details/131100688\">Django 学习笔记-配置 Docker、Git 环境与项目创建</a>文章创建一个 <code>hosts.allow</code> 文件。</p>\n<p>接着去云服务器的控制台，在安全组配置中开放80和443端口。</p>\n<h1>2. 安装Nginx</h1>\n<p>（1）安装依赖包（安装均在根用户 <code>root</code> 下进行）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install curl gnupg2 ca-certificates lsb-release ubuntu-keyring</span><br></pre></td></tr></table></figure>\n<p>（2）安装 Nginx：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\">apt-get install nginx</span><br></pre></td></tr></table></figure>\n<p>（3）查看版本号：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -v</span><br></pre></td></tr></table></figure>\n<p>（4）启动 Nginx 以及查看是否在运行中：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start nginx</span><br><span class=\"line\">systemctl status nginx</span><br></pre></td></tr></table></figure>\n<p>如果报错：<code>System has not been booted with systemd as init system (PID 1). Can't operate. Failed to connect to bus: Host is down</code>，可以参考这篇文章：<a href=\"https://blog.csdn.net/qq_43685040/article/details/112056242\">System has not been booted with systemd as init system (PID 1). Can‘t operate. 问题解决方法</a>，简而言之就是用以下指令代替：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service nginx start</span><br><span class=\"line\">service nginx status</span><br></pre></td></tr></table></figure>\n<h1>3. 写入AcWing配置信息</h1>\n<p>配置信息在 AcWing 平台上可以查看，按以下步骤将信息复制到项目的配置文件中即可：</p>\n<ul>\n<li>将 <code>nginx.conf</code> 中的内容写入服务器 <code>/etc/nginx/nginx.conf</code> 文件中。如果 Django 项目路径与配置文件中不同，注意修改路径。</li>\n<li>将 <code>acapp.key</code> 中的内容写入服务器 <code>/etc/nginx/cert/acapp.key</code> 文件中（<code>cert</code> 目录需要自己创建）。</li>\n<li>将 <code>acapp.pem</code> 中的内容写入服务器 <code>/etc/nginx/cert/acapp.pem</code> 文件中。</li>\n</ul>\n<p>然后启动 Nginx 服务：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo /etc/init.d/nginx start</span><br></pre></td></tr></table></figure>\n<p>如果启动不成功可以重新加载一下 Nginx 的配置文件即可看到错误在哪：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nginx -s reload</span><br></pre></td></tr></table></figure>\n<h1>4. 修改Django项目的配置</h1>\n<ul>\n<li>打开 <code>settings.py</code> 文件：\n<ul>\n<li>将分配的域名添加到 <code>ALLOWED_HOSTS</code> 列表中。注意只需要添加 <code>https://</code> 后面的部分。</li>\n<li>令 <code>DEBUG = False</code>。</li>\n</ul>\n</li>\n<li>归档 <code>static</code> 文件：\n<ul>\n<li>在项目根目录下执行：<code>python3 manage.py collectstatic</code>，执行完后可以看到生成了一份 <code>game</code> 中的 <code>static</code> 目录。</li>\n</ul>\n</li>\n</ul>\n<h1>5. 配置uWSGI</h1>\n<p>WSGI（Web Server Gateway Interface）是为 Python 语言定义的 Web 服务器和 Web 应用程序或框架之间的一种简单而通用的接口。网关（Gateway）的作用就是在协议之间进行转换。很多框架都自带了 WSGI Server，比如 Flask、Django 等。当然性能都不好，自带的 Web Server 更多的是测试用途，发布时则使用生产环境的 WSGI Server 或者是联合 Nginx 做 uWSGI。</p>\n<p>uWSGI 是一个 Web 服务器，它实现了 WSGI、uwsgi、HTTP 等协议。Nginx 中 <code>HttpUwsgiModule</code> 的作用是与 uWSGI 服务器进行交换。</p>\n<p>要注意 WSGI、uwsgi、uWSGI 这三个概念的区分：</p>\n<ul>\n<li>WSGI 的内容之前已经讲过了，是一种通信协议。</li>\n<li>uwsgi 同 WSGI 一样是一种通信协议。</li>\n<li>uWSGI 则是实现了 uwsgi 和 WSGI 两种协议的 Web 服务器。</li>\n</ul>\n<p>uwsgi 协议是一个 uWSGI 服务器自有的协议，它用于定义传输信息的类型（type of information），每一个 <code>uwsgi packet</code> 前 <code>4byte</code> 为传输信息类型描述，它与 WSGI 相比是两样东西。</p>\n<p>为什么有了 uWSGI 还需要 Nginx？因为 Nginx 具备优秀的静态内容处理能力，然后将动态内容转发给 uWSGI 服务器，这样可以达到很好的客户端响应。</p>\n<p>现在用户通过80/443端口访问 Nginx，而 Nginx 与 Django 项目之间还需要一个桥梁就是 uWSGI。</p>\n<p>在 Django 项目中添加 uWSGI 的配置文件：<code>scripts/uwsgi.ini</code>，内容如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[uwsgi]</span><br><span class=\"line\">socket    = 127.0.0.1:8000</span><br><span class=\"line\">chdir     = /home/asanosaki/djangoapp</span><br><span class=\"line\">wsgi-file = djangoapp/wsgi.py</span><br><span class=\"line\">master    = true</span><br><span class=\"line\">processes = 2</span><br><span class=\"line\">threads   = 5</span><br><span class=\"line\">vacuum    = true</span><br></pre></td></tr></table></figure>\n<p>由于使用 <code>uwsgi</code> 命令启动项目后原来的公网 IP 就无法访问了，因此需要对 <code>web.html</code> 中 CSS、JS 的链接地址进行修改：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% load static %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&#123;% static &#x27;css/jquery-ui.min.css&#x27; %&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;&#123;% static &#x27;js/jquery-3.6.1.min.js&#x27; %&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&#123;% static &#x27;css/game.css&#x27; %&#125;&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;margin: 0&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;ac_game_1&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;module&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">import</span> &#123;<span class=\"title class_\">AcGame</span>&#125; <span class=\"keyword\">from</span> <span class=\"string\">&quot;&#123;% static &#x27;js/dist/game.js&#x27; %&#125;&quot;</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        $(<span class=\"variable language_\">document</span>).<span class=\"title function_\">ready</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"keyword\">let</span> ac_game = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGame</span>(<span class=\"string\">&quot;ac_game_1&quot;</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>然后启动 <code>uwsgi</code> 服务（代替 <code>python3 manage.py runserver 0.0.0.0:8000</code>）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uwsgi --ini scripts/uwsgi.ini</span><br></pre></td></tr></table></figure>\n<p>在 AcWing 填写完应用的剩余信息即可发布。</p>\n<h1>6. 部分BUG修复</h1>\n<p>在 AcWing 中打开应用时可以发现鼠标右键点击的位置不对，这是因为之前我们默认游戏的画布在左上角，而开启小窗口后画布就不在左上角了，我们移动小球时用的 <code>e.clientX/Y</code> 表示的是整个屏幕的坐标，而小球的位置坐标本身是画布中的相对坐标。</p>\n<p>Canvas 中的 <code>getBoundingClientRect</code> 函数可以获得当前视窗在浏览器中的位置以及自身占据的空间的大小，<code>left</code> 表示窗口<strong>左侧</strong>边框距离浏览器视窗<strong>左侧</strong>的距离，<code>top</code> 表示窗口<strong>顶侧</strong>边框距离浏览器视窗<strong>顶侧</strong>的距离，<code>right</code> 表示窗口<strong>右侧</strong>边框距离浏览器视窗<strong>左侧</strong>的距离，<code>bottom</code> 表示窗口<strong>底侧</strong>边框距离浏览器视窗<strong>顶侧</strong>的距离：</p>\n<p>因此我们将鼠标点击的坐标分别减去 <code>left</code> 和 <code>top</code> 即可映射到当前视窗内，在 <code>Player</code> 类中进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> rect = outer.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"title function_\">getBoundingClientRect</span>();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">move_to</span>(e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>, e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>);  <span class=\"comment\">// e.clientX/Y为鼠标点击坐标</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;fireball&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">shoot_fireball</span>(e.<span class=\"property\">clientX</span> - rect.<span class=\"property\">left</span>, e.<span class=\"property\">clientY</span> - rect.<span class=\"property\">top</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 释放完一次技能后还原</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>注意现在我们的项目为发行版本，修改完静态文件且打包完后还需要去项目根目录执行：<code>python3 manage.py collectstatic</code>，此时会问你是否要覆盖，输入 <code>yes</code> 即可。我们同样也可以修改之前的打包脚本 <code>compress_game_js.sh</code>，在其后面添加一行：<code>echo yes | python3 manage.py collectstatic</code>。</p>\n<p>由于游戏有菜单界面，应该在从菜单进入游戏后才开始计算窗口大小，因此我们需要把 <code>AcGamePlayground</code> 的初始化放在 <code>show</code> 函数中执行：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_playground&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> colors = [<span class=\"string\">&#x27;blue&#x27;</span>, <span class=\"string\">&#x27;red&#x27;</span>, <span class=\"string\">&#x27;pink&#x27;</span>, <span class=\"string\">&#x27;grey&#x27;</span>, <span class=\"string\">&#x27;green&#x27;</span>];</span><br><span class=\"line\">        <span class=\"keyword\">return</span> colors[<span class=\"title class_\">Math</span>.<span class=\"title function_\">floor</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">5</span>)];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 初始化时需要先关闭playground界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将界面的宽高先存下来</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">width</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">height</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">game_map</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">GameMap</span>(<span class=\"variable language_\">this</span>);  <span class=\"comment\">// 创建游戏画面</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">players</span> = [];  <span class=\"comment\">// 所有玩家</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.05</span>, <span class=\"string\">&#x27;white&#x27;</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.15</span>, <span class=\"literal\">true</span>));  <span class=\"comment\">// 创建自己</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 创建敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">8</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.05</span>, <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_random_color</span>(), <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.15</span>, <span class=\"literal\">false</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最后我们需要对菜单页面进行修改，在小窗口中的菜单页面不太美观，需要让其适应窗口大小，应该用小窗口的相对距离来表示，对 <code>game.css</code> 进行修改：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.ac_game_menu</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">30%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">20%</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup_bt</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">15vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">3vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">font-style</span>: italic;</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">    <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">39</span>, <span class=\"number\">21</span>, <span class=\"number\">28</span>, <span class=\"number\">0.6</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">10px</span>;</span><br><span class=\"line\">    <span class=\"attribute\">letter-spacing</span>: <span class=\"number\">0.5vw</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup_bt</span><span class=\"selector-pseudo\">:hover</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_playground</span> &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上一章：<a href=\"/posts/4217.html\">Django学习笔记-创建游戏界面</a>。</p>\n<p>下一章：<a href=\"/posts/6653.html\">Django学习笔记-用户名密码登录</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/4217.html",
            "url": "https://asanosaki.github.io/posts/4217.html",
            "title": "Django学习笔记-创建游戏界面",
            "date_published": "2023-06-14T12:50:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是游戏界面的设计，包括各个目标的绘制、角色的移动与攻击、AI 敌人的设计等部分。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 模块化引入JS变量</h1>\n<p>首先我们需要对之前的代码进行一点小修改，在 <code>web.html</code> 中使用 <code>&lt;script&gt;</code> 会导致定义的所有 Class（例如 <code>AcGame</code>）都会变成网页的全局变量，当引入多个 JS 文件后网页可能会出现重名变量导致冲突，我们最好做一个模块化，当我们需要某个名称的时候，我们只将这一个名称引入进来：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% load static %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;http://8.130.54.44:8000/static/css/jquery-ui.min.css&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;http://8.130.54.44:8000/static/js/jquery-3.6.1.min.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&#123;% static &#x27;css/game.css&#x27; %&#125;&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;margin: 0&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;ac_game_1&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;module&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">import</span> &#123;<span class=\"title class_\">AcGame</span>&#125; <span class=\"keyword\">from</span> <span class=\"string\">&quot;&#123;% static &#x27;js/dist/game.js&#x27; %&#125;&quot;</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        $(<span class=\"variable language_\">document</span>).<span class=\"title function_\">ready</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"keyword\">let</span> ac_game = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGame</span>(<span class=\"string\">&quot;ac_game_1&quot;</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>这时候我们刷新网页会看到报错：<code>Uncaught SyntaxError: The requested module '/static/js/dist/game.js' does not provide an export named 'AcGame'</code>，表示如果我们想加载 <code>AcGame</code> 的话需要在这个类前面加一个关键字 <code>export</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AcGame</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">id</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">id</span> = id;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$ac_game</span> = $(<span class=\"string\">&#x27;#&#x27;</span> + id);  <span class=\"comment\">// jQuery通过id找对象的方式</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">menu</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGameMenu</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGamePlayground</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时再次刷新网页即可看到报错消失。</p>\n<h1>2. 实现物体运动基类</h1>\n<p>在游戏中物体的运动效果是通过不断刷新界面实现的，浏览器每秒刷新60次（即60帧），每一帧都是一张图片，因此我们需要先实现一个能够每一帧都调用对象的刷新函数的基类（简易游戏引擎）。</p>\n<p>我们在 <code>static/js/src/playground/</code> 目录下创建一个 <code>ac_game_object</code> 目录，然后进入该目录创建 <code>zbase.js</code>。</p>\n<p>这个类一般有三个函数，函数 <code>start</code> 在开始时执行一次，用于创建对象时初始化对象的颜色、分值、昵称等信息（从服务器端加载出来），函数 <code>update</code> 每一帧都会执行一次，函数 <code>destroy</code> 表示删除当前对象：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable constant_\">AC_GAME_OBJECTS</span> = [];  <span class=\"comment\">// 将所有对象加到一个全局数组里，之后可以遍历每个对象刷新一次</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable constant_\">AC_GAME_OBJECTS</span>.<span class=\"title function_\">push</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 只会在第一帧执行一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 每一帧都会执行一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">on_destroy</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在被删除前执行一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">destroy</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 删掉该对象</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">on_destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable constant_\">AC_GAME_OBJECTS</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable constant_\">AC_GAME_OBJECTS</span>[i] === <span class=\"variable language_\">this</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable constant_\">AC_GAME_OBJECTS</span>.<span class=\"title function_\">splice</span>(i, <span class=\"number\">1</span>);  <span class=\"comment\">// 从位置i开始删除1个</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们需要实现每一帧循环渲染一遍全局数组中的对象，JS 提供了一个 API：<code>requestAnimationFrame()</code>，该函数会在一秒钟调用60次，也就是将一秒钟分成60等份，在下一帧时执行一遍函数，我们可以定义一个函数 <code>AC_GAME_ANIMATION</code> 表示每帧需要执行的操作：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable constant_\">AC_GAME_OBJECTS</span> = [];  <span class=\"comment\">// 将所有对象加到一个全局数组里，之后可以遍历每个对象刷新一次</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable constant_\">AC_GAME_OBJECTS</span>.<span class=\"title function_\">push</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">has_called_start</span> = <span class=\"literal\">false</span>;  <span class=\"comment\">// 是否执行过start函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 当前帧距离上一帧的时间间隔，因为如果用帧来衡量的话不同浏览器可能帧数不一样会导致不同的效果</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 只会在第一帧执行一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 每一帧都会执行一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">on_destroy</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 在被删除前执行一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">destroy</span>(<span class=\"params\"></span>) &#123;  <span class=\"comment\">// 删掉该对象</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">on_destroy</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable constant_\">AC_GAME_OBJECTS</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable constant_\">AC_GAME_OBJECTS</span>[i] === <span class=\"variable language_\">this</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable constant_\">AC_GAME_OBJECTS</span>.<span class=\"title function_\">splice</span>(i, <span class=\"number\">1</span>);  <span class=\"comment\">// 从位置i开始删除1个</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> last_timestamp;  <span class=\"comment\">// 上一帧的时间戳</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable constant_\">AC_GAME_ANIMATION</span> = <span class=\"keyword\">function</span>(<span class=\"params\">timestamp</span>) &#123;  <span class=\"comment\">// timestamp表示在哪个时刻调用的这个函数</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable constant_\">AC_GAME_OBJECTS</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> obj = <span class=\"variable constant_\">AC_GAME_OBJECTS</span>[i];</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!obj.<span class=\"property\">has_called_start</span>) &#123;  <span class=\"comment\">// 如果没有执行过start</span></span><br><span class=\"line\">            obj.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">            obj.<span class=\"property\">has_called_start</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            obj.<span class=\"property\">timedelta</span> = timestamp - last_timestamp;  <span class=\"comment\">// 更新一下时间间隔</span></span><br><span class=\"line\">            obj.<span class=\"title function_\">update</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    last_timestamp = timestamp;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">requestAnimationFrame</span>(<span class=\"variable constant_\">AC_GAME_ANIMATION</span>)  <span class=\"comment\">// 递归实现每一帧都调用一次该函数</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">requestAnimationFrame</span>(<span class=\"variable constant_\">AC_GAME_ANIMATION</span>);</span><br></pre></td></tr></table></figure>\n<h1>3. Canvas绘制游戏画面</h1>\n<p>接下来我们需要创建游戏画面，在 <code>playground</code> 目录下创建一个 <code>game_map</code> 目录，然后创建 <code>zbase.js</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">GameMap</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;  <span class=\"comment\">// 需要将AcGamePlayground传进来</span></span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();  <span class=\"comment\">// 调用基类构造函数，相当于将自己添加到了AC_GAME_OBJECTS中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$canvas</span> = $(<span class=\"string\">`&lt;canvas&gt;&lt;/canvas&gt;`</span>);  <span class=\"comment\">// 画布，用来渲染画面</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$canvas</span>[<span class=\"number\">0</span>].<span class=\"title function_\">getContext</span>(<span class=\"string\">&#x27;2d&#x27;</span>);  <span class=\"comment\">// 二维画布</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span>;  <span class=\"comment\">// 设置画布宽度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span>;  <span class=\"comment\">// 设置画布高度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$canvas</span>);  <span class=\"comment\">// 将画布添加到HTML中</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在 <code>playground</code> 目录下的 <code>zbase.js</code> 中将游戏画面对象创建出来即可：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_playground&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 将界面的宽高先存下来</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">width</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">height</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">game_map</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">GameMap</span>(<span class=\"variable language_\">this</span>);  <span class=\"comment\">// 创建游戏画面</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 初始化时需要先关闭playground界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在浏览器中的 Canvas 是没有颜色的，我们需要将它渲染出来，即在 <code>GameMap</code> 类中添加一个渲染函数 <code>render</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">GameMap</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground</span>) &#123;  <span class=\"comment\">// 需要将AcGamePlayground传进来</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();  <span class=\"comment\">// 每一帧都要画一次</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"string\">&#x27;rgba(0, 0, 0, 0.2)&#x27;</span>;  <span class=\"comment\">// 黑色背景</span></span><br><span class=\"line\">        <span class=\"comment\">// 左上角坐标(0, 0)，右下角坐标(w, h)</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fillRect</span>(<span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">width</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">canvas</span>.<span class=\"property\">height</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>4. 创建游戏角色及实现移动效果</h1>\n<p>在 <code>playground</code> 目录下创建一个 <code>player</code> 目录，然后创建 <code>zbase.js</code>（角色也是一个游戏对象，因此也要从 <code>AcGameObject</code> 类中扩展出来），角色需要传入中心坐标 <code>x, y</code>、半径 <code>radius</code>、颜色 <code>color</code>、每秒移动的距离百分比 <code>speed</code>、是否为自己 <code>is_me</code>（因为未来在联机的时候自己和敌人的操作方式是不一样的，敌人的操作是通过网络传过来的）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">ctx</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> = x;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> = y;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> = radius;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">color</span> = color;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> = speed;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span> = is_me;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">0.1</span>;  <span class=\"comment\">// 误差小于0.1认为是0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"comment\">// 角度从0画到2PI，是否逆时针为false</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们修改 <code>AcGamePlayground</code> 类将自己创建出来试试效果：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_playground&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 将界面的宽高先存下来</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">width</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">height</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">game_map</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">GameMap</span>(<span class=\"variable language_\">this</span>);  <span class=\"comment\">// 创建游戏画面</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">players</span> = [];  <span class=\"comment\">// 所有玩家</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.05</span>, <span class=\"string\">&#x27;white&#x27;</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.15</span>, <span class=\"literal\">true</span>));  <span class=\"comment\">// 创建自己</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 初始化时需要先关闭playground界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接下来我们实现小球的移动，我们需要给每个小球设置一个 X 轴方向的速度和 Y 轴方向的速度，在每次刷新对象的时候更新一下小球的坐标即可：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"number\">0.5</span>;  <span class=\"comment\">// x轴方向上的速度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0.5</span>;  <span class=\"comment\">// y轴方向上的速度</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在我们还需要实现小球移动到鼠标右键点击的位置，如下图所示，假设从 <code>(x, y)</code> 移动到 <code>(tx, ty)</code>，移动的距离即为两点间的欧几里得距离，<code>atan2(y, x)</code> 函数可以求出方向角 θ，我们将其移动方向归一化视为一个单位圆，那么 X 轴方向的速度即为 <code>1 * cos(θ)</code>，Y 轴方向的速度即为 <code>1 * sin(θ)</code>。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">ctx</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> = x;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> = y;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// x轴方向上的速度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// y轴方向上的速度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 要移动的距离</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> = radius;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">color</span> = color;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> = speed;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span> = is_me;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">0.1</span>;  <span class=\"comment\">// 误差小于0.1认为是0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">move_to</span>(e.<span class=\"property\">clientX</span>, e.<span class=\"property\">clientY</span>);  <span class=\"comment\">// e.clientX/Y为鼠标点击坐标</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">sqrt</span>((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_dist</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, tx, ty);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"title function_\">atan2</span>(ty - <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, tx - <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 计算真实移动距离，与一帧的移动距离取min防止移出界</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> true_move = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> * true_move;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> * true_move;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> -= true_move;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"comment\">// 角度从0画到2PI，是否逆时针为false</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>5. 创建角色技能</h1>\n<p>在 <code>playground</code> 目录下创建一个 <code>skill</code> 目录，我们先实现火球技能，在 <code>skill</code> 目录下再创建 <code>fireball</code> 目录，然后创建 <code>zbase.js</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FireBall</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 火球需要标记是哪个玩家发射的，且射出后的速度方向与大小是固定的，射程为move_length</span></span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, player, x, y, radius, vx, vy, color, speed, move_length</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">player</span> = player;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">ctx</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> = x;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> = y;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = vx;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = vy;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> = radius;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">color</span> = color;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> = speed;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = move_length;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">0.1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> true_move = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> * true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> * true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> -= true_move;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们要实现玩家选中某个技能后点击鼠标能够使用该技能，获取按键信息时不能用 Canvas，因为不能聚焦，可以用 Window 来获取，每个按键的编号可以在网上查找对照表获得：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 当前选的技能是什么</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">on</span>(<span class=\"string\">&#x27;contextmenu&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;);  <span class=\"comment\">// 取消右键的菜单功能</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">$canvas</span>.<span class=\"title function_\">mousedown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">3</span>) &#123;  <span class=\"comment\">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class=\"line\">                outer.<span class=\"title function_\">move_to</span>(e.<span class=\"property\">clientX</span>, e.<span class=\"property\">clientY</span>);  <span class=\"comment\">// e.clientX/Y为鼠标点击坐标</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (outer.<span class=\"property\">cur_skill</span> === <span class=\"string\">&#x27;fireball&#x27;</span>) &#123;</span><br><span class=\"line\">                    outer.<span class=\"title function_\">shoot_fireball</span>(e.<span class=\"property\">clientX</span>, e.<span class=\"property\">clientY</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 释放完一次技能后还原</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        $(<span class=\"variable language_\">window</span>).<span class=\"title function_\">keydown</span>(<span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.<span class=\"property\">which</span> === <span class=\"number\">81</span>) &#123;  <span class=\"comment\">// Q键</span></span><br><span class=\"line\">                outer.<span class=\"property\">cur_skill</span> = <span class=\"string\">&#x27;fireball&#x27;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">sqrt</span>((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, y = <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> radius = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span> * <span class=\"number\">0.01</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"title function_\">atan2</span>(ty - <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, tx - <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> vx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta), vy = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> color = <span class=\"string\">&#x27;orange&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> speed = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span> * <span class=\"number\">0.5</span>;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> move_length = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span> * <span class=\"number\">0.8</span>;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">FireBall</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>, <span class=\"variable language_\">this</span>, x, y, radius, vx, vy, color, speed, move_length);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>6. 创建敌人及实现简单AI</h1>\n<p>首先我们在 <code>AcGamePlayground</code> 类中添加5名敌人：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 创建敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">5</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.05</span>, <span class=\"string\">&#x27;blue&#x27;</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.15</span>, <span class=\"literal\">false</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 初始化时需要先关闭playground界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们需要让敌人移动起来，可以设定一个随机的目的地，然后移动到该目的地时再随机一个新的目的地，在 <code>Player</code> 中进行相应的修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Math.random()返回一个0~1之间的数</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> tx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> ty = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">move_to</span>(tx, ty);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">sqrt</span>((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_dist</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, tx, ty);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"title function_\">atan2</span>(ty - <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, tx - <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;  <span class=\"comment\">// AI敌人不能停下来</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> tx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span>;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ty = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span>;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"title function_\">move_to</span>(tx, ty);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 计算真实移动距离，与一帧的移动距离取min防止移出界</span></span><br><span class=\"line\">            <span class=\"keyword\">let</span> true_move = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>);</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> * true_move;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> * true_move;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> -= true_move;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>7. 火球碰撞检测</h1>\n<p>两个圆的相交检测很简单，只需要判断两个圆的圆心距离是否小于两圆的半径之和即可，我们在 <code>FireBall</code> 类中进行碰撞检测：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FireBall</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 火球需要标记是哪个玩家发射的，且射出后的速度方向与大小是固定的，射程为move_length</span></span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, player, x, y, radius, vx, vy, color, speed, move_length, damage</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage</span> = damage;  <span class=\"comment\">// 伤害</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">0.1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> true_move = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> * true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> * true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> -= true_move;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 碰撞检测</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>.<span class=\"property\">length</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> player = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>[i];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (player !== <span class=\"variable language_\">this</span>.<span class=\"property\">player</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"title function_\">is_collision</span>(player)) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"title function_\">attack</span>(player);  <span class=\"comment\">// this攻击player</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">sqrt</span>((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_collision</span>(<span class=\"params\">player</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> distance = <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_dist</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, player.<span class=\"property\">x</span>, player.<span class=\"property\">y</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (distance &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> + player.<span class=\"property\">radius</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">attack</span>(<span class=\"params\">player</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"title function_\">atan2</span>(player.<span class=\"property\">y</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, player.<span class=\"property\">x</span> - <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>);</span><br><span class=\"line\">        player.<span class=\"title function_\">is_attacked</span>(theta, <span class=\"variable language_\">this</span>.<span class=\"property\">damage</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接着我们需要实现玩家被攻击时的效果，被攻击时有向后的击退效果，且击退过程中玩家无法移动，被攻击后血量减少（使用小球半径表示血量，即被攻击后小球半径变小），血量越少移动速度越快，我们在 <code>Player</code> 类中进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">ctx</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> = x;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> = y;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// x轴方向上的速度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// y轴方向上的速度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vx</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 被击中后在x轴方向上的速度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vy</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 被击中后在y轴方向上的速度</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 要移动的距离</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> = radius;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">color</span> = color;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> = speed;  <span class=\"comment\">// 每秒移动的距离</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span> = is_me;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">0.1</span>;  <span class=\"comment\">// 误差小于0.1认为是0</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">friction</span> = <span class=\"number\">0.9</span>;  <span class=\"comment\">// 摩擦力</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 当前选的技能是什么</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">sqrt</span>((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_attacked</span>(<span class=\"params\">theta, damage</span>) &#123;  <span class=\"comment\">// 被攻击到</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> -= damage;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> *= <span class=\"number\">1.08</span>;  <span class=\"comment\">// 血量越少移动越快</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> &lt; <span class=\"number\">10</span>) &#123;  <span class=\"comment\">// 半径小于10像素认为已死</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vx</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vy</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> = damage * <span class=\"number\">90</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> &gt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;  <span class=\"comment\">// 有击退效果时玩家无法移动</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vx</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vy</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> *= <span class=\"variable language_\">this</span>.<span class=\"property\">friction</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span>) &#123;  <span class=\"comment\">// AI敌人不能停下来</span></span><br><span class=\"line\">                    <span class=\"keyword\">let</span> tx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">width</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">let</span> ty = <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">height</span>;</span><br><span class=\"line\">                    <span class=\"variable language_\">this</span>.<span class=\"title function_\">move_to</span>(tx, ty);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 计算真实移动距离，与一帧的移动距离取min防止移出界</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> true_move = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>);</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> * true_move;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> * true_move;</span><br><span class=\"line\">                <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> -= true_move;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>8. 实现被攻击时的粒子效果</h1>\n<p>我们可以设计一个当被攻击时向前爆出若干小球的粒子效果，在 <code>playground</code> 目录下创建一个 <code>particle</code> 目录，然后创建 <code>zbase.js</code>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Particle</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, vx, vy, color, speed, move_length</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">super</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = playground;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">game_map</span>.<span class=\"property\">ctx</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> = x;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> = y;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> = radius;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> = vx;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> = vy;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">color</span> = color;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> = speed;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> = move_length;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">friction</span> = <span class=\"number\">0.9</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span> || <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> &lt; <span class=\"variable language_\">this</span>.<span class=\"property\">eps</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> true_move = <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">x</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vx</span> * true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">y</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">vy</span> * true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> *= <span class=\"variable language_\">this</span>.<span class=\"property\">friction</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">move_length</span> -= true_move;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">render</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">beginPath</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">arc</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span>, <span class=\"number\">0</span>, <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"property\">fillStyle</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">ctx</span>.<span class=\"title function_\">fill</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>Player</code> 类的被击中函数中创建若干粒子：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">sqrt</span>((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_attacked</span>(<span class=\"params\">theta, damage</span>) &#123;  <span class=\"comment\">// 被攻击到</span></span><br><span class=\"line\">        <span class=\"comment\">// 创建粒子效果</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span> + <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">5</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> x = <span class=\"variable language_\">this</span>.<span class=\"property\">x</span>, y = <span class=\"variable language_\">this</span>.<span class=\"property\">y</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> radius = <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">0.2</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> theta = <span class=\"title class_\">Math</span>.<span class=\"property\">PI</span> * <span class=\"number\">2</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>();</span><br><span class=\"line\">            <span class=\"keyword\">let</span> vx = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta), vy = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">            <span class=\"keyword\">let</span> color = <span class=\"variable language_\">this</span>.<span class=\"property\">color</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> speed = <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> * <span class=\"number\">10</span>;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> move_length = <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> * <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">10</span>;</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">Particle</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>, x, y, radius, vx, vy, color, speed, move_length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> -= damage;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">speed</span> *= <span class=\"number\">1.08</span>;  <span class=\"comment\">// 血量越少移动越快</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">radius</span> &lt; <span class=\"number\">10</span>) &#123;  <span class=\"comment\">// 半径小于10像素认为已死</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">destroy</span>();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vx</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">cos</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_vy</span> = <span class=\"title class_\">Math</span>.<span class=\"title function_\">sin</span>(theta);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">damage_speed</span> = damage * <span class=\"number\">90</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>9. 敌人随机颜色</h1>\n<p>最后我们随机生成每个敌人的颜色，在 <code>Playground</code> 类中进行修改：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"comment\">// 创建敌人</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">5</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">players</span>.<span class=\"title function_\">push</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Player</span>(<span class=\"variable language_\">this</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">width</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> / <span class=\"number\">2</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.05</span>, <span class=\"variable language_\">this</span>.<span class=\"title function_\">get_random_color</span>(), <span class=\"variable language_\">this</span>.<span class=\"property\">height</span> * <span class=\"number\">0.15</span>, <span class=\"literal\">false</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">get_random_color</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> colors = [<span class=\"string\">&#x27;blue&#x27;</span>, <span class=\"string\">&#x27;red&#x27;</span>, <span class=\"string\">&#x27;pink&#x27;</span>, <span class=\"string\">&#x27;grey&#x27;</span>, <span class=\"string\">&#x27;green&#x27;</span>];</span><br><span class=\"line\">        <span class=\"keyword\">return</span> colors[<span class=\"title class_\">Math</span>.<span class=\"title function_\">floor</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() * <span class=\"number\">5</span>)];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 初始化时需要先关闭playground界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1>10. 敌人自动攻击</h1>\n<p>我们可以设置敌人随机向玩家射击，但是开局前几秒限制敌人射击，修改 <code>Player</code> 类如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Player</span> <span class=\"keyword\">extends</span> <span class=\"title class_ inherited__\">AcGameObject</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> = <span class=\"number\">0</span>;  <span class=\"comment\">// 记录游戏时间，刚开局不能攻击</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">cur_skill</span> = <span class=\"literal\">null</span>;  <span class=\"comment\">// 当前选的技能是什么</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 计算两点之间的欧几里得距离</span></span><br><span class=\"line\">    <span class=\"title function_\">get_dist</span>(<span class=\"params\">x1, y1, x2, y2</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">sqrt</span>((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 向(tx, ty)位置发射火球</span></span><br><span class=\"line\">    <span class=\"title function_\">shoot_fireball</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">move_to</span>(<span class=\"params\">tx, ty</span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">is_attacked</span>(<span class=\"params\">theta, damage</span>) &#123;  <span class=\"comment\">// 被攻击到</span></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">update</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> += <span class=\"variable language_\">this</span>.<span class=\"property\">timedelta</span> / <span class=\"number\">1000</span>;</span><br><span class=\"line\">        <span class=\"comment\">// AI敌人随机向玩家射击，游戏刚开始前三秒AI不能射击</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">spent_time</span> &gt; <span class=\"number\">3</span> &amp;&amp; !<span class=\"variable language_\">this</span>.<span class=\"property\">is_me</span> &amp;&amp; <span class=\"title class_\">Math</span>.<span class=\"title function_\">random</span>() &lt; <span class=\"number\">1</span> / <span class=\"number\">360.0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> player = <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span>.<span class=\"property\">players</span>[<span class=\"number\">0</span>];</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">shoot_fireball</span>(player.<span class=\"property\">x</span>, player.<span class=\"property\">y</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">render</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上一章：<a href=\"/posts/602.html\">Django学习笔记-创建菜单界面</a>。</p>\n<p>下一章：<a href=\"/posts/13510.html\">Django学习笔记-部署Nginx与对接AcApp</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/602.html",
            "url": "https://asanosaki.github.io/posts/602.html",
            "title": "Django学习笔记-创建菜单界面",
            "date_published": "2023-06-10T12:04:00.000Z",
            "content_html": "<blockquote>\n<p>本节内容是项目结构的划分与游戏菜单界面的设计。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. 项目总体设计</h1>\n<p>（1）系统设计</p>\n<ul>\n<li><code>menu</code>：菜单页面；</li>\n<li><code>playground</code>：游戏界面；</li>\n<li><code>settings</code>：设置界面。</li>\n</ul>\n<p>（2）文件结构</p>\n<ul>\n<li><code>templates</code>：管理 HTML 文件；</li>\n<li><code>urls</code>：管理路由，即链接与函数的对应关系；</li>\n<li><code>views</code>：管理 HTTP 函数；</li>\n<li><code>models</code>：管理数据库数据；</li>\n<li><code>static</code>：管理静态文件，比如：\n<ul>\n<li><code>css</code>：对象的格式，比如位置、长宽、颜色、背景、字体大小等；</li>\n<li><code>js</code>：对象的逻辑，比如对象的创建与销毁、事件函数、移动、变色等；</li>\n<li><code>image</code>：图片；</li>\n<li><code>audio</code>：声音；</li>\n<li>……</li>\n</ul>\n</li>\n<li><code>consumers</code>：管理 WebSocket 函数。</li>\n</ul>\n<p>（3）素材地址</p>\n<ul>\n<li>背景图片：\n<ul>\n<li>下载方式：<code>wget --output-document=自定义图片名称 图片地址</code>；</li>\n<li>本地上传：<code>scp -P 20000 .\\xxx.jpeg asanosaki@&lt;公网IP&gt;:</code>。</li>\n</ul>\n</li>\n<li><code>jQuery</code> 库：\n<ul>\n<li><code>&lt;link rel=&quot;stylesheet&quot; href=&quot;http://&lt;公网IP&gt;:8000/static/css/jquery-ui.min.css&quot;&gt;</code>；</li>\n<li><code>&lt;script src=&quot;http://&lt;公网IP&gt;:8000/static/js/jquery-3.6.1.min.js&quot;&gt;&lt;/script&gt;</code>。</li>\n</ul>\n</li>\n</ul>\n<h1>2. 全局设置与项目结构创建</h1>\n<p>为了后期方便项目的维护管理，首先先将 <code>game</code> 中的 <code>urls.py</code>、<code>models.py</code>、<code>views.py</code> 删除，将其创建为一个目录，并在这三个目录下创建好 <code>__init__.py</code> 文件，注释掉上一节中在总 URL 文件中的配置信息，然后创建好 <code>static</code> 目录。</p>\n<p>接着进行一些项目的全局设置，首先设置一下项目的时区，打开 <code>~/djangoapp/djangoapp/settings.py</code>，修改 <code>TIME_ZONE</code> 和 <code>USE_TZ</code>：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TIME_ZONE = <span class=\"string\">&#x27;Asia/Shanghai&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">USE_TZ = <span class=\"literal\">False</span></span><br></pre></td></tr></table></figure>\n<p>如果 <code>USE_TZ</code> 设置为 <code>True</code> 时，Django 会使用系统默认设置的时区，即 <code>America/Chicago</code>，此时的 <code>TIME_ZONE</code> 不管有没有设置都不起作用。</p>\n<p>注意：由于我们是在云服务器上开发的，如果是 Windows 则设置 <code>TIME_ZONE</code> 是无效的，Django 会使用本机的时间。</p>\n<p>然后将自己创建的 App 加载进来，找到 <code>INSTALLED_APPS</code>，将 <code>game/apps.py</code> 添加进来：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">INSTALLED_APPS = [</span><br><span class=\"line\">    <span class=\"string\">&#x27;game.apps.GameConfig&#x27;</span>,  <span class=\"comment\"># 添加此行</span></span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>找到 <code>STATIC_URL = 'static/'</code>，在其附近添加几行：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os  <span class=\"comment\"># 在文件首部导入包</span></span><br><span class=\"line\"></span><br><span class=\"line\">STATIC_ROOT = os.path.join(BASE_DIR, <span class=\"string\">&#x27;static&#x27;</span>)  <span class=\"comment\"># 表示要将静态文件放到static目录下</span></span><br><span class=\"line\">STATIC_URL = <span class=\"string\">&#x27;static/&#x27;</span></span><br><span class=\"line\">MEDIA_ROOT = os.path.join(BASE_DIR, <span class=\"string\">&#x27;media&#x27;</span>)</span><br><span class=\"line\">MEDIA_URL = <span class=\"string\">&#x27;media/&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>我们在 <code>game/static/</code> 中创建 <code>image/menu/</code> 目录用来存放菜单界面的背景，将图片 <code>background.png</code> 放入该目录中即可在自己的网址上访问这张图片：<code>http://&lt;公网IP&gt;:8000/static/image/menu/background.png</code>。</p>\n<p>一般 CSS 文件只需要一个就行，因此只需要在 <code>game/static/css/</code> 中创建一个 <code>game.css</code> 文件即可。JS 文件最后一般会有很多，因此在 <code>game/static/js/</code> 中创建两个目录：<code>dist</code> 和 <code>src</code>，分别表示最终合并在一起生成的 <code>js</code> 文件以及许多 <code>js</code> 源文件，我们可以写一个脚本完成合并操作，在 <code>~/djangoapp/</code> 目录下创建一个 <code>scripts</code> 目录，然后在该目录中编写一个 <code>compress_game_js.sh</code> 文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">! /bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">JS_PATH=/home/asanosaki/djangoapp/game/static/js/</span><br><span class=\"line\">JS_PATH_DIST=$&#123;JS_PATH&#125;dist/</span><br><span class=\"line\">JS_PATH_SRC=$&#123;JS_PATH&#125;src/</span><br><span class=\"line\"></span><br><span class=\"line\">find $&#123;JS_PATH_SRC&#125; -type f -name &#x27;*.js&#x27; | sort | xargs cat &gt; $&#123;JS_PATH_DIST&#125;game.js</span><br></pre></td></tr></table></figure>\n<p>添加可执行权限：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod +x compress_game_js.sh</span><br></pre></td></tr></table></figure>\n<p>我们执行一下该脚本：<code>./compress_game_js.sh</code>，可以看到 <code>~/djangoapp/game/static/js/dist/</code> 中多了一个 <code>game.js</code> 文件。</p>\n<p>此时我们先将代码上传至 Git：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd ~/djangoapp/</span><br><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m &#x27;create project structure&#x27;</span><br><span class=\"line\">git push</span><br></pre></td></tr></table></figure>\n<h1>3. 创建HTML</h1>\n<p>我们先在 <code>templates</code> 目录下创建三个目录：<code>menu</code>、<code>playground</code>、<code>settings</code>。由于项目是前后端分离的，最后可以放在多种不同的终端上运行，因此我们再建一个 <code>multiends</code> 目录。</p>\n<p>在 <code>static/src</code> 目录下也创建三个目录：<code>menu</code>、<code>playground</code>、<code>settings</code>，然后再创建一个文件 <code>zbase.js</code>，表示总文件，由于打包工具是按照字典序打包的，该文件中为总的 Class，会调用前面三个目录中的 Class，JS 在调用之前必须定义好，因此在打包时需要保证前面三个目录中的文件在 <code>zbase.js</code> 之前被打包，因此加一个字典序最大的字母在首部。</p>\n<p>在 <code>zbase.js</code> 中定义好总类：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGame</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">id</span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在 <code>templates/multiends/</code> 中创建 <code>web.html</code>，文件内容如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% load static %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;http://&lt;公网IP&gt;:8000/static/css/jquery-ui.min.css&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;http://&lt;公网IP&gt;:8000/static/js/jquery-3.6.1.min.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">&quot;stylesheet&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&#123;% static &#x27;css/game.css&#x27; %&#125;&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;&#123;% static &#x27;js/dist/game.js&#x27; %&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">style</span>=<span class=\"string\">&quot;margin: 0&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;ac_game_1&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        $(<span class=\"variable language_\">document</span>).<span class=\"title function_\">ready</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"keyword\">let</span> ac_game = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGame</span>(<span class=\"string\">&quot;ac_game_1&quot;</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h1>4. 创建Views与更新URL</h1>\n<p>我们先在 <code>views</code> 目录下创建三个目录：<code>menu</code>、<code>playground</code>、<code>settings</code>，这三个目录都是存放 Python 文件的，因此每个目录下都需要一个 <code>__init__.py</code> 文件。</p>\n<p>然后再在 <code>views</code> 目录下创建一个 <code>index.py</code> 作为总函数，该函数只会在 Web 端被调用，主要作用是用来返回上一节中的 HTML 文件的：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.shortcuts <span class=\"keyword\">import</span> render</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">index</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    <span class=\"keyword\">return</span> render(request, <span class=\"string\">&#x27;multiends/web.html&#x27;</span>)  <span class=\"comment\"># 从templates目录之后开始写路径，因为Django默认会从templates开始找HTML</span></span><br></pre></td></tr></table></figure>\n<p>现在我们开始写路由，先在 <code>urls</code> 目录下创建三个目录：<code>menu</code>、<code>playground</code>、<code>settings</code>，在每个目录下都创建一个 <code>__init__.py</code> 文件。接着同样创建一个 <code>index.py</code>，用来将所有该路径下其它目录中的路径 Include 进来，可以参考总 URL 文件编写。</p>\n<p>先在三个目录中也创建好 <code>index.py</code>，内容如下：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = []</span><br></pre></td></tr></table></figure>\n<p>此前在 <code>views</code> 目录中实现的 <code>index.py</code> 为总函数，即整个项目只有一个主链接，因此 <code>urls</code> 目录中的 <code>index.py</code> 也要将其 Include 进来：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path, include</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views.index <span class=\"keyword\">import</span> index</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;&#x27;</span>, index, name=<span class=\"string\">&#x27;index&#x27;</span>),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;menu/&#x27;</span>, include(<span class=\"string\">&#x27;game.urls.menu.index&#x27;</span>)),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;playground/&#x27;</span>, include(<span class=\"string\">&#x27;game.urls.playground.index&#x27;</span>)),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;settings/&#x27;</span>, include(<span class=\"string\">&#x27;game.urls.settings.index&#x27;</span>)),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>最后修改一下总 URL 文件（<code>~/djangoapp/djangoapp/</code> 中的 <code>urls.py</code>）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.contrib <span class=\"keyword\">import</span> admin</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path, include</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;&#x27;</span>, include(<span class=\"string\">&#x27;game.urls.index&#x27;</span>)),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>此时梳理一下路由顺序：首先会进入到 <code>~/djangoapp/djangoapp/</code> 中的 <code>urls.py</code> 中，然后发现浏览器链接中没有带后缀（例如 <code>admin/</code>），所以会进到 <code>game.urls.index</code> 中，由于没有后缀因此又调用第一个路由，也就是直接调用 <code>game.views.index</code> 中的 <code>index</code> 函数，该函数会渲染 <code>multiends/web.html</code> 里面的内容。</p>\n<p>Tips：浏览器中按 F12 打开控制台后如果看到报错：<code>The Cross-Origin-Opener-Policy header has been ignored, because the URL's origin was untrustworthy. It was defined either in the final response or a redirect.</code>，表示出现了跨域问题，在 <code>settings.py</code> 中添加如下代码即可：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SECURE_CROSS_ORIGIN_OPENER_POLICY = <span class=\"string\">&#x27;None&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>最后将代码上传至 Git：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m &#x27;modify html &amp; js &amp; views &amp; urls&#x27;</span><br><span class=\"line\">git push</span><br></pre></td></tr></table></figure>\n<h1>5. 创建菜单</h1>\n<p>我们需要创建一个菜单对象，首先在 <code>static/js/src/menu/</code> 目录中创建一个 <code>zbase.js</code> 文件，内容如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGameMenu</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;  <span class=\"comment\">// root用来传AcGame对象</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"comment\">// 如果是HTML对象通常会加一个&#x27;$&#x27;符号</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_menu&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>)</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>);  <span class=\"comment\">// 将this.$menu添加到主类的div中</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后在 <code>game.css</code> 中定义相应的样式：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.ac_game_menu</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">background-image</span>: <span class=\"built_in\">url</span>(<span class=\"string\">&#x27;/static/image/menu/background.png&#x27;</span>);  <span class=\"comment\">/* 注意不用带公网IP */</span></span><br><span class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">100%</span> <span class=\"number\">100%</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最后需要更新 <code>static/js/src/</code> 中的 <code>zbase.js</code> 文件：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGame</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">id</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">id</span> = id;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$ac_game</span> = $(<span class=\"string\">&#x27;#&#x27;</span> + id);  <span class=\"comment\">// jQuery通过id找对象的方式</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">menu</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGameMenu</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时即可在页面中看到自己的背景图片（注意更新完 JS 文件后都需要执行一下打包脚本 <code>compress_game_js.sh</code>）。</p>\n<p>Tips：如果修改完 CSS 文件后网页没有变化说明页面把 CSS 文件缓存下来了，可以按 F12 打开控制台，在 Network 选项卡中勾选上 <code>Disable cache</code>。</p>\n<p>现在我们在菜单界面添加几个按钮，首先修改菜单目录中的 <code>zbase.js</code> 文件（修改完记得运行打包脚本）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGameMenu</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;  <span class=\"comment\">// root用来传AcGame对象</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"comment\">// 如果是HTML对象通常会加一个&#x27;$&#x27;符号</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_menu&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=&#x27;ac_game_menu_btgroup&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_menu_btgroup_bt ac_game_menu_btgroup_bt_single&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        单人模式</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_menu_btgroup_bt ac_game_menu_btgroup_bt_multi&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        多人模式</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_menu_btgroup_bt ac_game_menu_btgroup_bt_settings&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        设置</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>);  <span class=\"comment\">// 将this.$menu添加到主类的div中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$single</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_menu_btgroup_bt_single&#x27;</span>);  <span class=\"comment\">// class名前面要加&#x27;.&#x27;</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$multi</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_menu_btgroup_bt_multi&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_menu_btgroup_bt_settings&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后修改 <code>game.css</code> 设置一下按钮的样式：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.ac_game_menu</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">100%</span>;</span><br><span class=\"line\">    <span class=\"attribute\">background-image</span>: <span class=\"built_in\">url</span>(<span class=\"string\">&#x27;/static/image/menu/background.png&#x27;</span>);  <span class=\"comment\">/* 注意不用带公网IP */</span></span><br><span class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">100%</span> <span class=\"number\">100%</span>;</span><br><span class=\"line\">    user-select: none;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">20vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">position</span>: relative;</span><br><span class=\"line\">    <span class=\"attribute\">top</span>: <span class=\"number\">35vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">left</span>: <span class=\"number\">19vw</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup_bt</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">18vw</span>;</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: white;</span><br><span class=\"line\">    <span class=\"attribute\">font-size</span>: <span class=\"number\">6vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">line-height</span>: <span class=\"number\">7vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">font-style</span>: italic;</span><br><span class=\"line\">    <span class=\"attribute\">padding</span>: <span class=\"number\">2vh</span>;</span><br><span class=\"line\">    <span class=\"attribute\">cursor</span>: pointer;</span><br><span class=\"line\">    <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">39</span>, <span class=\"number\">21</span>, <span class=\"number\">28</span>, <span class=\"number\">0.6</span>);</span><br><span class=\"line\">    <span class=\"attribute\">border-radius</span>: <span class=\"number\">10px</span>;</span><br><span class=\"line\">    <span class=\"attribute\">letter-spacing</span>: <span class=\"number\">0.5vw</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.ac_game_menu_btgroup_bt</span><span class=\"selector-pseudo\">:hover</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">transform</span>: <span class=\"built_in\">scale</span>(<span class=\"number\">1.2</span>);</span><br><span class=\"line\">    <span class=\"attribute\">transition</span>: <span class=\"number\">100ms</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>现在我们实现点击按钮切换页面的功能，需要给每个按钮绑定一个函数，我们可以定义一个 <code>start</code> 函数放在构造函数中，表示对象被创建出来时需要执行的一些初始化操作，即在 <code>start</code> 中可以绑定一些事件。</p>\n<p>首先我们先把游戏界面的简易版本写出来，在 <code>static/js/src/playground/</code> 目录中创建一个 <code>zbase.js</code> 文件，内容如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGamePlayground</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                游戏界面</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 初始化时需要先关闭playground界面</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭playground界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$playground</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>然后更新一下总的 <code>zbase.js</code> 文件：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGame</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">id</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">id</span> = id;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$ac_game</span> = $(<span class=\"string\">&#x27;#&#x27;</span> + id);  <span class=\"comment\">// jQuery通过id找对象的方式</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">menu</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGameMenu</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">playground</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">AcGamePlayground</span>(<span class=\"variable language_\">this</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最后在菜单界面中设置一下按钮点击的响应操作，点击单人模式按钮即可跳转到 <code>AcGamePlayground</code> 界面：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">AcGameMenu</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">root</span>) &#123;  <span class=\"comment\">// root用来传AcGame对象</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span> = root;</span><br><span class=\"line\">        <span class=\"comment\">// 如果是HTML对象通常会加一个&#x27;$&#x27;符号</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span> = $(<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">            &lt;div class=&#x27;ac_game_menu&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div class=&#x27;ac_game_menu_btgroup&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_menu_btgroup_bt ac_game_menu_btgroup_bt_single&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        单人模式</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_menu_btgroup_bt ac_game_menu_btgroup_bt_multi&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        多人模式</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;br&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=&#x27;ac_game_menu_btgroup_bt ac_game_menu_btgroup_bt_settings&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        设置</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">        `</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">root</span>.<span class=\"property\">$ac_game</span>.<span class=\"title function_\">append</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>);  <span class=\"comment\">// 将this.$menu添加到主类的div中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$single</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_menu_btgroup_bt_single&#x27;</span>);  <span class=\"comment\">// class名前面要加&#x27;.&#x27;</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$multi</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_menu_btgroup_bt_multi&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span> = <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">find</span>(<span class=\"string\">&#x27;.ac_game_menu_btgroup_bt_settings&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">start</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">start</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"title function_\">add_listening_events</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 给按钮绑定监听函数</span></span><br><span class=\"line\">    <span class=\"title function_\">add_listening_events</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outer = <span class=\"variable language_\">this</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 注意在function中调用this指的是function本身，因此需要先将外面的this存起来</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$single</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">            outer.<span class=\"title function_\">hide</span>();  <span class=\"comment\">// 关闭menu界面</span></span><br><span class=\"line\">            outer.<span class=\"property\">root</span>.<span class=\"property\">playground</span>.<span class=\"title function_\">show</span>();  <span class=\"comment\">// 显示playground界面</span></span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$multi</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$settings</span>.<span class=\"title function_\">click</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 显示menu界面</span></span><br><span class=\"line\">    <span class=\"title function_\">show</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">show</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭menu界面</span></span><br><span class=\"line\">    <span class=\"title function_\">hide</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">$menu</span>.<span class=\"title function_\">hide</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>最后将代码上传至 Git：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m &#x27;modify html &amp; css &amp; menu &amp; playground&#x27;</span><br><span class=\"line\">git push</span><br></pre></td></tr></table></figure>\n<p>上一章：<a href=\"/posts/26150.html\">Django学习笔记-概述与项目环境配置</a>。</p>\n<p>下一章：<a href=\"/posts/4217.html\">Django学习笔记-创建游戏界面</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/26150.html",
            "url": "https://asanosaki.github.io/posts/26150.html",
            "title": "Django学习笔记-概述与项目环境配置",
            "date_published": "2023-06-08T09:16:00.000Z",
            "content_html": "<blockquote>\n<p>本文记录 Django 的学习过程。<br>\nDjango 官方文档：<a href=\"https://docs.djangoproject.com/zh-hans/4.2/\">Django Web Docs</a>。<br>\n本节内容是 Django 框架的介绍以及本次开发的小游戏项目的环境配置与初始化。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. Django概述</h1>\n<p>Django 是后起之秀，近些年越来越流行，Youtube（月活20亿+）、Instagram（月活10亿+）等公司采用了 Django 框架。可以作为 Web、App、小程序、AcWing 云端 App（AC APP）等各种项目的后端。</p>\n<p>Django 优势：</p>\n<ul>\n<li>开发效率高，生态完善，有<a href=\"https://www.djangoproject.com/\">官方社区</a>长期支持。</li>\n<li>运行效率高（常见误区：Python 运行效率低，所以 Python 写的应用运行效率低）。\n<ul>\n<li>项目运行效率瓶颈有很多，比如：数据库查询、网络带宽/延迟、硬盘读写速度等，这些与框架关系不大。</li>\n<li>计算密集型的模块可以用 C/C++ 实现，然后编译成动态链接库再 <code>import</code> 进来。</li>\n<li>计算密集型的微服务可以通过 <code>thrift</code> 等工具对接，微服务的 <code>Server</code> 端代码可以用 C/C++ 语言实现。</li>\n<li>有很多工具可以将 Python 代码翻译成 C/C++，比如 Cython、Pypy。AcWing 题库中的不少题目，会发现 Python3 比 Java 还快一些。</li>\n</ul>\n</li>\n<li>既适合大公司，也适合个人开发者，平均开发一个 Web/AC App 只需要半个月至一个月。</li>\n</ul>\n<h1>2. 开发环境介绍</h1>\n<ul>\n<li>完全无需配置本地环境。利用 AC Terminal 直接在云端开发，使用工具：<code>vim</code>、<code>tmux</code> 等。不推荐在本地开发。\n<ul>\n<li>本项目会涉及多台服务器间的网络通信，如果在本地开发，未来不方便调试和部署。</li>\n<li>在本地开发无法统一开发环境，部分 Python 包在 Windows 系统上安装困难。</li>\n</ul>\n</li>\n<li>需要租一台具有公网 IP 的云服务器，并安装 <a href=\"https://docs.docker.com/engine/install/ubuntu/\">Docker</a>。\n<ul>\n<li>服务器配置无要求。</li>\n<li>后期可以利用 <code>Docker</code> 随意迁移。</li>\n</ul>\n</li>\n<li>在 AC Terminal 的 <code>/var/lib/acwing/docker/images/</code> 目录下给大家提供统一的课程 <code>Docker</code> 镜像（也会讲解如何自己配置 Django 开发环境）。\n<ul>\n<li>标准化开发环境，避免未来出现软件版本不兼容。</li>\n<li>省去配环境的环节。</li>\n</ul>\n</li>\n<li>使用 <a href=\"https://git.acwing.com/\">AC Git</a> 管理项目代码。\n<ul>\n<li>方便回滚代码。</li>\n</ul>\n</li>\n</ul>\n<h1>3. 配置Docker环境</h1>\n<p>首先拉取一个 Ubuntu 镜像：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull ubuntu:20.04</span><br></pre></td></tr></table></figure>\n<p>创建容器后进入容器配置基本环境并创建用户：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -p 20000:22 -p 8000:8000 --name ubuntu_django -itd ubuntu:20.04</span><br><span class=\"line\">docker attach ubuntu_django</span><br><span class=\"line\">apt-get update</span><br><span class=\"line\">apt-get install sudo</span><br><span class=\"line\">apt-get install vim</span><br><span class=\"line\">apt-get install tmux</span><br><span class=\"line\">apt-get install ipython3</span><br><span class=\"line\">apt-get install tree</span><br><span class=\"line\">apt-get install silversearcher-ag</span><br><span class=\"line\">apt-get install openssh-server</span><br><span class=\"line\">adduser asanosaki</span><br><span class=\"line\">usermod -aG sudo asanosaki</span><br><span class=\"line\">exit</span><br></pre></td></tr></table></figure>\n<p>然后去云服务器官网放行20000端口和8000端口，以阿里云为例，协议类型选 <code>TCP</code>，端口范围分别为 <code>目的: 8000/8000</code> 与 <code>目的: 20000/20000</code>，授权对象都为 <code>源: 0.0.0.0/0</code>。</p>\n<p>通过 SSH 远程连接容器：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh asanosaki@localhost -p 20000</span><br></pre></td></tr></table></figure>\n<p>如果出现 <code>kex_exchange_identification: read: Connection reset by peer</code> 报错，就去进入容器的根用户下编辑 <code>hosts.allow</code> 文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/hosts.allow</span><br></pre></td></tr></table></figure>\n<p>在文件中添加一行：<code>sshd: ALL</code>，然后重启 SSH 服务：<code>service ssh restart</code>。</p>\n<p>进入容器根用户安装剩余的环境：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br><span class=\"line\">apt-get install python3</span><br><span class=\"line\">apt-get install python3-pip</span><br><span class=\"line\">apt-get install git</span><br><span class=\"line\">pip install Django</span><br><span class=\"line\">pip install uwsgi</span><br><span class=\"line\">pip install supervisor</span><br></pre></td></tr></table></figure>\n<p>在命令行查看 Django 版本：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">django-admin --version</span><br></pre></td></tr></table></figure>\n<h1>4. Django项目创建</h1>\n<p>通过以下命令创建一个 Django 项目：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">django-admin startproject djangoapp</span><br></pre></td></tr></table></figure>\n<p>将项目上传至 Git（注意需要先在容器中生成公钥，并在 Git 中添加公钥）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd djangoapp/</span><br><span class=\"line\">git init</span><br><span class=\"line\">git config --global user.name &quot;xxx&quot;</span><br><span class=\"line\">git config --global user.email &quot;xxx@qq.com&quot;</span><br><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m &quot;initial project&quot;</span><br><span class=\"line\">git remote add origin git@git.acwing.com:&lt;用户ID&gt;/&lt;仓库名&gt;.git</span><br><span class=\"line\">git push --set-upstream origin master</span><br></pre></td></tr></table></figure>\n<p>尝试启动一下项目：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 manage.py runserver 0.0.0.0:8000</span><br></pre></td></tr></table></figure>\n<p>这时候访问一下网址：<code>http://&lt;云服务器的公网IP&gt;:8000/</code>，会看到提示：<code>Invalid HTTP_HOST header: '&lt;云服务器的公网IP&gt;:8000'. You may need to add '&lt;云服务器的公网IP&gt;' to ALLOWED_HOSTS.</code>，这是因为 Django 是个很安全的框架，会自动屏蔽很多可疑的访问，我们需要将公网 IP 添加到 <code>settings.py</code> 文件的 <code>ALLOWED_HOSTS</code> 中：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd djangoapp/  # 此时在 ~/djangoapp/djangoapp 中</span><br><span class=\"line\">vim settings.py</span><br><span class=\"line\">找到 ALLOWED_HOSTS = []，改为 ALLOWED_HOSTS = [&quot;&lt;公网IP&gt;&quot;]  # 注意要用引号</span><br></pre></td></tr></table></figure>\n<p>Tips：如果找不到 <code>ALLOWED_HOSTS</code> 可以使用 <code>ag</code> 命令查找：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ag ALLOWED_HOSTS</span><br></pre></td></tr></table></figure>\n<p>现在即可成功访问网址。</p>\n<p>此时会看到项目文件夹下出现了一个 <code>__pycache__</code> 目录，这个是预编译好的一些文件，用于加速 Python 运行，我们在往 Git 上传代码时最好不要上传这些中间文件，我们可以在仓库的根目录下添加一个 <code>.gitignore</code> 文件，文件内容如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">**/__pycache__</span><br><span class=\"line\">*.swp  # 过滤掉swap文件</span><br></pre></td></tr></table></figure>\n<p>最后上传至 Git：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m &quot;modify ALLOWED_HOSTS&quot;</span><br><span class=\"line\">git push</span><br></pre></td></tr></table></figure>\n<h1>5. Django App创建</h1>\n<p>在上一节中启动的页面为 Django 的默认页面，我们在开发时需要创建一个新的 App 写自己的页面，首先通过以下指令创建一个名为 <code>game</code> 的 App，创建好后当前目录下会生成一个名为 <code>game</code> 的目录：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 manage.py startapp game</span><br><span class=\"line\"></span><br><span class=\"line\">git add .</span><br><span class=\"line\">git commit -m &quot;init app game&quot;</span><br><span class=\"line\">git push</span><br></pre></td></tr></table></figure>\n<p>此时启动 <code>runserver</code> 指令时会发现出现了报错：<code>You have 18 unapplied migration(s). Your project may not work properly ......</code>，原因是有一部分的数据库修改还没有同步到数据库里，运行以下指令同步数据库的修改：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 manage.py migrate</span><br></pre></td></tr></table></figure>\n<p>打开 <code>http://&lt;公网IP&gt;:8000/admin/</code> 页面可以看到 Django 自带的管理员页面，我们可以创建管理员用户（假设用户名和密码都为 <code>admin</code>）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 manage.py createsuperuser</span><br></pre></td></tr></table></figure>\n<p>然后即可登录管理员账户进入管理员界面。</p>\n<p>我们再回过头来进入之前创建的 App 中，能看到有几个比较重要的文件：<code>models.py</code>、<code>views.py</code>，我们先手动创建剩余的比较重要的文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch urls.py</span><br><span class=\"line\">mkdir templates</span><br></pre></td></tr></table></figure>\n<p>接下来整个项目需要操作的就这四个文件，其中 <code>models.py</code> 存储各种数据结构，<code>views.py</code> 存储视图（函数），例如每点一次按钮都要调用一次服务器端的函数，<code>urls.py</code> 是一个路由，用户访问某个功能（页面）时传的是一个地址（URL），服务器端拿到这个地址后需要做一个路由，查看调用的是哪个函数，<code>templates</code> 存储 HTML 文件。</p>\n<p>首先在 <code>views.py</code> 中写一个简单的函数：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.http <span class=\"keyword\">import</span> HttpResponse</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">index</span>(<span class=\"params\">request</span>):</span><br><span class=\"line\">    <span class=\"keyword\">return</span> HttpResponse(<span class=\"string\">&#x27;Hello World!&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p>然后参考 <code>~/djangoapp/djangoapp/urls.py</code>（总 URL 文件）编写 <code>game</code> 中的 <code>urls.py</code> 文件：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> game.views <span class=\"keyword\">import</span> index</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;&#x27;</span>, index, name=<span class=\"string\">&#x27;index&#x27;</span>)</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>然后我们需要更新一下总 URL 文件（<code>~/djangoapp/djangoapp/urls.py</code>）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> django.contrib <span class=\"keyword\">import</span> admin</span><br><span class=\"line\"><span class=\"keyword\">from</span> django.urls <span class=\"keyword\">import</span> path, include</span><br><span class=\"line\"></span><br><span class=\"line\">urlpatterns = [</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;game/&#x27;</span>, include(<span class=\"string\">&#x27;game.urls&#x27;</span>)),</span><br><span class=\"line\">    path(<span class=\"string\">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>此时我们在项目根目录下启动项目：<code>python3 manage.py runserver 0.0.0.0:8000</code>，然后打开网址 <code>http://&lt;公网IP&gt;:8000/game/</code> 即可看到我们的网页，最后更新一下 Git 即可。</p>\n<h1>6. 更改Django项目名称</h1>\n<p>我们以 <code>settings.py</code> 文件为例，假设项目的目录结构为：<code>OLD_NAME/OLD_NAME/settings.py</code>，项目根目录的名称可以随意改变，即我们可以先改为 <code>NEW_NAME/OLD_NAME/...</code>，然后我们再将第二级 <code>OLD_NAME</code> 目录改为 <code>NEW_NAME</code>，修改完第二级目录的名字后我们还需要改以下几个文件：</p>\n<ul>\n<li><code>settings.py</code></li>\n</ul>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ROOT_URLCONF = <span class=\"string\">&#x27;NEW_NAME.urls&#x27;</span></span><br><span class=\"line\">WSGI_APPLICATION = <span class=\"string\">&#x27;NEW_NAME.wsgi.application&#x27;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>manage.py</code></li>\n</ul>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">os.environ.setdefault(<span class=\"string\">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class=\"string\">&#x27;NEW_NAME.settings&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>asgi.py</code></li>\n</ul>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">os.environ.setdefault(<span class=\"string\">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class=\"string\">&#x27;NEW_NAME.settings&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>wsgi.py</code></li>\n</ul>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">os.environ.setdefault(<span class=\"string\">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class=\"string\">&#x27;NEW_NAME.settings&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p>上一章：无。</p>\n<p>下一章：<a href=\"/posts/602.html\">Django学习笔记-创建菜单界面</a>。</p>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/9681.html",
            "url": "https://asanosaki.github.io/posts/9681.html",
            "title": "Python遥感常用模块Rasterio与Rioxarray教程",
            "date_published": "2023-05-29T07:52:00.000Z",
            "content_html": "<blockquote>\n<p><code>rasterio</code> 是一个很多模块是基于 <code>GDAL</code> 的 Python 包，可用于处理地理空间栅格数据，例如 GeoTIFF 文件。<code>xarray</code> 是一个为数组提供标签，例如尺寸、坐标和其他特定属性的 Python 包，它使大维数组的工作更加直观。<code>rioxarray</code> 结合了 <code>rasterio</code> 的功能和 <code>xarray</code> 的所有优点。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. Rasterio与Rioxarray安装</h1>\n<p>首先安装 Rasterio 模块，（本人使用 <code>conda</code> 安装时遇到过报错 <code>ImportError: cannot import name 'CRS' from 'pyproj' (unknown location)</code>，是由于 <code>pyproj</code> 模块安装不全，因此建议采用后面的离线安装方式或者之后遇到问题时删除 <code>pyproj</code> 模块后再离线安装该模块）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">conda install gdal</span><br><span class=\"line\">conda install rasterio</span><br></pre></td></tr></table></figure>\n<p>如果安装失败可以采用离线安装的方式，Rasterio 依赖很多第三方库，所以比较麻烦，按下面的顺序依次安装即可，可以尝试使用 <code>pip</code> 安装或者下载 <code>.whl</code> 文件离线安装（注意对上 Python 版本）：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pyproj</span><br><span class=\"line\">Shapely</span><br><span class=\"line\">GDAL</span><br><span class=\"line\">Fiona</span><br><span class=\"line\">rasterio</span><br></pre></td></tr></table></figure>\n<p>各个模块的链接：<a href=\"https://pypi.org/project/pyproj/\">Pyproj</a>、<a href=\"https://pypi.org/project/shapely/\">Shapely</a>、<a href=\"https://pypi.org/project/GDAL/\">GDAL</a>、<a href=\"https://pypi.org/project/Fiona/\">Fiona</a>、<a href=\"https://pypi.org/project/rasterio/\">Rasterio</a>。</p>\n<p>离线安装指令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install E:\\GDAL-1.2.10-cp310-cp310-win_amd64.whl</span><br></pre></td></tr></table></figure>\n<p>在 Python 中使用 Anaconda 安装 <code>rioxarray</code> 包时，首先需要安装 <code>GDAL</code> 和 <code>rasterio</code>，然后再安装 <code>rioxarray</code>：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install rioxarray</span><br></pre></td></tr></table></figure>\n<h1>2. 使用教程</h1>\n<p>（1）使用 Rioxarray 读取并展示图像：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> rasterio</span><br><span class=\"line\"><span class=\"keyword\">import</span> rioxarray</span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"></span><br><span class=\"line\">plt.rcParams[<span class=\"string\">&#x27;font.sans-serif&#x27;</span>] = [<span class=\"string\">&#x27;SimHei&#x27;</span>]</span><br><span class=\"line\">plt.rcParams[<span class=\"string\">&#x27;axes.unicode_minus&#x27;</span>] = <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\">img_path = <span class=\"string\">&#x27;../images/tiff_img.tif&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">img = rioxarray.open_rasterio(img_path)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(img.shape)  <span class=\"comment\"># (22, 488, 480)，第一维为通道数</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">type</span>(img))  <span class=\"comment\"># &lt;class &#x27;xarray.core.dataarray.DataArray&#x27;&gt;</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">type</span>(img.values))  <span class=\"comment\"># &lt;class &#x27;numpy.ndarray&#x27;&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">fig, axes = plt.subplots(<span class=\"number\">1</span>, <span class=\"number\">2</span>, figsize=(<span class=\"number\">10</span>, <span class=\"number\">6</span>))</span><br><span class=\"line\"><span class=\"keyword\">for</span> ax <span class=\"keyword\">in</span> axes.flat:</span><br><span class=\"line\">    ax_img = ax.imshow(img[<span class=\"number\">0</span>], cmap=<span class=\"string\">&#x27;viridis&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> ax, title <span class=\"keyword\">in</span> <span class=\"built_in\">zip</span>(axes.flat, [<span class=\"string\">&#x27;img1&#x27;</span>, <span class=\"string\">&#x27;img2&#x27;</span>]):</span><br><span class=\"line\">    ax.set_title(title)</span><br><span class=\"line\">fig.colorbar(mappable=ax_img, label=<span class=\"string\">&#x27;FSC&#x27;</span>, orientation=<span class=\"string\">&#x27;horizontal&#x27;</span>, ax=axes, fraction=<span class=\"number\">0.04</span>)  <span class=\"comment\"># 图例，fraction可调整大小</span></span><br><span class=\"line\"></span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></table></figure>\n<p>也可以用另一种形式展示（注意如果使用 Rasterio 读取图像则无法使用该方式展示图像）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plt.figure(dpi=<span class=\"number\">300</span>, figsize=(<span class=\"number\">15</span>, <span class=\"number\">5</span>))</span><br><span class=\"line\">plt.subplots_adjust(hspace=<span class=\"number\">0.2</span>, wspace=<span class=\"number\">0.5</span>)</span><br><span class=\"line\">plt.subplot(<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">img[<span class=\"number\">0</span>].plot(cmap=<span class=\"string\">&#x27;terrain&#x27;</span>)  <span class=\"comment\"># getting the first band</span></span><br><span class=\"line\">plt.subplot(<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">2</span>)</span><br><span class=\"line\">img[<span class=\"number\">1</span>].plot(cmap=<span class=\"string\">&#x27;terrain&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># plt.savefig(&#x27;1.png&#x27;, dpi=300, bbox_inches=&#x27;tight&#x27;, pad_inches=0)</span></span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></table></figure>\n<p>（2）使用 Rasterio 读取图像：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">img = rasterio.<span class=\"built_in\">open</span>(img_path).read()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(img.shape)  <span class=\"comment\"># (22, 488, 480)</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">type</span>(img))  <span class=\"comment\"># &lt;class &#x27;numpy.ndarray&#x27;&gt;</span></span><br></pre></td></tr></table></figure>\n<p>（3）转换为 Tensor 类型：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> torch</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"></span><br><span class=\"line\">img_torch = torch.tensor(np.array(img.values), dtype=torch.float32)  <span class=\"comment\"># Rioxarray转Tensor</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(img_torch.shape)  <span class=\"comment\"># torch.Size([22, 488, 480])</span></span><br><span class=\"line\"></span><br><span class=\"line\">img_torch = torch.tensor(img, dtype=torch.float32)  <span class=\"comment\"># Rasterio转Tensor</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(img_torch.shape)  <span class=\"comment\"># torch.Size([22, 488, 480])</span></span><br></pre></td></tr></table></figure>\n<p>（4）将 TIFF 图像逐像素提取出数据构建 CSV 文件：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> tqdm</span><br><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.model_selection <span class=\"keyword\">import</span> train_test_split</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">read_image</span>(<span class=\"params\">img_path</span>):</span><br><span class=\"line\">    img = rasterio.<span class=\"built_in\">open</span>(img_path).read()</span><br><span class=\"line\">    band, height, width = np.shape(img)</span><br><span class=\"line\"></span><br><span class=\"line\">    img_data_list = []</span><br><span class=\"line\">    <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> tqdm.trange(height):</span><br><span class=\"line\">        <span class=\"keyword\">for</span> y <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(width):</span><br><span class=\"line\">            temp = img[::, x, y]</span><br><span class=\"line\">            <span class=\"keyword\">if</span> np.array(np.isnan(temp), dtype=np.int8).<span class=\"built_in\">sum</span>() &gt; <span class=\"number\">0</span>:  <span class=\"comment\"># 过滤nan值</span></span><br><span class=\"line\">                <span class=\"keyword\">continue</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                img_data_list.append(temp.tolist())</span><br><span class=\"line\"></span><br><span class=\"line\">    img_arr = np.array(img_data_list)</span><br><span class=\"line\">    img_arr = np.around(img_arr, <span class=\"number\">6</span>)  <span class=\"comment\"># 将数据四舍五入保留6位小数</span></span><br><span class=\"line\">    labels = img_arr[:, <span class=\"number\">0</span>]  <span class=\"comment\"># 第一个特征为标签</span></span><br><span class=\"line\">    dataset = img_arr[:, <span class=\"number\">1</span>:]  <span class=\"comment\"># 之后的特征为训练数据</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(os.path.basename(img_path), <span class=\"string\">&#x27;读取成功!&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># return dataset, labels</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> img_arr</span><br><span class=\"line\"></span><br><span class=\"line\">total_dataset = np.zeros((<span class=\"number\">1</span>, <span class=\"number\">22</span>), dtype=np.float32)</span><br><span class=\"line\">img_data = read_image(img_path)</span><br><span class=\"line\">total_dataset = np.append(total_dataset, img_data, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\">total_dataset = np.delete(total_dataset, obj=<span class=\"number\">0</span>, axis=<span class=\"number\">0</span>)  <span class=\"comment\"># 按行(axis=0)删除第一行(obj=0)元素</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(total_dataset, <span class=\"string\">&#x27;\\n&#x27;</span>, np.shape(total_dataset))</span><br><span class=\"line\"><span class=\"comment\"># [[0.570768 0.14354  0.159068 ... 0.458602 1.       0.4     ]</span></span><br><span class=\"line\"><span class=\"comment\">#  [0.307365 0.14354  0.159068 ... 0.458602 1.       0.4     ]</span></span><br><span class=\"line\"><span class=\"comment\">#  [0.005285 0.14354  0.159068 ... 0.428406 1.       0.4     ]</span></span><br><span class=\"line\"><span class=\"comment\">#  ...</span></span><br><span class=\"line\"><span class=\"comment\">#  [0.993229 0.393478 0.370807 ... 0.243081 1.       0.8     ]</span></span><br><span class=\"line\"><span class=\"comment\">#  [0.967867 0.370807 0.356894 ... 0.243081 1.       0.8     ]</span></span><br><span class=\"line\"><span class=\"comment\">#  [0.945627 0.321429 0.305714 ... 0.243081 1.       0.8     ]]</span></span><br><span class=\"line\"><span class=\"comment\">#  (116082, 22)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 一张影像22个波段，每一波段为一种特征，特征名如下，其中FSC既是模型训练时的标签数据也是模型输出数据</span></span><br><span class=\"line\">feature_name = [<span class=\"string\">&#x27;FSC&#x27;</span>, <span class=\"string\">&#x27;SR1&#x27;</span>, <span class=\"string\">&#x27;SR2&#x27;</span>, <span class=\"string\">&#x27;SR3&#x27;</span>, <span class=\"string\">&#x27;SR4&#x27;</span>, <span class=\"string\">&#x27;SR5&#x27;</span>, <span class=\"string\">&#x27;SR6&#x27;</span>, <span class=\"string\">&#x27;SR7&#x27;</span>, <span class=\"string\">&#x27;NDVI&#x27;</span>, <span class=\"string\">&#x27;NDSI&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;NDFSI&#x27;</span>, <span class=\"string\">&#x27;SensorZenith&#x27;</span>, <span class=\"string\">&#x27;SensorAzimuth&#x27;</span>, <span class=\"string\">&#x27;SolarZenith&#x27;</span>, <span class=\"string\">&#x27;SolarAzimuth&#x27;</span>,</span><br><span class=\"line\">                <span class=\"string\">&#x27;Dem&#x27;</span>, <span class=\"string\">&#x27;Slope&#x27;</span>, <span class=\"string\">&#x27;Aspect&#x27;</span>, <span class=\"string\">&#x27;LST&#x27;</span>, <span class=\"string\">&#x27;A2T&#x27;</span>, <span class=\"string\">&#x27;SC&#x27;</span>, <span class=\"string\">&#x27;LCT&#x27;</span>]</span><br><span class=\"line\">df = pd.DataFrame(total_dataset, columns=feature_name)</span><br><span class=\"line\">df.to_csv(<span class=\"string\">&#x27;../data/MODIS_total_data.csv&#x27;</span>, index=<span class=\"literal\">False</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(df)</span><br><span class=\"line\"><span class=\"comment\">#              FSC       SR1       SR2       SR3  ...       LST       A2T   SC  LCT</span></span><br><span class=\"line\"><span class=\"comment\"># 0       0.570768  0.143540  0.159068  0.165776  ...  0.447205  0.458602  1.0  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># 1       0.307365  0.143540  0.159068  0.165776  ...  0.447205  0.458602  1.0  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># ...          ...       ...       ...       ...  ...       ...       ...  ...  ...</span></span><br><span class=\"line\"><span class=\"comment\"># 116080  0.967867  0.370807  0.356894  0.384162  ...  0.252946  0.243081  1.0  0.8</span></span><br><span class=\"line\"><span class=\"comment\"># 116081  0.945627  0.321429  0.305714  0.327329  ...  0.252946  0.243081  1.0  0.8</span></span><br><span class=\"line\"><span class=\"comment\"># [116082 rows x 22 columns]</span></span><br><span class=\"line\"></span><br><span class=\"line\">train_data, valid_data = train_test_split(df, test_size=<span class=\"number\">0.3</span>, random_state=<span class=\"number\">1</span>)  <span class=\"comment\"># 按7:3的比例划分train_data与valid_data</span></span><br><span class=\"line\">train_data.to_csv(<span class=\"string\">&#x27;../data/MODIS_train_data.csv&#x27;</span>, index=<span class=\"literal\">False</span>)</span><br><span class=\"line\">valid_data.to_csv(<span class=\"string\">&#x27;../data/MODIS_valid_data.csv&#x27;</span>, index=<span class=\"literal\">False</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(train_data)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(valid_data)</span><br><span class=\"line\"><span class=\"comment\">#             FSC       SR1       SR2  ...       A2T        SC  LCT</span></span><br><span class=\"line\"><span class=\"comment\"># 65463  1.000000  0.868261  0.860124  ...  0.306415  0.954102  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># 71636  0.000000  0.074969  0.090683  ...  0.492837  0.021780  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># ...         ...       ...       ...  ...       ...       ...  ...</span></span><br><span class=\"line\"><span class=\"comment\"># 77708  0.836359  0.252298  0.268199  ...  0.400243  1.000000  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># 98539  0.004958  0.048758  0.073168  ...  0.547051  0.000000  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># [81257 rows x 22 columns]</span></span><br><span class=\"line\"><span class=\"comment\">#              FSC       SR1       SR2  ...       A2T        SC  LCT</span></span><br><span class=\"line\"><span class=\"comment\"># 24035   0.907556  0.579814  0.588075  ...  0.332088  1.000000  0.8</span></span><br><span class=\"line\"><span class=\"comment\"># 26625   0.988592  0.708696  0.702981  ...  0.334435  0.999297  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># ...          ...       ...       ...  ...       ...       ...  ...</span></span><br><span class=\"line\"><span class=\"comment\"># 22745   0.000000  0.054348  0.127143  ...  0.494257  0.532436  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># 31068   0.994422  0.562795  0.532174  ...  0.384267  1.000000  0.4</span></span><br><span class=\"line\"><span class=\"comment\"># [34825 rows x 22 columns]</span></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/31783.html",
            "url": "https://asanosaki.github.io/posts/31783.html",
            "title": "Python绘图模块Plotly教程",
            "date_published": "2023-05-29T07:42:00.000Z",
            "content_html": "<blockquote>\n<p>Plotly 是一个快速完善并崛起的交互式的、开源的绘图库库，Python 库则是它的一个重要分支。现已支持超过40种独特的图表类型，涵盖了广泛的统计、金融、地理、科学和三维用例。</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1>1. Plotly安装</h1>\n<p>Python 中可以使用 <code>pip</code> 或者 <code>conda</code> 安装 Plotly：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install plotly</span><br><span class=\"line\">conda install plotly</span><br></pre></td></tr></table></figure>\n<h1>2. Plotly绘图教程</h1>\n<h2 id=\"2-1-折线图与散点图\">2.1 折线图与散点图</h2>\n<p>折线图不仅可以表示数量的多少，而且可以反映同一事物在不同时间里的发展变化的情况，易于显示数据变化趋势，可以直观地反映这种变化以及各组之间的差别。</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> plotly.graph_objects <span class=\"keyword\">as</span> go</span><br><span class=\"line\"></span><br><span class=\"line\">x = np.arange(<span class=\"number\">5</span>)</span><br><span class=\"line\">y1 = np.random.rand(<span class=\"number\">5</span>) * <span class=\"number\">5</span></span><br><span class=\"line\">y2 = np.random.rand(<span class=\"number\">5</span>) * <span class=\"number\">5</span></span><br><span class=\"line\">y3 = np.random.rand(<span class=\"number\">5</span>) * <span class=\"number\">5</span></span><br><span class=\"line\"></span><br><span class=\"line\">fig = go.Figure(</span><br><span class=\"line\">    data=[</span><br><span class=\"line\">        <span class=\"comment\"># name为图例名，textfont设置字体属性，mode为绘图模式，marker设置颜色否则后续导出图像会丢失颜色（不导出可不设置该参数也有默认颜色）</span></span><br><span class=\"line\">        go.Scatter(name=<span class=\"string\">&#x27;Lines&#x27;</span>, x=x, y=y1, textfont=<span class=\"built_in\">dict</span>(size=<span class=\"number\">25</span>), mode=<span class=\"string\">&#x27;lines&#x27;</span>, marker=<span class=\"built_in\">dict</span>(color=<span class=\"string\">&#x27;#0068C9&#x27;</span>)),</span><br><span class=\"line\">        go.Scatter(name=<span class=\"string\">&#x27;Markers&#x27;</span>, x=x, y=y2, textfont=<span class=\"built_in\">dict</span>(size=<span class=\"number\">25</span>), mode=<span class=\"string\">&#x27;markers&#x27;</span>),</span><br><span class=\"line\">        go.Scatter(name=<span class=\"string\">&#x27;Lines&amp;Markers&#x27;</span>, x=x, y=y3, textfont=<span class=\"built_in\">dict</span>(size=<span class=\"number\">25</span>), mode=<span class=\"string\">&#x27;lines+markers&#x27;</span>),</span><br><span class=\"line\">    ]</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置图像格式</span></span><br><span class=\"line\">fig.update_layout(</span><br><span class=\"line\">    autosize=<span class=\"literal\">False</span>, width=<span class=\"number\">1200</span>, height=<span class=\"number\">650</span>,  <span class=\"comment\"># 取消自动大小，手动设置宽高</span></span><br><span class=\"line\">    title=<span class=\"string\">&#x27;This is title&#x27;</span>,  <span class=\"comment\"># 标题</span></span><br><span class=\"line\">    xaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;X&#x27;</span>, nticks=<span class=\"number\">5</span>),  <span class=\"comment\"># 设置X轴属性</span></span><br><span class=\"line\">    yaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;Y&#x27;</span>, nticks=<span class=\"number\">11</span>, <span class=\"built_in\">range</span>=(<span class=\"number\">0</span>, <span class=\"number\">5</span>)),  <span class=\"comment\"># 设置Y轴属性，nticks表示划分为多少段</span></span><br><span class=\"line\">    showlegend=<span class=\"literal\">True</span>  <span class=\"comment\"># 显示图例</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.show()</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-2-饼图\">2.2 饼图</h2>\n<p>饼图用于强调各项数据占总体的占比，强调个体和整体的比较。</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fig = go.Figure(</span><br><span class=\"line\">    <span class=\"comment\"># textinfo表示显示内容是百分比还是标签，hoverinfo表示鼠标悬停的显示内容，pull表示每一块往外拉的比例</span></span><br><span class=\"line\">    go.Pie(labels=[<span class=\"string\">&#x27;Train data&#x27;</span>, <span class=\"string\">&#x27;Valid data&#x27;</span>], values=[<span class=\"number\">7</span>, <span class=\"number\">3</span>],</span><br><span class=\"line\">           textinfo=<span class=\"string\">&#x27;percent&#x27;</span>, hoverinfo=<span class=\"string\">&#x27;label+percent&#x27;</span>,</span><br><span class=\"line\">           textfont=<span class=\"built_in\">dict</span>(size=<span class=\"number\">15</span>), pull=[<span class=\"number\">0</span>, <span class=\"number\">0.05</span>],</span><br><span class=\"line\">           title=<span class=\"string\">&#x27;训练集划分&#x27;</span>, titlefont=<span class=\"built_in\">dict</span>(size=<span class=\"number\">18</span>),</span><br><span class=\"line\">           marker=<span class=\"built_in\">dict</span>(colors=[<span class=\"string\">&#x27;#0068C9&#x27;</span>, <span class=\"string\">&#x27;#83C9FF&#x27;</span>]))</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.update_layout(</span><br><span class=\"line\">    autosize=<span class=\"literal\">False</span>, width=<span class=\"number\">600</span>, height=<span class=\"number\">450</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.show()</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-3-直方图\">2.3 直方图</h2>\n<p>直方图虽然也和条形图一样通过矩形的长度表示数值，但他的宽度一般用于表示各组的组距，因此其高度与宽度均有意义，适合展示大量数据集的统计结果，直方图的表示的数据通常是连续排列，而柱状图则是分开排列。</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">x = np.random.rand(<span class=\"number\">1000</span>) * <span class=\"number\">30</span>  <span class=\"comment\"># 生成1000个0-30之间的数</span></span><br><span class=\"line\"></span><br><span class=\"line\">fig = go.Figure(</span><br><span class=\"line\">    data=[</span><br><span class=\"line\">        go.Histogram(name=<span class=\"string\">&#x27;X&#x27;</span>, x=x)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.update_layout(</span><br><span class=\"line\">    autosize=<span class=\"literal\">False</span>, width=<span class=\"number\">1350</span>, height=<span class=\"number\">600</span>,</span><br><span class=\"line\">    xaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;Value&#x27;</span>),</span><br><span class=\"line\">    yaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;Count&#x27;</span>),</span><br><span class=\"line\">    showlegend=<span class=\"literal\">True</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.update_traces(opacity=<span class=\"number\">0.6</span>)  <span class=\"comment\"># 设置透明度</span></span><br><span class=\"line\"></span><br><span class=\"line\">fig.show()</span><br></pre></td></tr></table></figure>\n<p>可设置 <code>barmode</code> 参数实现多个直方图覆盖的效果：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">x1 = np.random.rand(<span class=\"number\">1000</span>) * <span class=\"number\">30</span></span><br><span class=\"line\">x2 = np.random.rand(<span class=\"number\">500</span>) * <span class=\"number\">30</span></span><br><span class=\"line\"></span><br><span class=\"line\">fig = go.Figure(</span><br><span class=\"line\">    data=[</span><br><span class=\"line\">        go.Histogram(name=<span class=\"string\">&#x27;X1&#x27;</span>, x=x1),</span><br><span class=\"line\">        go.Histogram(name=<span class=\"string\">&#x27;X2&#x27;</span>, x=x2)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.update_layout(</span><br><span class=\"line\">    barmode=<span class=\"string\">&#x27;overlay&#x27;</span>,  <span class=\"comment\"># 设置覆盖模式</span></span><br><span class=\"line\">    autosize=<span class=\"literal\">False</span>, width=<span class=\"number\">1350</span>, height=<span class=\"number\">600</span>,</span><br><span class=\"line\">    xaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;Value&#x27;</span>),</span><br><span class=\"line\">    yaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;Count&#x27;</span>),</span><br><span class=\"line\">    showlegend=<span class=\"literal\">True</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.update_traces(opacity=<span class=\"number\">0.6</span>)  <span class=\"comment\"># 设置透明度</span></span><br><span class=\"line\"></span><br><span class=\"line\">fig.show()</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-4-条形图\">2.4 条形图</h2>\n<p>条形图用于比较各组数据的差异性，强调进行个体间的比较。</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">x = np.arange(<span class=\"number\">10</span>)</span><br><span class=\"line\">y = np.random.randint(<span class=\"number\">30</span>, size=<span class=\"number\">10</span>) + <span class=\"number\">1</span>  <span class=\"comment\"># 生成10个1~30的整数</span></span><br><span class=\"line\"></span><br><span class=\"line\">fig = go.Figure(</span><br><span class=\"line\">    data=[</span><br><span class=\"line\">        go.Bar(name=<span class=\"string\">&#x27;Bar1&#x27;</span>, x=x, y=y, textfont=<span class=\"built_in\">dict</span>(size=<span class=\"number\">25</span>))</span><br><span class=\"line\">    ]</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.update_layout(</span><br><span class=\"line\">    autosize=<span class=\"literal\">False</span>, width=<span class=\"number\">800</span>, height=<span class=\"number\">500</span>,</span><br><span class=\"line\">    title=<span class=\"string\">&#x27;Bar&#x27;</span>,</span><br><span class=\"line\">    xaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;X&#x27;</span>),</span><br><span class=\"line\">    yaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;Y&#x27;</span>),</span><br><span class=\"line\">    showlegend=<span class=\"literal\">True</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.show()</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-5-热力图\">2.5 热力图</h2>\n<p>热力图是一种特殊的图表，它是一种通过对色块着色来显示数据的统计图表，在绘图时，需要指定每个颜色映射的规则（一般以颜色的强度或色调为标准）；比如颜色越深的表示数值越大、程度越深或者颜色越浅的数值越大、程度越深。热力图适合用于查看总体的情况、观察特殊值或者显示多个变量之间的差异性、检测它们之间是否存在相关性等等。</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df = pd.read_csv(<span class=\"string\">&#x27;../data/MODIS/test_data.csv&#x27;</span>, nrows=<span class=\"number\">10</span>)  <span class=\"comment\"># [10 rows x 22 columns]</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(df.head(<span class=\"number\">1</span>))</span><br><span class=\"line\"><span class=\"comment\">#    FSC       SR1       SR2       SR3  ...       LST       A2T   SC  LCT</span></span><br><span class=\"line\"><span class=\"comment\"># 0  1.0  0.587019  0.551739  0.565093  ...  0.129661  0.205581  1.0  0.8</span></span><br><span class=\"line\"></span><br><span class=\"line\">pearson = df.corr()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pearson.values.shape)  <span class=\"comment\"># (22, 22)</span></span><br><span class=\"line\">features = df.columns.values  <span class=\"comment\"># 或者features = pearson.index.values</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(features)  <span class=\"comment\"># [&#x27;FSC&#x27; &#x27;SR1&#x27; &#x27;SR2&#x27; &#x27;SR3&#x27; ...]</span></span><br><span class=\"line\"></span><br><span class=\"line\">fig = go.Figure(</span><br><span class=\"line\">    data=[</span><br><span class=\"line\">        go.Heatmap(x=features, y=features, z=pearson.values, colorscale=<span class=\"string\">&#x27;blues&#x27;</span>)</span><br><span class=\"line\">    ]</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.update_layout(</span><br><span class=\"line\">    autosize=<span class=\"literal\">False</span>, width=<span class=\"number\">900</span>, height=<span class=\"number\">900</span>,</span><br><span class=\"line\">    title=<span class=\"string\">&#x27;皮尔逊相关系数热力图&#x27;</span>,</span><br><span class=\"line\">    <span class=\"comment\"># 以下注释的两行代码用于保存本地时调整字体的大小防止显示不全</span></span><br><span class=\"line\">    <span class=\"comment\"># xaxis=dict(title=&#x27;Feature&#x27;, titlefont=dict(size=10), tickfont=dict(size=8)),</span></span><br><span class=\"line\">    <span class=\"comment\"># yaxis=dict(title=&#x27;Feature&#x27;, titlefont=dict(size=10), tickfont=dict(size=8)),</span></span><br><span class=\"line\">    xaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;Features&#x27;</span>),</span><br><span class=\"line\">    yaxis=<span class=\"built_in\">dict</span>(title=<span class=\"string\">&#x27;Features&#x27;</span>),</span><br><span class=\"line\">    showlegend=<span class=\"literal\">True</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">fig.show()</span><br></pre></td></tr></table></figure>\n<h2 id=\"2-6-导出图像到本地\">2.6 导出图像到本地</h2>\n<p>首先我们需要安装两个依赖项：<code>orca</code> 和 <code>psutil</code>，<code>orca</code> 在 PyPi 存储库中不可用，因此需要使用 <code>conda</code> 安装：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">conda install -c plotly plotly-orca psutil</span><br></pre></td></tr></table></figure>\n<p>或者直接安装 <code>kaleido</code> 模块：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install kaleido</span><br></pre></td></tr></table></figure>\n<p>安装完成后即可使用 Plotly 的 <code>io</code> 库导出图像（格式可以是 SVG、JPG、PNG等）：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> plotly.io <span class=\"keyword\">as</span> pio</span><br><span class=\"line\"></span><br><span class=\"line\">pio.write_image(fig, <span class=\"string\">&#x27;images/figure.svg&#x27;</span>)</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Python"
            ]
        },
        {
            "id": "https://asanosaki.github.io/posts/55.html",
            "url": "https://asanosaki.github.io/posts/55.html",
            "title": "Python路径操作模块pathlib教程",
            "date_published": "2023-03-31T02:47:00.000Z",
            "content_html": "<blockquote>\n<p>Python 路径操作新标准：<code>pathlib</code> 模块相较于老式的 <code>os.path</code> 更为简洁易用，本文为该模块的使用教程。</p>\n</blockquote>\n<span id=\"more\"></span>\n<p><code>pathlib</code> 库从 Python 3.4 开始，到 Python 3.6 已经比较成熟。如果你的新项目可以直接用 3.6 及以上，建议用 <code>pathlib</code>。相比于老式的 <code>os.path</code> 有几个优势：</p>\n<ul>\n<li>老的路径操作函数管理比较混乱，有的是导入 <code>os</code>，有的又是在 <code>os.path</code> 当中，而新的用法统一可以用 <code>pathlib</code> 管理。</li>\n<li>老用法在处理不同操作系统 Win、Mac 以及 Linux 之间很吃力。换了操作系统常常要改代码，还经常需要进行一些额外操作。</li>\n<li>老用法主要是函数形式，返回的数据类型通常是字符串。但是路径和字符串并不等价，所以在使用 <code>os</code> 操作路径的时候常常还要引入其他类库协助操作。新用法是面向对象，处理起来更灵活方便。</li>\n<li><code>pathlib</code> 简化了很多操作，用起来更轻松。</li>\n</ul>\n<h1>1. 路径获取</h1>\n<p><strong>（1）获取当前工作目录</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(pathlib.Path.cwd())  <span class=\"comment\"># D:\\Dive into Deep Learning\\src</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"built_in\">str</span>(pathlib.Path.cwd()))  <span class=\"comment\"># D:\\Dive into Deep Learning\\src</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注意：工作目录是在哪个目录下运行你的程序，不是项目目录。</p>\n</blockquote>\n<p>虽然在这里打印出来的很像一个字符串，但实际上得到的是一个 <code>WindowsPath('D:\\Dive into Deep Learning\\src')</code> 对象，如果只想得到字符串表示，不想要 <code>WindowsPath</code> 对象，可以用 <code>str()</code> 转化。</p>\n<p><strong>（2）获取用户 Home 目录</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(pathlib.Path.home())  <span class=\"comment\"># C:\\Users\\AsanoSaki</span></span><br></pre></td></tr></table></figure>\n<p><strong>（3）获取当前文件路径</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(pathlib.Path(__file__))  <span class=\"comment\"># D:\\Dive into Deep Learning\\src\\路径操作.py</span></span><br></pre></td></tr></table></figure>\n<p><strong>（4）获取任意字符串路径</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir_path = pathlib.Path(<span class=\"string\">&#x27;../images&#x27;</span>)</span><br><span class=\"line\">file_path = pathlib.Path(<span class=\"string\">&#x27;../images/cat1.jpg&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(dir_path)  <span class=\"comment\"># ..\\images</span></span><br></pre></td></tr></table></figure>\n<p><strong>（5）获取绝对路径</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(dir_path.resolve())  <span class=\"comment\"># D:\\Dive into Deep Learning\\images</span></span><br></pre></td></tr></table></figure>\n<p><strong>（6）获取文件属性</strong></p>\n<p>文件属性比如文件大小、创建时间、修改时间等。</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(file_path.stat())  <span class=\"comment\"># os.stat_result(st_mode=33206, st_ino=281474978388098, st_dev=80873957, st_nlink=1, st_uid=0, st_gid=0, st_size=53081, st_atime=1680229254, st_mtime=1670460384, st_ctime=1680228818)</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(file_path.stat().st_size)  <span class=\"comment\"># 53081</span></span><br></pre></td></tr></table></figure>\n<h1>2. 路径组成部分</h1>\n<p>获取路径的组成部分非常方便：</p>\n<ul>\n<li><code>.name</code>：文件名，包含后缀名，如果是目录则获取目录名。</li>\n<li><code>.stem</code>：文件名，不包含后缀。</li>\n<li><code>.suffix</code>：后缀，比如 <code>.txt</code>、<code>.png</code>。</li>\n<li><code>.parent</code>：父级目录，相当于 <code>cd ..</code>。</li>\n<li><code>.anchor</code>：锚，目录前面的部分 <code>C:\\</code> 或者 <code>/</code>。</li>\n</ul>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(file_path.name)  <span class=\"comment\"># cat1.jpg</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(file_path.stem)  <span class=\"comment\"># cat1</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(file_path.suffix)  <span class=\"comment\"># .jpg</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(file_path.parent)  <span class=\"comment\"># ..\\images</span></span><br></pre></td></tr></table></figure>\n<h1>3. 子路径扫描</h1>\n<p><strong>（1）扫描某个目录下的所有路径</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">all_path = [<span class=\"built_in\">str</span>(p) <span class=\"keyword\">for</span> p <span class=\"keyword\">in</span> dir_path.iterdir() <span class=\"keyword\">if</span> dir_path.is_dir()]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(all_path)  <span class=\"comment\"># [&#x27;..\\\\images\\\\cat1.jpg&#x27;, &#x27;..\\\\images\\\\cat2.jpg&#x27;, &#x27;..\\\\images\\\\cat3.jpg&#x27;, &#x27;..\\\\images\\\\catdog.jpg&#x27;]</span></span><br></pre></td></tr></table></figure>\n<p><strong>（2）使用模式匹配（正则表达式）查找目录下的指定文件</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">all_jpg = <span class=\"built_in\">list</span>(dir_path.glob(<span class=\"string\">&#x27;*.jpg&#x27;</span>))</span><br><span class=\"line\">all_jpg_strpath = [<span class=\"built_in\">str</span>(p) <span class=\"keyword\">for</span> p <span class=\"keyword\">in</span> all_jpg]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(all_jpg)  <span class=\"comment\"># [WindowsPath(&#x27;../images/cat1.jpg&#x27;), WindowsPath(&#x27;../images/cat2.jpg&#x27;), WindowsPath(&#x27;../images/cat3.jpg&#x27;), WindowsPath(&#x27;../images/catdog.jpg&#x27;)]</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(all_jpg_strpath)  <span class=\"comment\"># [&#x27;..\\\\images\\\\cat1.jpg&#x27;, &#x27;..\\\\images\\\\cat2.jpg&#x27;, &#x27;..\\\\images\\\\cat3.jpg&#x27;, &#x27;..\\\\images\\\\catdog.jpg&#x27;]</span></span><br></pre></td></tr></table></figure>\n<p><strong>（3）检查路径是否符合规则</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(file_path.<span class=\"keyword\">match</span>(<span class=\"string\">&#x27;*.jpg&#x27;</span>))  <span class=\"comment\"># True</span></span><br></pre></td></tr></table></figure>\n<h1>4. 路径拼接</h1>\n<p><code>pathlib</code> 支持用 <code>/</code> 拼接路径，如果用不惯 <code>/</code>，也可以用类似 <code>os.path.join</code> 的方法：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(dir_path / <span class=\"string\">&#x27;dir1&#x27;</span> / <span class=\"string\">&#x27;file1.txt&#x27;</span>)  <span class=\"comment\"># ..\\images\\dir1\\file1.txt</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(dir_path.joinpath(<span class=\"string\">&#x27;dir1&#x27;</span>, <span class=\"string\">&#x27;file1.txt&#x27;</span>))  <span class=\"comment\"># ..\\images\\dir1\\file1.txt</span></span><br></pre></td></tr></table></figure>\n<h1>5. 路径测试（判断）</h1>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(dir_path.is_file())  <span class=\"comment\"># 是否为文件，False</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(dir_path.is_dir())  <span class=\"comment\"># 是否为文件夹，True</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(dir_path.exists())  <span class=\"comment\"># 是否存在，True</span></span><br></pre></td></tr></table></figure>\n<h1>6. 文件操作</h1>\n<p><strong>（1）创建文件</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">new_file = pathlib.Path(<span class=\"string\">&#x27;../images/readme.txt&#x27;</span>)</span><br><span class=\"line\">new_file.touch(exist_ok=<span class=\"literal\">True</span>)</span><br><span class=\"line\">new_file.touch(exist_ok=<span class=\"literal\">False</span>)  <span class=\"comment\"># FileExistsError: [Errno 17] File exists: &#x27;..\\\\images\\\\readme.txt&#x27;</span></span><br></pre></td></tr></table></figure>\n<p><code>exist_ok</code> 表示当文件已经存在时，程序的反应。如果为 <code>True</code>，文件存在时，不进行任何操作；如果为 <code>False</code>，则会报 <code>FileExistsError</code> 错误。</p>\n<p><strong>（2）创建目录</strong></p>\n<p>用 <code>os</code> 创建目录分为两个函数：<code>mkdir()</code> 和 <code>makedirs()</code>。<code>mkdir()</code> 一次只能创建一级目录，<code>makedirs()</code> 可以同时创建多级目录。使用 <code>pathlib</code> 只需要用 <code>path.mkdir()</code> 函数就可以。它提供了 <code>parents</code> 参数，设置为 <code>True</code> 可以创建多级目录，不设置则只能创建一层：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">new_dir = pathlib.Path(<span class=\"string\">&#x27;../images/dir1/dir2&#x27;</span>)</span><br><span class=\"line\">new_dir.mkdir()  <span class=\"comment\"># FileNotFoundError: [WinError 3] The system cannot find the path specified: &#x27;..\\\\images\\\\dir1\\\\dir2&#x27;</span></span><br><span class=\"line\">new_dir.mkdir(parents=<span class=\"literal\">True</span>)</span><br></pre></td></tr></table></figure>\n<p><strong>（3）删除目录</strong></p>\n<p>删除目录非常危险，并且没有提示，一定要谨慎操作。一次只删除一级目录，且当前目录必须为空：</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">del_dir = pathlib.Path(<span class=\"string\">&#x27;../images/dir&#x27;</span>)</span><br><span class=\"line\">del_dir.rmdir()</span><br></pre></td></tr></table></figure>\n<p><strong>（4）删除文件</strong></p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">del_file = pathlib.Path(<span class=\"string\">&#x27;../images/readme.txt&#x27;</span>)</span><br><span class=\"line\">del_file.unlink()</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "Python"
            ]
        }
    ]
}