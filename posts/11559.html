<!DOCTYPE html>
<html lang="zh-CN">
    <head>
  <!-- å…ƒæ•°æ® -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/favicon.ico">
  
  <title>åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ç¬”è®°(ææ²)-å¾ªç¯ç¥ç»ç½‘ç»œ | AsanoSaki</title>
  <meta name="author" content="AsanoSaki" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="AI" />
  
  <meta name="description" content="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ç¬”è®°(ææ²)-å¾ªç¯ç¥ç»ç½‘ç»œ">
<meta property="og:type" content="article">
<meta property="og:title" content="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ç¬”è®°(ææ²)-å¾ªç¯ç¥ç»ç½‘ç»œ">
<meta property="og:url" content="https://asanosaki.github.io/posts/11559.html">
<meta property="og:site_name" content="AsanoSaki">
<meta property="og:description" content="åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ç¬”è®°(ææ²)-å¾ªç¯ç¥ç»ç½‘ç»œ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://asanosaki.github.io/images/favicon.ico">
<meta property="article:published_time" content="2023-04-05T06:04:00.000Z">
<meta property="article:modified_time" content="2023-04-11T08:45:08.263Z">
<meta property="article:author" content="AsanoSaki">
<meta property="article:tag" content="AI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://asanosaki.github.io/images/favicon.ico">
  
  <!-- ç«™ç‚¹éªŒè¯ç›¸å…³ -->
  
    
    
    
  
  <!-- æ ·å¼è¡¨æ–‡ä»¶ -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/light.min.css" media="all"></script>
  
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- ä¸å¾—ä¸é¢„å…ˆåŠ è½½çš„ä¸€äº›JSæ–‡ä»¶ -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('https://z4a.net/images/2023/02/23/background03.jpg');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('https://z4a.net/images/2023/02/23/background02.jpg');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="AsanoSaki" type="application/atom+xml">
</head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                        <li>
                                            
                                                <a href="/">
                                            
                                                
                                                    <i class="fa fa-home"></i>
                                                
                                                Home
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="/archives/">
                                            
                                                
                                                    <i class="fa fa-file"></i>
                                                
                                                Archives
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a>
                                            
                                                
                                                    <i class="fa fa-paw"></i>
                                                
                                                Friends
                                            </a>
                                            
                                                <ul class="sub-menu">
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://angels-d.github.io">
                                                                
                                                                Angels-D
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="http://syh521.cn">
                                                                
                                                                SYH
                                                            </a>
                                                        </li>
                                                    
                                                </ul>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a>
                                            
                                                
                                                    <i class="fa fa-link"></i>
                                                
                                                Links
                                            </a>
                                            
                                                <ul class="sub-menu">
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://github.com/AsanoSaki">
                                                                
                                                                GitHub
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://gitee.com/asanosaki">
                                                                
                                                                Gitee
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://git.acwing.com/AsanoSaki">
                                                                
                                                                AcGit
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a href="https://asanosaki.github.io">
                                                                
                                                                BLOG
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://asanosaki.blog.csdn.net">
                                                                
                                                                CSDN
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://www.acwing.com/user/myspace/index/82581">
                                                                
                                                                AcWing
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://www.luogu.com.cn/user/459347">
                                                                
                                                                LuoGu
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://codeforces.com/profile/AsanoSaki">
                                                                
                                                                CodeForces
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://leetcode.cn/u/asanosaki">
                                                                
                                                                LeetCode
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://space.bilibili.com/12300056">
                                                                
                                                                Bilibili
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://www.youtube.com/@AsanoSaki0417">
                                                                
                                                                YouTube
                                                            </a>
                                                        </li>
                                                    
                                                </ul>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a>
                                            
                                                
                                                    <i class="fa fa-heart"></i>
                                                
                                                Favorite
                                            </a>
                                            
                                                <ul class="sub-menu">
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://www.cnki.net">
                                                                
                                                                CNKI
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://www.runoob.com">
                                                                
                                                                Runoob
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://wallhaven.cc">
                                                                
                                                                Wallhaven
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="http://www.flysheep6.com">
                                                                
                                                                Flysheep
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://thrift.apache.org">
                                                                
                                                                Thrift
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US">
                                                                
                                                                MDN
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://v5.bootcss.com">
                                                                
                                                                Bootstrap
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://reactjs.org">
                                                                
                                                                React
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/4.2">
                                                                
                                                                Django
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://hub.docker.com">
                                                                
                                                                DockerHub
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://fontawesome.com.cn">
                                                                
                                                                FontAwesome
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://www.online-convert.com">
                                                                
                                                                File-Convert
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://pytorch.org">
                                                                
                                                                PyTorch
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai">
                                                                
                                                                D2L
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="http://www.cvtutorials.com">
                                                                
                                                                CVTutorials
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://oi-wiki.org">
                                                                
                                                                OI-Wiki
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://board.xcpcio.com">
                                                                
                                                                XCPC-Board
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://kr-demo.candinya.com/posts/Kratos-Rebirth-Manual">
                                                                
                                                                Kratos-MNL
                                                            </a>
                                                        </li>
                                                    
                                                </ul>
                                            
                                        </li>
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">AsanoSaki</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>AsanoSaki</h2> <br />
                        <span>In summer, the sea breeze tastes like ice cream.</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://asanosaki.github.io/posts/11559.html">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ç¬”è®°(ææ²)-å¾ªç¯ç¥ç»ç½‘ç»œ</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-04-05T06:04:00.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-04-05</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> Author <span itemprop="name">AsanoSaki</span>
                </li>
                <li>
                    <i class="fa fa-edit"></i> 
                    
                    
                        ~31.26K
                    
                    words
                </li>
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>æœ¬æ–‡æœ€åç¼–è¾‘äº <time datetime="1681202708263"></time> å‰ï¼Œå…¶ä¸­çš„å†…å®¹å¯èƒ½éœ€è¦æ›´æ–°ã€‚</p></div>
            </div>
            
            
            
                <div class="kratos-post-inner-toc toc-div-class" >
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BA%8F%E5%88%97%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.</span> <span class="toc-text">1. åºåˆ—æ¨¡å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%96%87%E6%9C%AC%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">2. æ–‡æœ¬é¢„å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-number">3.</span> <span class="toc-text">3. è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C"><span class="toc-number">4.</span> <span class="toc-text">4. å¾ªç¯ç¥ç»ç½‘ç»œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 å¾ªç¯ç¥ç»ç½‘ç»œçš„ä»é›¶å¼€å§‹å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 å¾ªç¯ç¥ç»ç½‘ç»œçš„ç®€æ´å®ç°</span></a></li></ol></li></ol>
                </div>
            
            <hr />
            <div itemprop="articleBody"><blockquote>
<p>ææ²åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ï¼ˆPyTorchï¼‰è¯¾ç¨‹å­¦ä¹ ç¬”è®°ç¬¬å…«ç« ï¼šå¾ªç¯ç¥ç»ç½‘ç»œã€‚</p>
</blockquote>
<span id="more"></span>
<h2 id="1-åºåˆ—æ¨¡å‹">1. åºåˆ—æ¨¡å‹</h2>
<p>ç”±äºæ¶‰åŠè¾ƒå¤šæ•°å­¦å…¬å¼ï¼Œåºåˆ—æ¨¡å‹çš„è®²è§£å¯ä»¥è½¬è‡³ï¼š<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_recurrent-neural-networks/sequence.html">åºåˆ—æ¨¡å‹</a>ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€äº›æ•°æ®ï¼šä½¿ç”¨æ­£å¼¦å‡½æ•°å’Œä¸€äº›å¯åŠ æ€§å™ªå£°æ¥ç”Ÿæˆåºåˆ—æ•°æ®ï¼Œæ—¶é—´æ­¥ä¸º <code>1, 2, ..., 1000</code>ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">T = <span class="number">1000</span>  <span class="comment"># æ€»å…±äº§ç”Ÿ1000ä¸ªç‚¹</span></span><br><span class="line">time = torch.arange(<span class="number">1</span>, T + <span class="number">1</span>, dtype=torch.float32)</span><br><span class="line">x = torch.sin(<span class="number">0.01</span> * time) + torch.normal(<span class="number">0</span>, <span class="number">0.2</span>, (T,))  <span class="comment"># 0~10å¤§æ¦‚ä¸ºä¸€ä¸ªåŠå‘¨æœŸ(3*PI)ï¼Œå¹¶åŠ å…¥å™ªå£°</span></span><br><span class="line">d2l.plot(time, [x], <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, xlim=[<span class="number">1</span>, <span class="number">1000</span>], figsize=(<span class="number">6</span>, <span class="number">4</span>))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªåºåˆ—è½¬æ¢ä¸ºæ¨¡å‹çš„ç‰¹å¾-æ ‡ç­¾ï¼ˆfeature-labelï¼‰å¯¹ã€‚åŸºäºåµŒå…¥ç»´åº¦ <code>ğœ</code>ï¼Œæˆ‘ä»¬å°†æ•°æ®æ˜ å°„ä¸ºæ•°æ®å¯¹ <code>ğ‘¦_ğ‘¡ = ğ‘¥_ğ‘¡</code> å’Œ <code>ğ±_ğ‘¡ = [ğ‘¥_&#123;ğ‘¡ - ğœ&#125;, ...,ğ‘¥_&#123;ğ‘¡ - 1&#125;]</code>ï¼Œè¿™æ¯”æˆ‘ä»¬æä¾›çš„æ•°æ®æ ·æœ¬å°‘äº† <code>ğœ</code> ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰è¶³å¤Ÿçš„å†å²è®°å½•æ¥æè¿°å‰ <code>ğœ</code> ä¸ªæ•°æ®æ ·æœ¬ã€‚ä¸€ä¸ªç®€å•çš„è§£å†³åŠæ³•æ˜¯ï¼šå¦‚æœæ‹¥æœ‰è¶³å¤Ÿé•¿çš„åºåˆ—å°±ä¸¢å¼ƒè¿™å‡ é¡¹ï¼›å¦ä¸€ä¸ªæ–¹æ³•æ˜¯ç”¨é›¶å¡«å……åºåˆ—ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨å‰600ä¸ªç‰¹å¾-æ ‡ç­¾å¯¹è¿›è¡Œè®­ç»ƒï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tau = <span class="number">4</span></span><br><span class="line">features = torch.zeros((T - tau, tau))  <span class="comment"># ä¸€å…±996ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬çš„ç‰¹å¾é•¿åº¦ä¸º4</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(tau):</span><br><span class="line">    features[:, i] = x[i:T - tau + i]  <span class="comment"># æŒ‰åˆ—å¡«å……</span></span><br><span class="line">labels = x[tau:].reshape((-<span class="number">1</span>, <span class="number">1</span>))  <span class="comment"># labelsçš„å…ƒç´ åœ¨xä¸­çš„ä¸‹æ ‡ä¸º[4, 5, 6, ...]ï¼Œå³0~3é¢„æµ‹4ï¼Œ1~4é¢„æµ‹5</span></span><br><span class="line"><span class="comment"># featuresçš„å…ƒç´ åœ¨xä¸­çš„ä¸‹æ ‡:</span></span><br><span class="line"><span class="comment"># [0, 1, 2, 3]</span></span><br><span class="line"><span class="comment"># [1, 2, 3, 4]</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># [T - tau, T - tau + 1, T - tau + 2, T - tau + 3]</span></span><br><span class="line"></span><br><span class="line">batch_size, n_train = <span class="number">16</span>, <span class="number">600</span></span><br><span class="line"><span class="comment"># åªæœ‰å‰n_trainä¸ªæ ·æœ¬ç”¨äºè®­ç»ƒ</span></span><br><span class="line">train_iter = d2l.load_array((features[:n_train], labels[:n_train]), batch_size, is_train=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç›¸å½“ç®€å•çš„æ¶æ„è®­ç»ƒæ¨¡å‹ï¼šä¸€ä¸ªæ‹¥æœ‰ä¸¤ä¸ªå…¨è¿æ¥å±‚çš„å¤šå±‚æ„ŸçŸ¥æœºï¼ŒReLU æ¿€æ´»å‡½æ•°å’Œå¹³æ–¹æŸå¤±ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_weights</span>(<span class="params">m</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(m) == nn.Linear:</span><br><span class="line">        nn.init.xavier_uniform_(m.weight)</span><br><span class="line"></span><br><span class="line">net = nn.Sequential(nn.Linear(<span class="number">4</span>, <span class="number">10</span>), nn.ReLU(), nn.Linear(<span class="number">10</span>, <span class="number">1</span>))</span><br><span class="line">net.apply(init_weights)</span><br><span class="line"></span><br><span class="line">loss_function = nn.MSELoss(reduction=<span class="string">&#x27;none&#x27;</span>)  <span class="comment"># æ³¨æ„ï¼šMSELossè®¡ç®—å¹³æ–¹è¯¯å·®æ—¶ä¸å¸¦ç³»æ•°1/2</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å‡†å¤‡è®­ç»ƒæ¨¡å‹ï¼Œå®ç°ä¸‹é¢çš„è®­ç»ƒä»£ç çš„æ–¹å¼ä¸å‰é¢å‡ ç« ä¸­çš„å¾ªç¯è®­ç»ƒåŸºæœ¬ç›¸åŒã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸ä¼šæ·±å…¥æ¢è®¨å¤ªå¤šç»†èŠ‚ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">net, train_iter, loss_function, num_epochs, lr, device</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;training on&#x27;</span>, device)</span><br><span class="line">    net.to(device)</span><br><span class="line">    loss_function.to(device)</span><br><span class="line">    optimizer = torch.optim.Adam(net.parameters(), lr=lr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        net.train()</span><br><span class="line">        train_loss = []</span><br><span class="line">        <span class="keyword">for</span> X, y <span class="keyword">in</span> tqdm(train_iter):</span><br><span class="line">            X, y = X.to(device), y.to(device)</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            loss = loss_function(net(X), y)</span><br><span class="line">            loss.mean().backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line"></span><br><span class="line">            train_loss.append(loss.mean())</span><br><span class="line">        train_loss = <span class="built_in">sum</span>(train_loss) / <span class="built_in">len</span>(train_loss)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[ Train | <span class="subst">&#123;epoch + <span class="number">1</span>:03d&#125;</span>/<span class="subst">&#123;num_epochs:03d&#125;</span> ] loss = <span class="subst">&#123;train_loss:<span class="number">.5</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">lr, num_epochs = <span class="number">0.01</span>, <span class="number">5</span></span><br><span class="line"></span><br><span class="line">train(net, train_iter, loss_function, <span class="number">5</span>, <span class="number">0.01</span>, device)</span><br></pre></td></tr></table></figure>
<p>ç”±äºè®­ç»ƒæŸå¤±å¾ˆå°ï¼Œå› æ­¤æˆ‘ä»¬æœŸæœ›æ¨¡å‹èƒ½æœ‰å¾ˆå¥½çš„å·¥ä½œæ•ˆæœã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™åœ¨å®è·µä¸­æ„å‘³ç€ä»€ä¹ˆã€‚é¦–å…ˆæ˜¯æ£€æŸ¥æ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥çš„èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯å•æ­¥é¢„æµ‹ï¼ˆone-step-ahead predictionï¼‰ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onestep_preds = net(features.to(device))</span><br><span class="line">d2l.plot([time, time[tau:]], [x.detach().numpy(), onestep_preds.cpu().detach().numpy()],</span><br><span class="line">         <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, legend=[<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;1-step preds&#x27;</span>], xlim=[<span class="number">1</span>, <span class="number">1000</span>], figsize=(<span class="number">6</span>, <span class="number">4</span>))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>æ­£å¦‚æˆ‘ä»¬æ‰€æ–™ï¼Œå•æ­¥é¢„æµ‹æ•ˆæœä¸é”™ã€‚å³ä½¿è¿™äº›é¢„æµ‹çš„æ—¶é—´æ­¥è¶…è¿‡äº†604ï¼ˆ<code>n_train + tau</code>ï¼‰ï¼Œå…¶ç»“æœçœ‹èµ·æ¥ä»ç„¶æ˜¯å¯ä¿¡çš„ã€‚ç„¶è€Œæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼šå¦‚æœæ•°æ®è§‚å¯Ÿåºåˆ—çš„æ—¶é—´æ­¥åªåˆ°604ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ­¥ä¸€æ­¥åœ°å‘å‰è¿ˆè¿›ï¼Œæ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„é¢„æµ‹ï¼ˆè€Œä¸æ˜¯åŸå§‹æ•°æ®ï¼‰æ¥è¿›è¡Œå¤šæ­¥é¢„æµ‹ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æ•ˆæœå¦‚ä½•ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">multistep_preds = torch.zeros(T)</span><br><span class="line">multistep_preds[:n_train + tau] = x[:n_train + tau]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n_train + tau, T):</span><br><span class="line">    multistep_preds[i] = net(multistep_preds[i - tau:i].reshape((<span class="number">1</span>, -<span class="number">1</span>)).to(device))</span><br><span class="line"></span><br><span class="line">d2l.plot([time, time[tau:], time[n_train + tau:]],</span><br><span class="line">         [x.detach().numpy(), onestep_preds.cpu().detach().numpy(),</span><br><span class="line">          multistep_preds[n_train + tau:].cpu().detach().numpy()], <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;x&#x27;</span>,</span><br><span class="line">         legend=[<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;1-step preds&#x27;</span>, <span class="string">&#x27;multi-step preds&#x27;</span>], xlim=[<span class="number">1</span>, <span class="number">1000</span>], figsize=(<span class="number">6</span>, <span class="number">4</span>))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šé¢çš„ä¾‹å­æ‰€ç¤ºï¼Œç»¿çº¿çš„é¢„æµ‹æ˜¾ç„¶å¹¶ä¸ç†æƒ³ã€‚ç»è¿‡å‡ ä¸ªé¢„æµ‹æ­¥éª¤ä¹‹åï¼Œé¢„æµ‹çš„ç»“æœå¾ˆå¿«å°±ä¼šè¡°å‡åˆ°ä¸€ä¸ªå¸¸æ•°ã€‚ä¸ºä»€ä¹ˆè¿™ä¸ªç®—æ³•æ•ˆæœè¿™ä¹ˆå·®å‘¢ï¼Ÿäº‹å®æ˜¯ç”±äºè¯¯å·®çš„ç´¯ç§¯ï¼šå‡è®¾åœ¨æ­¥éª¤1ä¹‹åï¼Œæˆ‘ä»¬ç§¯ç´¯äº†ä¸€äº›è¯¯å·®ï¼Œäºæ˜¯æ­¥éª¤2çš„è¾“å…¥è¢«æ‰°åŠ¨äº†ï¼Œåé¢çš„é¢„æµ‹è¯¯å·®ä¾æ­¤ç±»æ¨ã€‚å› æ­¤è¯¯å·®å¯èƒ½ä¼šç›¸å½“å¿«åœ°åç¦»çœŸå®çš„è§‚æµ‹ç»“æœã€‚ä¾‹å¦‚ï¼Œæœªæ¥24å°æ—¶çš„å¤©æ°”é¢„æŠ¥å¾€å¾€ç›¸å½“å‡†ç¡®ï¼Œä½†è¶…è¿‡è¿™ä¸€ç‚¹ï¼Œç²¾åº¦å°±ä¼šè¿…é€Ÿä¸‹é™ã€‚æˆ‘ä»¬å°†åœ¨æœ¬ç« åŠåç»­ç« èŠ‚ä¸­è®¨è®ºå¦‚ä½•æ”¹è¿›è¿™ä¸€ç‚¹ã€‚</p>
<p>åŸºäº <code>k = 1, 4, 16, 64</code>ï¼Œé€šè¿‡å¯¹æ•´ä¸ªåºåˆ—é¢„æµ‹çš„è®¡ç®—ï¼Œè®©æˆ‘ä»¬æ›´ä»”ç»†åœ°çœ‹ä¸€ä¸‹ <code>k</code> æ­¥é¢„æµ‹çš„å›°éš¾ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">max_steps = <span class="number">64</span></span><br><span class="line">features = torch.zeros((T - tau - max_steps + <span class="number">1</span>, tau + max_steps))</span><br><span class="line"><span class="comment"># åˆ—i(i&lt;tau)æ˜¯æ¥è‡ªxçš„è§‚æµ‹ï¼Œå…¶æ—¶é—´æ­¥ä»(i)åˆ°(i+T-tau-max_steps+1)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(tau):</span><br><span class="line">    features[:, i] = x[i:i + T - tau - max_steps + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—i(i&gt;=tau)æ˜¯æ¥è‡ª(i-tau+1)æ­¥çš„é¢„æµ‹ï¼Œå…¶æ—¶é—´æ­¥ä»(i)åˆ°(i+T-tau-max_steps+1)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(tau, tau + max_steps):</span><br><span class="line">    features[:, i] = net(features[:, i - tau:i].to(device)).reshape(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">steps = (<span class="number">1</span>, <span class="number">4</span>, <span class="number">16</span>, <span class="number">64</span>)</span><br><span class="line">d2l.plot([time[tau + i - <span class="number">1</span>:T - max_steps + i] <span class="keyword">for</span> i <span class="keyword">in</span> steps],</span><br><span class="line">         [features[:, tau + i - <span class="number">1</span>].cpu().detach().numpy() <span class="keyword">for</span> i <span class="keyword">in</span> steps], <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;x&#x27;</span>,</span><br><span class="line">         legend=[<span class="string">f&#x27;<span class="subst">&#123;i&#125;</span>-step preds&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> steps], xlim=[<span class="number">5</span>, <span class="number">1000</span>], figsize=(<span class="number">6</span>, <span class="number">4</span>))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<h2 id="2-æ–‡æœ¬é¢„å¤„ç†">2. æ–‡æœ¬é¢„å¤„ç†</h2>
<p>å¯¹äºåºåˆ—æ•°æ®å¤„ç†é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­è¯„ä¼°äº†æ‰€éœ€çš„ç»Ÿè®¡å·¥å…·å’Œé¢„æµ‹æ—¶é¢ä¸´çš„æŒ‘æˆ˜ã€‚è¿™æ ·çš„æ•°æ®å­˜åœ¨è®¸å¤šç§å½¢å¼ï¼Œæ–‡æœ¬æ˜¯æœ€å¸¸è§ä¾‹å­ä¹‹ä¸€ã€‚ä¾‹å¦‚ï¼Œä¸€ç¯‡æ–‡ç« å¯ä»¥è¢«ç®€å•åœ°çœ‹ä½œä¸€ä¸²å•è¯åºåˆ—ï¼Œç”šè‡³æ˜¯ä¸€ä¸²å­—ç¬¦åºåˆ—ã€‚æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è§£ææ–‡æœ¬çš„å¸¸è§é¢„å¤„ç†æ­¥éª¤ã€‚è¿™äº›æ­¥éª¤é€šå¸¸åŒ…æ‹¬ï¼š</p>
<ul>
<li>å°†æ–‡æœ¬ä½œä¸ºå­—ç¬¦ä¸²åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li>
<li>å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºè¯å…ƒï¼ˆå¦‚å•è¯å’Œå­—ç¬¦ï¼‰ã€‚</li>
<li>å»ºç«‹ä¸€ä¸ªè¯è¡¨ï¼Œå°†æ‹†åˆ†çš„è¯å…ƒæ˜ å°„åˆ°æ•°å­—ç´¢å¼•ã€‚</li>
<li>å°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å­—ç´¢å¼•åºåˆ—ï¼Œæ–¹ä¾¿æ¨¡å‹æ“ä½œã€‚</li>
</ul>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä» H.G.Well çš„<a target="_blank" rel="noopener" href="https://www.gutenberg.org/ebooks/35">æ—¶å…‰æœºå™¨</a>ä¸­åŠ è½½æ–‡æœ¬ã€‚è¿™æ˜¯ä¸€ä¸ªç›¸å½“å°çš„è¯­æ–™åº“ï¼Œåªæœ‰30000å¤šä¸ªå•è¯ï¼Œä½†è¶³å¤Ÿæˆ‘ä»¬å°è¯•ç‰›åˆ€ï¼Œè€Œç°å®ä¸­çš„æ–‡æ¡£é›†åˆå¯èƒ½ä¼šåŒ…å«æ•°åäº¿ä¸ªå•è¯ã€‚ä¸‹é¢çš„å‡½æ•°å°†æ•°æ®é›†è¯»å–åˆ°ç”±å¤šæ¡æ–‡æœ¬è¡Œç»„æˆçš„åˆ—è¡¨ä¸­ï¼Œå…¶ä¸­æ¯æ¡æ–‡æœ¬è¡Œéƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¿½ç•¥äº†æ ‡ç‚¹ç¬¦å·å’Œå­—æ¯å¤§å†™ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br><span class="line"></span><br><span class="line">d2l.DATA_HUB[<span class="string">&#x27;time_machine&#x27;</span>] = (d2l.DATA_URL + <span class="string">&#x27;timemachine.txt&#x27;</span>, <span class="string">&#x27;090b5e7e70c295757f55df93cb0a180b9691891a&#x27;</span>)</span><br><span class="line">d2l.download(<span class="string">&#x27;time_machine&#x27;</span>)  <span class="comment"># é»˜è®¤è·¯å¾„åœ¨../data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_time_machine</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æ—¶é—´æœºå™¨æ•°æ®é›†åŠ è½½åˆ°æ–‡æœ¬è¡Œçš„åˆ—è¡¨ä¸­ï¼ŒåŒæ—¶å°†éå¤§å°å†™å­—æ¯å¤–çš„æ‰€æœ‰å­—ç¬¦æ›¿æ¢ä¸ºç©ºæ ¼&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;../data/timemachine.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">    <span class="keyword">return</span> [re.sub(<span class="string">&#x27;[^A-Za-z]+&#x27;</span>, <span class="string">&#x27; &#x27;</span>, line).strip().lower() <span class="keyword">for</span> line <span class="keyword">in</span> lines]</span><br><span class="line"></span><br><span class="line">lines = read_time_machine()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;æ–‡æœ¬æ€»è¡Œæ•°: <span class="subst">&#123;<span class="built_in">len</span>(lines)&#125;</span>&#x27;</span>)  <span class="comment"># æ–‡æœ¬æ€»è¡Œæ•°: 3221</span></span><br><span class="line"><span class="built_in">print</span>(lines[<span class="number">0</span>])  <span class="comment"># the time machine by h g wells</span></span><br><span class="line"><span class="built_in">print</span>(lines[<span class="number">10</span>])  <span class="comment"># twinkled and his usually pale face was flushed and animated the</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ <code>tokenize</code> å‡½æ•°å°†æ–‡æœ¬è¡Œåˆ—è¡¨ï¼ˆlinesï¼‰ä½œä¸ºè¾“å…¥ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªæ–‡æœ¬åºåˆ—ï¼ˆå¦‚ä¸€æ¡æ–‡æœ¬è¡Œï¼‰ã€‚æ¯ä¸ªæ–‡æœ¬åºåˆ—åˆè¢«æ‹†åˆ†æˆä¸€ä¸ªè¯å…ƒåˆ—è¡¨ï¼Œè¯å…ƒï¼ˆtokenï¼‰æ˜¯æ–‡æœ¬çš„åŸºæœ¬å•ä½ã€‚æœ€åï¼Œè¿”å›ä¸€ä¸ªç”±è¯å…ƒåˆ—è¡¨ç»„æˆçš„åˆ—è¡¨ï¼Œå…¶ä¸­çš„æ¯ä¸ªè¯å…ƒéƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆstringï¼‰ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">tokenize</span>(<span class="params">lines, token=<span class="string">&#x27;word&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æ–‡æœ¬è¡Œæ‹†åˆ†ä¸ºå•è¯æˆ–å­—ç¬¦è¯å…ƒ&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> token == <span class="string">&#x27;word&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> [line.split() <span class="keyword">for</span> line <span class="keyword">in</span> lines]</span><br><span class="line">    <span class="keyword">elif</span> token == <span class="string">&#x27;char&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">list</span>(line) <span class="keyword">for</span> line <span class="keyword">in</span> lines]  <span class="comment"># list(str)èƒ½å°†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦åˆ†éš”å¼€å½¢æˆlist</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;é”™è¯¯ï¼æœªçŸ¥è¯å…ƒç±»å‹:&#x27;</span> + token)</span><br><span class="line"></span><br><span class="line">tokens = tokenize(lines)</span><br><span class="line"><span class="comment"># tokens = tokenize(lines, token=&#x27;char&#x27;)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(tokens[i])</span><br><span class="line"><span class="comment"># [&#x27;the&#x27;, &#x27;time&#x27;, &#x27;machine&#x27;, &#x27;by&#x27;, &#x27;h&#x27;, &#x27;g&#x27;, &#x27;wells&#x27;]</span></span><br><span class="line"><span class="comment"># []</span></span><br><span class="line"><span class="comment"># []</span></span><br><span class="line"><span class="comment"># []</span></span><br><span class="line"><span class="comment"># []</span></span><br><span class="line"><span class="comment"># [&#x27;i&#x27;]</span></span><br><span class="line"><span class="comment"># []</span></span><br><span class="line"><span class="comment"># []</span></span><br><span class="line"><span class="comment"># [&#x27;the&#x27;, &#x27;time&#x27;, &#x27;traveller&#x27;, &#x27;for&#x27;, &#x27;so&#x27;, &#x27;it&#x27;, &#x27;will&#x27;, &#x27;be&#x27;, &#x27;convenient&#x27;, &#x27;to&#x27;, &#x27;speak&#x27;, &#x27;of&#x27;, &#x27;him&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;was&#x27;, &#x27;expounding&#x27;, &#x27;a&#x27;, &#x27;recondite&#x27;, &#x27;matter&#x27;, &#x27;to&#x27;, &#x27;us&#x27;, &#x27;his&#x27;, &#x27;grey&#x27;, &#x27;eyes&#x27;, &#x27;shone&#x27;, &#x27;and&#x27;]</span></span><br></pre></td></tr></table></figure>
<p>è¯å…ƒçš„ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ¨¡å‹éœ€è¦çš„è¾“å…¥æ˜¯æ•°å­—ï¼Œå› æ­¤è¿™ç§ç±»å‹ä¸æ–¹ä¾¿æ¨¡å‹ä½¿ç”¨ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªå­—å…¸ï¼Œé€šå¸¸ä¹Ÿå«åšè¯è¡¨ï¼ˆvocabularyï¼‰ï¼Œç”¨æ¥å°†å­—ç¬¦ä¸²ç±»å‹çš„è¯å…ƒæ˜ å°„åˆ°ä»0å¼€å§‹çš„æ•°å­—ç´¢å¼•ä¸­ã€‚æˆ‘ä»¬å…ˆå°†è®­ç»ƒé›†ä¸­çš„æ‰€æœ‰æ–‡æ¡£åˆå¹¶åœ¨ä¸€èµ·ï¼Œå¯¹å®ƒä»¬çš„å”¯ä¸€è¯å…ƒè¿›è¡Œç»Ÿè®¡ï¼Œå¾—åˆ°çš„ç»Ÿè®¡ç»“æœç§°ä¹‹ä¸ºè¯­æ–™ï¼ˆcorpusï¼‰ã€‚ç„¶åæ ¹æ®æ¯ä¸ªå”¯ä¸€è¯å…ƒçš„å‡ºç°é¢‘ç‡ï¼Œä¸ºå…¶åˆ†é…ä¸€ä¸ªæ•°å­—ç´¢å¼•ã€‚å¾ˆå°‘å‡ºç°çš„è¯å…ƒé€šå¸¸è¢«ç§»é™¤ï¼Œè¿™å¯ä»¥é™ä½å¤æ‚æ€§ã€‚å¦å¤–ï¼Œè¯­æ–™åº“ä¸­ä¸å­˜åœ¨æˆ–å·²åˆ é™¤çš„ä»»ä½•è¯å…ƒéƒ½å°†æ˜ å°„åˆ°ä¸€ä¸ªç‰¹å®šçš„æœªçŸ¥è¯å…ƒ <code>&lt;unk&gt;</code>ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©å¢åŠ ä¸€ä¸ªåˆ—è¡¨ï¼Œç”¨äºä¿å­˜é‚£äº›è¢«ä¿ç•™çš„è¯å…ƒï¼Œä¾‹å¦‚ï¼šå¡«å……è¯å…ƒï¼ˆ<code>&lt;pad&gt;</code>ï¼‰ã€åºåˆ—å¼€å§‹è¯å…ƒï¼ˆ<code>&lt;bos&gt;</code>ï¼‰ã€åºåˆ—ç»“æŸè¯å…ƒï¼ˆ<code>&lt;eos&gt;</code>ï¼‰ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vocab</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ–‡æœ¬è¯è¡¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, tokens=<span class="literal">None</span>, min_freq=<span class="number">0</span>, reserved_tokens=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> tokens <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            tokens = []</span><br><span class="line">        <span class="keyword">if</span> reserved_tokens <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            reserved_tokens = []</span><br><span class="line">        <span class="comment"># æŒ‰å‡ºç°é¢‘ç‡ä»å¤§åˆ°å°æ’åº</span></span><br><span class="line">        counter = count_corpus(tokens)</span><br><span class="line">        self._token_freqs = <span class="built_in">sorted</span>(counter.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># æ„å»ºç´¢å¼•åˆ°è¯å…ƒä¸è¯å…ƒåˆ°ç´¢å¼•çš„æ˜ å°„ï¼ŒæœªçŸ¥è¯å…ƒçš„ç´¢å¼•ä¸º0</span></span><br><span class="line">        self.idx_to_token = [<span class="string">&#x27;&lt;unk&gt;&#x27;</span>] + reserved_tokens</span><br><span class="line">        self.token_to_idx = &#123;token: idx <span class="keyword">for</span> idx, token <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.idx_to_token)&#125;</span><br><span class="line">        <span class="keyword">for</span> token, freq <span class="keyword">in</span> self._token_freqs:</span><br><span class="line">            <span class="keyword">if</span> freq &lt; min_freq:  <span class="comment"># å¦‚æœtokenå‡ºç°çš„æ¬¡æ•°å°‘äºmin_freqæ¬¡åˆ™ç›´æ¥ä¸¢å¼ƒ</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> token <span class="keyword">not</span> <span class="keyword">in</span> self.token_to_idx:</span><br><span class="line">                self.idx_to_token.append(token)</span><br><span class="line">                self.token_to_idx[token] = <span class="built_in">len</span>(self.idx_to_token) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.idx_to_token)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, tokens</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(tokens, (<span class="built_in">list</span>, <span class="built_in">tuple</span>)):</span><br><span class="line">            <span class="keyword">return</span> self.token_to_idx.get(tokens, self.unk)  <span class="comment"># tokensä¸å­˜åœ¨åˆ™è¿”å›0</span></span><br><span class="line">        <span class="keyword">return</span> [self.__getitem__(token) <span class="keyword">for</span> token <span class="keyword">in</span> tokens]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_tokens</span>(<span class="params">self, indices</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(indices, (<span class="built_in">list</span>, <span class="built_in">tuple</span>)):</span><br><span class="line">            <span class="keyword">return</span> self.idx_to_token[indices]</span><br><span class="line">        <span class="keyword">return</span> [self.idx_to_token[index] <span class="keyword">for</span> index <span class="keyword">in</span> indices]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unk</span>(<span class="params">self</span>):  <span class="comment"># æœªçŸ¥è¯å…ƒçš„ç´¢å¼•ä¸º0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">token_freqs</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._token_freqs</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_corpus</span>(<span class="params">tokens</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç»Ÿè®¡è¯å…ƒçš„é¢‘ç‡&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œçš„tokensæ˜¯1Dåˆ—è¡¨æˆ–2Dåˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tokens) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">isinstance</span>(tokens[<span class="number">0</span>], <span class="built_in">list</span>):</span><br><span class="line">        tokens = [token <span class="keyword">for</span> line <span class="keyword">in</span> tokens <span class="keyword">for</span> token <span class="keyword">in</span> line]  <span class="comment"># å°†è¯å…ƒåˆ—è¡¨å±•å¹³æˆä¸€ä¸ªåˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">return</span> collections.Counter(tokens)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é¦–å…ˆä½¿ç”¨æ—¶å…‰æœºå™¨æ•°æ®é›†ä½œä¸ºè¯­æ–™åº“æ¥æ„å»ºè¯è¡¨ï¼Œç„¶åæ‰“å°å‰å‡ ä¸ªé«˜é¢‘è¯å…ƒåŠå…¶ç´¢å¼•ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vocab = Vocab(tokens)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(vocab.token_to_idx.items())[:<span class="number">10</span>])  <span class="comment"># æ³¨æ„ä¸åŠ item()çš„è¯åªä¼šå°†keyè½¬æˆlist</span></span><br><span class="line"><span class="comment"># [(&#x27;&lt;unk&gt;&#x27;, 0), (&#x27;the&#x27;, 1), (&#x27;i&#x27;, 2), (&#x27;and&#x27;, 3), (&#x27;of&#x27;, 4), (&#x27;a&#x27;, 5), (&#x27;to&#x27;, 6), (&#x27;was&#x27;, 7), (&#x27;in&#x27;, 8), (&#x27;that&#x27;, 9)]</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¯ä¸€æ¡æ–‡æœ¬è¡Œè½¬æ¢æˆä¸€ä¸ªæ•°å­—ç´¢å¼•åˆ—è¡¨ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ–‡æœ¬:&#x27;</span>, tokens[<span class="number">0</span>])  <span class="comment"># æ–‡æœ¬: [&#x27;the&#x27;, &#x27;time&#x27;, &#x27;machine&#x27;, &#x27;by&#x27;, &#x27;h&#x27;, &#x27;g&#x27;, &#x27;wells&#x27;]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ç´¢å¼•:&#x27;</span>, vocab[tokens[<span class="number">0</span>]])  <span class="comment"># ç´¢å¼•: [1, 19, 50, 40, 2183, 2184, 400]</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ä½¿ç”¨ä¸Šè¿°å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰åŠŸèƒ½æ‰“åŒ…åˆ° <code>load_corpus_time_machine</code> å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°è¿”å› <code>corpus</code>ï¼ˆè¯å…ƒç´¢å¼•åˆ—è¡¨ï¼‰å’Œ <code>vocab</code>ï¼ˆæ—¶å…‰æœºå™¨è¯­æ–™åº“çš„è¯è¡¨ï¼‰ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œæ‰€åšçš„æ”¹å˜æ˜¯ï¼š</p>
<ul>
<li>ä¸ºäº†ç®€åŒ–åé¢ç« èŠ‚ä¸­çš„è®­ç»ƒï¼Œæˆ‘ä»¬ä½¿ç”¨å­—ç¬¦ï¼ˆè€Œä¸æ˜¯å•è¯ï¼‰å®ç°æ–‡æœ¬è¯å…ƒåŒ–ï¼›</li>
<li>æ—¶å…‰æœºå™¨æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ–‡æœ¬è¡Œä¸ä¸€å®šæ˜¯ä¸€ä¸ªå¥å­æˆ–ä¸€ä¸ªæ®µè½ï¼Œè¿˜å¯èƒ½æ˜¯ä¸€ä¸ªå•è¯ï¼Œå› æ­¤è¿”å›çš„ <code>corpus</code> ä»…å¤„ç†ä¸ºå•ä¸ªåˆ—è¡¨ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¤šè¯å…ƒåˆ—è¡¨æ„æˆçš„ä¸€ä¸ªåˆ—è¡¨ã€‚</li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_corpus_time_machine</span>(<span class="params">max_tokens=-<span class="number">1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¿”å›æ—¶å…‰æœºå™¨æ•°æ®é›†çš„è¯å…ƒç´¢å¼•åˆ—è¡¨å’Œè¯è¡¨&quot;&quot;&quot;</span></span><br><span class="line">    lines = read_time_machine()</span><br><span class="line">    tokens = tokenize(lines, <span class="string">&#x27;char&#x27;</span>)</span><br><span class="line">    vocab = Vocab(tokens)</span><br><span class="line">    <span class="comment"># å› ä¸ºæ—¶å…‰æœºå™¨æ•°æ®é›†ä¸­çš„æ¯ä¸ªæ–‡æœ¬è¡Œä¸ä¸€å®šæ˜¯ä¸€ä¸ªå¥å­æˆ–ä¸€ä¸ªæ®µè½ï¼Œæ‰€ä»¥å°†æ‰€æœ‰æ–‡æœ¬è¡Œå±•å¹³åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­</span></span><br><span class="line">    corpus = [vocab[token] <span class="keyword">for</span> line <span class="keyword">in</span> tokens <span class="keyword">for</span> token <span class="keyword">in</span> line]</span><br><span class="line">    <span class="keyword">if</span> max_tokens &gt; <span class="number">0</span>:</span><br><span class="line">        corpus = corpus[:max_tokens]</span><br><span class="line">    <span class="keyword">return</span> corpus, vocab</span><br><span class="line"></span><br><span class="line">corpus, vocab = load_corpus_time_machine()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(corpus), <span class="built_in">len</span>(vocab))  <span class="comment"># 170580 28</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ç´¢å¼•:&#x27;</span>, corpus[:<span class="number">10</span>])  <span class="comment"># ç´¢å¼•: [3, 9, 2, 1, 3, 5, 13, 2, 1, 13]</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ–‡æœ¬:&#x27;</span>, vocab.to_tokens(corpus[:<span class="number">10</span>]))  <span class="comment"># æ–‡æœ¬: [&#x27;t&#x27;, &#x27;h&#x27;, &#x27;e&#x27;, &#x27; &#x27;, &#x27;t&#x27;, &#x27;i&#x27;, &#x27;m&#x27;, &#x27;e&#x27;, &#x27; &#x27;, &#x27;m&#x27;]</span></span><br></pre></td></tr></table></figure>
<h2 id="3-è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†">3. è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†</h2>
<p>ç”±äºæ¶‰åŠè¾ƒå¤šæ•°å­¦å…¬å¼ï¼Œè¯­è¨€æ¨¡å‹çš„è®²è§£å¯ä»¥è½¬è‡³ï¼š<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_recurrent-neural-networks/language-models-and-dataset.html">è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†</a>ã€‚</p>
<p>æ ¹æ®ä¸Šä¸€èŠ‚ä¸­ä»‹ç»çš„æ—¶å…‰æœºå™¨æ•°æ®é›†æ„å»ºè¯è¡¨ï¼Œå¹¶æ‰“å°å‰10ä¸ªæœ€å¸¸ç”¨çš„ï¼ˆé¢‘ç‡æœ€é«˜çš„ï¼‰å•è¯ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br><span class="line"></span><br><span class="line">tokens = d2l.tokenize(d2l.read_time_machine())</span><br><span class="line"><span class="comment"># å› ä¸ºæ¯ä¸ªæ–‡æœ¬è¡Œä¸ä¸€å®šæ˜¯ä¸€ä¸ªå¥å­æˆ–ä¸€ä¸ªæ®µè½ï¼Œå› æ­¤æˆ‘ä»¬æŠŠæ‰€æœ‰æ–‡æœ¬è¡Œæ‹¼æ¥åˆ°ä¸€èµ·</span></span><br><span class="line">corpus = [token <span class="keyword">for</span> line <span class="keyword">in</span> tokens <span class="keyword">for</span> token <span class="keyword">in</span> line]</span><br><span class="line"><span class="built_in">print</span>(corpus[:<span class="number">10</span>])  <span class="comment"># [&#x27;the&#x27;, &#x27;time&#x27;, &#x27;machine&#x27;, &#x27;by&#x27;, &#x27;h&#x27;, &#x27;g&#x27;, &#x27;wells&#x27;, &#x27;i&#x27;, &#x27;the&#x27;, &#x27;time&#x27;]</span></span><br><span class="line">vocab = d2l.Vocab(corpus)</span><br><span class="line"><span class="built_in">print</span>(vocab.token_freqs[:<span class="number">10</span>])  <span class="comment"># [(&#x27;the&#x27;, 2261), (&#x27;i&#x27;, 1267), (&#x27;and&#x27;, 1245), (&#x27;of&#x27;, 1155), ...]</span></span><br></pre></td></tr></table></figure>
<p>æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œæœ€æµè¡Œçš„è¯çœ‹èµ·æ¥å¾ˆæ— èŠï¼Œè¿™äº›è¯é€šå¸¸è¢«ç§°ä¸ºåœç”¨è¯ï¼ˆstop wordsï¼‰ï¼Œå› æ­¤å¯ä»¥è¢«è¿‡æ»¤æ‰ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒä»¬æœ¬èº«ä»ç„¶æ˜¯æœ‰æ„ä¹‰çš„ï¼Œæˆ‘ä»¬ä»ç„¶ä¼šåœ¨æ¨¡å‹ä¸­ä½¿ç”¨å®ƒä»¬ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸ªæ˜æ˜¾çš„é—®é¢˜æ˜¯è¯é¢‘è¡°å‡çš„é€Ÿåº¦ç›¸å½“åœ°å¿«ã€‚ä¾‹å¦‚ï¼Œæœ€å¸¸ç”¨å•è¯çš„è¯é¢‘å¯¹æ¯”ï¼Œç¬¬10ä¸ªè¿˜ä¸åˆ°ç¬¬1ä¸ªçš„1/5ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ç”»å‡ºçš„è¯é¢‘å›¾ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">freqs = [freq <span class="keyword">for</span> token, freq <span class="keyword">in</span> vocab.token_freqs]</span><br><span class="line">d2l.plot(freqs, xlabel=<span class="string">&#x27;token: x&#x27;</span>, ylabel=<span class="string">&#x27;frequency: n(x)&#x27;</span>, xscale=<span class="string">&#x27;log&#x27;</span>, yscale=<span class="string">&#x27;log&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¯é¢‘å›¾æˆ‘ä»¬å¯ä»¥å‘ç°ï¼šè¯é¢‘ä»¥ä¸€ç§æ˜ç¡®çš„æ–¹å¼è¿…é€Ÿè¡°å‡ã€‚å°†å‰å‡ ä¸ªå•è¯ä½œä¸ºä¾‹å¤–æ¶ˆé™¤åï¼Œå‰©ä½™çš„æ‰€æœ‰å•è¯å¤§è‡´éµå¾ªåŒå¯¹æ•°åæ ‡å›¾ä¸Šçš„ä¸€æ¡ç›´çº¿ã€‚è¿™æ„å‘³ç€å•è¯çš„é¢‘ç‡æ»¡è¶³é½æ™®å¤«å®šå¾‹ï¼ˆZipfâ€™s lawï¼‰ã€‚è¿™å‘Šè¯‰æˆ‘ä»¬æƒ³è¦é€šè¿‡è®¡æ•°ç»Ÿè®¡å’Œå¹³æ»‘æ¥å»ºæ¨¡å•è¯æ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºè¿™æ ·å»ºæ¨¡çš„ç»“æœä¼šå¤§å¤§é«˜ä¼°å°¾éƒ¨å•è¯çš„é¢‘ç‡ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ä¸å¸¸ç”¨å•è¯ã€‚é‚£ä¹ˆå…¶ä»–çš„è¯å…ƒç»„åˆï¼Œæ¯”å¦‚äºŒå…ƒè¯­æ³•ã€ä¸‰å…ƒè¯­æ³•ç­‰ç­‰ï¼Œåˆä¼šå¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹äºŒå…ƒè¯­æ³•çš„é¢‘ç‡æ˜¯å¦ä¸ä¸€å…ƒè¯­æ³•çš„é¢‘ç‡è¡¨ç°å‡ºç›¸åŒçš„è¡Œä¸ºæ–¹å¼ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bigram_tokens = [pair <span class="keyword">for</span> pair <span class="keyword">in</span> <span class="built_in">zip</span>(corpus[:-<span class="number">1</span>], corpus[<span class="number">1</span>:])]  <span class="comment"># éå†æ‰€æœ‰è¿ç»­çš„ä¸¤ä¸ªè¯å…ƒ</span></span><br><span class="line">bigram_vocab = d2l.Vocab(bigram_tokens)</span><br><span class="line"><span class="built_in">print</span>(bigram_vocab.token_freqs[:<span class="number">10</span>])  <span class="comment"># [((&#x27;of&#x27;, &#x27;the&#x27;), 309), ((&#x27;in&#x27;, &#x27;the&#x27;), 169), ...]</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå€¼å¾—æ³¨æ„ï¼šåœ¨åä¸ªæœ€é¢‘ç¹çš„è¯å¯¹ä¸­ï¼Œæœ‰ä¹ä¸ªæ˜¯ç”±ä¸¤ä¸ªåœç”¨è¯ç»„æˆçš„ï¼Œåªæœ‰ä¸€ä¸ªä¸ <code>the time</code> æœ‰å…³ã€‚æˆ‘ä»¬å†è¿›ä¸€æ­¥çœ‹çœ‹ä¸‰å…ƒè¯­æ³•çš„é¢‘ç‡æ˜¯å¦è¡¨ç°å‡ºç›¸åŒçš„è¡Œä¸ºæ–¹å¼ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trigram_tokens = [triple <span class="keyword">for</span> triple <span class="keyword">in</span> <span class="built_in">zip</span>(corpus[:-<span class="number">2</span>], corpus[<span class="number">1</span>:-<span class="number">1</span>], corpus[<span class="number">2</span>:])]  <span class="comment"># éå†æ‰€æœ‰è¿ç»­çš„ä¸‰ä¸ªè¯å…ƒ</span></span><br><span class="line">trigram_vocab = d2l.Vocab(trigram_tokens)</span><br><span class="line"><span class="built_in">print</span>(trigram_vocab.token_freqs[:<span class="number">10</span>])  <span class="comment"># [((&#x27;the&#x27;, &#x27;time&#x27;, &#x27;traveller&#x27;), 59), ((&#x27;the&#x27;, &#x27;time&#x27;, &#x27;machine&#x27;), 30), ...]</span></span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œæˆ‘ä»¬ç›´è§‚åœ°å¯¹æ¯”ä¸‰ç§æ¨¡å‹ä¸­çš„è¯å…ƒé¢‘ç‡ï¼šä¸€å…ƒè¯­æ³•ã€äºŒå…ƒè¯­æ³•å’Œä¸‰å…ƒè¯­æ³•ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bigram_freqs = [freq <span class="keyword">for</span> token, freq <span class="keyword">in</span> bigram_vocab.token_freqs]</span><br><span class="line">trigram_freqs = [freq <span class="keyword">for</span> token, freq <span class="keyword">in</span> trigram_vocab.token_freqs]</span><br><span class="line">d2l.plot([freqs, bigram_freqs, trigram_freqs], xlabel=<span class="string">&#x27;token: x&#x27;</span>, ylabel=<span class="string">&#x27;frequency: n(x)&#x27;</span>,</span><br><span class="line">         xscale=<span class="string">&#x27;log&#x27;</span>, yscale=<span class="string">&#x27;log&#x27;</span>, legend=[<span class="string">&#x27;unigram&#x27;</span>, <span class="string">&#x27;bigram&#x27;</span>, <span class="string">&#x27;trigram&#x27;</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>ç”±äºåºåˆ—æ•°æ®æœ¬è´¨ä¸Šæ˜¯<strong>è¿ç»­çš„</strong>ï¼Œå› æ­¤æˆ‘ä»¬åœ¨å¤„ç†æ•°æ®æ—¶éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨ç¬¬ä¸€èŠ‚ä¸­æˆ‘ä»¬ä»¥ä¸€ç§ç›¸å½“ç‰¹åˆ«çš„æ–¹å¼åšåˆ°äº†è¿™ä¸€ç‚¹ï¼šå½“åºåˆ—å˜å¾—å¤ªé•¿è€Œä¸èƒ½è¢«æ¨¡å‹ä¸€æ¬¡æ€§å…¨éƒ¨å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›æ‹†åˆ†è¿™æ ·çš„åºåˆ—æ–¹ä¾¿æ¨¡å‹è¯»å–ã€‚</p>
<p>åœ¨ä»‹ç»è¯¥æ¨¡å‹ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ€»ä½“ç­–ç•¥ã€‚å‡è®¾æˆ‘ä»¬å°†ä½¿ç”¨ç¥ç»ç½‘ç»œæ¥è®­ç»ƒè¯­è¨€æ¨¡å‹ï¼Œæ¨¡å‹ä¸­çš„ç½‘ç»œä¸€æ¬¡å¤„ç†å…·æœ‰é¢„å®šä¹‰é•¿åº¦ï¼ˆä¾‹å¦‚ ğ‘› ä¸ªæ—¶é—´æ­¥ï¼‰çš„ä¸€ä¸ªå°æ‰¹é‡åºåˆ—ã€‚ç°åœ¨çš„é—®é¢˜æ˜¯å¦‚ä½•éšæœºç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡æ•°æ®çš„ç‰¹å¾å’Œæ ‡ç­¾ä»¥ä¾›è¯»å–ã€‚</p>
<p>é¦–å…ˆï¼Œç”±äºæ–‡æœ¬åºåˆ—å¯ä»¥æ˜¯ä»»æ„é•¿çš„ï¼Œä¾‹å¦‚æ•´æœ¬ã€Šæ—¶å…‰æœºå™¨ã€‹ï¼ˆThe Time Machineï¼‰ï¼Œäºæ˜¯ä»»æ„é•¿çš„åºåˆ—å¯ä»¥è¢«æˆ‘ä»¬åˆ’åˆ†ä¸ºå…·æœ‰ç›¸åŒæ—¶é—´æ­¥æ•°çš„å­åºåˆ—ã€‚å½“è®­ç»ƒæˆ‘ä»¬çš„ç¥ç»ç½‘ç»œæ—¶ï¼Œè¿™æ ·çš„å°æ‰¹é‡å­åºåˆ—å°†è¢«è¾“å…¥åˆ°æ¨¡å‹ä¸­ã€‚å‡è®¾ç½‘ç»œä¸€æ¬¡åªå¤„ç†å…·æœ‰ ğ‘› ä¸ªæ—¶é—´æ­¥çš„å­åºåˆ—ï¼Œé‚£ä¹ˆå¯ä»¥ä»æŒ‡å®šçš„èµ·å§‹ä½ç½®å¼€å§‹æˆªå–è¿ç»­çš„é•¿åº¦ä¸º ğ‘› çš„å­åºåˆ—ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä»»æ„åç§»é‡æ¥æŒ‡ç¤ºåˆå§‹ä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ç›¸å½“å¤§çš„è‡ªç”±åº¦ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åªé€‰æ‹©ä¸€ä¸ªåç§»é‡ï¼Œé‚£ä¹ˆç”¨äºè®­ç»ƒç½‘ç»œçš„ã€æ‰€æœ‰å¯èƒ½çš„å­åºåˆ—çš„è¦†ç›–èŒƒå›´å°†æ˜¯æœ‰é™çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä»<strong>éšæœºåç§»é‡</strong>å¼€å§‹åˆ’åˆ†åºåˆ—ï¼Œä»¥åŒæ—¶è·å¾—è¦†ç›–æ€§ï¼ˆcoverageï¼‰å’Œéšæœºæ€§ï¼ˆrandomnessï¼‰ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°†æè¿°å¦‚ä½•å®ç°<strong>éšæœºé‡‡æ ·</strong>ï¼ˆrandom samplingï¼‰å’Œ<strong>é¡ºåºåˆ†åŒº</strong>ï¼ˆsequential partitioningï¼‰ç­–ç•¥ã€‚</p>
<p>åœ¨éšæœºé‡‡æ ·ä¸­ï¼Œæ¯ä¸ªæ ·æœ¬éƒ½æ˜¯åœ¨åŸå§‹çš„é•¿åºåˆ—ä¸Š<strong>ä»»æ„æ•è·</strong>çš„å­åºåˆ—ã€‚åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œæ¥è‡ªä¸¤ä¸ªç›¸é‚»çš„ã€éšæœºçš„ã€å°æ‰¹é‡ä¸­çš„å­åºåˆ—ä¸ä¸€å®šåœ¨åŸå§‹åºåˆ—ä¸Šç›¸é‚»ã€‚å¯¹äºè¯­è¨€å»ºæ¨¡ï¼Œç›®æ ‡æ˜¯åŸºäºåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬çœ‹åˆ°çš„è¯å…ƒæ¥é¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒï¼Œå› æ­¤æ ‡ç­¾æ˜¯ç§»ä½äº†ä¸€ä¸ªè¯å…ƒçš„åŸå§‹åºåˆ—ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç æ¯æ¬¡å¯ä»¥ä»æ•°æ®ä¸­éšæœºç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡ã€‚åœ¨è¿™é‡Œï¼Œå‚æ•° <code>batch_size</code> æŒ‡å®šäº†æ¯ä¸ªå°æ‰¹é‡ä¸­å­åºåˆ—æ ·æœ¬çš„æ•°ç›®ï¼Œå‚æ•° <code>num_steps</code> æ˜¯æ¯ä¸ªå­åºåˆ—ä¸­é¢„å®šä¹‰çš„æ—¶é—´æ­¥æ•°ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">seq_data_iter_random</span>(<span class="params">corpus, batch_size, num_steps</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨éšæœºæŠ½æ ·ç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡å­åºåˆ—&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ä»éšæœºåç§»é‡å¼€å§‹å¯¹åºåˆ—è¿›è¡Œåˆ†åŒºï¼ŒéšæœºèŒƒå›´åŒ…æ‹¬num_steps-1</span></span><br><span class="line">    corpus = corpus[random.randint(<span class="number">0</span>, num_steps - <span class="number">1</span>):]  <span class="comment"># æˆªå–éšæœºèµ·å§‹ä½ç½®ä¹‹åçš„éƒ¨åˆ†</span></span><br><span class="line">    <span class="comment"># å‡å»1ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦è€ƒè™‘æ ‡ç­¾ï¼Œè¦ç•™è‡³å°‘ä¸€ä¸ªæ•°æ®ä½œä¸ºæœ€åä¸€ç»„é¢„æµ‹çš„æ ‡ç­¾</span></span><br><span class="line">    num_subseqs = (<span class="built_in">len</span>(corpus) - <span class="number">1</span>) // num_steps  <span class="comment"># åˆ†åŒºæ•°</span></span><br><span class="line">    <span class="comment"># é•¿åº¦ä¸ºnum_stepsçš„å­åºåˆ—çš„èµ·å§‹ç´¢å¼•</span></span><br><span class="line">    initial_indices = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">0</span>, num_subseqs * num_steps, num_steps))</span><br><span class="line">    <span class="comment"># åœ¨éšæœºæŠ½æ ·çš„è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œæ¥è‡ªä¸¤ä¸ªç›¸é‚»çš„ã€éšæœºçš„ã€å°æ‰¹é‡ä¸­çš„å­åºåˆ—ä¸ä¸€å®šåœ¨åŸå§‹åºåˆ—ä¸Šç›¸é‚»</span></span><br><span class="line">    random.shuffle(initial_indices)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">data</span>(<span class="params">pos</span>):</span><br><span class="line">        <span class="comment"># è¿”å›ä»posä½ç½®å¼€å§‹çš„é•¿åº¦ä¸ºnum_stepsçš„åºåˆ—</span></span><br><span class="line">        <span class="keyword">return</span> corpus[pos:pos + num_steps]</span><br><span class="line"></span><br><span class="line">    num_batches = num_subseqs // batch_size</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, batch_size * num_batches, batch_size):</span><br><span class="line">        <span class="comment"># åœ¨è¿™é‡Œï¼Œinitial_indicesåŒ…å«å­åºåˆ—çš„éšæœºèµ·å§‹ç´¢å¼•</span></span><br><span class="line">        initial_indices_per_batch = initial_indices[i:i + batch_size]</span><br><span class="line">        X = [data(j) <span class="keyword">for</span> j <span class="keyword">in</span> initial_indices_per_batch]</span><br><span class="line">        Y = [data(j + <span class="number">1</span>) <span class="keyword">for</span> j <span class="keyword">in</span> initial_indices_per_batch]</span><br><span class="line">        <span class="keyword">yield</span> torch.tensor(X), torch.tensor(Y)</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªä»0åˆ°34çš„åºåˆ—ã€‚å‡è®¾æ‰¹é‡å¤§å°ä¸º2ï¼Œæ—¶é—´æ­¥æ•°ä¸º5ï¼Œè¿™æ„å‘³ç€å¯ä»¥ç”Ÿæˆ6ä¸ªç‰¹å¾-æ ‡ç­¾å­åºåˆ—å¯¹ã€‚å¦‚æœè®¾ç½®å°æ‰¹é‡å¤§å°ä¸º2ï¼Œæˆ‘ä»¬åªèƒ½å¾—åˆ°3ä¸ªå°æ‰¹é‡ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">my_seq = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">35</span>))</span><br><span class="line"><span class="keyword">for</span> X, Y <span class="keyword">in</span> seq_data_iter_random(my_seq, batch_size=<span class="number">2</span>, num_steps=<span class="number">5</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;X:&#x27;</span>, X, <span class="string">&#x27;\nY:&#x27;</span>, Y)</span><br><span class="line"><span class="comment"># X: tensor([[ 7,  8,  9, 10, 11], [17, 18, 19, 20, 21]])</span></span><br><span class="line"><span class="comment"># Y: tensor([[ 8,  9, 10, 11, 12], [18, 19, 20, 21, 22]])</span></span><br><span class="line"><span class="comment"># X: tensor([[22, 23, 24, 25, 26], [27, 28, 29, 30, 31]])</span></span><br><span class="line"><span class="comment"># Y: tensor([[23, 24, 25, 26, 27], [28, 29, 30, 31, 32]])</span></span><br><span class="line"><span class="comment"># X: tensor([[ 2,  3,  4,  5,  6], [12, 13, 14, 15, 16]])</span></span><br><span class="line"><span class="comment"># Y: tensor([[ 3,  4,  5,  6,  7], [13, 14, 15, 16, 17]])</span></span><br></pre></td></tr></table></figure>
<p>åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œé™¤äº†å¯¹åŸå§‹åºåˆ—å¯ä»¥éšæœºæŠ½æ ·å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¿è¯ä¸¤ä¸ªç›¸é‚»çš„å°æ‰¹é‡ä¸­çš„å­åºåˆ—åœ¨åŸå§‹åºåˆ—ä¸Šä¹Ÿæ˜¯ç›¸é‚»çš„ã€‚è¿™ç§ç­–ç•¥åœ¨åŸºäºå°æ‰¹é‡çš„è¿­ä»£è¿‡ç¨‹ä¸­ä¿ç•™äº†æ‹†åˆ†çš„å­åºåˆ—çš„é¡ºåºï¼Œå› æ­¤ç§°ä¸ºé¡ºåºåˆ†åŒºï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">seq_data_iter_sequential</span>(<span class="params">corpus, batch_size, num_steps</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨é¡ºåºåˆ†åŒºç”Ÿæˆä¸€ä¸ªå°æ‰¹é‡å­åºåˆ—&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ä»éšæœºåç§»é‡å¼€å§‹åˆ’åˆ†åºåˆ—</span></span><br><span class="line">    offset = random.randint(<span class="number">0</span>, num_steps)</span><br><span class="line">    num_tokens = ((<span class="built_in">len</span>(corpus) - offset - <span class="number">1</span>) // batch_size) * batch_size</span><br><span class="line">    Xs = torch.tensor(corpus[offset:offset + num_tokens])</span><br><span class="line">    Ys = torch.tensor(corpus[offset + <span class="number">1</span>:offset + <span class="number">1</span> + num_tokens])</span><br><span class="line">    Xs, Ys = Xs.reshape(batch_size, -<span class="number">1</span>), Ys.reshape(batch_size, -<span class="number">1</span>)</span><br><span class="line">    num_batches = Xs.shape[<span class="number">1</span>] // num_steps  <span class="comment"># batchçš„æ•°é‡</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, num_steps * num_batches, num_steps):</span><br><span class="line">        X = Xs[:, i:i + num_steps]</span><br><span class="line">        Y = Ys[:, i:i + num_steps]</span><br><span class="line">        <span class="keyword">yield</span> X, Y</span><br></pre></td></tr></table></figure>
<p>åŸºäºç›¸åŒçš„è®¾ç½®ï¼Œé€šè¿‡é¡ºåºåˆ†åŒºè¯»å–æ¯ä¸ªå°æ‰¹é‡çš„å­åºåˆ—çš„ç‰¹å¾ <code>X</code> å’Œæ ‡ç­¾ <code>Y</code>ã€‚é€šè¿‡å°†å®ƒä»¬æ‰“å°å‡ºæ¥å¯ä»¥å‘ç°ï¼šè¿­ä»£æœŸé—´æ¥è‡ªä¸¤ä¸ªç›¸é‚»çš„å°æ‰¹é‡ä¸­çš„å­åºåˆ—åœ¨åŸå§‹åºåˆ—ä¸­ç¡®å®æ˜¯ç›¸é‚»çš„ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> X, Y <span class="keyword">in</span> seq_data_iter_sequential(my_seq, batch_size=<span class="number">2</span>, num_steps=<span class="number">5</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;X:&#x27;</span>, X, <span class="string">&#x27;\nY:&#x27;</span>, Y)</span><br><span class="line"><span class="comment"># X: tensor([[ 2,  3,  4,  5,  6], [18, 19, 20, 21, 22]])</span></span><br><span class="line"><span class="comment"># Y: tensor([[ 3,  4,  5,  6,  7], [19, 20, 21, 22, 23]])</span></span><br><span class="line"><span class="comment"># X: tensor([[ 7,  8,  9, 10, 11], [23, 24, 25, 26, 27]])</span></span><br><span class="line"><span class="comment"># Y: tensor([[ 8,  9, 10, 11, 12], [24, 25, 26, 27, 28]])</span></span><br><span class="line"><span class="comment"># X: tensor([[12, 13, 14, 15, 16], [28, 29, 30, 31, 32]])</span></span><br><span class="line"><span class="comment"># Y: tensor([[13, 14, 15, 16, 17], [29, 30, 31, 32, 33]])</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ä¸¤ä¸ªé‡‡æ ·å‡½æ•°åŒ…è£…åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œä»¥ä¾¿ç¨åå¯ä»¥å°†å…¶ç”¨ä½œæ•°æ®è¿­ä»£å™¨ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SeqDataLoader</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŠ è½½åºåˆ—æ•°æ®çš„è¿­ä»£å™¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, batch_size, num_steps, use_random_iter, max_tokens</span>):</span><br><span class="line">        <span class="keyword">if</span> use_random_iter:</span><br><span class="line">            self.data_iter_fn = d2l.seq_data_iter_random</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.data_iter_fn = d2l.seq_data_iter_sequential</span><br><span class="line">        self.corpus, self.vocab = d2l.load_corpus_time_machine(max_tokens)</span><br><span class="line">        self.batch_size, self.num_steps = batch_size, num_steps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.data_iter_fn(self.corpus, self.batch_size, self.num_steps)</span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° <code>load_data_time_machine</code>ï¼Œå®ƒåŒæ—¶è¿”å›æ•°æ®è¿­ä»£å™¨å’Œè¯è¡¨ï¼Œå› æ­¤å¯ä»¥ä¸å…¶ä»–å¸¦æœ‰ <code>load_data</code> å‰ç¼€çš„å‡½æ•°ï¼ˆå¦‚ <code>d2l.load_data_fashion_mnist</code>ï¼‰ç±»ä¼¼åœ°ä½¿ç”¨ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_data_time_machine</span>(<span class="params">batch_size, num_steps, use_random_iter=<span class="literal">False</span>, max_tokens=<span class="number">10000</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¿”å›æ—¶å…‰æœºå™¨æ•°æ®é›†çš„è¿­ä»£å™¨å’Œè¯è¡¨&quot;&quot;&quot;</span></span><br><span class="line">    data_iter = SeqDataLoader(batch_size, num_steps, use_random_iter, max_tokens)</span><br><span class="line">    <span class="keyword">return</span> data_iter, data_iter.vocab</span><br></pre></td></tr></table></figure>
<h2 id="4-å¾ªç¯ç¥ç»ç½‘ç»œ">4. å¾ªç¯ç¥ç»ç½‘ç»œ</h2>
<p>ç”±äºæ¶‰åŠè¾ƒå¤šæ•°å­¦å…¬å¼ï¼Œå¾ªç¯ç¥ç»ç½‘ç»œçš„ç†è®ºéƒ¨åˆ†å¯ä»¥è½¬è‡³ï¼š<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_recurrent-neural-networks/rnn.html">å¾ªç¯ç¥ç»ç½‘ç»œ</a>ã€‚</p>
<h3 id="4-1-å¾ªç¯ç¥ç»ç½‘ç»œçš„ä»é›¶å¼€å§‹å®ç°">4.1 å¾ªç¯ç¥ç»ç½‘ç»œçš„ä»é›¶å¼€å§‹å®ç°</h3>
<p>æœ¬èŠ‚å°†ä»å¤´å¼€å§‹åŸºäºå¾ªç¯ç¥ç»ç½‘ç»œå®ç°å­—ç¬¦çº§è¯­è¨€æ¨¡å‹ã€‚è¿™æ ·çš„æ¨¡å‹å°†åœ¨ H.G.Wells çš„æ—¶å…‰æœºå™¨æ•°æ®é›†ä¸Šè®­ç»ƒã€‚å’Œå‰é¢ä¸Šä¸€èŠ‚ä¸­ä»‹ç»è¿‡çš„ä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆè¯»å–æ•°æ®é›†ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.utils.tensorboard <span class="keyword">import</span> SummaryWriter</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">batch_size, num_steps = <span class="number">32</span>, <span class="number">35</span></span><br><span class="line">train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps, max_tokens=<span class="number">10000</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(train_iter.corpus))  <span class="comment"># 10000</span></span><br><span class="line"><span class="keyword">for</span> X, y <span class="keyword">in</span> train_iter:</span><br><span class="line">    <span class="built_in">print</span>(X.shape, y.shape)  <span class="comment"># torch.Size([32, 35]) torch.Size([32, 35])</span></span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>å›æƒ³ä¸€ä¸‹ï¼Œåœ¨ <code>train_iter</code> ä¸­ï¼Œæ¯ä¸ªè¯å…ƒéƒ½è¡¨ç¤ºä¸ºä¸€ä¸ªæ•°å­—ç´¢å¼•ï¼Œå°†è¿™äº›ç´¢å¼•ç›´æ¥è¾“å…¥ç¥ç»ç½‘ç»œå¯èƒ½ä¼šä½¿å­¦ä¹ å˜å¾—å›°éš¾ã€‚æˆ‘ä»¬é€šå¸¸å°†æ¯ä¸ªè¯å…ƒè¡¨ç¤ºä¸ºæ›´å…·è¡¨ç°åŠ›çš„ç‰¹å¾å‘é‡ã€‚æœ€ç®€å•çš„è¡¨ç¤ºç§°ä¸ºç‹¬çƒ­ç¼–ç ï¼ˆone-hot encodingï¼‰ã€‚</p>
<p>ç®€è¨€ä¹‹ï¼Œå°†æ¯ä¸ªç´¢å¼•æ˜ å°„ä¸ºç›¸äº’ä¸åŒçš„å•ä½å‘é‡ï¼šå‡è®¾è¯è¡¨ä¸­ä¸åŒè¯å…ƒçš„æ•°ç›®ä¸ºNï¼ˆå³ <code>len(vocab)</code>ï¼‰ï¼Œè¯å…ƒç´¢å¼•çš„èŒƒå›´ä¸º0~N-1ã€‚å¦‚æœè¯å…ƒçš„ç´¢å¼•æ˜¯æ•´æ•° <code>i</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸ºNçš„å…¨0å‘é‡ï¼Œå¹¶å°†ç¬¬ <code>i</code> å¤„çš„å…ƒç´ è®¾ç½®ä¸º1ã€‚æ­¤å‘é‡æ˜¯åŸå§‹è¯å…ƒçš„ä¸€ä¸ªç‹¬çƒ­å‘é‡ã€‚ç´¢å¼•ä¸º0å’Œ2çš„ç‹¬çƒ­å‘é‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(F.one_hot(torch.tensor([<span class="number">0</span>, <span class="number">2</span>]), <span class="built_in">len</span>(vocab)))</span><br><span class="line"><span class="comment"># tensor([[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],</span></span><br><span class="line"><span class="comment">#         [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]])</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¯æ¬¡é‡‡æ ·çš„å°æ‰¹é‡æ•°æ®å½¢çŠ¶æ˜¯äºŒç»´å¼ é‡ï¼š<code>(æ‰¹é‡å¤§å°, æ—¶é—´æ­¥æ•°)</code>ã€‚<code>one_hot</code> å‡½æ•°å°†è¿™æ ·ä¸€ä¸ªå°æ‰¹é‡æ•°æ®è½¬æ¢æˆä¸‰ç»´å¼ é‡ï¼Œå¼ é‡çš„æœ€åä¸€ä¸ªç»´åº¦ç­‰äºè¯è¡¨å¤§å°ï¼ˆ<code>len(vocab)</code>ï¼‰ã€‚æˆ‘ä»¬ç»å¸¸è½¬æ¢è¾“å…¥çš„ç»´åº¦ï¼Œä»¥ä¾¿è·å¾—å½¢çŠ¶ä¸º <code>(æ—¶é—´æ­¥æ•°, æ‰¹é‡å¤§å°, è¯è¡¨å¤§å°)</code> çš„è¾“å‡ºã€‚è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°é€šè¿‡æœ€å¤–å±‚çš„ç»´åº¦ï¼Œä¸€æ­¥ä¸€æ­¥åœ°æ›´æ–°å°æ‰¹é‡æ•°æ®çš„éšçŠ¶æ€ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X = torch.arange(<span class="number">10</span>).reshape((<span class="number">2</span>, <span class="number">5</span>))</span><br><span class="line"><span class="built_in">print</span>(F.one_hot(X.T, <span class="number">28</span>).shape)  <span class="comment"># torch.Size([5, 2, 28])</span></span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆå§‹åŒ–å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹çš„æ¨¡å‹å‚æ•°ã€‚éšè—å•å…ƒæ•° <code>num_hiddens</code> æ˜¯ä¸€ä¸ªå¯è°ƒçš„è¶…å‚æ•°ã€‚å½“è®­ç»ƒè¯­è¨€æ¨¡å‹æ—¶ï¼Œè¾“å…¥å’Œè¾“å‡ºæ¥è‡ªç›¸åŒçš„è¯è¡¨ï¼ˆè¾“å‡ºå¯ä»¥çœ‹æˆå¤šåˆ†ç±»é—®é¢˜ï¼Œå³è¾“å‡ºè¡¨ç¤ºå¯¹æ¯ä¸ªè¯å…ƒçš„é¢„æµ‹æ¦‚ç‡ï¼‰ã€‚å› æ­¤ï¼Œå®ƒä»¬å…·æœ‰ç›¸åŒçš„ç»´åº¦ï¼Œå³è¯è¡¨çš„å¤§å°ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_params</span>(<span class="params">vocab_size, num_hiddens, device</span>):</span><br><span class="line">    num_inputs = num_outputs = vocab_size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">normal</span>(<span class="params">shape</span>):</span><br><span class="line">        <span class="keyword">return</span> torch.randn(size=shape, device=device) * <span class="number">0.01</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># éšè—å±‚å‚æ•°</span></span><br><span class="line">    W_xh = normal((num_inputs, num_hiddens))</span><br><span class="line">    W_hh = normal((num_hiddens, num_hiddens))</span><br><span class="line">    b_h = torch.zeros(num_hiddens, device=device)</span><br><span class="line">    <span class="comment"># è¾“å‡ºå±‚å‚æ•°</span></span><br><span class="line">    W_hq = normal((num_hiddens, num_outputs))</span><br><span class="line">    b_q = torch.zeros(num_outputs, device=device)</span><br><span class="line">    <span class="comment"># é™„åŠ æ¢¯åº¦</span></span><br><span class="line">    params = [W_xh, W_hh, b_h, W_hq, b_q]</span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> params:</span><br><span class="line">        param.requires_grad_(<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> params</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†å®šä¹‰å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ª <code>init_rnn_state</code> å‡½æ•°åœ¨åˆå§‹åŒ–æ—¶è¿”å›éšçŠ¶æ€ã€‚è¿™ä¸ªå‡½æ•°çš„è¿”å›æ˜¯ä¸€ä¸ªå¼ é‡ï¼Œå¼ é‡å…¨ç”¨0å¡«å……ï¼Œå½¢çŠ¶ä¸º <code>(æ‰¹é‡å¤§å°, éšè—å•å…ƒæ•°)</code>ã€‚åœ¨åé¢çš„ç« èŠ‚ä¸­æˆ‘ä»¬å°†ä¼šé‡åˆ°éšçŠ¶æ€åŒ…å«å¤šä¸ªå˜é‡çš„æƒ…å†µï¼Œè€Œä½¿ç”¨å…ƒç»„å¯ä»¥æ›´å®¹æ˜“åœ°å¤„ç†äº›ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_rnn_state</span>(<span class="params">batch_size, num_hiddens, device</span>):</span><br><span class="line">    <span class="keyword">return</span> (torch.zeros((batch_size, num_hiddens), device=device),)</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ <code>rnn</code> å‡½æ•°å®šä¹‰äº†å¦‚ä½•åœ¨ä¸€ä¸ªæ—¶é—´æ­¥å†…è®¡ç®—éšçŠ¶æ€å’Œè¾“å‡ºã€‚å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹é€šè¿‡ <code>inputs</code> æœ€å¤–å±‚çš„ç»´åº¦å®ç°å¾ªç¯ï¼Œä»¥ä¾¿é€æ—¶é—´æ­¥æ›´æ–°å°æ‰¹é‡æ•°æ®çš„éšçŠ¶æ€Hã€‚æ­¤å¤–ï¼Œè¿™é‡Œä½¿ç”¨ <code>tanh</code> å‡½æ•°ä½œä¸ºæ¿€æ´»å‡½æ•°ï¼Œå½“å…ƒç´ åœ¨å®æ•°ä¸Šæ»¡è¶³å‡åŒ€åˆ†å¸ƒæ—¶ï¼Œ<code>tanh</code> å‡½æ•°çš„å¹³å‡å€¼ä¸º0ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rnn</span>(<span class="params">inputs, state, params</span>):</span><br><span class="line">    <span class="comment"># inputs.shape: (æ—¶é—´æ­¥æ•°é‡, æ‰¹é‡å¤§å°, è¯è¡¨å¤§å°)</span></span><br><span class="line">    W_xh, W_hh, b_h, W_hq, b_q = params</span><br><span class="line">    H, = state</span><br><span class="line">    outputs = []</span><br><span class="line">    <span class="comment"># X.shape: (æ‰¹é‡å¤§å°, è¯è¡¨å¤§å°)</span></span><br><span class="line">    <span class="keyword">for</span> X <span class="keyword">in</span> inputs:</span><br><span class="line">        H = torch.tanh(torch.mm(X, W_xh) + torch.mm(H, W_hh) + b_h)</span><br><span class="line">        Y = torch.mm(H, W_hq) + b_q</span><br><span class="line">        outputs.append(Y)</span><br><span class="line">    <span class="keyword">return</span> torch.cat(outputs, dim=<span class="number">0</span>), (H,)</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰äº†æ‰€æœ‰éœ€è¦çš„å‡½æ•°ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»æ¥åŒ…è£…è¿™äº›å‡½æ•°ï¼Œå¹¶å­˜å‚¨ä»é›¶å¼€å§‹å®ç°çš„å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹çš„å‚æ•°ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RNNModelScratch</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»é›¶å¼€å§‹å®ç°çš„å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, vocab_size, num_hiddens, device, get_params, init_state, forward_fn</span>):</span><br><span class="line">        self.vocab_size, self.num_hiddens = vocab_size, num_hiddens</span><br><span class="line">        self.params = get_params(vocab_size, num_hiddens, device)</span><br><span class="line">        self.init_state, self.forward_fn = init_state, forward_fn</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, X, state</span>):</span><br><span class="line">        X = F.one_hot(X.T, self.vocab_size).<span class="built_in">type</span>(torch.float32)</span><br><span class="line">        <span class="keyword">return</span> self.forward_fn(X, state, self.params)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">begin_state</span>(<span class="params">self, batch_size, device</span>):</span><br><span class="line">        <span class="keyword">return</span> self.init_state(batch_size, self.num_hiddens, device)</span><br></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬æ£€æŸ¥è¾“å‡ºæ˜¯å¦å…·æœ‰æ­£ç¡®çš„å½¢çŠ¶ã€‚ä¾‹å¦‚ï¼ŒéšçŠ¶æ€çš„ç»´æ•°æ˜¯å¦ä¿æŒä¸å˜ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">num_hiddens = <span class="number">512</span></span><br><span class="line">net = RNNModelScratch(<span class="built_in">len</span>(vocab), num_hiddens, device, get_params, init_rnn_state, rnn)</span><br><span class="line">state = net.begin_state(X.shape[<span class="number">0</span>], device)</span><br><span class="line">Y, new_state = net(X.to(device), state)</span><br><span class="line"><span class="built_in">print</span>(Y.shape, <span class="built_in">len</span>(new_state), new_state[<span class="number">0</span>].shape)  <span class="comment"># torch.Size([10, 28]) 1 torch.Size([2, 512])</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¾“å‡ºå½¢çŠ¶æ˜¯ <code>(æ—¶é—´æ­¥æ•° * æ‰¹é‡å¤§å°, è¯è¡¨å¤§å°)</code>ï¼Œè€ŒéšçŠ¶æ€å½¢çŠ¶ä¿æŒä¸å˜ï¼Œå³ <code>(æ‰¹é‡å¤§å°, éšè—å•å…ƒæ•°)</code>ã€‚</p>
<p>è®©æˆ‘ä»¬é¦–å…ˆå®šä¹‰é¢„æµ‹å‡½æ•°æ¥ç”Ÿæˆ <code>prefix</code> ä¹‹åçš„æ–°å­—ç¬¦ï¼Œå…¶ä¸­çš„ <code>prefix</code> æ˜¯ä¸€ä¸ªç”¨æˆ·æä¾›çš„åŒ…å«å¤šä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚åœ¨å¾ªç¯éå† <code>prefix</code> ä¸­çš„å¼€å§‹å­—ç¬¦æ—¶ï¼Œæˆ‘ä»¬ä¸æ–­åœ°å°†éšçŠ¶æ€ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥ï¼Œä½†æ˜¯ä¸ç”Ÿæˆä»»ä½•è¾“å‡ºã€‚è¿™è¢«ç§°ä¸ºé¢„çƒ­ï¼ˆwarm-upï¼‰æœŸï¼Œå› ä¸ºåœ¨æ­¤æœŸé—´æ¨¡å‹ä¼šè‡ªæˆ‘æ›´æ–°ï¼ˆä¾‹å¦‚ï¼Œæ›´æ–°éšçŠ¶æ€ï¼‰ï¼Œä½†ä¸ä¼šè¿›è¡Œé¢„æµ‹ã€‚é¢„çƒ­æœŸç»“æŸåï¼ŒéšçŠ¶æ€çš„å€¼é€šå¸¸æ¯”åˆšå¼€å§‹çš„åˆå§‹å€¼æ›´é€‚åˆé¢„æµ‹ï¼Œä»è€Œé¢„æµ‹å­—ç¬¦å¹¶è¾“å‡ºå®ƒä»¬ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">prefix, num_preds, net, vocab, device</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åœ¨prefixåé¢ç”Ÿæˆæ–°å­—ç¬¦&quot;&quot;&quot;</span></span><br><span class="line">    state = net.begin_state(batch_size=<span class="number">1</span>, device=device)</span><br><span class="line">    outputs = [vocab[prefix[<span class="number">0</span>]]]</span><br><span class="line">    get_input = <span class="keyword">lambda</span>: torch.tensor([outputs[-<span class="number">1</span>]], device=device).reshape((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> prefix[<span class="number">1</span>:]:  <span class="comment"># é¢„çƒ­æœŸ</span></span><br><span class="line">        _, state = net(get_input(), state)</span><br><span class="line">        outputs.append(vocab[y])</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_preds):  <span class="comment"># é¢„æµ‹num_predsæ­¥</span></span><br><span class="line">        y, state = net(get_input(), state)</span><br><span class="line">        outputs.append(<span class="built_in">int</span>(y.argmax(dim=<span class="number">1</span>).reshape(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([vocab.idx_to_token[i] <span class="keyword">for</span> i <span class="keyword">in</span> outputs])</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æµ‹è¯• <code>predict</code> å‡½æ•°ã€‚æˆ‘ä»¬å°†å‰ç¼€æŒ‡å®šä¸º <code>time traveller</code>ï¼Œå¹¶åŸºäºè¿™ä¸ªå‰ç¼€ç”Ÿæˆ10ä¸ªåç»­å­—ç¬¦ã€‚é‰´äºæˆ‘ä»¬è¿˜æ²¡æœ‰è®­ç»ƒç½‘ç»œï¼Œå®ƒä¼šç”Ÿæˆè’è°¬çš„é¢„æµ‹ç»“æœï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(predict(<span class="string">&#x27;time traveller &#x27;</span>, <span class="number">10</span>, net, vocab, device))  <span class="comment"># time traveller gxgtlsryyy</span></span><br></pre></td></tr></table></figure>
<p>æ¢¯åº¦è£å‰ªçš„ç†è®ºå¯è½¬è‡³ï¼š<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_recurrent-neural-networks/rnn-scratch.html">å¾ªç¯ç¥ç»ç½‘ç»œçš„ä»é›¶å¼€å§‹å®ç°</a>ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è£å‰ªæ¨¡å‹çš„æ¢¯åº¦ï¼Œæ¨¡å‹æ˜¯ä»é›¶å¼€å§‹å®ç°çš„æ¨¡å‹æˆ–ç”±é«˜çº§ API æ„å»ºçš„æ¨¡å‹ã€‚æˆ‘ä»¬åœ¨æ­¤è®¡ç®—äº†æ‰€æœ‰æ¨¡å‹å‚æ•°çš„æ¢¯åº¦çš„èŒƒæ•°ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">grad_clipping</span>(<span class="params">net, theta</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è£å‰ªæ¢¯åº¦&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(net, nn.Module):</span><br><span class="line">        params = [p <span class="keyword">for</span> p <span class="keyword">in</span> net.parameters() <span class="keyword">if</span> p.requires_grad]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        params = net.params</span><br><span class="line">    norm = torch.sqrt(<span class="built_in">sum</span>(torch.<span class="built_in">sum</span>((p.grad ** <span class="number">2</span>)) <span class="keyword">for</span> p <span class="keyword">in</span> params))</span><br><span class="line">    <span class="keyword">if</span> norm &gt; theta:</span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> params:</span><br><span class="line">            param.grad[:] *= theta / norm</span><br></pre></td></tr></table></figure>
<p>åœ¨è®­ç»ƒæ¨¡å‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå‡½æ•°åœ¨ä¸€ä¸ªè¿­ä»£å‘¨æœŸå†…è®­ç»ƒæ¨¡å‹ã€‚å®ƒä¸æˆ‘ä»¬è®­ç»ƒ Softmax æ¨¡å‹çš„æ–¹å¼æœ‰ä¸‰ä¸ªä¸åŒä¹‹å¤„ï¼š</p>
<ul>
<li>åºåˆ—æ•°æ®çš„ä¸åŒé‡‡æ ·æ–¹æ³•ï¼ˆéšæœºé‡‡æ ·å’Œé¡ºåºåˆ†åŒºï¼‰å°†å¯¼è‡´éšçŠ¶æ€åˆå§‹åŒ–çš„å·®å¼‚ã€‚</li>
<li>æˆ‘ä»¬åœ¨æ›´æ–°æ¨¡å‹å‚æ•°ä¹‹å‰è£å‰ªæ¢¯åº¦ã€‚è¿™æ ·çš„æ“ä½œçš„ç›®çš„æ˜¯ï¼Œå³ä½¿è®­ç»ƒè¿‡ç¨‹ä¸­æŸä¸ªç‚¹ä¸Šå‘ç”Ÿäº†æ¢¯åº¦çˆ†ç‚¸ï¼Œä¹Ÿèƒ½ä¿è¯æ¨¡å‹ä¸ä¼šå‘æ•£ã€‚</li>
<li>æˆ‘ä»¬ç”¨å›°æƒ‘åº¦æ¥è¯„ä»·æ¨¡å‹ã€‚è¿™æ ·çš„åº¦é‡ç¡®ä¿äº†ä¸åŒé•¿åº¦çš„åºåˆ—å…·æœ‰å¯æ¯”æ€§ã€‚</li>
</ul>
<p>å…·ä½“æ¥è¯´ï¼Œå½“ä½¿ç”¨é¡ºåºåˆ†åŒºæ—¶ï¼Œæˆ‘ä»¬åªåœ¨æ¯ä¸ªè¿­ä»£å‘¨æœŸçš„å¼€å§‹ä½ç½®åˆå§‹åŒ–éšçŠ¶æ€ã€‚ç”±äºä¸‹ä¸€ä¸ªå°æ‰¹é‡æ•°æ®ä¸­çš„ç¬¬ <code>i</code> ä¸ªå­åºåˆ—æ ·æœ¬ä¸å½“å‰ç¬¬ <code>i</code> ä¸ªå­åºåˆ—æ ·æœ¬ç›¸é‚»ï¼Œå› æ­¤å½“å‰å°æ‰¹é‡æ•°æ®æœ€åä¸€ä¸ªæ ·æœ¬çš„éšçŠ¶æ€ï¼Œå°†ç”¨äºåˆå§‹åŒ–ä¸‹ä¸€ä¸ªå°æ‰¹é‡æ•°æ®ç¬¬ä¸€ä¸ªæ ·æœ¬çš„éšçŠ¶æ€ã€‚è¿™æ ·ï¼Œå­˜å‚¨åœ¨éšçŠ¶æ€ä¸­çš„åºåˆ—çš„å†å²ä¿¡æ¯å¯ä»¥åœ¨ä¸€ä¸ªè¿­ä»£å‘¨æœŸå†…æµç»ç›¸é‚»çš„å­åºåˆ—ã€‚ç„¶è€Œï¼Œåœ¨ä»»ä½•ä¸€ç‚¹éšçŠ¶æ€çš„è®¡ç®—ï¼Œéƒ½ä¾èµ–äºåŒä¸€è¿­ä»£å‘¨æœŸä¸­å‰é¢æ‰€æœ‰çš„å°æ‰¹é‡æ•°æ®ï¼Œè¿™ä½¿å¾—æ¢¯åº¦è®¡ç®—å˜å¾—å¤æ‚ã€‚ä¸ºäº†é™ä½è®¡ç®—é‡ï¼Œåœ¨å¤„ç†ä»»ä½•ä¸€ä¸ªå°æ‰¹é‡æ•°æ®ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆ<strong>åˆ†ç¦»æ¢¯åº¦</strong>ï¼Œä½¿å¾—éšçŠ¶æ€çš„æ¢¯åº¦è®¡ç®—æ€»æ˜¯é™åˆ¶åœ¨ä¸€ä¸ªå°æ‰¹é‡æ•°æ®çš„æ—¶é—´æ­¥å†…ã€‚</p>
<p>å½“ä½¿ç”¨éšæœºæŠ½æ ·æ—¶ï¼Œå› ä¸ºæ¯ä¸ªæ ·æœ¬éƒ½æ˜¯åœ¨ä¸€ä¸ªéšæœºä½ç½®æŠ½æ ·çš„ï¼Œå› æ­¤éœ€è¦<strong>ä¸ºæ¯ä¸ªè¿­ä»£å‘¨æœŸé‡æ–°åˆå§‹åŒ–éšçŠ¶æ€</strong>ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_epoch</span>(<span class="params">net, train_iter, loss_function, optimizer, device, use_random_iter</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®­ç»ƒç½‘ç»œä¸€ä¸ªè¿­ä»£å‘¨æœŸï¼ˆå®šä¹‰è§ç¬¬8ç« ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">    state = <span class="literal">None</span></span><br><span class="line">    train_loss = []</span><br><span class="line">    <span class="keyword">for</span> X, Y <span class="keyword">in</span> tqdm(train_iter):</span><br><span class="line">        <span class="keyword">if</span> state <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> use_random_iter:</span><br><span class="line">            <span class="comment"># åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æˆ–ä½¿ç”¨éšæœºæŠ½æ ·æ—¶åˆå§‹åŒ–state</span></span><br><span class="line">            state = net.begin_state(batch_size=X.shape[<span class="number">0</span>], device=device)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(net, nn.Module) <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(state, <span class="built_in">tuple</span>):</span><br><span class="line">                <span class="comment"># stateå¯¹äºnn.GRUæ˜¯ä¸ªå¼ é‡</span></span><br><span class="line">                state.detach_()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># stateå¯¹äºnn.LSTMæˆ–å¯¹äºæˆ‘ä»¬ä»é›¶å¼€å§‹å®ç°çš„æ¨¡å‹æ˜¯ä¸ªå…ƒç»„</span></span><br><span class="line">                <span class="keyword">for</span> s <span class="keyword">in</span> state:</span><br><span class="line">                    s.detach_()</span><br><span class="line">        y = Y.T.reshape(-<span class="number">1</span>)</span><br><span class="line">        X, y = X.to(device), y.to(device)</span><br><span class="line">        y_hat, state = net(X, state)</span><br><span class="line">        loss = loss_function(y_hat, y.long()).mean()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(optimizer, torch.optim.Optimizer):</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            loss.backward()</span><br><span class="line">            grad_clipping(net, <span class="number">1</span>)</span><br><span class="line">            optimizer.step()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            loss.backward()</span><br><span class="line">            grad_clipping(net, <span class="number">1</span>)</span><br><span class="line">            optimizer(batch_size=<span class="number">1</span>)</span><br><span class="line">        train_loss.append(loss)  <span class="comment"># å› ä¸ºå·²ç»è°ƒç”¨äº†meanå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> math.exp(<span class="built_in">sum</span>(train_loss) / <span class="built_in">len</span>(train_loss))  <span class="comment"># è¿”å›å›°æƒ‘åº¦</span></span><br></pre></td></tr></table></figure>
<p>å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹çš„è®­ç»ƒå‡½æ•°æ—¢æ”¯æŒä»é›¶å¼€å§‹å®ç°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é«˜çº§ API æ¥å®ç°ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">net, train_iter, vocab, lr, num_epochs, device, use_random_iter=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹ï¼ˆå®šä¹‰è§ç¬¬8ç« ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">    loss_function = nn.CrossEntropyLoss()</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(net, nn.Module):</span><br><span class="line">        optimizer = torch.optim.SGD(net.parameters(), lr)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        optimizer = <span class="keyword">lambda</span> batch_size: d2l.sgd(net.params, lr, batch_size)</span><br><span class="line">    pred = <span class="keyword">lambda</span> prefix: predict(prefix, <span class="number">50</span>, net, vocab, device)</span><br><span class="line">    <span class="comment"># è®­ç»ƒå’Œé¢„æµ‹</span></span><br><span class="line">    writer = SummaryWriter(<span class="string">&#x27;../logs/RNN_scratch_train_log&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        ppl = train_epoch(net, train_iter, loss_function, optimizer, device, use_random_iter)</span><br><span class="line">        <span class="keyword">if</span> (epoch + <span class="number">1</span>) % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(pred(<span class="string">&#x27;time traveller&#x27;</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Perplexity: <span class="subst">&#123;ppl:<span class="number">.1</span>f&#125;</span>&#x27;</span>)</span><br><span class="line">            writer.add_scalar(<span class="string">&#x27;train_loss&#x27;</span>, ppl, epoch + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(pred(<span class="string">&#x27;time traveller&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(pred(<span class="string">&#x27;traveller&#x27;</span>))</span><br><span class="line">    writer.close()</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬è®­ç»ƒå¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚å› ä¸ºæˆ‘ä»¬åœ¨æ•°æ®é›†ä¸­åªä½¿ç”¨äº†10000ä¸ªè¯å…ƒï¼Œæ‰€ä»¥æ¨¡å‹éœ€è¦æ›´å¤šçš„è¿­ä»£å‘¨æœŸæ¥æ›´å¥½åœ°æ”¶æ•›ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">num_epochs, lr = <span class="number">500</span>, <span class="number">1</span></span><br><span class="line">train(net, train_iter, vocab, lr, num_epochs, device)</span><br><span class="line"><span class="comment"># Perplexity: 1.0</span></span><br><span class="line"><span class="comment"># time travelleryou can show black is white by argument said filby</span></span><br><span class="line"><span class="comment"># travelleryou can show black is white by argument said filby</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-å¾ªç¯ç¥ç»ç½‘ç»œçš„ç®€æ´å®ç°">4.2 å¾ªç¯ç¥ç»ç½‘ç»œçš„ç®€æ´å®ç°</h3>
<p>è™½ç„¶ä»é›¶å¼€å§‹å®ç°å¾ªç¯ç¥ç»ç½‘ç»œå¯¹äº†è§£ç½‘ç»œçš„å®ç°æ–¹å¼å…·æœ‰æŒ‡å¯¼æ„ä¹‰ï¼Œä½†å¹¶ä¸æ–¹ä¾¿ã€‚æœ¬èŠ‚å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¡†æ¶çš„é«˜çº§ API æä¾›çš„å‡½æ•°æ›´æœ‰æ•ˆåœ°å®ç°ç›¸åŒçš„è¯­è¨€æ¨¡å‹ã€‚æˆ‘ä»¬ä»ç„¶ä»è¯»å–æ—¶å…‰æœºå™¨æ•°æ®é›†å¼€å§‹ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.utils.tensorboard <span class="keyword">import</span> SummaryWriter</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> d2l <span class="keyword">import</span> torch <span class="keyword">as</span> d2l</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">batch_size, num_steps = <span class="number">32</span>, <span class="number">35</span></span><br><span class="line">train_iter, vocab = d2l.load_data_time_machine(batch_size, num_steps)</span><br></pre></td></tr></table></figure>
<p>é«˜çº§ API æä¾›äº†å¾ªç¯ç¥ç»ç½‘ç»œçš„å®ç°ã€‚æˆ‘ä»¬æ„é€ ä¸€ä¸ªå…·æœ‰256ä¸ªéšè—å•å…ƒçš„å•éšè—å±‚çš„å¾ªç¯ç¥ç»ç½‘ç»œå±‚ <code>rnn_layer</code>ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è®¨è®ºå¤šå±‚å¾ªç¯ç¥ç»ç½‘ç»œçš„æ„ä¹‰ï¼ˆè¿™å°†åœ¨æ·±åº¦å¾ªç¯ç¥ç»ç½‘ç»œä¸­ä»‹ç»ï¼‰ã€‚ç°åœ¨ä»…éœ€è¦å°†å¤šå±‚ç†è§£ä¸ºä¸€å±‚å¾ªç¯ç¥ç»ç½‘ç»œçš„è¾“å‡ºè¢«ç”¨ä½œä¸‹ä¸€å±‚å¾ªç¯ç¥ç»ç½‘ç»œçš„è¾“å…¥å°±è¶³å¤Ÿäº†ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">num_hiddens = <span class="number">256</span></span><br><span class="line">rnn_layer = nn.RNN(<span class="built_in">len</span>(vocab), num_hiddens)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨å¼ é‡æ¥åˆå§‹åŒ–éšçŠ¶æ€ï¼Œå®ƒçš„å½¢çŠ¶æ˜¯ <code>(éšè—å±‚æ•°, æ‰¹é‡å¤§å°, éšè—å•å…ƒæ•°)</code>ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">state = torch.zeros((<span class="number">1</span>, batch_size, num_hiddens))</span><br><span class="line"><span class="built_in">print</span>(state.shape)  <span class="comment"># torch.Size([1, 32, 256])</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸€ä¸ªéšçŠ¶æ€å’Œä¸€ä¸ªè¾“å…¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æ›´æ–°åçš„éšçŠ¶æ€è®¡ç®—è¾“å‡ºã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œ<code>rnn_layer</code> çš„è¾“å‡ºï¼ˆ<code>Y</code>ï¼‰ä¸æ¶‰åŠè¾“å‡ºå±‚çš„è®¡ç®—ï¼šå®ƒæ˜¯æŒ‡<strong>æ¯ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€</strong>ï¼Œè¿™äº›éšçŠ¶æ€å¯ä»¥ç”¨ä½œåç»­è¾“å‡ºå±‚çš„è¾“å…¥ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">X = torch.rand(size=(num_steps, batch_size, <span class="built_in">len</span>(vocab)))</span><br><span class="line">Y, state_new = rnn_layer(X, state)</span><br><span class="line"><span class="built_in">print</span>(Y.shape, state_new.shape)  <span class="comment"># torch.Size([35, 32, 256]) torch.Size([1, 32, 256])</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸ºä¸€ä¸ªå®Œæ•´çš„å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹å®šä¹‰äº†ä¸€ä¸ª <code>RNNModel</code> ç±»ã€‚æ³¨æ„ï¼Œ<code>rnn_layer</code> åªåŒ…å«éšè—çš„å¾ªç¯å±‚ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„è¾“å‡ºå±‚ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RNNModel</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¾ªç¯ç¥ç»ç½‘ç»œæ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, rnn_layer, vocab_size, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(RNNModel, self).__init__(**kwargs)</span><br><span class="line">        self.rnn = rnn_layer</span><br><span class="line">        self.vocab_size = vocab_size</span><br><span class="line">        self.num_hiddens = self.rnn.hidden_size</span><br><span class="line">        <span class="comment"># å¦‚æœRNNæ˜¯åŒå‘çš„ï¼ˆä¹‹åå°†ä»‹ç»ï¼‰ï¼Œnum_directionsåº”è¯¥æ˜¯2ï¼Œå¦åˆ™åº”è¯¥æ˜¯1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.rnn.bidirectional:</span><br><span class="line">            self.num_directions = <span class="number">1</span></span><br><span class="line">            self.linear = nn.Linear(self.num_hiddens, self.vocab_size)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.num_directions = <span class="number">2</span></span><br><span class="line">            self.linear = nn.Linear(self.num_hiddens * <span class="number">2</span>, self.vocab_size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs, state</span>):</span><br><span class="line">        X = F.one_hot(inputs.T.long(), self.vocab_size)</span><br><span class="line">        X = X.to(torch.float32)</span><br><span class="line">        Y, state = self.rnn(X, state)</span><br><span class="line">        <span class="comment"># å…¨è¿æ¥å±‚é¦–å…ˆå°†Yçš„å½¢çŠ¶æ”¹ä¸ºï¼š(æ—¶é—´æ­¥æ•° * æ‰¹é‡å¤§å°, éšè—å•å…ƒæ•°)</span></span><br><span class="line">        <span class="comment"># å®ƒçš„è¾“å‡ºå½¢çŠ¶æ˜¯ï¼š(æ—¶é—´æ­¥æ•° * æ‰¹é‡å¤§å°, è¯è¡¨å¤§å°)</span></span><br><span class="line">        output = self.linear(Y.reshape((-<span class="number">1</span>, Y.shape[-<span class="number">1</span>])))  <span class="comment"># (35 * 32, 256) -&gt; (35 * 32, 28)</span></span><br><span class="line">        <span class="keyword">return</span> output, state</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">begin_state</span>(<span class="params">self, device, batch_size=<span class="number">1</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(self.rnn, nn.LSTM):</span><br><span class="line">            <span class="comment"># nn.GRUä»¥å¼ é‡ä½œä¸ºéšçŠ¶æ€</span></span><br><span class="line">            <span class="keyword">return</span> torch.zeros((self.num_directions * self.rnn.num_layers, batch_size, self.num_hiddens), device=device)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># nn.LSTMä»¥å…ƒç»„ä½œä¸ºéšçŠ¶æ€</span></span><br><span class="line">            <span class="keyword">return</span> (torch.zeros((self.num_directions * self.rnn.num_layers, batch_size, self.num_hiddens), device=device),</span><br><span class="line">                    torch.zeros((self.num_directions * self.rnn.num_layers, batch_size, self.num_hiddens), device=device))</span><br></pre></td></tr></table></figure>
<p>åœ¨è®­ç»ƒæ¨¡å‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬åŸºäºä¸€ä¸ªå…·æœ‰éšæœºæƒé‡çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹ï¼Œ<code>d2l.predict_ch8</code> å‡½æ•°ä¸ä¸Šä¸€èŠ‚ä¸­çš„ <code>predict</code> å‡½æ•°ç›¸åŒï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">net = RNNModel(rnn_layer, vocab_size=<span class="built_in">len</span>(vocab))</span><br><span class="line">net = net.to(device)</span><br><span class="line"><span class="built_in">print</span>(d2l.predict_ch8(<span class="string">&#x27;time traveller&#x27;</span>, <span class="number">10</span>, net, vocab, device))  <span class="comment"># time travellerxhhhhhhhhh</span></span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ï¼Œè¿™ç§æ¨¡å‹æ ¹æœ¬ä¸èƒ½è¾“å‡ºå¥½çš„ç»“æœã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸Šä¸€èŠ‚ä¸­å®šä¹‰çš„è¶…å‚æ•°è®­ç»ƒæ¨¡å‹ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_epoch</span>(<span class="params">net, train_iter, loss_function, optimizer, device, use_random_iter</span>):</span><br><span class="line">    state = <span class="literal">None</span></span><br><span class="line">    train_loss = []</span><br><span class="line">    <span class="keyword">for</span> X, Y <span class="keyword">in</span> tqdm(train_iter):</span><br><span class="line">        <span class="keyword">if</span> state <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> use_random_iter:</span><br><span class="line">            state = net.begin_state(batch_size=X.shape[<span class="number">0</span>], device=device)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(net, nn.Module) <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(state, <span class="built_in">tuple</span>):</span><br><span class="line">                state.detach_()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">for</span> s <span class="keyword">in</span> state:</span><br><span class="line">                    s.detach_()</span><br><span class="line">        y = Y.T.reshape(-<span class="number">1</span>)</span><br><span class="line">        X, y = X.to(device), y.to(device)</span><br><span class="line">        loss_function.to(device)</span><br><span class="line">        y_hat, state = net(X, state)</span><br><span class="line">        loss = loss_function(y_hat, y.long()).mean()</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        d2l.grad_clipping(net, <span class="number">1</span>)  <span class="comment"># ä¸ä¸Šä¸€èŠ‚ä¸­çš„grad_clippingå‡½æ•°ç›¸åŒ</span></span><br><span class="line">        optimizer.step()</span><br><span class="line">        train_loss.append(loss)  <span class="comment"># å› ä¸ºå·²ç»è°ƒç”¨äº†meanå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> math.exp(<span class="built_in">sum</span>(train_loss) / <span class="built_in">len</span>(train_loss))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">net, train_iter, vocab, lr, num_epochs, device, use_random_iter=<span class="literal">False</span></span>):</span><br><span class="line">    loss_function = nn.CrossEntropyLoss()</span><br><span class="line">    optimizer = torch.optim.SGD(net.parameters(), lr)</span><br><span class="line">    pred = <span class="keyword">lambda</span> prefix: d2l.predict_ch8(prefix, <span class="number">50</span>, net, vocab, device)</span><br><span class="line"></span><br><span class="line">    writer = SummaryWriter(<span class="string">&#x27;../logs/RNN_scratch_train_log&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        ppl = train_epoch(net, train_iter, loss_function, optimizer, device, use_random_iter)</span><br><span class="line">        <span class="keyword">if</span> (epoch + <span class="number">1</span>) % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(pred(<span class="string">&#x27;time traveller&#x27;</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Perplexity: <span class="subst">&#123;ppl:<span class="number">.1</span>f&#125;</span>&#x27;</span>)</span><br><span class="line">            writer.add_scalar(<span class="string">&#x27;train_loss&#x27;</span>, ppl, epoch + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(pred(<span class="string">&#x27;time traveller&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(pred(<span class="string">&#x27;traveller&#x27;</span>))</span><br><span class="line">    writer.close()</span><br><span class="line"></span><br><span class="line">num_epochs, lr = <span class="number">500</span>, <span class="number">1</span></span><br><span class="line">train(net, train_iter, vocab, lr, num_epochs, device)</span><br><span class="line"><span class="comment"># Perplexity: 1.3</span></span><br><span class="line"><span class="comment"># time traveller for so ig will aboca thoursugli gpseknop how stac</span></span><br><span class="line"><span class="comment"># travelleryou can space of the simestiok satt or al and wisc</span></span><br></pre></td></tr></table></figure>
</div>
        </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> Share</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>æ‰“å¼€å¾®ä¿¡â€œæ‰«ä¸€æ‰«â€ï¼Œæ‰“å¼€ç½‘é¡µåç‚¹å‡»å±å¹•å³ä¸Šè§’åˆ†äº«æŒ‰é’®</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://asanosaki.github.io/posts/11559.html",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://asanosaki.github.io/posts/11559.html";
            const title         = "ã€ŒåŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ç¬”è®°(ææ²)-å¾ªç¯ç¥ç»ç½‘ç»œã€";
            const excerpt       = `ææ²åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ï¼ˆPyTorchï¼‰è¯¾ç¨‹å­¦ä¹ ç¬”è®°ç¬¬å…«ç« ï¼šå¾ªç¯ç¥ç»ç½‘ç»œã€‚`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/AI/" rel="tag">AI</a>
                </div>
                <div class="pull-date">
                    <time datetime="2023-04-11T08:45:08.263Z" itemprop="dateModified">Last edited: 2023-04-11</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" Pythonè·¯å¾„æ“ä½œæ¨¡å—pathlibæ•™ç¨‹" href="/posts/55.html">&lt; Previous</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ ç¬”è®°(ææ²)-ç°ä»£å¾ªç¯ç¥ç»ç½‘ç»œ" href="/posts/7592.html">Next &gt;</a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- æ–‡ç« å’Œé¡µé¢æ ¹æ®splitteræ¥åˆ†å‰²ï¼Œæ²¡æœ‰çš„è¯å°±ä»å¤´å¼€å§‹è®¾ç½®ä¸ºsticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/head.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                Articles
            </span>
            <span class="count">
                59
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                Classifications
            </span>
            <span class="count">
                11
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                Tags
            </span>
            <span class="count">
                11
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class" >
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        Contents
        <span class="toc-progress-bar" role="progressbar" aria-label="é˜…è¯»è¿›åº¦ï¼š"></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BA%8F%E5%88%97%E6%A8%A1%E5%9E%8B"><span class="toc-text">1. åºåˆ—æ¨¡å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%96%87%E6%9C%AC%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-text">2. æ–‡æœ¬é¢„å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-text">3. è¯­è¨€æ¨¡å‹å’Œæ•°æ®é›†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C"><span class="toc-text">4. å¾ªç¯ç¥ç»ç½‘ç»œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.1 å¾ªç¯ç¥ç»ç½‘ç»œçš„ä»é›¶å¼€å§‹å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%BE%AA%E7%8E%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E7%AE%80%E6%B4%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.2 å¾ªç¯ç¥ç»ç½‘ç»œçš„ç®€æ´å®ç°</span></a></li></ol></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>Contents</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Django/">Django</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Essay/">Essay</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">7</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>Tags aggregation</h4>
      <div class="tag-clouds">
        <a href="/tags/AI/" style="font-size: 0.8em;">AI</a> <a href="/tags/C/" style="font-size: 0.6em;">C++</a> <a href="/tags/Django/" style="font-size: 0.77em;">Django</a> <a href="/tags/Essay/" style="font-size: 0.6em;">Essay</a> <a href="/tags/Hexo/" style="font-size: 0.63em;">Hexo</a> <a href="/tags/Linux/" style="font-size: 0.67em;">Linux</a> <a href="/tags/MySQL/" style="font-size: 0.6em;">MySQL</a> <a href="/tags/Network/" style="font-size: 0.6em;">Network</a> <a href="/tags/Others/" style="font-size: 0.7em;">Others</a> <a href="/tags/Python/" style="font-size: 0.63em;">Python</a> <a href="/tags/Web/" style="font-size: 0.73em;">Web</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>Latest articles</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/posts/45720.html"><i class="fa  fa-book"></i> Django Channelsã€WSåè®®åŠåŒæ­¥ä¸å¼‚æ­¥è¯¦è§£</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/60606.html"><i class="fa  fa-book"></i> Djangoä½¿ç”¨SMTPå‘é€é‚®ä»¶æ•™ç¨‹</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/54938.html"><i class="fa  fa-book"></i> Djangoå­¦ä¹ ç¬”è®°-å®ç°èŠå¤©ç³»ç»Ÿ</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/65222.html"><i class="fa  fa-book"></i> Djangoã€Nginxã€uWSGIè¯¦è§£åŠé…ç½®ç¤ºä¾‹</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/60167.html"><i class="fa  fa-book"></i> Djangoå­¦ä¹ ç¬”è®°-å®ç°è”æœºå¯¹æˆ˜(ä¸‹)</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <li><a target="_blank" rel="nofollow" href="https://weibo.com/u/1952449115"><i class="fa fa-weibo"></i></a></li>
                        <li><a href="mailto:mail@1195595343@qq.com"><i class="fa fa-envelope"></i></a></li>
                        
                        
                        
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/AsanoSaki"><i class="fa fa-github"></i></a></li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 AsanoSaki Copyright.</li>
                            <li>This site is running<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by AsanoSaki.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.com/" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    


    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>