<!DOCTYPE html>
<html lang="zh-CN">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/favicon.ico">
  
  <title>Django学习笔记-实现联机对战（上） | AsanoSaki</title>
  
  <meta name="author" content="AsanoSaki" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="Python" />
  
  <meta name="description" content="Django学习笔记-实现联机对战（上）">
<meta property="og:type" content="article">
<meta property="og:title" content="Django学习笔记-实现联机对战（上）">
<meta property="og:url" content="https://asanosaki.github.io/posts/31494.html">
<meta property="og:site_name" content="AsanoSaki">
<meta property="og:description" content="Django学习笔记-实现联机对战（上）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://asanosaki.github.io/images/favicon.ico">
<meta property="article:published_time" content="2023-08-27T09:42:00.000Z">
<meta property="article:modified_time" content="2024-03-16T06:20:36.480Z">
<meta property="article:author" content="AsanoSaki">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://asanosaki.github.io/images/favicon.ico">
  <link rel="alternate" href="atom.xml" type="application/atom+xml">
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/light.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner2.jpg');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/opacity.png');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 5.4.2"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                        
                                            <li><a href="/"><i class="fa fa-home"></i>Home</a></li>
                                        
                                    
                                        
                                            <li><a href="/archives/"><i class="fa fa-file"></i>Archives</a></li>
                                        
                                    
                                        
                                            <li>
                                                <a><i class="fa fa-paw"></i>Friends</a>
                                                <ul class="sub-menu">
                                                    
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://angels-d.github.io">Angels-D</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="http://syh521.cn">SYH</a></li>
                                                        
                                                    
                                                </ul>
                                            </li>
                                        
                                    
                                        
                                            <li>
                                                <a><i class="fa fa-link"></i>My Links</a>
                                                <ul class="sub-menu">
                                                    
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://github.com/AsanoSaki">GitHub</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://gitee.com/asanosaki">Gitee</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://git.acwing.com/AsanoSaki">AcGit</a></li>
                                                        
                                                    
                                                        
                                                            <li><a href="https://asanosaki.github.io">BLOG</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://asanosaki.blog.csdn.net">CSDN</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://www.acwing.com/user/myspace/index/82581">AcWing</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/user/459347">LuoGu</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://codeforces.com/profile/AsanoSaki">CodeForces</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://leetcode.cn/u/asanosaki">LeetCode</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://space.bilibili.com/12300056">Bilibili</a></li>
                                                        
                                                    
                                                </ul>
                                            </li>
                                        
                                    
                                        
                                            <li>
                                                <a><i class="fa fa-heart"></i>Favorite</a>
                                                <ul class="sub-menu">
                                                    
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://www.runoob.com">Runoob</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://wallhaven.cc">Wallhaven</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="http://www.flysheep6.com">Flysheep</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://thrift.apache.org">Thrift</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN">MDN</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://v5.bootcss.com">Bootstrap</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://zh-hans.react.dev">React</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://www.nextjs.cn">Next.js</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://cn.vuejs.org">Vue.js</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/4.2">Django</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle">Spring Boot</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://hub.docker.com">Docker Hub</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://fontawesome.com.cn">Font Awesome</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://www.online-convert.com">File Convert</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://pytorch.org">PyTorch</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai">D2L</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://board.xcpcio.com">XCPC Board</a></li>
                                                        
                                                    
                                                        
                                                            <li><a target="_blank" rel="noopener" href="https://kr-demo.candinya.com/posts/Kratos-Rebirth-Manual">Kratos MNL</a></li>
                                                        
                                                    
                                                </ul>
                                            </li>
                                        
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">AsanoSaki</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>AsanoSaki</h2> <br />
                        <span>夏天的海边有冰淇淋口味的海风~</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://asanosaki.github.io/posts/31494.html">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">Django学习笔记-实现联机对战（上）</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-08-27T09:42:00.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-08-27</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> Author <span itemprop="name">AsanoSaki</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~35.48K
                        
                        words
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1710570036480"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
                <div class="kratos-post-inner-toc toc-div-class" >
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BB%9F%E4%B8%80%E9%95%BF%E5%BA%A6%E5%8D%95%E4%BD%8D"><span class="toc-text">1. 统一长度单位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A2%9E%E5%8A%A0%E8%81%94%E6%9C%BA%E5%AF%B9%E6%88%98%E6%A8%A1%E5%BC%8F"><span class="toc-text">2. 增加联机对战模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AEDjango-Channels"><span class="toc-text">3. 配置Django Channels</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%89%8D%E7%AB%AF%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5"><span class="toc-text">4. 前端创建连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%89%8D%E7%AB%AF%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="toc-text">5. 前端发送请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%BC%96%E5%86%99%E5%90%8C%E6%AD%A5%E5%87%BD%E6%95%B0create-player"><span class="toc-text">6. 编写同步函数create_player</span></a></li></ol>
                </div>
            
            <hr />
            <div itemprop="articleBody"><blockquote>
<p>本节内容是通过 Django Channels 框架使用 WebSocket 协议实现多人模式中的同步创建玩家函数。</p>
</blockquote>
<span id="more"></span>
<h2 id="1-统一长度单位">1. 统一长度单位</h2>
<p>多人模式中每个玩家所看到的地图相对来说应该是一样的，因此需要固定地图的长宽比，一般固定为16:9。我们需要在游戏窗口的长宽中取最小值，然后将地图渲染为16:9的大小。</p>
<p>我们在 <code>AcGamePlayground</code> 类中实现一个 <code>resize</code> 函数用于将长宽比调整为16:9并且达到最大：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AcGamePlayground</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">root</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">root</span> = root;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span> = $(<span class="string">`</span></span><br><span class="line"><span class="string">            &lt;div class=&#x27;ac_game_playground&#x27;&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        `</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">root</span>.<span class="property">$ac_game</span>.<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="property">$playground</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_random_color</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">hide</span>();  <span class="comment">// 初始化时需要先关闭playground界面</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        $(<span class="variable language_">window</span>).<span class="title function_">resize</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            outer.<span class="title function_">resize</span>();</span><br><span class="line">        &#125;);  <span class="comment">// 用户改变窗口大小时改函数会触发</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将长宽比调整为16:9</span></span><br><span class="line">    <span class="title function_">resize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">width</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">height</span>();</span><br><span class="line">        <span class="keyword">let</span> unit = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">width</span> / <span class="number">16</span>, <span class="variable language_">this</span>.<span class="property">height</span> / <span class="number">9</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">width</span> = unit * <span class="number">16</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">height</span> = unit * <span class="number">9</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scale</span> = <span class="variable language_">this</span>.<span class="property">height</span>;  <span class="comment">// 当窗口大小改变时所有目标的相对大小和位置也要改变</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">game_map</span>) <span class="variable language_">this</span>.<span class="property">game_map</span>.<span class="title function_">resize</span>();  <span class="comment">// 如果地图存在需要调用地图的resize函数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示playground界面</span></span><br><span class="line">    <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">show</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将界面的宽高先存下来</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">width</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">height</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">game_map</span> = <span class="keyword">new</span> <span class="title class_">GameMap</span>(<span class="variable language_">this</span>);  <span class="comment">// 创建游戏画面</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">resize</span>();  <span class="comment">// 界面打开后需要resize一次，需要将game_map也resize</span></span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭playground界面</span></span><br><span class="line">    <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">hide</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在需要将窗口大小的修改效果作用到黑色背景上，因此我们在 <code>GameMap</code> 类中也实现一个 <code>resize</code> 函数用于修改背景大小：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GameMap</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AcGameObject</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground</span>) &#123;  <span class="comment">// 需要将AcGamePlayground传进来</span></span><br><span class="line">        <span class="variable language_">super</span>();  <span class="comment">// 调用基类构造函数，相当于将自己添加到了AC_GAME_OBJECTS中</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span> = playground;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$canvas</span> = $(<span class="string">`&lt;canvas&gt;&lt;/canvas&gt;`</span>);  <span class="comment">// 画布，用来渲染画面</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span> = <span class="variable language_">this</span>.<span class="property">$canvas</span>[<span class="number">0</span>].<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);  <span class="comment">// 二维画布</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">width</span>;  <span class="comment">// 设置画布宽度</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">height</span>;  <span class="comment">// 设置画布高度</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">$playground</span>.<span class="title function_">append</span>(<span class="variable language_">this</span>.<span class="property">$canvas</span>);  <span class="comment">// 将画布添加到HTML中</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">resize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">width</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">height</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">fillStyle</span> = <span class="string">&#x27;rgba(0, 0, 0, 1)&#x27;</span>;  <span class="comment">// 每次调整大小后直接涂一层不透明的背景</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">width</span>, <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">height</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">render</span>();  <span class="comment">// 每一帧都要画一次</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">fillStyle</span> = <span class="string">&#x27;rgba(0, 0, 0, 0.2)&#x27;</span>;  <span class="comment">// 黑色背景</span></span><br><span class="line">        <span class="comment">// 左上角坐标(0, 0)，右下角坐标(w, h)</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">width</span>, <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="property">height</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们修改一下 <code>game.css</code> 文件，添加以下内容，实现将地图居中：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.ac_game_playground</span> &gt; <span class="selector-tag">canvas</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-<span class="number">50%</span>, -<span class="number">50%</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们还需要修改地图里面的目标，一共有三种分别是玩家、火球、被击中的粒子效果。</p>
<p>首先修改一下 <code>AcGamePlayground</code> 类中的玩家初始化代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AcGamePlayground</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">root</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_random_color</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将长宽比调整为16:9</span></span><br><span class="line">    <span class="title function_">resize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示playground界面</span></span><br><span class="line">    <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">show</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将界面的宽高先存下来</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">width</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">height</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">game_map</span> = <span class="keyword">new</span> <span class="title class_">GameMap</span>(<span class="variable language_">this</span>);  <span class="comment">// 创建游戏画面</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">resize</span>();  <span class="comment">// 界面打开后需要resize一次，需要将game_map也resize</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">players</span> = [];  <span class="comment">// 所有玩家</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">players</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">width</span> / <span class="number">2</span> / <span class="variable language_">this</span>.<span class="property">scale</span>, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="string">&#x27;white&#x27;</span>, <span class="number">0.15</span>, <span class="literal">true</span>));  <span class="comment">// 创建自己</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建敌人</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">players</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">width</span> / <span class="number">2</span> / <span class="variable language_">this</span>.<span class="property">scale</span>, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="variable language_">this</span>.<span class="title function_">get_random_color</span>(), <span class="number">0.15</span>, <span class="literal">false</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭playground界面</span></span><br><span class="line">    <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">hide</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们修改 <code>Player</code> 类，将所有绝对变量替换为相对变量：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AcGameObject</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground, x, y, radius, color, speed, is_me</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">eps</span> = <span class="number">0.01</span>;  <span class="comment">// 误差小于0.01认为是0</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_me</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">add_listening_events</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Math.random()返回一个0~1之间的数，随机初始化AI的位置</span></span><br><span class="line">            <span class="keyword">let</span> tx = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">width</span> / <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>;</span><br><span class="line">            <span class="keyword">let</span> ty = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">height</span> / <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">move_to</span>(tx, ty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">add_listening_events</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">game_map</span>.<span class="property">$canvas</span>.<span class="title function_">on</span>(<span class="string">&#x27;contextmenu&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;);  <span class="comment">// 取消右键的菜单功能</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">game_map</span>.<span class="property">$canvas</span>.<span class="title function_">mousedown</span>(<span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> rect = outer.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line">            <span class="keyword">if</span> (e.<span class="property">which</span> === <span class="number">3</span>) &#123;  <span class="comment">// 1表示左键，2表示滚轮，3表示右键</span></span><br><span class="line">                outer.<span class="title function_">move_to</span>((e.<span class="property">clientX</span> - rect.<span class="property">left</span>) / outer.<span class="property">playground</span>.<span class="property">scale</span>, (e.<span class="property">clientY</span> - rect.<span class="property">top</span>) / outer.<span class="property">playground</span>.<span class="property">scale</span>);  <span class="comment">// e.clientX/Y为鼠标点击坐标</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">which</span> === <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (outer.<span class="property">cur_skill</span> === <span class="string">&#x27;fireball&#x27;</span>) &#123;</span><br><span class="line">                    outer.<span class="title function_">shoot_fireball</span>((e.<span class="property">clientX</span> - rect.<span class="property">left</span>) / outer.<span class="property">playground</span>.<span class="property">scale</span>, (e.<span class="property">clientY</span> - rect.<span class="property">top</span>) / outer.<span class="property">playground</span>.<span class="property">scale</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                outer.<span class="property">cur_skill</span> = <span class="literal">null</span>;  <span class="comment">// 释放完一次技能后还原</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        $(<span class="variable language_">window</span>).<span class="title function_">keydown</span>(<span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.<span class="property">which</span> === <span class="number">81</span>) &#123;  <span class="comment">// Q键</span></span><br><span class="line">                outer.<span class="property">cur_skill</span> = <span class="string">&#x27;fireball&#x27;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算两点之间的欧几里得距离</span></span><br><span class="line">    <span class="title function_">get_dist</span>(<span class="params">x1, y1, x2, y2</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向(tx, ty)位置发射火球</span></span><br><span class="line">    <span class="title function_">shoot_fireball</span>(<span class="params">tx, ty</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> x = <span class="variable language_">this</span>.<span class="property">x</span>, y = <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">let</span> radius = <span class="number">0.01</span>;</span><br><span class="line">        <span class="keyword">let</span> theta = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(ty - <span class="variable language_">this</span>.<span class="property">y</span>, tx - <span class="variable language_">this</span>.<span class="property">x</span>);</span><br><span class="line">        <span class="keyword">let</span> vx = <span class="title class_">Math</span>.<span class="title function_">cos</span>(theta), vy = <span class="title class_">Math</span>.<span class="title function_">sin</span>(theta);</span><br><span class="line">        <span class="keyword">let</span> color = <span class="string">&#x27;orange&#x27;</span>;</span><br><span class="line">        <span class="keyword">let</span> speed = <span class="number">0.5</span>;</span><br><span class="line">        <span class="keyword">let</span> move_length = <span class="number">0.8</span>;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FireBall</span>(<span class="variable language_">this</span>.<span class="property">playground</span>, <span class="variable language_">this</span>, x, y, radius, vx, vy, color, speed, move_length, <span class="number">0.01</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">move_to</span>(<span class="params">tx, ty</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">is_attacked</span>(<span class="params">theta, damage</span>) &#123;  <span class="comment">// 被攻击到</span></span><br><span class="line">        <span class="comment">// 创建粒子效果</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> x = <span class="variable language_">this</span>.<span class="property">x</span>, y = <span class="variable language_">this</span>.<span class="property">y</span>;</span><br><span class="line">            <span class="keyword">let</span> radius = <span class="variable language_">this</span>.<span class="property">radius</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">0.2</span>;</span><br><span class="line">            <span class="keyword">let</span> theta = <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line">            <span class="keyword">let</span> vx = <span class="title class_">Math</span>.<span class="title function_">cos</span>(theta), vy = <span class="title class_">Math</span>.<span class="title function_">sin</span>(theta);</span><br><span class="line">            <span class="keyword">let</span> color = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">            <span class="keyword">let</span> speed = <span class="variable language_">this</span>.<span class="property">speed</span> * <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">let</span> move_length = <span class="variable language_">this</span>.<span class="property">radius</span> * <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Particle</span>(<span class="variable language_">this</span>.<span class="property">playground</span>, x, y, radius, vx, vy, color, speed, move_length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">radius</span> -= damage;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">speed</span> *= <span class="number">1.08</span>;  <span class="comment">// 血量越少移动越快</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">radius</span> &lt; <span class="variable language_">this</span>.<span class="property">eps</span>) &#123;  <span class="comment">// 半径小于eps认为已死</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">destroy</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">damage_vx</span> = <span class="title class_">Math</span>.<span class="title function_">cos</span>(theta);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">damage_vy</span> = <span class="title class_">Math</span>.<span class="title function_">sin</span>(theta);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">damage_speed</span> = damage * <span class="number">90</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新移动</span></span><br><span class="line">    <span class="title function_">update_move</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">spent_time</span> += <span class="variable language_">this</span>.<span class="property">timedelta</span> / <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">// AI敌人随机向玩家射击，游戏刚开始前三秒AI不能射击</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">spent_time</span> &gt; <span class="number">3</span> &amp;&amp; !<span class="variable language_">this</span>.<span class="property">is_me</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">random</span>() &lt; <span class="number">1</span> / <span class="number">360.0</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> player = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">players</span>[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">shoot_fireball</span>(player.<span class="property">x</span>, player.<span class="property">y</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">damage_speed</span> &gt; <span class="variable language_">this</span>.<span class="property">eps</span>) &#123;  <span class="comment">// 有击退效果时玩家无法移动</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">vx</span> = <span class="variable language_">this</span>.<span class="property">vy</span> = <span class="number">0</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">move_length</span> = <span class="number">0</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">x</span> += <span class="variable language_">this</span>.<span class="property">damage_vx</span> * <span class="variable language_">this</span>.<span class="property">damage_speed</span> * <span class="variable language_">this</span>.<span class="property">timedelta</span> / <span class="number">1000</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">y</span> += <span class="variable language_">this</span>.<span class="property">damage_vy</span> * <span class="variable language_">this</span>.<span class="property">damage_speed</span> * <span class="variable language_">this</span>.<span class="property">timedelta</span> / <span class="number">1000</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">damage_speed</span> *= <span class="variable language_">this</span>.<span class="property">friction</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">move_length</span> &lt; <span class="variable language_">this</span>.<span class="property">eps</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">move_length</span> = <span class="number">0</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">vx</span> = <span class="variable language_">this</span>.<span class="property">vy</span> = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">is_me</span>) &#123;  <span class="comment">// AI敌人不能停下来</span></span><br><span class="line">                    <span class="keyword">let</span> tx = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">width</span> / <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>;</span><br><span class="line">                    <span class="keyword">let</span> ty = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">height</span> / <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">move_to</span>(tx, ty);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 计算真实移动距离，与一帧的移动距离取min防止移出界</span></span><br><span class="line">                <span class="keyword">let</span> true_move = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">move_length</span>, <span class="variable language_">this</span>.<span class="property">speed</span> * <span class="variable language_">this</span>.<span class="property">timedelta</span> / <span class="number">1000</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">x</span> += <span class="variable language_">this</span>.<span class="property">vx</span> * true_move;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">y</span> += <span class="variable language_">this</span>.<span class="property">vy</span> * true_move;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">move_length</span> -= true_move;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">update_move</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> scale = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>;  <span class="comment">// 要将相对值恢复成绝对值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is_me</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">save</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">beginPath</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span> * scale, <span class="variable language_">this</span>.<span class="property">y</span> * scale, <span class="variable language_">this</span>.<span class="property">radius</span> * scale, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">stroke</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">clip</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">drawImage</span>(<span class="variable language_">this</span>.<span class="property">img</span>, (<span class="variable language_">this</span>.<span class="property">x</span> - <span class="variable language_">this</span>.<span class="property">radius</span>) * scale, (<span class="variable language_">this</span>.<span class="property">y</span> - <span class="variable language_">this</span>.<span class="property">radius</span>) * scale, <span class="variable language_">this</span>.<span class="property">radius</span> * <span class="number">2</span> * scale, <span class="variable language_">this</span>.<span class="property">radius</span> * <span class="number">2</span> * scale);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">restore</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  <span class="comment">// AI</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">beginPath</span>();</span><br><span class="line">            <span class="comment">// 角度从0画到2PI，是否逆时针为false</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span> * scale, <span class="variable language_">this</span>.<span class="property">y</span> * scale, <span class="variable language_">this</span>.<span class="property">radius</span> * scale, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">fill</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后修改 <code>FireBall</code> 类，只需要修改 <code>eps</code> 以及 <code>render</code> 函数即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FireBall</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AcGameObject</span> &#123;</span><br><span class="line">    <span class="comment">// 火球需要标记是哪个玩家发射的，且射出后的速度方向与大小是固定的，射程为move_length</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground, player, x, y, radius, vx, vy, color, speed, move_length, damage</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">eps</span> = <span class="number">0.01</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_dist</span>(<span class="params">x1, y1, x2, y2</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">is_collision</span>(<span class="params">player</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">attack</span>(<span class="params">player</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> scale = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">beginPath</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span> * scale, <span class="variable language_">this</span>.<span class="property">y</span> * scale, <span class="variable language_">this</span>.<span class="property">radius</span> * scale, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">fill</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后修改 <code>Particle</code> 类，同样也是只需要修改 <code>eps</code> 以及 <code>render</code> 函数即可：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Particle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AcGameObject</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground, x, y, radius, vx, vy, color, speed, move_length</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">eps</span> = <span class="number">0.01</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">friction</span> = <span class="number">0.9</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> scale = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">beginPath</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">arc</span>(<span class="variable language_">this</span>.<span class="property">x</span> * scale, <span class="variable language_">this</span>.<span class="property">y</span> * scale, <span class="variable language_">this</span>.<span class="property">radius</span> * scale, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">2</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">fillStyle</span> = <span class="variable language_">this</span>.<span class="property">color</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">fill</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-增加联机对战模式">2. 增加联机对战模式</h2>
<p>我们先修改 <code>AcGameMenu</code> 类，实现多人模式按钮的逻辑：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AcGameMenu</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">root</span>) &#123;  <span class="comment">// root用来传AcGame对象</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">hide</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">add_listening_events</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给按钮绑定监听函数</span></span><br><span class="line">    <span class="title function_">add_listening_events</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="comment">// 注意在function中调用this指的是function本身，因此需要先将外面的this存起来</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$single</span>.<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            outer.<span class="title function_">hide</span>();  <span class="comment">// 关闭menu界面</span></span><br><span class="line">            outer.<span class="property">root</span>.<span class="property">playground</span>.<span class="title function_">show</span>(<span class="string">&#x27;single mode&#x27;</span>);  <span class="comment">// 显示playground界面，加入参数用于区分</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$multi</span>.<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            outer.<span class="title function_">hide</span>();</span><br><span class="line">            outer.<span class="property">root</span>.<span class="property">playground</span>.<span class="title function_">show</span>(<span class="string">&#x27;multi mode&#x27;</span>);  <span class="comment">// 多人模式</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$settings</span>.<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            outer.<span class="property">root</span>.<span class="property">settings</span>.<span class="title function_">logout_on_remote</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示menu界面</span></span><br><span class="line">    <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$menu</span>.<span class="title function_">show</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭menu界面</span></span><br><span class="line">    <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$menu</span>.<span class="title function_">hide</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后修改 <code>AcGamePlayground</code> 类，区分两种模式，且需要进一步区分玩家类别，之前使用 True/False 表示是否是玩家本人，现在可以用字符串区分玩家本人（<code>me</code>）、其他玩家（<code>enemy</code>）以及人机（<code>robot</code>）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AcGamePlayground</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">root</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_random_color</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将长宽比调整为16:9</span></span><br><span class="line">    <span class="title function_">resize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示playground界面</span></span><br><span class="line">    <span class="title function_">show</span>(<span class="params">mode</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">show</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将界面的宽高先存下来</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">width</span> = <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">width</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">height</span> = <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">height</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">game_map</span> = <span class="keyword">new</span> <span class="title class_">GameMap</span>(<span class="variable language_">this</span>);  <span class="comment">// 创建游戏画面</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">resize</span>();  <span class="comment">// 界面打开后需要resize一次，需要将game_map也resize</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">players</span> = [];  <span class="comment">// 所有玩家</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">players</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">width</span> / <span class="number">2</span> / <span class="variable language_">this</span>.<span class="property">scale</span>, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="string">&#x27;white&#x27;</span>, <span class="number">0.15</span>, <span class="string">&#x27;me&#x27;</span>, <span class="variable language_">this</span>.<span class="property">root</span>.<span class="property">settings</span>.<span class="property">username</span>, <span class="variable language_">this</span>.<span class="property">root</span>.<span class="property">settings</span>.<span class="property">avatar</span>));  <span class="comment">// 创建自己，自己的用户名和头像从settings中获得</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单人模式下创建AI敌人</span></span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="string">&#x27;single mode&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">players</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">width</span> / <span class="number">2</span> / <span class="variable language_">this</span>.<span class="property">scale</span>, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="variable language_">this</span>.<span class="title function_">get_random_color</span>(), <span class="number">0.15</span>, <span class="string">&#x27;robot&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭playground界面</span></span><br><span class="line">    <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">hide</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后还需要修改一下 <code>Player</code> 类，将原本的 <code>this.is_me</code> 判断进行修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AcGameObject</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground, x, y, radius, color, speed, character, username, avatar</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">character</span> = character;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">username</span> = username;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">avatar</span> = avatar;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">character</span> !== <span class="string">&#x27;robot&#x27;</span>) &#123;  <span class="comment">// 只有AI不用渲染图片</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">img</span> = <span class="keyword">new</span> <span class="title class_">Image</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">img</span>.<span class="property">src</span> = <span class="variable language_">this</span>.<span class="property">avatar</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">character</span> === <span class="string">&#x27;me&#x27;</span>) &#123;  <span class="comment">// 只给自己添加监听函数</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">add_listening_events</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">character</span> === <span class="string">&#x27;robot&#x27;</span>) &#123;  <span class="comment">// 机器人才会随机动</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">add_listening_events</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算两点之间的欧几里得距离</span></span><br><span class="line">    <span class="title function_">get_dist</span>(<span class="params">x1, y1, x2, y2</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向(tx, ty)位置发射火球</span></span><br><span class="line">    <span class="title function_">shoot_fireball</span>(<span class="params">tx, ty</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">move_to</span>(<span class="params">tx, ty</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">is_attacked</span>(<span class="params">theta, damage</span>) &#123;  <span class="comment">// 被攻击到</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新移动</span></span><br><span class="line">    <span class="title function_">update_move</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">spent_time</span> += <span class="variable language_">this</span>.<span class="property">timedelta</span> / <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">// AI敌人随机向玩家射击，游戏刚开始前三秒AI不能射击</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">character</span> === <span class="string">&#x27;robot&#x27;</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">spent_time</span> &gt; <span class="number">3</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">random</span>() &lt; <span class="number">1</span> / <span class="number">360.0</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">damage_speed</span> &gt; <span class="variable language_">this</span>.<span class="property">eps</span>) &#123;  <span class="comment">// 有击退效果时玩家无法移动</span></span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">move_length</span> &lt; <span class="variable language_">this</span>.<span class="property">eps</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">character</span> === <span class="string">&#x27;robot&#x27;</span>) &#123;  <span class="comment">// AI敌人不能停下来</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 计算真实移动距离，与一帧的移动距离取min防止移出界</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">update_move</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">render</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> scale = <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>;  <span class="comment">// 要将相对值恢复成绝对值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">character</span> !== <span class="string">&#x27;robot&#x27;</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  <span class="comment">// AI</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-配置Django-Channels">3. 配置Django Channels</h2>
<p>假设有三名玩家编号为1、2、3进行多人游戏，那么每个玩家都有自己的一个窗口，且窗口中都能看到三名玩家。如果当前玩家1、2在进行游戏，3加入了游戏，那么需要告诉1、2两名玩家3来了，且还要告诉3当前已经有玩家1、2了。</p>
<p>要实现这一点，可以通过一个<strong>中心服务器 Server</strong>（可以就是自己租的云服务器），即3向服务器发送他来了，服务器给1、2发送消息，且服务器给3发送消息说之前已经有1、2两名玩家了。因此服务器中需要存储每个地图中的玩家信息，用于完成第一个同步事件：生成玩家事件。</p>
<p>我们之后一共需要实现四个同步函数：<code>create_player</code>、<code>move_to</code>、<code>shoot_fireball</code>、<code>attack</code>。前三个函数顾名思义，最后的 <code>attack</code> 函数是因为服务器存在延迟，比如3发射一个火球在本地看打中了1，但是由于延迟在1那边可能是没被打中的。</p>
<p>攻击判断是一个权衡问题，一般的游戏都是选择在本地进行攻击判断，而不是云服务器，即以发起攻击的玩家窗口进行判断，如果击中了则通过 <code>attack</code> 函数在服务器上广播信息。</p>
<p>在此之前我们使用的是 HTTP 协议，该协议为单向的，即客户端需要先向服务器请求信息后服务器才会返回信息，而服务器是不会主动向客户端发送信息的。</p>
<p>因此此处我们需要使用 WebSocket 协议（WS），同理该协议也有对应的加密协议 WSS，Django Channels 即为 Django 支持 WSS 协议的一种实现方式。</p>
<p>（1）安装 <code>channels_redis</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install channels_redis</span><br></pre></td></tr></table></figure>
<p>（2）配置 <code>djangoapp/djangoapp/asgi.py</code> 文件：</p>
<p>文件内容如下（注意 <code>djangoapp</code> 需要改成自己项目的名称）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> channels.auth <span class="keyword">import</span> AuthMiddlewareStack</span><br><span class="line"><span class="keyword">from</span> channels.routing <span class="keyword">import</span> ProtocolTypeRouter, URLRouter</span><br><span class="line"><span class="keyword">from</span> django.core.asgi <span class="keyword">import</span> get_asgi_application</span><br><span class="line"><span class="keyword">from</span> game.routing <span class="keyword">import</span> websocket_urlpatterns</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="string">&#x27;djangoapp.settings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">application = ProtocolTypeRouter(&#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: get_asgi_application(),</span><br><span class="line">    <span class="string">&quot;websocket&quot;</span>: AuthMiddlewareStack(URLRouter(websocket_urlpatterns))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>（3）配置 <code>djangoapp/djangoapp/settings.py</code> 文件：</p>
<p>在 <code>INSTALLED_APPS</code> 中添加 <code>channels</code>，添加后如下所示（注意 <code>djangoapp</code> 需要改成自己项目的名称）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [ </span><br><span class="line">    <span class="string">&#x27;channels&#x27;</span>,  <span class="comment"># 添加此行</span></span><br><span class="line">    <span class="string">&#x27;game.apps.GameConfig&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>然后在文件末尾添加：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ASGI_APPLICATION = <span class="string">&#x27;djangoapp.asgi.application&#x27;</span></span><br><span class="line">CHANNEL_LAYERS = &#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;channels_redis.core.RedisChannelLayer&quot;</span>,</span><br><span class="line">        <span class="string">&quot;CONFIG&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;hosts&quot;</span>: [(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>)],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）配置 <code>game/routing.py</code> 文件：</p>
<p>这一部分的作用相当于 HTTP 的 <code>urls</code>，文件内容如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">websocket_urlpatterns = [</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>（5）编写 <code>game/consumers</code>，这一部分的作用相当于 HTTP 的 <code>views</code>。</p>
<p>在 <code>game</code> 目录下创建 <code>consumers</code> 目录，然后进入该目录，先创建好 <code>__init__.py</code> 文件。由于我们未来会使用 WSS 协议支持联机对战和聊天室，因此我们需要再创建两个目录，先创建 <code>multiplayer</code> 目录，进入该目录创建 <code>__init__.py</code> 文件，然后编写 <code>index.py</code>：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> channels.generic.websocket <span class="keyword">import</span> AsyncWebsocketConsumer</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlayer</span>(<span class="title class_ inherited__">AsyncWebsocketConsumer</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">await</span> self.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;accept&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.room_name = <span class="string">&quot;room&quot;</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_add(self.room_name, self.channel_name)  <span class="comment"># 将当前连接加到组里</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">disconnect</span>(<span class="params">self, close_code</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">receive</span>(<span class="params">self, text_data</span>):</span><br><span class="line">        data = json.loads(text_data)</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br></pre></td></tr></table></figure>
<p>（6）启动 <code>django_channels</code>：</p>
<p>首先安装 <code>daphne</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install daphne</span><br></pre></td></tr></table></figure>
<p>输入 <code>daphne</code> 查看是否可用，如果不可用说明应该是没有配置环境变量，按如下方式修改环境变量（需要重启系统）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/environment</span><br><span class="line">在 PATH=&#x27;xxx&#x27; 后面添加 &#x27;:/home/&lt;用户名&gt;/.local/bin&#x27;</span><br><span class="line">即: &#x27;xxx:/home/&lt;用户名&gt;/.local/bin&#x27;</span><br><span class="line"></span><br><span class="line">source /etc/environment  # 应用更新</span><br></pre></td></tr></table></figure>
<p>HTTP 有 <code>uwsgi</code> 启动服务，WS 同样也需要启动，使用的是 <code>asgi</code>，在 <code>~/djangoapp</code> 目录下执行（注意 <code>djangoapp</code> 需要改成自己项目的名称）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daphne -b 0.0.0.0 -p 5015 djangoapp.asgi:application</span><br></pre></td></tr></table></figure>
<p>项目进行到这里已经需要启动多个服务了，顺序是：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NginX: sudo /etc/init.d/nginx start</span><br><span class="line">Redis-server: sudo redis-server /etc/redis/redis.conf</span><br><span class="line">uWSGI: uwsgi --ini scripts/uwsgi.ini</span><br><span class="line">Django_channels: daphne -b 0.0.0.0 -p 5015 djangoapp.asgi:application</span><br></pre></td></tr></table></figure>
<h2 id="4-前端创建连接">4. 前端创建连接</h2>
<p>前端（Playground）需要跟后端（WS）连接，我们需要在每个客户端中建立一个和服务器的连接，一般是使用 <strong>Web Socket</strong> 连接。</p>
<p>首先配置一下 <code>/djangoapp/game</code> 目录下的路由 <code>routing.py</code>：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> game.consumers.multiplayer.index <span class="keyword">import</span> MultiPlayer</span><br><span class="line"></span><br><span class="line">websocket_urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;wss/multiplayer/&#x27;</span>, MultiPlayer.as_asgi(), name=<span class="string">&#x27;wss_multiplayer&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>我们在 <code>/djangoapp/game/static/js/src/playground</code> 目录下创建 <code>socket</code> 目录，Socket 也分为两个模块，分别为联机模式和聊天室，还是先实现联机模式，在 <code>socket</code> 目录中创建 <code>multiplayer</code> 目录，进入该目录后创建 <code>zbase.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlayerSocket</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span> = playground;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当前端创建连接，即执行 <code>new WebSocket</code> 时，会调用 <code>consumers</code> 的 <code>MultiPlayer</code> 类（之后直接称为 <code>MultiPlayer</code>）中的 <code>connect</code> 函数；当前端断开连接（刷新或者关闭页面）时，会调用 <code>disconnect</code> 函数；<code>receive</code> 函数用于接收前端向后端发送的请求。</p>
<p>由于服务器需要向多个客户端群发消息，Django Channels 中有一个概念叫做组（group），可以将多个不同的连接放到同一个组里，可以使用相关函数统一操作组里的连接，例如 <code>group_send</code> 群发消息。</p>
<p>现在在 <code>AcGamePlayground</code> 类中添加我们刚实现的 <code>MultiPlayerSocket</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AcGamePlayground</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">root</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_random_color</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将长宽比调整为16:9</span></span><br><span class="line">    <span class="title function_">resize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示playground界面</span></span><br><span class="line">    <span class="title function_">show</span>(<span class="params">mode</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单人模式下创建AI敌人</span></span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="string">&#x27;single mode&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">players</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">width</span> / <span class="number">2</span> / <span class="variable language_">this</span>.<span class="property">scale</span>, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="variable language_">this</span>.<span class="title function_">get_random_color</span>(), <span class="number">0.15</span>, <span class="string">&#x27;robot&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span> = <span class="keyword">new</span> <span class="title class_">MultiPlayerSocket</span>(<span class="variable language_">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭playground界面</span></span><br><span class="line">    <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">hide</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们打包静态文件并同步到发行版本，复习一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/djangoapp</span><br><span class="line">./scripts/compress_game_js.sh</span><br><span class="line">python3 manage.py collectstatic</span><br></pre></td></tr></table></figure>
<p>重启一下服务，现在我们每次都需要重启两个服务，即 HTTPS 和 WSS：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uwsgi --ini scripts/uwsgi.ini</span><br><span class="line">daphne -b 0.0.0.0 -p 5015 djangoapp.asgi:application</span><br></pre></td></tr></table></figure>
<p>打开游戏进入多人模式，即可在后端的 WSS 服务看到输出信息。</p>
<h2 id="5-前端发送请求">5. 前端发送请求</h2>
<p>有玩家进来时，需要两个函数，一个是实现客户端向服务器发送 <code>create_player</code> 请求，另一个是实现服务器从客户端接收请求的功能。</p>
<p>先实现发送请求功能，在 <code>MultiPlayerSocket</code> 类中编写 <code>send_create_player</code> 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlayerSocket</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span> = playground;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">send_create_player</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// stringify可以将JSON变为字符串</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;hello world!&#x27;</span></span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive_create_player</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>AcGamePlayground</code> 类中调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AcGamePlayground</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">root</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_random_color</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将长宽比调整为16:9</span></span><br><span class="line">    <span class="title function_">resize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示playground界面</span></span><br><span class="line">    <span class="title function_">show</span>(<span class="params">mode</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单人模式下创建AI敌人</span></span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="string">&#x27;single mode&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">players</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">width</span> / <span class="number">2</span> / <span class="variable language_">this</span>.<span class="property">scale</span>, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="variable language_">this</span>.<span class="title function_">get_random_color</span>(), <span class="number">0.15</span>, <span class="string">&#x27;robot&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span> = <span class="keyword">new</span> <span class="title class_">MultiPlayerSocket</span>(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span>.<span class="property">ws</span>.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                outer.<span class="property">mps</span>.<span class="title function_">send_create_player</span>();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭playground界面</span></span><br><span class="line">    <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">hide</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有修改过后端代码，因此不需要重启服务，直接重新打包一下静态文件即可，然后进入多人模式即可看到后端的输出信息，说明现在连接就已经创建成功了。</p>
<h2 id="6-编写同步函数create-player">6. 编写同步函数create_player</h2>
<p>我们每一个地图的所有信息都会有一个备份，比如1号玩家在2、3号窗口都会有一个备份，在不同的地图里我们需要能够判断出来谁是谁，比如在1号窗口中玩家1击中了玩家2，那么把信息发送到第二个窗口后，需要知道谁是2。</p>
<p>因此我们需要给所有信息一个唯一的编号（可以使用一个随机的八位数，如果怕重复可以使用更多位数），使得我们未来知道需要同步哪些东西。在 <code>AcGameObject</code> 类中进行修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable constant_">AC_GAME_OBJECTS</span> = [];  <span class="comment">// 将所有对象加到一个全局数组里，之后可以遍历每个对象刷新一次</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AcGameObject</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable constant_">AC_GAME_OBJECTS</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">has_called_start</span> = <span class="literal">false</span>;  <span class="comment">// 是否执行过start函数</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">timedelta</span> = <span class="number">0</span>;  <span class="comment">// 当前帧距离上一帧的时间间隔，因为如果用帧来衡量的话不同浏览器可能帧数不一样会导致不同的效果</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uuid</span> = <span class="variable language_">this</span>.<span class="title function_">create_uuid</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">create_uuid</span>(<span class="params"></span>) &#123;  <span class="comment">// 创建唯一编号</span></span><br><span class="line">        <span class="keyword">let</span> res = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">let</span> x = <span class="built_in">parseInt</span>(<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span>));  <span class="comment">// Math.random()返回[0, 1)之间的数</span></span><br><span class="line">            res += x;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;  <span class="comment">// 只会在第一帧执行一次</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">update</span>(<span class="params"></span>) &#123;  <span class="comment">// 每一帧都会执行一次</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">on_destroy</span>(<span class="params"></span>) &#123;  <span class="comment">// 在被删除前执行一次</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">destroy</span>(<span class="params"></span>) &#123;  <span class="comment">// 删掉该对象</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> last_timestamp;  <span class="comment">// 上一帧的时间戳</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable constant_">AC_GAME_ANIMATION</span> = <span class="keyword">function</span>(<span class="params">timestamp</span>) &#123;  <span class="comment">// timestamp表示在哪个时刻调用的这个函数</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">requestAnimationFrame</span>(<span class="variable constant_">AC_GAME_ANIMATION</span>);</span><br></pre></td></tr></table></figure>
<p>现在又有一个问题，每次有一名新玩家进入时都会创建若干个编号，但是和之前其它窗口中的编号不一致，我们需要用通信的方式将他们保持一致，原则为<strong>谁创建的对象就用谁那边产生的编号</strong>，比如1号窗口创建了1号玩家，那么其它玩家窗口中的1号玩家的编号就由1号窗口发送过来。</p>
<p>由于某个客户端（假设是1号窗口）向服务器发送消息后服务器会转播给<strong>所有</strong>客户端，也就是会发给自己（1号窗口），这种情况1号窗口应该要 Pass 掉这条信息，因此我们需要<strong>判断信息是哪个客户端发的</strong>。这边我们就可以用<strong>每个玩家的唯一编号</strong>，这样就可以保证每个窗口不一样，我们在 <code>AcGamePlayground</code> 中修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AcGamePlayground</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">root</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_random_color</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将长宽比调整为16:9</span></span><br><span class="line">    <span class="title function_">resize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示playground界面</span></span><br><span class="line">    <span class="title function_">show</span>(<span class="params">mode</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单人模式下创建AI敌人</span></span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="string">&#x27;single mode&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">players</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Player</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">width</span> / <span class="number">2</span> / <span class="variable language_">this</span>.<span class="property">scale</span>, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="variable language_">this</span>.<span class="title function_">get_random_color</span>(), <span class="number">0.15</span>, <span class="string">&#x27;robot&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span> = <span class="keyword">new</span> <span class="title class_">MultiPlayerSocket</span>(<span class="variable language_">this</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span>.<span class="property">uuid</span> = <span class="variable language_">this</span>.<span class="property">players</span>[<span class="number">0</span>].<span class="property">uuid</span>;  <span class="comment">// 用每名玩家的唯一编号区分不同的窗口</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span>.<span class="property">ws</span>.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                outer.<span class="property">mps</span>.<span class="title function_">send_create_player</span>();</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭playground界面</span></span><br><span class="line">    <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">hide</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在客户端向服务器端发送消息的时候就要带上自己的 <code>uuid</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlayerSocket</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span> = playground;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">send_create_player</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="comment">// stringify可以将JSON变为字符串</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;create_player&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.<span class="property">uuid</span>,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive_create_player</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在再测试一下即可在后端看到服务器接收到的客户端信息。</p>
<p>接下来我们需要同步 <code>create_player</code> 这个事件，即当有新玩家来的时候，在所有窗口里创建这个玩家，同时将已有的玩家渲染到当前窗口里。</p>
<p>首先我们需要在服务器端存下每一个游戏房间的信息，可以存在 Redis 里，我们可以用房间（room）的概念。每个房间有人数上限，这是一个通用配置，可以写在 <code>settings.py</code> 里，我们往该文件里添加一行：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROOM_CAPACITY = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>然后修改后端文件（<code>/djangoapp/game/consumers/multiplayer</code> 目录中的 <code>index.py</code>）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> channels.generic.websocket <span class="keyword">import</span> AsyncWebsocketConsumer</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlayer</span>(<span class="title class_ inherited__">AsyncWebsocketConsumer</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        self.room_name = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):  <span class="comment"># 假设暂定最多1000个房间</span></span><br><span class="line">            name = <span class="string">&#x27;room-%d&#x27;</span> % (i)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(name) <span class="keyword">or</span> <span class="built_in">len</span>(cache.get(name)) &lt; settings.ROOM_CAPACITY:  <span class="comment"># 判断当前房间是否可用</span></span><br><span class="line">                self.room_name = name</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.room_name:  <span class="comment"># 房间不足</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> self.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;accept&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(self.room_name):  <span class="comment"># 如果没有该房间需要创建房间</span></span><br><span class="line">            cache.<span class="built_in">set</span>(self.room_name, [], <span class="number">3600</span>)  <span class="comment"># 每局时长设置为1小时</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> player <span class="keyword">in</span> cache.get(self.room_name):  <span class="comment"># 发送房间所有玩家的信息到当前的本地客户端</span></span><br><span class="line">            <span class="keyword">await</span> self.send(text_data=json.dumps(&#123;  <span class="comment"># dumps将字典变为字符串</span></span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;create_player&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: player[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: player[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;avatar&#x27;</span>: player[<span class="string">&#x27;avatar&#x27;</span>],</span><br><span class="line">            &#125;))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_add(self.room_name, self.channel_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">disconnect</span>(<span class="params">self, close_code</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">receive</span>(<span class="params">self, text_data</span>):</span><br><span class="line">        data = json.loads(text_data)</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br></pre></td></tr></table></figure>
<p>现在我们需要在 <code>AcGamePlayground</code> 中传送用户名和头像参数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AcGamePlayground</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">root</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_random_color</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将长宽比调整为16:9</span></span><br><span class="line">    <span class="title function_">resize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示playground界面</span></span><br><span class="line">    <span class="title function_">show</span>(<span class="params">mode</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 单人模式下创建AI敌人</span></span><br><span class="line">        <span class="keyword">if</span> (mode === <span class="string">&#x27;single mode&#x27;</span>)&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode === <span class="string">&#x27;multi mode&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span> = <span class="keyword">new</span> <span class="title class_">MultiPlayerSocket</span>(<span class="variable language_">this</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span>.<span class="property">uuid</span> = <span class="variable language_">this</span>.<span class="property">players</span>[<span class="number">0</span>].<span class="property">uuid</span>;  <span class="comment">// 用每名玩家的唯一编号区分不同的窗口</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mps</span>.<span class="property">ws</span>.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                outer.<span class="property">mps</span>.<span class="title function_">send_create_player</span>(outer.<span class="property">root</span>.<span class="property">settings</span>.<span class="property">username</span>, outer.<span class="property">root</span>.<span class="property">settings</span>.<span class="property">avatar</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭playground界面</span></span><br><span class="line">    <span class="title function_">hide</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$playground</span>.<span class="title function_">hide</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 <code>MultiPlayerSocket</code> 中接收信息并向服务器后端发送请求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlayerSocket</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span> = playground;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">send_create_player</span>(<span class="params">username, avatar</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="comment">// stringify可以将JSON变为字符串</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;  <span class="comment">// 向后台发送请求</span></span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;create_player&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.<span class="property">uuid</span>,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">            <span class="string">&#x27;avatar&#x27;</span>: avatar,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive_create_player</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在编写后端接收到信息后的处理逻辑，接收到创建玩家的信息后需要将该玩家添加到房间中，并给房间中其他连接群发消息，组内各个连接接收到消息后再发送给前端即可：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> channels.generic.websocket <span class="keyword">import</span> AsyncWebsocketConsumer</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlayer</span>(<span class="title class_ inherited__">AsyncWebsocketConsumer</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        self.room_name = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):  <span class="comment"># 假设暂定最多1000个房间</span></span><br><span class="line">            name = <span class="string">&#x27;room-%d&#x27;</span> % (i)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(name) <span class="keyword">or</span> <span class="built_in">len</span>(cache.get(name)) &lt; settings.ROOM_CAPACITY:  <span class="comment"># 判断当前房间是否可用</span></span><br><span class="line">                self.room_name = name</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.room_name:  <span class="comment"># 房间不足</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> self.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;accept&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cache.has_key(self.room_name):  <span class="comment"># 如果没有该房间需要创建房间</span></span><br><span class="line">            cache.<span class="built_in">set</span>(self.room_name, [], <span class="number">3600</span>)  <span class="comment"># 每局时长设置为1小时</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> player <span class="keyword">in</span> cache.get(self.room_name):  <span class="comment"># 发送房间所有玩家的信息到当前的本地客户端</span></span><br><span class="line">            <span class="keyword">await</span> self.send(text_data=json.dumps(&#123;  <span class="comment"># dumps将字典变为字符串</span></span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;create_player&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: player[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: player[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;avatar&#x27;</span>: player[<span class="string">&#x27;avatar&#x27;</span>],</span><br><span class="line">            &#125;))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_add(self.room_name, self.channel_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">disconnect</span>(<span class="params">self, close_code</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_discard(self.room_name, self.channel_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_player</span>(<span class="params">self, data</span>):  <span class="comment"># async表示异步函数</span></span><br><span class="line">        players = cache.get(self.room_name)  <span class="comment"># 获得房间信息</span></span><br><span class="line">        players.append(&#123;  <span class="comment"># 将当前玩家添加到房间里</span></span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: data[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;avatar&#x27;</span>: data[<span class="string">&#x27;avatar&#x27;</span>],</span><br><span class="line">        &#125;)</span><br><span class="line">        cache.<span class="built_in">set</span>(self.room_name, players, <span class="number">3600</span>)  <span class="comment"># 存入Redis</span></span><br><span class="line">        <span class="keyword">await</span> self.channel_layer.group_send(  <span class="comment"># 群发消息，有两个参数，一个是room_name，一个是需要发送的信息</span></span><br><span class="line">            self.room_name,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;group_send_event&#x27;</span>,  <span class="comment"># 很重要，表示将消息发送给组内的所有人，接收消息的函数就是type</span></span><br><span class="line">                <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;create_player&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;uuid&#x27;</span>: data[<span class="string">&#x27;uuid&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: data[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;avatar&#x27;</span>: data[<span class="string">&#x27;avatar&#x27;</span>],</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">group_send_event</span>(<span class="params">self, data</span>):  <span class="comment"># 组内的每个连接接收到消息后直接发给前端即可</span></span><br><span class="line">        <span class="keyword">await</span> self.send(text_data=json.dumps(data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">receive</span>(<span class="params">self, text_data</span>):</span><br><span class="line">        data = json.loads(text_data)</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line">        event = data[<span class="string">&#x27;event&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> event == <span class="string">&#x27;create_player&#x27;</span>:  <span class="comment"># 做一个路由</span></span><br><span class="line">            <span class="keyword">await</span> self.create_player(data)</span><br></pre></td></tr></table></figure>
<p>现在我们需要在前端处理接收 WSS 协议的信息，修改一下 <code>MultiPlayerSocket</code> 类：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiPlayerSocket</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">playground</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span> = playground;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直接将网站链接复制过来，将https改成wss，如果没有配置https那就改成ws，然后最后加上wss的路由</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;wss://app4007.acapp.acwing.com.cn/wss/multiplayer/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">receive</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span>.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(e.<span class="property">data</span>);  <span class="comment">// 将字符串变回JSON</span></span><br><span class="line">            <span class="keyword">let</span> uuid = data.<span class="property">uuid</span>;</span><br><span class="line">            <span class="keyword">if</span> (uuid === outer.<span class="property">uuid</span>) <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 如果是给自己发送消息就直接过滤掉</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> event = data.<span class="property">event</span>;</span><br><span class="line">            <span class="keyword">if</span> (event === <span class="string">&#x27;create_player&#x27;</span>) &#123;</span><br><span class="line">                outer.<span class="title function_">receive_create_player</span>(uuid, data.<span class="property">username</span>, data.<span class="property">avatar</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">send_create_player</span>(<span class="params">username, avatar</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> outer = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="comment">// stringify可以将JSON变为字符串</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;  <span class="comment">// 向后台发送请求</span></span><br><span class="line">            <span class="string">&#x27;event&#x27;</span>: <span class="string">&#x27;create_player&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;uuid&#x27;</span>: outer.<span class="property">uuid</span>,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">            <span class="string">&#x27;avatar&#x27;</span>: avatar,</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive_create_player</span>(<span class="params">uuid, username, avatar</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> player = <span class="keyword">new</span> <span class="title class_">Player</span>(<span class="variable language_">this</span>.<span class="property">playground</span>, <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">width</span> / <span class="number">2</span> / <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">scale</span>, <span class="number">0.5</span>, <span class="number">0.05</span>, <span class="string">&#x27;white&#x27;</span>, <span class="number">0.15</span>, <span class="string">&#x27;enemy&#x27;</span>, username, avatar);</span><br><span class="line">        player.<span class="property">uuid</span> = uuid;  <span class="comment">// 每个Player的uuid为创建他的窗口的uuid</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playground</span>.<span class="property">players</span>.<span class="title function_">push</span>(player);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们多开窗口即可看到多名玩家同步到一个地图上了。</p>
<p>上一章：<a href="/posts/57210.html">Django学习笔记-AcApp端授权AcWing一键登录</a>。</p>
<p>下一章：<a href="/posts/60167.html">Django学习笔记-实现联机对战（下）</a>。</p>
</div>
        </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> Share</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://asanosaki.github.io/posts/31494.html",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://asanosaki.github.io/posts/31494.html";
            const title         = "「Django学习笔记-实现联机对战（上）」";
            const excerpt       = `本节内容是通过 Django Channels 框架使用 WebSocket 协议实现多人模式中的同步创建玩家函数。`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/Python/" rel="tag">Python</a>
                </div>
                <div class="pull-date">
                    <time datetime="2024-03-16T06:20:36.480Z" itemprop="dateModified">Last edited: 2024-03-16</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" Django学习笔记-AcApp端授权AcWing一键登录" href="/posts/57210.html">&lt; Previous</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" Web学习笔记-React（组合Components）" href="/posts/18290.html">Next &gt;</a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/head.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                Articles
            </span>
            <span class="count">
                89
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                Classifications
            </span>
            <span class="count">
                10
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                Tags
            </span>
            <span class="count">
                10
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class" >
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        Contents
        <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BB%9F%E4%B8%80%E9%95%BF%E5%BA%A6%E5%8D%95%E4%BD%8D"><span class="toc-text">1. 统一长度单位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A2%9E%E5%8A%A0%E8%81%94%E6%9C%BA%E5%AF%B9%E6%88%98%E6%A8%A1%E5%BC%8F"><span class="toc-text">2. 增加联机对战模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AEDjango-Channels"><span class="toc-text">3. 配置Django Channels</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%89%8D%E7%AB%AF%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5"><span class="toc-text">4. 前端创建连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%89%8D%E7%AB%AF%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="toc-text">5. 前端发送请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%BC%96%E5%86%99%E5%90%8C%E6%AD%A5%E5%87%BD%E6%95%B0create-player"><span class="toc-text">6. 编写同步函数create_player</span></a></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>Contents</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Essay/">Essay</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Interview/">Interview</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Others/">Others</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">9</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>Tags aggregation</h4>
      <div class="tag-clouds">
        <a href="/tags/AI/" style="font-size: 0.77em;">AI</a> <a href="/tags/C/" style="font-size: 0.6em;">C++</a> <a href="/tags/Essay/" style="font-size: 0.6em;">Essay</a> <a href="/tags/Hexo/" style="font-size: 0.63em;">Hexo</a> <a href="/tags/Interview/" style="font-size: 0.67em;">Interview</a> <a href="/tags/Java/" style="font-size: 0.8em;">Java</a> <a href="/tags/Linux/" style="font-size: 0.67em;">Linux</a> <a href="/tags/Others/" style="font-size: 0.7em;">Others</a> <a href="/tags/Python/" style="font-size: 0.77em;">Python</a> <a href="/tags/Web/" style="font-size: 0.73em;">Web</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>Latest articles</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/posts/32409.html"><i class="fa  fa-book"></i> Determined AI部署与使用教程</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/24133.html"><i class="fa  fa-book"></i> SpringBoot学习笔记-实现微服务：匹配系统（下）</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/5710.html"><i class="fa  fa-book"></i> SpringBoot学习笔记-实现微服务：匹配系统（中）</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/2329.html"><i class="fa  fa-book"></i> Spring面试题总结</a>
            
          
        
          
          
            <a class="list-group-item" href="/posts/53737.html"><i class="fa  fa-book"></i> Java进阶面试题总结</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        <li><a target="_blank" rel="nofollow" href="https://weibo.com/u/1952449115"><i class="fa fa-weibo"></i></a></li>
                        <li><a href="mailto:mail@1195595343@qq.com"><i class="fa fa-envelope"></i></a></li>
                        
                        
                        
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/AsanoSaki"><i class="fa fa-github"></i></a></li>
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2025 AsanoSaki Copyright.</li>
                            <li>This site is running<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by AsanoSaki.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.com/" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>





    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>